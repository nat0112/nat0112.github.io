<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Fish Farm Pro - ระบบจัดการบ่อเลี้ยงปลา</title>

  <!-- PWA Meta Tags -->
  <meta name="description" content="แอพจัดการบ่อเลี้ยงปลา บันทึกการให้อาหาร คุณภาพน้ำ และค่าใช้จ่าย">
  <meta name="theme-color" content="#0ea5e9">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Fish Farm">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Fish Farm Pro">
  <meta name="msapplication-TileColor" content="#0ea5e9">
  <meta name="msapplication-tap-highlight" content="no">

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Icons -->
  <link rel="icon" type="image/svg+xml" href="icons/icon.svg">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-192x192.png">

  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Cloud Database SDKs (Multi-Provider Support) -->
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- PocketBase -->
  <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.1/dist/pocketbase.umd.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700&display=swap');
    * { font-family: 'IBM Plex Sans Thai', -apple-system, sans-serif; }

    /* Default Dark Theme */
    :root {
      --bg-gradient-1: #0f172a;
      --bg-gradient-2: #1e293b;
      --scrollbar-track: #1e293b;
      --scrollbar-thumb: #475569;
      --text-color: #e2e8f0;
    }

    /* Pastel Blue Theme - readable version */
    body.pastel-theme {
      --bg-gradient-1: #bfdbfe;
      --bg-gradient-2: #dbeafe;
      --scrollbar-track: #93c5fd;
      --scrollbar-thumb: #3b82f6;
      --text-color: #1e293b;
    }
    body.pastel-theme { color: var(--text-color) !important; }
    /* Text colors - dark for readability */
    body.pastel-theme .text-slate-100 { color: #0f172a !important; }
    body.pastel-theme .text-slate-200 { color: #1e293b !important; }
    body.pastel-theme .text-slate-300 { color: #334155 !important; }
    body.pastel-theme .text-slate-400 { color: #475569 !important; }
    body.pastel-theme .text-slate-500 { color: #64748b !important; }
    /* Background colors - use white/light with shadows for contrast */
    body.pastel-theme .bg-slate-700 { background-color: rgba(255, 255, 255, 0.9) !important; color: #1e293b !important; }
    body.pastel-theme .bg-slate-700\/30 { background-color: rgba(255, 255, 255, 0.7) !important; }
    body.pastel-theme .bg-slate-700\/50 { background-color: rgba(255, 255, 255, 0.8) !important; }
    body.pastel-theme .bg-slate-800 { background-color: #ffffff !important; }
    body.pastel-theme .bg-slate-800\/50 { background-color: rgba(255, 255, 255, 0.95) !important; }
    body.pastel-theme .bg-slate-900 { background-color: #f8fafc !important; }
    body.pastel-theme .bg-slate-900\/95 { background-color: rgba(248, 250, 252, 0.98) !important; }
    body.pastel-theme .bg-slate-600 { background-color: rgba(255, 255, 255, 0.85) !important; color: #1e293b !important; }
    /* Borders */
    body.pastel-theme .border-slate-500 { border-color: #93c5fd !important; }
    body.pastel-theme .border-slate-600 { border-color: #bfdbfe !important; }
    body.pastel-theme .border-slate-700 { border-color: #e2e8f0 !important; }
    body.pastel-theme .border-slate-700\/50 { border-color: rgba(203, 213, 225, 0.8) !important; }
    body.pastel-theme .hover\:bg-slate-700:hover { background-color: rgba(255, 255, 255, 0.95) !important; }
    body.pastel-theme .hover\:bg-slate-700\/50:hover { background-color: rgba(255, 255, 255, 0.9) !important; }
    /* Pastel accent colors - vibrant for readability */
    body.pastel-theme .text-cyan-400 { color: #0284c7 !important; }
    body.pastel-theme .text-cyan-500 { color: #0369a1 !important; }
    body.pastel-theme .bg-cyan-500 { background-color: #0ea5e9 !important; color: #ffffff !important; }
    body.pastel-theme .bg-cyan-500\/20 { background-color: rgba(14, 165, 233, 0.2) !important; }
    body.pastel-theme .hover\:bg-cyan-500\/30:hover { background-color: rgba(14, 165, 233, 0.3) !important; }
    body.pastel-theme .hover\:bg-cyan-600:hover { background-color: #0284c7 !important; }
    body.pastel-theme .text-rose-400 { color: #e11d48 !important; }
    body.pastel-theme .text-rose-300 { color: #f43f5e !important; }
    body.pastel-theme .bg-rose-500 { background-color: #f43f5e !important; color: #ffffff !important; }
    body.pastel-theme .bg-rose-500\/20 { background-color: rgba(244, 63, 94, 0.2) !important; }
    body.pastel-theme .bg-rose-500\/10 { background-color: rgba(244, 63, 94, 0.15) !important; }
    body.pastel-theme .text-amber-400 { color: #d97706 !important; }
    body.pastel-theme .bg-amber-500\/20 { background-color: rgba(245, 158, 11, 0.2) !important; }
    body.pastel-theme .bg-amber-500\/10 { background-color: rgba(245, 158, 11, 0.15) !important; }
    body.pastel-theme .hover\:bg-amber-500\/30:hover { background-color: rgba(245, 158, 11, 0.3) !important; }
    body.pastel-theme .text-green-400 { color: #16a34a !important; }
    body.pastel-theme .bg-green-500\/20 { background-color: rgba(34, 197, 94, 0.2) !important; }
    body.pastel-theme .hover\:bg-green-500\/30:hover { background-color: rgba(34, 197, 94, 0.3) !important; }
    body.pastel-theme .text-blue-400 { color: #2563eb !important; }
    body.pastel-theme .bg-blue-500\/20 { background-color: rgba(59, 130, 246, 0.2) !important; }
    body.pastel-theme .hover\:bg-blue-500\/30:hover { background-color: rgba(59, 130, 246, 0.3) !important; }
    body.pastel-theme .text-red-400 { color: #dc2626 !important; }
    body.pastel-theme .bg-red-500 { background-color: #ef4444 !important; color: #ffffff !important; }
    body.pastel-theme .bg-red-500\/20 { background-color: rgba(239, 68, 68, 0.2) !important; }
    body.pastel-theme .bg-red-500\/10 { background-color: rgba(239, 68, 68, 0.15) !important; }
    body.pastel-theme .hover\:bg-red-500\/20:hover { background-color: rgba(239, 68, 68, 0.25) !important; }
    body.pastel-theme .hover\:bg-red-500\/30:hover { background-color: rgba(239, 68, 68, 0.35) !important; }
    /* Input text colors */
    body.pastel-theme input, body.pastel-theme select, body.pastel-theme textarea {
      color: #1e293b !important;
      background-color: rgba(255, 255, 255, 0.9) !important;
    }
    body.pastel-theme input::placeholder { color: #94a3b8 !important; }
    /* Font weight for better readability */
    body.pastel-theme .font-medium { font-weight: 600 !important; }
    body.pastel-theme .font-semibold { font-weight: 700 !important; }
    body.pastel-theme .font-bold { font-weight: 800 !important; }
    /* Card backgrounds - white with shadow for contrast */
    body.pastel-theme .bg-slate-800\/50 { background-color: rgba(255, 255, 255, 0.85) !important; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important; }
    body.pastel-theme .bg-slate-700\/30 { background-color: rgba(255, 255, 255, 0.75) !important; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06) !important; }
    body.pastel-theme .bg-slate-700\/50 { background-color: rgba(255, 255, 255, 0.8) !important; }
    body.pastel-theme .text-xs.text-slate-400 { color: #64748b !important; }
    body.pastel-theme .text-xs.text-slate-500 { color: #94a3b8 !important; }
    /* Cards and sections with shadow */
    body.pastel-theme .rounded-2xl.border { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important; background-color: rgba(255, 255, 255, 0.9) !important; }
    body.pastel-theme .rounded-xl.border { box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06) !important; }
    /* Stats boxes - white bg for contrast */
    body.pastel-theme .bg-slate-700\/30.rounded-xl.p-3 { background-color: rgba(255, 255, 255, 0.8) !important; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important; }
    body.pastel-theme .bg-slate-700\/30.rounded-xl.p-2 { background-color: rgba(255, 255, 255, 0.8) !important; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important; }
    /* Modal background */
    body.pastel-theme .bg-slate-800 { background-color: #ffffff !important; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15) !important; }
    /* Bottom nav */
    body.pastel-theme nav.fixed.bottom-0 { background-color: rgba(255, 255, 255, 0.98) !important; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.08) !important; }
    /* Header */
    body.pastel-theme header { background-color: rgba(255, 255, 255, 0.98) !important; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06) !important; }
    /* Text on colored buttons */
    body.pastel-theme .bg-cyan-500\/20 .text-cyan-400 { color: #0369a1 !important; }
    body.pastel-theme .bg-blue-500\/20 .text-blue-400 { color: #1d4ed8 !important; }
    body.pastel-theme .bg-green-500\/20 .text-green-400 { color: #15803d !important; }
    body.pastel-theme .bg-amber-500\/20 .text-amber-400 { color: #b45309 !important; }
    body.pastel-theme .bg-red-500\/20 .text-red-400 { color: #dc2626 !important; }
    body.pastel-theme .bg-rose-500\/20 .text-rose-400 { color: #be123c !important; }
    /* Accent info boxes */
    body.pastel-theme .bg-cyan-500\/10 { background-color: rgba(14, 165, 233, 0.15) !important; border-color: rgba(14, 165, 233, 0.4) !important; }
    body.pastel-theme .bg-amber-500\/10 { background-color: rgba(245, 158, 11, 0.15) !important; }
    /* Toast notifications */
    body.pastel-theme .bg-green-500 { background-color: #16a34a !important; color: white !important; }
    body.pastel-theme .bg-red-500 { background-color: #dc2626 !important; color: white !important; }
    body.pastel-theme .bg-amber-500 { background-color: #d97706 !important; color: white !important; }
    /* Orange text */
    body.pastel-theme .text-orange-400 { color: #ea580c !important; }

    body { background: linear-gradient(135deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 50%, var(--bg-gradient-1) 100%); min-height: 100vh; transition: background 0.3s ease; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
    ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 2px; }
    input, select { font-size: 16px; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 5px #22d3ee40; } 50% { box-shadow: 0 0 15px #22d3ee60; } }
    .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
    .slide-up { animation: slideUp 0.3s ease-out; }
    @keyframes toastIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
    @keyframes toastOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
    .toast-in { animation: toastIn 0.3s ease-out; }
    .toast-out { animation: toastOut 0.3s ease-out forwards; }
  </style>
</head>
<body class="text-slate-100">
  <div id="app"></div>
  <div id="toast-container" class="fixed top-4 right-4 z-[100] space-y-2"></div>
  <div id="confirm-modal"></div>

  <script>
    // ===== Constants =====
    const KEYS = {
      PONDS: 'ff_ponds',
      CYCLES: 'ff_cycles',
      FEEDS: 'ff_feeds',
      FEED_STOCK: 'ff_feed_stock',
      SUPPLEMENTS: 'ff_supplements',
      MEDICINES: 'ff_medicines',
      FEEDING_LOGS: 'ff_feeding_logs',
      WATER_QUALITY: 'ff_water_quality',
      EXPENSES: 'ff_expenses',
      HARVESTS: 'ff_harvests',
      MORTALITIES: 'ff_mortalities',
      SETTINGS: 'ff_settings',
      FISH_TYPES: 'ff_fish_types',
      STOCK_PASSWORD: 'ff_stock_password'
    };

    // Default fish types (will be loaded from storage)
    const DEFAULT_FISH_TYPES = [
      { id: 'catfish', name: 'ปลาดุก', feedType: 'fresh', avgWeight: 150 },
      { id: 'tilapia', name: 'ปลานิล', feedType: 'pellet', avgWeight: 500 },
      { id: 'red_tilapia', name: 'ปลาทับทิม', feedType: 'pellet', avgWeight: 600 }
    ];

    // Helper to get fish types from storage
    const getFishTypes = () => {
      const types = storage.get(KEYS.FISH_TYPES);
      return types.length > 0 ? types : DEFAULT_FISH_TYPES;
    };

    const EXPENSE_CATEGORIES = ['ค่าไฟ', 'ค่าน้ำ', 'ค่าแรง', 'ค่ายา/เคมี', 'ค่าซ่อมบำรุง', 'อื่นๆ'];

    // ===== Utils =====
    const generateId = () => `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    const formatCurrency = (n) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', minimumFractionDigits: 0 }).format(n || 0);
    const formatNumber = (n, d = 0) => new Intl.NumberFormat('th-TH', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
    const formatDate = (date) => new Date(date).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
    const calculateDays = (start) => Math.max(1, Math.ceil((new Date().getTime() - new Date(start).getTime()) / (1000 * 60 * 60 * 24)));

    // Improved storage with error handling
    const storage = {
      get: (key) => {
        try {
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          console.error(`Storage read error for ${key}:`, e);
          return [];
        }
      },
      set: (key, data) => {
        try {
          localStorage.setItem(key, JSON.stringify(data));
          // Trigger auto-save to file for Electron
          if (window.autoSaveToFile) window.autoSaveToFile();
          return true;
        } catch (e) {
          if (e.name === 'QuotaExceededError') {
            showToast('พื้นที่จัดเก็บเต็ม กรุณาลบข้อมูลเก่า', 'error');
          } else {
            showToast('เกิดข้อผิดพลาดในการบันทึก', 'error');
          }
          console.error(`Storage write error for ${key}:`, e);
          return false;
        }
      },
      getStorageUsage: () => {
        let total = 0;
        Object.values(KEYS).forEach(key => {
          const item = localStorage.getItem(key);
          if (item) total += item.length * 2; // UTF-16
        });
        return (total / 1024).toFixed(2); // KB
      }
    };
    window.storage = storage; // Export for firebase-sync.js

    // ===== Toast Notification System =====
    const showToast = (message, type = 'success', duration = 3000) => {
      const container = document.getElementById('toast-container');
      const id = generateId();
      const colors = {
        success: 'bg-green-500/90 border-green-400',
        error: 'bg-red-500/90 border-red-400',
        warning: 'bg-amber-500/90 border-amber-400',
        info: 'bg-cyan-500/90 border-cyan-400'
      };
      const icons = { success: '✓', error: '✕', warning: '⚠', info: 'ℹ' };

      const toast = document.createElement('div');
      toast.id = `toast-${id}`;
      toast.className = `toast-in flex items-center gap-2 px-4 py-3 rounded-xl border ${colors[type]} text-white shadow-lg backdrop-blur`;
      toast.innerHTML = `<span class="text-lg">${icons[type]}</span><span>${message}</span>`;
      container.appendChild(toast);

      setTimeout(() => {
        toast.classList.remove('toast-in');
        toast.classList.add('toast-out');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    };
    window.showToast = showToast; // Export for firebase-sync.js

    // ===== Custom Confirm Dialog =====
    const showConfirm = (title, message, onConfirm, type = 'warning') => {
      const modal = document.getElementById('confirm-modal');
      const colors = {
        warning: { bg: 'bg-amber-500', hover: 'hover:bg-amber-600' },
        danger: { bg: 'bg-red-500', hover: 'hover:bg-red-600' }
      };

      modal.innerHTML = `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[90] flex items-center justify-center p-4" onclick="closeConfirm()">
          <div class="bg-slate-800 rounded-2xl w-full max-w-sm p-6 fade-in" onclick="event.stopPropagation()">
            <div class="text-center mb-4">
              <div class="text-4xl mb-2">${type === 'danger' ? '⚠️' : '❓'}</div>
              <h3 class="text-lg font-semibold">${title}</h3>
              <p class="text-slate-400 text-sm mt-2">${message}</p>
            </div>
            <div class="flex gap-3">
              <button onclick="closeConfirm()" class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl transition-colors">ยกเลิก</button>
              <button onclick="confirmAction()" class="flex-1 py-3 ${colors[type].bg} ${colors[type].hover} text-white rounded-xl transition-colors">ยืนยัน</button>
            </div>
          </div>
        </div>
      `;
      window._confirmCallback = onConfirm;
    };

    window.closeConfirm = () => {
      document.getElementById('confirm-modal').innerHTML = '';
      window._confirmCallback = null;
    };

    window.confirmAction = () => {
      if (window._confirmCallback) window._confirmCallback();
      closeConfirm();
    };

    // ===== Validation =====
    const validate = {
      required: (value, fieldName) => {
        if (!value || (typeof value === 'string' && !value.trim())) {
          showToast(`กรุณากรอก ${fieldName}`, 'error');
          return false;
        }
        return true;
      },
      number: (value, fieldName, min = 0, max = Infinity) => {
        const num = parseFloat(value);
        if (isNaN(num) || num < min || num > max) {
          showToast(`${fieldName} ต้องเป็นตัวเลข ${min}-${max}`, 'error');
          return false;
        }
        return true;
      },
      positiveNumber: (value, fieldName) => {
        const num = parseFloat(value);
        if (isNaN(num) || num <= 0) {
          showToast(`${fieldName} ต้องมากกว่า 0`, 'error');
          return false;
        }
        return true;
      }
    };

    // ===== Database with validation =====
    const db = {
      ponds: {
        getAll: () => storage.get(KEYS.PONDS),
        getById: (id) => storage.get(KEYS.PONDS).find(p => p.id === id),
        create: (name) => {
          if (!validate.required(name, 'ชื่อบ่อ')) return null;
          const ponds = storage.get(KEYS.PONDS);
          if (ponds.some(p => p.name.toLowerCase() === name.trim().toLowerCase())) {
            showToast('ชื่อบ่อซ้ำ', 'error');
            return null;
          }
          const p = { id: generateId(), name: name.trim(), status: 'empty', createdAt: new Date().toISOString() };
          ponds.push(p);
          if (storage.set(KEYS.PONDS, ponds)) {
            showToast('สร้างบ่อสำเร็จ', 'success');
            return p;
          }
          return null;
        },
        update: (id, data) => {
          const ponds = storage.get(KEYS.PONDS);
          const i = ponds.findIndex(p => p.id === id);
          if (i >= 0) {
            ponds[i] = { ...ponds[i], ...data, updatedAt: new Date().toISOString() };
            storage.set(KEYS.PONDS, ponds);
          }
        },
        delete: (id) => {
          // Also delete related cycles and their data
          const cycles = storage.get(KEYS.CYCLES).filter(c => c.pondId === id);
          cycles.forEach(cycle => {
            storage.set(KEYS.FEEDING_LOGS, storage.get(KEYS.FEEDING_LOGS).filter(l => l.cycleId !== cycle.id));
            storage.set(KEYS.WATER_QUALITY, storage.get(KEYS.WATER_QUALITY).filter(w => w.cycleId !== cycle.id));
            storage.set(KEYS.EXPENSES, storage.get(KEYS.EXPENSES).filter(e => e.cycleId !== cycle.id));
            storage.set(KEYS.HARVESTS, storage.get(KEYS.HARVESTS).filter(h => h.cycleId !== cycle.id));
          });
          storage.set(KEYS.CYCLES, storage.get(KEYS.CYCLES).filter(c => c.pondId !== id));
          storage.set(KEYS.PONDS, storage.get(KEYS.PONDS).filter(p => p.id !== id));
          showToast('ลบบ่อสำเร็จ', 'success');
        }
      },
      fishTypes: {
        getAll: () => getFishTypes(),
        getById: (id) => getFishTypes().find(f => f.id === id),
        create: (data) => {
          if (!validate.required(data.name, 'ชื่อชนิดปลา')) return null;
          const types = storage.get(KEYS.FISH_TYPES);
          if (types.length === 0) {
            // First time - copy defaults
            DEFAULT_FISH_TYPES.forEach(t => types.push(t));
          }
          if (types.some(t => t.name.toLowerCase() === data.name.trim().toLowerCase())) {
            showToast('ชื่อชนิดปลาซ้ำ', 'error');
            return null;
          }
          const ft = {
            id: generateId(),
            name: data.name.trim(),
            feedType: data.feedType || 'pellet',
            avgWeight: parseFloat(data.avgWeight) || 100,
            createdAt: new Date().toISOString(),
            editHistory: []
          };
          types.push(ft);
          if (storage.set(KEYS.FISH_TYPES, types)) {
            showToast('เพิ่มชนิดปลาสำเร็จ', 'success');
            return ft;
          }
          return null;
        },
        update: (id, data) => {
          let types = storage.get(KEYS.FISH_TYPES);
          if (types.length === 0) {
            types = [...DEFAULT_FISH_TYPES];
          }
          const i = types.findIndex(t => t.id === id);
          if (i >= 0) {
            const old = types[i];
            const history = [...(old.editHistory || []), {
              editedAt: new Date().toISOString(),
              prev: { name: old.name, feedType: old.feedType, avgWeight: old.avgWeight }
            }];
            types[i] = { ...old, ...data, editHistory: history, updatedAt: new Date().toISOString() };
            if (storage.set(KEYS.FISH_TYPES, types)) {
              showToast('แก้ไขชนิดปลาสำเร็จ', 'success');
            }
          }
        },
        delete: (id) => {
          let types = storage.get(KEYS.FISH_TYPES);
          if (types.length === 0) {
            types = [...DEFAULT_FISH_TYPES];
          }
          types = types.filter(t => t.id !== id);
          storage.set(KEYS.FISH_TYPES, types);
          showToast('ลบชนิดปลาสำเร็จ', 'success');
        }
      },
      cycles: {
        getAll: () => storage.get(KEYS.CYCLES),
        getActive: (pondId) => storage.get(KEYS.CYCLES).find(c => c.pondId === pondId && c.status === 'active'),
        getCompleted: (pondId) => storage.get(KEYS.CYCLES).filter(c => c.pondId === pondId && c.status === 'completed'),
        create: (data) => {
          if (!validate.positiveNumber(data.initialCount, 'จำนวนปลา')) return null;
          if (!validate.positiveNumber(data.pricePerFish, 'ราคาต่อตัว')) return null;

          const cycles = storage.get(KEYS.CYCLES);
          const c = { ...data, id: generateId() };
          cycles.push(c);
          if (storage.set(KEYS.CYCLES, cycles)) {
            db.ponds.update(data.pondId, { status: 'active' });
            showToast('เริ่มรอบการเลี้ยงสำเร็จ', 'success');
            return c;
          }
          return null;
        },
        complete: (id) => {
          const cycles = storage.get(KEYS.CYCLES);
          const i = cycles.findIndex(c => c.id === id);
          if (i >= 0) {
            cycles[i].status = 'completed';
            cycles[i].endDate = new Date().toISOString();
            cycles[i].updatedAt = new Date().toISOString();
            storage.set(KEYS.CYCLES, cycles);
            db.ponds.update(cycles[i].pondId, { status: 'empty' });
          }
        },
        reset: (pondId) => {
          const cycle = db.cycles.getActive(pondId);
          if (cycle) {
            storage.set(KEYS.FEEDING_LOGS, storage.get(KEYS.FEEDING_LOGS).filter(l => l.cycleId !== cycle.id));
            storage.set(KEYS.WATER_QUALITY, storage.get(KEYS.WATER_QUALITY).filter(w => w.cycleId !== cycle.id));
            storage.set(KEYS.EXPENSES, storage.get(KEYS.EXPENSES).filter(e => e.cycleId !== cycle.id));
            storage.set(KEYS.HARVESTS, storage.get(KEYS.HARVESTS).filter(h => h.cycleId !== cycle.id));
            storage.set(KEYS.CYCLES, storage.get(KEYS.CYCLES).filter(c => c.id !== cycle.id));
            db.ponds.update(pondId, { status: 'empty' });
            showToast('รีเซ็ตบ่อสำเร็จ', 'success');
          }
        }
      },
      feeds: {
        getAll: () => storage.get(KEYS.FEEDS),
        getById: (id) => storage.get(KEYS.FEEDS).find(f => f.id === id),
        create: (data) => {
          if (!validate.required(data.name, 'ชื่ออาหาร')) return null;
          if (!validate.positiveNumber(data.pricePerKg, 'ราคา')) return null;

          const feeds = storage.get(KEYS.FEEDS);
          const f = { ...data, id: generateId(), createdAt: new Date().toISOString(), editHistory: [] };
          feeds.push(f);
          if (storage.set(KEYS.FEEDS, feeds)) {
            showToast('เพิ่มอาหารสำเร็จ', 'success');
            return f;
          }
          return null;
        },
        update: (id, data) => {
          const feeds = storage.get(KEYS.FEEDS);
          const i = feeds.findIndex(f => f.id === id);
          if (i >= 0) {
            const old = feeds[i];
            const history = [...(old.editHistory || []), {
              editedAt: new Date().toISOString(),
              prev: { name: old.name, type: old.type, brand: old.brand, sizeNumber: old.sizeNumber, pricePerKg: old.pricePerKg }
            }];
            feeds[i] = { ...old, ...data, editHistory: history, updatedAt: new Date().toISOString() };
            if (storage.set(KEYS.FEEDS, feeds)) {
              showToast('แก้ไขอาหารสำเร็จ', 'success');
            }
          }
        },
        delete: (id) => {
          storage.set(KEYS.FEEDS, storage.get(KEYS.FEEDS).filter(f => f.id !== id));
          showToast('ลบอาหารสำเร็จ', 'success');
        }
      },
      supplements: {
        getAll: () => storage.get(KEYS.SUPPLEMENTS),
        getById: (id) => storage.get(KEYS.SUPPLEMENTS).find(s => s.id === id),
        create: (data) => {
          if (!validate.required(data.name, 'ชื่อวิตามิน')) return null;

          const supps = storage.get(KEYS.SUPPLEMENTS);
          const s = { ...data, id: generateId(), createdAt: new Date().toISOString(), editHistory: [] };
          supps.push(s);
          if (storage.set(KEYS.SUPPLEMENTS, supps)) {
            showToast('เพิ่มวิตามินสำเร็จ', 'success');
            return s;
          }
          return null;
        },
        update: (id, data) => {
          const supps = storage.get(KEYS.SUPPLEMENTS);
          const i = supps.findIndex(s => s.id === id);
          if (i >= 0) {
            const old = supps[i];
            const history = [...(old.editHistory || []), {
              editedAt: new Date().toISOString(),
              prev: { name: old.name, description: old.description, suppType: old.suppType, price: old.price, unit: old.unit }
            }];
            supps[i] = { ...old, ...data, editHistory: history, updatedAt: new Date().toISOString() };
            if (storage.set(KEYS.SUPPLEMENTS, supps)) {
              showToast('แก้ไขวิตามินสำเร็จ', 'success');
            }
          }
        },
        delete: (id) => {
          storage.set(KEYS.SUPPLEMENTS, storage.get(KEYS.SUPPLEMENTS).filter(s => s.id !== id));
          showToast('ลบวิตามินสำเร็จ', 'success');
        }
      },
      medicines: {
        getAll: () => storage.get(KEYS.MEDICINES),
        getById: (id) => storage.get(KEYS.MEDICINES).find(m => m.id === id),
        create: (data) => {
          if (!validate.required(data.name, 'ชื่อยา')) return null;
          if (!validate.required(data.usageDetails, 'รายละเอียดการใช้')) return null;

          const meds = storage.get(KEYS.MEDICINES);
          const m = { ...data, id: generateId(), createdAt: new Date().toISOString(), editHistory: [] };
          meds.push(m);
          if (storage.set(KEYS.MEDICINES, meds)) {
            showToast('เพิ่มยารักษาโรคสำเร็จ', 'success');
            return m;
          }
          return null;
        },
        update: (id, data) => {
          const meds = storage.get(KEYS.MEDICINES);
          const i = meds.findIndex(m => m.id === id);
          if (i >= 0) {
            const old = meds[i];
            const history = [...(old.editHistory || []), {
              editedAt: new Date().toISOString(),
              prev: { name: old.name, description: old.description, medType: old.medType, price: old.price, unit: old.unit, usageDetails: old.usageDetails }
            }];
            meds[i] = { ...old, ...data, editHistory: history, updatedAt: new Date().toISOString() };
            if (storage.set(KEYS.MEDICINES, meds)) {
              showToast('แก้ไขยารักษาโรคสำเร็จ', 'success');
            }
          }
        },
        delete: (id) => {
          storage.set(KEYS.MEDICINES, storage.get(KEYS.MEDICINES).filter(m => m.id !== id));
          showToast('ลบยารักษาโรคสำเร็จ', 'success');
        }
      },
      feedingLogs: {
        getByCycle: (cycleId) => storage.get(KEYS.FEEDING_LOGS)
          .filter(l => l.cycleId === cycleId)
          .sort((a, b) => new Date(b.date) - new Date(a.date) || b.time.localeCompare(a.time)),
        create: (data) => {
          // Allow medicine-only records without feed weight
          if (!data.medicineOnly && !validate.positiveNumber(data.weightKg, 'น้ำหนักอาหาร')) return null;
          if (data.medicineOnly && (!data.medicines || data.medicines.length === 0)) {
            showToast('กรุณาเลือกยาอย่างน้อย 1 รายการ', 'error');
            return null;
          }

          const logs = storage.get(KEYS.FEEDING_LOGS);
          const l = { ...data, id: generateId(), createdAt: new Date().toISOString(), editHistory: [] };
          logs.push(l);
          if (storage.set(KEYS.FEEDING_LOGS, logs)) {
            showToast(data.medicineOnly ? 'บันทึกการให้ยาสำเร็จ' : 'บันทึกมื้ออาหารสำเร็จ', 'success');
            return l;
          }
          return null;
        },
        update: (id, data) => {
          const logs = storage.get(KEYS.FEEDING_LOGS);
          const i = logs.findIndex(l => l.id === id);
          if (i >= 0) {
            const old = logs[i];
            const history = [...(old.editHistory || []), {
              editedAt: new Date().toISOString(),
              prev: { feedId: old.feedId, weightKg: old.weightKg, time: old.time }
            }];
            logs[i] = { ...old, ...data, editHistory: history, updatedAt: new Date().toISOString() };
            if (storage.set(KEYS.FEEDING_LOGS, logs)) {
              showToast('แก้ไขสำเร็จ', 'success');
            }
          }
        },
        delete: (id) => {
          storage.set(KEYS.FEEDING_LOGS, storage.get(KEYS.FEEDING_LOGS).filter(l => l.id !== id));
          showToast('ลบมื้ออาหารสำเร็จ', 'success');
        },
        getLatest: (cycleId) => db.feedingLogs.getByCycle(cycleId)[0],
        getByDate: (cycleId, date) => {
          const dateStr = new Date(date).toDateString();
          return storage.get(KEYS.FEEDING_LOGS)
            .filter(l => l.cycleId === cycleId && new Date(l.date).toDateString() === dateStr)
            .sort((a, b) => a.time.localeCompare(b.time));
        }
      },
      waterQuality: {
        getByCycle: (cycleId) => storage.get(KEYS.WATER_QUALITY)
          .filter(w => w.cycleId === cycleId)
          .sort((a, b) => new Date(b.date) - new Date(a.date)),
        create: (data) => {
          const records = storage.get(KEYS.WATER_QUALITY);
          const w = { ...data, id: generateId(), createdAt: new Date().toISOString() };
          records.push(w);
          if (storage.set(KEYS.WATER_QUALITY, records)) {
            showToast('บันทึกคุณภาพน้ำสำเร็จ', 'success');
            return w;
          }
          return null;
        },
        getLatest: (cycleId) => db.waterQuality.getByCycle(cycleId)[0]
      },
      expenses: {
        getByCycle: (cycleId) => storage.get(KEYS.EXPENSES).filter(e => e.cycleId === cycleId),
        create: (data) => {
          if (!validate.positiveNumber(data.amount, 'จำนวนเงิน')) return null;

          const exps = storage.get(KEYS.EXPENSES);
          const e = { ...data, id: generateId(), createdAt: new Date().toISOString() };
          exps.push(e);
          if (storage.set(KEYS.EXPENSES, exps)) {
            showToast('เพิ่มค่าใช้จ่ายสำเร็จ', 'success');
            return e;
          }
          return null;
        },
        delete: (id) => {
          storage.set(KEYS.EXPENSES, storage.get(KEYS.EXPENSES).filter(e => e.id !== id));
          showToast('ลบค่าใช้จ่ายสำเร็จ', 'success');
        }
      },
      harvests: {
        getByCycle: (cycleId) => storage.get(KEYS.HARVESTS).filter(h => h.cycleId === cycleId),
        create: (data) => {
          if (!validate.positiveNumber(data.weightKg, 'น้ำหนัก')) return null;
          if (!validate.positiveNumber(data.pricePerKg, 'ราคาขาย')) return null;

          const harvests = storage.get(KEYS.HARVESTS);
          const h = { ...data, id: generateId(), createdAt: new Date().toISOString() };
          harvests.push(h);
          if (storage.set(KEYS.HARVESTS, harvests)) {
            if (data.isFinalHarvest) {
              const cycle = storage.get(KEYS.CYCLES).find(c => c.id === data.cycleId);
              if (cycle) db.cycles.complete(cycle.id);
              showToast('จับปลาและจบรอบสำเร็จ', 'success');
            } else {
              showToast('บันทึกการจับปลาสำเร็จ', 'success');
            }
            return h;
          }
          return null;
        },
        getTotalByPond: (cycleId) => {
          const harvests = db.harvests.getByCycle(cycleId);
          return {
            totalWeight: harvests.reduce((s, h) => s + h.weightKg, 0),
            totalCount: harvests.reduce((s, h) => s + h.count, 0),
            totalRevenue: harvests.reduce((s, h) => s + (h.weightKg * h.pricePerKg), 0)
          };
        }
      },
      mortalities: {
        getByCycle: (cycleId) => storage.get(KEYS.MORTALITIES)
          .filter(m => m.cycleId === cycleId)
          .sort((a, b) => new Date(b.date) - new Date(a.date)),
        create: (data) => {
          if (!validate.positiveNumber(data.count, 'จำนวนปลาตาย')) return null;

          const morts = storage.get(KEYS.MORTALITIES);
          const m = { ...data, id: generateId(), createdAt: new Date().toISOString() };
          morts.push(m);
          if (storage.set(KEYS.MORTALITIES, morts)) {
            showToast('บันทึกจำนวนปลาตายสำเร็จ', 'success');
            return m;
          }
          return null;
        },
        delete: (id) => {
          storage.set(KEYS.MORTALITIES, storage.get(KEYS.MORTALITIES).filter(m => m.id !== id));
          showToast('ลบบันทึกสำเร็จ', 'success');
        },
        getTotalByCycle: (cycleId) => {
          const morts = storage.get(KEYS.MORTALITIES).filter(m => m.cycleId === cycleId);
          return morts.reduce((sum, m) => sum + m.count, 0);
        },
        getToday: (cycleId) => {
          const today = new Date().toDateString();
          return storage.get(KEYS.MORTALITIES)
            .filter(m => m.cycleId === cycleId && new Date(m.date).toDateString() === today);
        }
      },
      feedStock: {
        getAll: () => storage.get(KEYS.FEED_STOCK),
        getByFeedId: (feedId) => storage.get(KEYS.FEED_STOCK).find(s => s.feedId === feedId),
        getStock: (feedId) => {
          const stock = storage.get(KEYS.FEED_STOCK).find(s => s.feedId === feedId);
          return stock ? stock.quantity : 0;
        },
        getFeedsWithStock: () => {
          const stocks = storage.get(KEYS.FEED_STOCK);
          const feeds = db.feeds.getAll();
          return feeds.filter(f => {
            const stock = stocks.find(s => s.feedId === f.id);
            return stock && stock.quantity > 0;
          }).map(f => {
            const stock = stocks.find(s => s.feedId === f.id);
            return { ...f, stockQuantity: stock.quantity };
          });
        },
        add: (feedId, quantity, note = '') => {
          if (!validate.positiveNumber(quantity, 'จำนวน')) return null;
          const stocks = storage.get(KEYS.FEED_STOCK);
          const existingIndex = stocks.findIndex(s => s.feedId === feedId);

          if (existingIndex >= 0) {
            stocks[existingIndex].quantity += parseFloat(quantity);
            stocks[existingIndex].lastUpdated = new Date().toISOString();
            stocks[existingIndex].history = stocks[existingIndex].history || [];
            stocks[existingIndex].history.push({
              type: 'add',
              quantity: parseFloat(quantity),
              note: note,
              date: new Date().toISOString()
            });
          } else {
            stocks.push({
              id: generateId(),
              feedId: feedId,
              quantity: parseFloat(quantity),
              lastUpdated: new Date().toISOString(),
              history: [{
                type: 'add',
                quantity: parseFloat(quantity),
                note: note,
                date: new Date().toISOString()
              }]
            });
          }

          if (storage.set(KEYS.FEED_STOCK, stocks)) {
            showToast('เพิ่มสต็อกอาหารสำเร็จ', 'success');
            return true;
          }
          return null;
        },
        deduct: (feedId, quantity) => {
          const stocks = storage.get(KEYS.FEED_STOCK);
          const existingIndex = stocks.findIndex(s => s.feedId === feedId);

          if (existingIndex >= 0) {
            const newQty = stocks[existingIndex].quantity - parseFloat(quantity);
            if (newQty < 0) {
              showToast('สต็อกไม่เพียงพอ', 'error');
              return false;
            }
            stocks[existingIndex].quantity = newQty;
            stocks[existingIndex].lastUpdated = new Date().toISOString();
            stocks[existingIndex].history = stocks[existingIndex].history || [];
            stocks[existingIndex].history.push({
              type: 'deduct',
              quantity: parseFloat(quantity),
              date: new Date().toISOString()
            });
            storage.set(KEYS.FEED_STOCK, stocks);
            return true;
          }
          return false;
        },
        setQuantity: (feedId, quantity) => {
          if (quantity < 0) {
            showToast('จำนวนต้องไม่ติดลบ', 'error');
            return null;
          }
          const stocks = storage.get(KEYS.FEED_STOCK);
          const existingIndex = stocks.findIndex(s => s.feedId === feedId);

          if (existingIndex >= 0) {
            const oldQty = stocks[existingIndex].quantity;
            stocks[existingIndex].quantity = parseFloat(quantity);
            stocks[existingIndex].lastUpdated = new Date().toISOString();
            stocks[existingIndex].history = stocks[existingIndex].history || [];
            stocks[existingIndex].history.push({
              type: 'adjust',
              oldQuantity: oldQty,
              newQuantity: parseFloat(quantity),
              date: new Date().toISOString()
            });
          } else {
            stocks.push({
              id: generateId(),
              feedId: feedId,
              quantity: parseFloat(quantity),
              lastUpdated: new Date().toISOString(),
              history: [{
                type: 'set',
                quantity: parseFloat(quantity),
                date: new Date().toISOString()
              }]
            });
          }

          if (storage.set(KEYS.FEED_STOCK, stocks)) {
            showToast('อัพเดตสต็อกสำเร็จ', 'success');
            return true;
          }
          return null;
        },
        delete: (feedId) => {
          const stocks = storage.get(KEYS.FEED_STOCK).filter(s => s.feedId !== feedId);
          storage.set(KEYS.FEED_STOCK, stocks);
        }
      },
      stockPassword: {
        get: () => {
          const data = localStorage.getItem(KEYS.STOCK_PASSWORD);
          return data ? JSON.parse(data) : { enabled: false, password: '' };
        },
        set: (password) => {
          const data = { enabled: true, password: password };
          localStorage.setItem(KEYS.STOCK_PASSWORD, JSON.stringify(data));
          showToast('ตั้งรหัสผ่านสำเร็จ', 'success');
          return true;
        },
        check: (inputPassword) => {
          const data = db.stockPassword.get();
          if (!data.enabled) return true;
          return data.password === inputPassword;
        },
        isEnabled: () => {
          return db.stockPassword.get().enabled;
        },
        disable: () => {
          localStorage.setItem(KEYS.STOCK_PASSWORD, JSON.stringify({ enabled: false, password: '' }));
          showToast('ยกเลิกใช้รหัสผ่านแล้ว', 'success');
          return true;
        },
        change: (oldPassword, newPassword) => {
          const data = db.stockPassword.get();
          if (data.enabled && data.password !== oldPassword) {
            showToast('รหัสผ่านเดิมไม่ถูกต้อง', 'error');
            return false;
          }
          db.stockPassword.set(newPassword);
          return true;
        }
      }
    };

    // ===== Calculations =====
    // Chart Helper - Simple SVG Line Chart
    const createChart = (data, options = {}) => {
      const { width = 280, height = 80, color = '#22d3ee', showDots = true, label = '' } = options;
      if (!data || data.length < 2) return '';

      const values = data.map(d => d.value);
      const max = Math.max(...values);
      const min = Math.min(...values);
      const range = max - min || 1;

      const points = data.map((d, i) => {
        const x = (i / (data.length - 1)) * (width - 20) + 10;
        const y = height - 10 - ((d.value - min) / range) * (height - 25);
        return { x, y, label: d.label, value: d.value };
      });

      const pathD = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');

      return `
        <svg width="${width}" height="${height}" class="w-full">
          <defs>
            <linearGradient id="grad-${label}" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style="stop-color:${color};stop-opacity:0.3" />
              <stop offset="100%" style="stop-color:${color};stop-opacity:0" />
            </linearGradient>
          </defs>
          <path d="${pathD} L ${points[points.length-1].x} ${height-5} L ${points[0].x} ${height-5} Z" fill="url(#grad-${label})" />
          <path d="${pathD}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          ${showDots ? points.map(p => `<circle cx="${p.x}" cy="${p.y}" r="3" fill="${color}" />`).join('') : ''}
          <text x="10" y="${height - 2}" fill="#64748b" font-size="10">${points[0].label || ''}</text>
          <text x="${width - 10}" y="${height - 2}" fill="#64748b" font-size="10" text-anchor="end">${points[points.length-1].label || ''}</text>
        </svg>
      `;
    };

    const calculations = {
      getCycleStats: (cycleId) => {
        const cycle = storage.get(KEYS.CYCLES).find(c => c.id === cycleId);
        if (!cycle) return null;

        const feeds = db.feeds.getAll();
        const supplements = db.supplements.getAll();
        const logs = db.feedingLogs.getByCycle(cycleId);
        const expenses = db.expenses.getByCycle(cycleId);
        const harvests = db.harvests.getByCycle(cycleId);
        const waterQuality = db.waterQuality.getLatest(cycleId);

        const totalFeed = logs.reduce((s, l) => s + l.weightKg, 0);
        const feedCost = logs.reduce((s, l) => s + l.weightKg * (feeds.find(f => f.id === l.feedId)?.pricePerKg || 0), 0);
        const suppCost = logs.reduce((sum, log) => {
          return sum + (log.supplements?.reduce((s, fs) => {
            const supp = supplements.find(sp => sp.id === fs.supplementId);
            // Use pricePerUnit if available, otherwise fallback to old calculation (price/100)
            const unitPrice = supp?.pricePerUnit || (supp?.price || 0) / (supp?.packageSize || 100);
            return s + unitPrice * fs.amount;
          }, 0) || 0);
        }, 0);
        const fishCost = cycle.initialCount * cycle.pricePerFish;
        const otherCost = expenses.reduce((s, e) => s + e.amount, 0);
        const totalCost = fishCost + feedCost + suppCost + otherCost;

        const harvestData = db.harvests.getTotalByPond(cycleId);
        const days = calculateDays(cycle.startDate);

        // Calculate FCR based on actual harvest weight or estimated
        const fishTypeData = db.fishTypes.getById(cycle.fishType);
        const avgWeightKg = (fishTypeData?.avgWeight || 150) / 1000; // Convert grams to kg
        const estimatedWeight = harvestData.totalWeight > 0
          ? harvestData.totalWeight
          : cycle.initialCount * avgWeightKg * 0.95;
        const fcr = totalFeed > 0 && estimatedWeight > 0 ? (totalFeed / estimatedWeight).toFixed(2) : '-';

        // Mortality tracking
        const totalMortality = db.mortalities.getTotalByCycle(cycleId);

        // Survival rate - use actual mortality if available
        const survivingCount = cycle.initialCount - totalMortality;
        const survivalRate = harvestData.totalCount > 0
          ? ((harvestData.totalCount / cycle.initialCount) * 100).toFixed(1)
          : totalMortality > 0 ? ((survivingCount / cycle.initialCount) * 100).toFixed(1) : null;

        // Cost per fish - based on actual surviving fish (after mortality) or estimated 95%
        const estimatedSurviving = totalMortality > 0
          ? survivingCount
          : Math.floor(cycle.initialCount * 0.95);
        const costPerFish = estimatedSurviving > 0 ? totalCost / estimatedSurviving : 0;

        return {
          cycle,
          days,
          totalFeed,
          feedCost,
          suppCost,
          fishCost,
          otherCost,
          totalCost,
          fcr,
          harvestData,
          survivalRate,
          waterQuality,
          costPerFish,
          estimatedSurviving,
          totalMortality,
          survivingCount,
          profit: harvestData.totalRevenue - totalCost
        };
      },

      getTodayLogs: (cycleId) => {
        return db.feedingLogs.getByDate(cycleId, new Date());
      },

      getDailyFeedSummary: (cycleId, days = 7) => {
        const logs = db.feedingLogs.getByCycle(cycleId);
        const summary = {};

        for (let i = 0; i < days; i++) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          const dateStr = date.toISOString().split('T')[0];
          const dayLogs = logs.filter(l => l.date.split('T')[0] === dateStr);
          summary[dateStr] = {
            totalWeight: dayLogs.reduce((s, l) => s + l.weightKg, 0),
            mealCount: dayLogs.length
          };
        }
        return summary;
      }
    };

    // Init default data
    const initData = () => {
      if (db.feeds.getAll().length === 0) {
        db.feeds.create({ type: 'fresh', name: 'ปลาเป็ด', pricePerKg: 15 });
        db.feeds.create({ type: 'fresh', name: 'เศษไก่', pricePerKg: 12 });
        db.feeds.create({ type: 'fresh', name: 'หัวปลา', pricePerKg: 8 });
        db.feeds.create({ type: 'pellet', name: 'CP 9950', brand: 'CP', sizeNumber: '2', pricePerKg: 32 });
        db.feeds.create({ type: 'pellet', name: 'Betagro', brand: 'Betagro', sizeNumber: '2', pricePerKg: 28 });
      }
      if (db.supplements.getAll().length === 0) {
        db.supplements.create({ name: 'Vitamin C', description: 'เสริมภูมิคุ้มกัน', suppType: 'solid', price: 45, unit: 'กรัม' });
        db.supplements.create({ name: 'แร่ธาตุรวม', description: 'แร่ธาตุจำเป็น', suppType: 'solid', price: 35, unit: 'กรัม' });
        db.supplements.create({ name: 'โปรไบโอติก', description: 'จุลินทรีย์', suppType: 'liquid', price: 60, unit: 'มล.' });
      }
      if (db.medicines.getAll().length === 0) {
        db.medicines.create({ name: 'ฟอร์มาลิน', description: 'รักษาปรสิตภายนอก', medType: 'liquid', price: 120, unit: 'มล.', packageSize: 1000, usageDetails: 'ใช้ 25-50 มล./น้ำ 1,000 ลิตร แช่ 30-60 นาที' });
        db.medicines.create({ name: 'เกลือ', description: 'รักษาโรคทั่วไป', medType: 'solid', price: 10, unit: 'กรัม', packageSize: 25000, usageDetails: 'ใช้ 0.5-1% ของปริมาณน้ำ แช่ 24-48 ชม.' });
        db.medicines.create({ name: 'ด่างทับทิม', description: 'ฆ่าเชื้อแบคทีเรีย', medType: 'solid', price: 250, unit: 'กรัม', packageSize: 100, usageDetails: 'ใช้ 2-4 กรัม/น้ำ 1,000 ลิตร แช่ 30 นาที' });
      }
    };

    // ===== App State =====
    let state = {
      tab: 'home',
      selectedPond: null,
      modal: null,
      editingLog: null,
      editingFishType: null,
      viewingFishTypeHistory: null,
      editingFeed: null,
      viewingFeedHistory: null,
      editingSupplement: null,
      viewingSupplementHistory: null,
      editingMedicine: null,
      viewingMedicineHistory: null,
      editingStockFeedId: null,
      pendingStockDelete: null,
      loading: false
    };

    const setState = (newState) => {
      state = { ...state, ...newState };
      render();
    };

    // ===== Render Functions =====
    const render = () => {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="min-h-screen pb-24">
          ${state.selectedPond ? renderPondDetail() : renderMainContent()}
        </div>
        ${!state.selectedPond ? renderBottomNav() : ''}
        ${state.modal ? renderModal() : ''}
      `;

      // Post-render actions for settings page
      if (state.tab === 'settings' && !state.selectedPond) {
        loadDiskSpaceInfo();
      }
    };
    window.render = render; // Export for firebase-sync.js

    // Load disk space info for settings page
    const loadDiskSpaceInfo = async () => {
      const diskSpaceEl = document.getElementById('diskSpaceInfo');
      const dataPathEl = document.getElementById('dataPathInfo');
      if (!diskSpaceEl) return;

      if (window.electronAPI && window.electronAPI.getDiskSpace) {
        try {
          const space = await window.electronAPI.getDiskSpace();
          const path = await window.electronAPI.getDataPath();
          diskSpaceEl.innerHTML = `
            <div class="grid grid-cols-3 gap-2 text-center">
              <div class="bg-slate-700/30 rounded-lg p-2">
                <div class="text-lg font-bold text-cyan-400">${space.total} GB</div>
                <div class="text-xs text-slate-500">ทั้งหมด</div>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2">
                <div class="text-lg font-bold text-amber-400">${space.used} GB</div>
                <div class="text-xs text-slate-500">ใช้แล้ว</div>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2">
                <div class="text-lg font-bold text-green-400">${space.free} GB</div>
                <div class="text-xs text-slate-500">ว่าง</div>
              </div>
            </div>
          `;
          if (dataPathEl) {
            dataPathEl.innerHTML = `📁 ไฟล์ข้อมูล: <span class="text-slate-400">${path}</span>`;
          }
        } catch (e) {
          diskSpaceEl.innerHTML = '<div class="text-xs text-slate-500">ไม่สามารถโหลดข้อมูลพื้นที่ได้</div>';
        }
      } else {
        diskSpaceEl.innerHTML = `
          <div class="flex items-center gap-2 p-2 bg-green-500/10 rounded-lg border border-green-500/30">
            <span class="text-green-400 text-lg">♾️</span>
            <div>
              <p class="text-green-400 font-medium">ไม่จำกัดพื้นที่</p>
              <p class="text-xs text-slate-500">ใช้ localStorage ของเบราว์เซอร์</p>
            </div>
          </div>
        `;
      }
    };

    // Auto-save to file (for Electron)
    window.autoSaveToFile = async () => {
      if (window.electronAPI && window.electronAPI.saveData) {
        const backup = { version: '1.2', savedAt: new Date().toISOString() };
        Object.entries(KEYS).forEach(([name, key]) => {
          backup[name] = storage.get(key);
        });
        await window.electronAPI.saveData(backup);
      }
    };

    const renderMainContent = () => {
      if (state.tab === 'home') return renderHome();
      if (state.tab === 'inventory') return renderInventory();
      if (state.tab === 'reports') return renderReports();
      if (state.tab === 'settings') return renderSettings();
      return '';
    };

    const renderHome = () => {
      const ponds = db.ponds.getAll();
      const activePonds = ponds.filter(p => p.status === 'active');
      let totalCost = 0;
      let totalFcrSum = 0;
      let fcrCount = 0;

      // FCR by fish type
      const fcrByFishType = {};

      activePonds.forEach(p => {
        const cycle = db.cycles.getActive(p.id);
        if (cycle) {
          const stats = calculations.getCycleStats(cycle.id);
          if (stats) {
            totalCost += stats.totalCost;
            if (stats.fcr !== '-') {
              const fcrValue = parseFloat(stats.fcr);
              totalFcrSum += fcrValue;
              fcrCount++;

              // Group by fish type
              const fishTypeName = cycle.fishTypeName || 'ไม่ระบุ';
              if (!fcrByFishType[fishTypeName]) {
                fcrByFishType[fishTypeName] = { sum: 0, count: 0 };
              }
              fcrByFishType[fishTypeName].sum += fcrValue;
              fcrByFishType[fishTypeName].count++;
            }
          }
        }
      });

      const avgFcr = fcrCount > 0 ? (totalFcrSum / fcrCount).toFixed(2) : '-';

      // Calculate average FCR for each fish type
      const fishTypeFcrList = Object.entries(fcrByFishType).map(([name, data]) => ({
        name,
        fcr: (data.sum / data.count).toFixed(2),
        count: data.count
      }));

      return `
        <div class="p-4 max-w-lg mx-auto fade-in">
          <header class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-2xl font-bold bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent flex items-center gap-2">
                Fish Farm Pro
              </h1>
              <p class="text-slate-400 text-sm">ระบบจัดการบ่อเลี้ยงปลา</p>
            </div>
          </header>

          <div class="grid grid-cols-4 gap-2 mb-6">
            <div class="bg-slate-800/60 rounded-2xl p-3 border border-slate-700/50 text-center">
              <div class="text-lg">🔲</div>
              <div class="text-lg font-bold">${ponds.length}</div>
              <div class="text-[10px] text-slate-400">บ่อทั้งหมด</div>
            </div>
            <div class="bg-slate-800/60 rounded-2xl p-3 border border-slate-700/50 text-center">
              <div class="text-lg">🟢</div>
              <div class="text-lg font-bold">${activePonds.length}</div>
              <div class="text-[10px] text-slate-400">กำลังเลี้ยง</div>
            </div>
            <div class="bg-slate-800/60 rounded-2xl p-3 border border-slate-700/50 text-center">
              <div class="text-lg">💰</div>
              <div class="text-xs font-bold">${formatCurrency(totalCost)}</div>
              <div class="text-[10px] text-slate-400">ต้นทุนรวม</div>
            </div>
            <div class="bg-slate-800/60 rounded-2xl p-3 border border-slate-700/50 text-center">
              <div class="text-lg">📊</div>
              <div class="text-lg font-bold">${avgFcr}</div>
              <div class="text-[10px] text-slate-400">FCR เฉลี่ย</div>
            </div>
          </div>

          ${fishTypeFcrList.length > 1 ? `
          <!-- FCR by Fish Type -->
          <div class="mb-6">
            <h3 class="text-sm font-medium text-slate-400 mb-2">📊 FCR แยกตามชนิดปลา</h3>
            <div class="grid grid-cols-${Math.min(fishTypeFcrList.length, 3)} gap-2">
              ${fishTypeFcrList.map(ft => {
                const fcrNum = parseFloat(ft.fcr);
                const fcrColor = fcrNum < 1.5 ? 'text-green-400 border-green-500/30' : fcrNum < 2 ? 'text-cyan-400 border-cyan-500/30' : fcrNum < 2.5 ? 'text-amber-400 border-amber-500/30' : 'text-red-400 border-red-500/30';
                return `
                  <div class="bg-slate-800/40 rounded-xl p-3 border ${fcrColor.split(' ')[1]} text-center">
                    <div class="text-xs text-slate-400 mb-1">${ft.name}</div>
                    <div class="text-xl font-bold ${fcrColor.split(' ')[0]}">${ft.fcr}</div>
                    <div class="text-[10px] text-slate-500">${ft.count} บ่อ</div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
          ` : ''}

          <!-- Feed Stock Section -->
          <div class="mb-6">
            ${(() => {
              const feeds = db.feeds.getAll();
              const feedsWithStock = feeds.map(f => ({
                ...f,
                stock: db.feedStock.getStock(f.id)
              })).filter(f => f.stock > 0);

              const showCollapseBtn = feedsWithStock.length > 4;
              const isCollapsed = state.feedStockCollapsed !== undefined ? state.feedStockCollapsed : showCollapseBtn;
              const displayFeeds = isCollapsed ? feedsWithStock.slice(0, 4) : feedsWithStock;
              const hiddenCount = feedsWithStock.length - 4;
              const totalStock = feedsWithStock.reduce((sum, f) => sum + f.stock, 0);

              if (feedsWithStock.length === 0) {
                return `
                  <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-semibold">📦 คลังอาหาร</h2>
                    <button onclick="setState({modal:'addFeedStock'})" class="flex items-center gap-1 px-3 py-1.5 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg text-sm font-medium transition-colors">
                      + เพิ่มสต็อก
                    </button>
                  </div>
                  <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50 text-center">
                    <div class="text-3xl mb-2">📦</div>
                    <p class="text-slate-400 text-sm">ยังไม่มีอาหารในสต็อก</p>
                    <p class="text-slate-500 text-xs mt-1">กดปุ่ม "เพิ่มสต็อก" เพื่อเพิ่มอาหาร</p>
                  </div>
                `;
              }

              return `
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-2">
                    <h2 class="text-lg font-semibold">📦 คลังอาหาร</h2>
                    <span class="text-xs text-slate-500 bg-slate-800/50 px-2 py-0.5 rounded">${feedsWithStock.length} รายการ • ${formatNumber(totalStock, 1)} กก.</span>
                  </div>
                  <div class="flex items-center gap-1">
                    <button onclick="setState({modal:'stockHistory', stockHistoryLimit: 20})" class="p-1.5 bg-slate-700/50 hover:bg-slate-600/50 text-slate-300 rounded-lg text-sm transition-colors" title="ประวัติ">📊</button>
                    <button onclick="setState({modal:'addFeedStock'})" class="px-2 py-1 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg text-xs font-medium transition-colors">+ เพิ่มสต็อก</button>
                  </div>
                </div>
                <div class="grid grid-cols-3 sm:grid-cols-4 gap-2">
                  ${displayFeeds.map(f => {
                    const stockColor = f.stock < 10 ? 'border-red-500/40 bg-red-500/5' : f.stock < 30 ? 'border-amber-500/40 bg-amber-500/5' : 'border-green-500/40 bg-green-500/5';
                    const textColor = f.stock < 10 ? 'text-red-400' : f.stock < 30 ? 'text-amber-400' : 'text-green-400';
                    return `
                      <div onclick="setState({modal:'editFeedStock', editingStockFeedId:'${f.id}'})" class="bg-slate-800/60 rounded-xl p-2 border ${stockColor} hover:bg-slate-700/50 cursor-pointer transition-all relative group">
                        <button onclick="event.stopPropagation(); requestDeleteStock('${f.id}')" class="absolute -top-1 -right-1 w-5 h-5 bg-slate-700 hover:bg-red-500/80 text-slate-400 hover:text-white rounded-full text-[10px] sm:opacity-0 sm:group-hover:opacity-100 transition-all flex items-center justify-center" title="ลบ">✕</button>
                        <div class="flex items-center gap-1.5 mb-1">
                          <span class="text-sm">${f.type === 'fresh' ? '🟠' : '🔵'}</span>
                          <span class="text-xs font-medium text-slate-300 truncate flex-1">${f.name}</span>
                        </div>
                        <div class="flex items-baseline gap-0.5">
                          <span class="text-base font-bold ${textColor}">${formatNumber(f.stock, 1)}</span>
                          <span class="text-[10px] text-slate-500">กก.</span>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
                ${showCollapseBtn ? `
                  <button onclick="setState({feedStockCollapsed: ${!isCollapsed}})" class="w-full mt-2 py-1.5 bg-slate-800/40 hover:bg-slate-700/40 text-slate-400 rounded-lg text-xs transition-colors flex items-center justify-center gap-1">
                    ${isCollapsed ? `▼ ดูเพิ่ม (${hiddenCount} รายการ)` : '▲ ย่อ'}
                  </button>
                ` : ''}
              `;
            })()}
          </div>

          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">🔲 บ่อเลี้ยง</h2>
            <button onclick="setState({modal:'createPond'})" class="flex items-center gap-1.5 px-4 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-xl transition-colors text-sm font-medium">
              + สร้างบ่อ
            </button>
          </div>

          <div class="space-y-3">
            ${ponds.length === 0 ? `
              <div class="text-center py-12 text-slate-400">
                <div class="text-5xl mb-3">🐟</div>
                <p>ยังไม่มีบ่อเลี้ยง</p>
                <p class="text-sm">กดปุ่ม "สร้างบ่อ" เพื่อเริ่มต้น</p>
              </div>
            ` : ponds.map(p => renderPondCard(p)).join('')}
          </div>
        </div>
      `;
    };

    const renderPondCard = (pond) => {
      const cycle = db.cycles.getActive(pond.id);
      const isActive = pond.status === 'active';

      if (!cycle) {
        return `
          <button onclick="setState({selectedPond:'${pond.id}'})" class="w-full bg-slate-800/50 backdrop-blur rounded-2xl p-4 border border-slate-700/50 hover:border-cyan-500/40 hover:bg-slate-800/70 transition-all text-left group">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="w-2.5 h-2.5 rounded-full bg-slate-500"></span>
                  <h3 class="font-semibold text-slate-100">${pond.name}</h3>
                </div>
                <p class="text-sm text-slate-500">ว่าง - พร้อมปล่อยปลา</p>
              </div>
              <span class="text-slate-500 group-hover:text-cyan-400 transition-colors">›</span>
            </div>
          </button>
        `;
      }

      const stats = calculations.getCycleStats(cycle.id);
      const todayLogs = calculations.getTodayLogs(cycle.id);
      const todayFeed = todayLogs.reduce((s, l) => s + l.weightKg, 0);
      const lastLog = db.feedingLogs.getLatest(cycle.id);

      return `
        <button onclick="setState({selectedPond:'${pond.id}'})" class="w-full bg-slate-800/50 backdrop-blur rounded-2xl p-4 border border-slate-700/50 hover:border-cyan-500/40 hover:bg-slate-800/70 transition-all text-left group">
          <div class="flex items-center justify-between">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class="w-2.5 h-2.5 rounded-full flex-shrink-0 bg-green-400 pulse-glow"></span>
                <h3 class="font-semibold text-slate-100 truncate">${pond.name}</h3>
              </div>
              <div class="space-y-1">
                <div class="flex items-center gap-2 text-sm text-slate-300 flex-wrap">
                  <span>${cycle.fishTypeName}</span>
                  <span class="text-slate-500">│</span>
                  <span>วันที่ ${stats.days}</span>
                  <span class="text-slate-500">│</span>
                  <span>${formatNumber(cycle.initialCount)} ตัว</span>
                </div>
                <div class="flex items-center gap-3 text-xs text-slate-400 flex-wrap">
                  <span>🍽️ ${formatNumber(stats.totalFeed, 1)} กก.</span>
                  <span>💰 ${formatCurrency(stats.totalCost)}</span>
                  <span>FCR: ${stats.fcr}</span>
                </div>
                ${lastLog ? `
                  <div class="flex items-center gap-1 text-xs text-cyan-400/70 mt-1">
                    🕐 ล่าสุด: ${lastLog.time} น. (วันนี้ ${todayLogs.length} มื้อ)
                  </div>
                ` : ''}
              </div>
            </div>
            <span class="text-slate-500 group-hover:text-cyan-400 transition-colors">›</span>
          </div>
        </button>
      `;
    };

    const renderPondDetail = () => {
      const pond = db.ponds.getById(state.selectedPond);
      if (!pond) {
        setState({ selectedPond: null });
        return '';
      }

      const cycle = db.cycles.getActive(pond.id);

      if (!cycle) {
        return `
          <div class="fade-in">
            <header class="sticky top-0 bg-slate-900/95 backdrop-blur-xl border-b border-slate-700/50 z-40">
              <div class="flex items-center justify-between p-4 max-w-lg mx-auto">
                <button onclick="setState({selectedPond:null})" class="text-slate-400 hover:text-slate-200">‹ กลับ</button>
                <h1 class="font-semibold">${pond.name}</h1>
                <button onclick="deletePond('${pond.id}')" class="text-red-400 hover:text-red-300 text-sm">ลบบ่อ</button>
              </div>
            </header>
            <div class="p-4 text-center py-16 max-w-lg mx-auto">
              <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-slate-800 flex items-center justify-center text-4xl">🐟</div>
              <h2 class="text-xl font-semibold mb-2">บ่อว่าง</h2>
              <p class="text-slate-400 mb-6">เริ่มรอบการเลี้ยงใหม่</p>
              <button onclick="setState({modal:'startCycle'})" class="px-6 py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">
                🐟 เริ่มปล่อยปลา
              </button>

              ${renderCompletedCycles(pond.id)}
            </div>
          </div>
        `;
      }

      const stats = calculations.getCycleStats(cycle.id);
      const todayLogs = calculations.getTodayLogs(cycle.id);
      const todayFeed = todayLogs.reduce((s, l) => s + l.weightKg, 0);
      const feeds = db.feeds.getAll();
      const supplements = db.supplements.getAll();

      return `
        <div class="fade-in">
          <header class="sticky top-0 bg-slate-900/95 backdrop-blur-xl border-b border-slate-700/50 z-40">
            <div class="flex items-center justify-between p-4 max-w-lg mx-auto">
              <button onclick="setState({selectedPond:null})" class="text-slate-400 hover:text-slate-200">‹ กลับ</button>
              <h1 class="font-semibold truncate max-w-[200px]">${pond.name} - ${cycle.fishTypeName}</h1>
              <div class="w-12"></div>
            </div>
          </header>

          <div class="p-4 max-w-lg mx-auto space-y-4">
            <!-- Days Banner -->
            <div class="bg-gradient-to-r from-cyan-500/20 to-blue-500/20 rounded-2xl p-4 border border-cyan-500/30 text-center">
              <div class="text-4xl font-bold text-cyan-400">${stats.days}</div>
              <div class="text-sm text-slate-300">วันที่เลี้ยง</div>
              <div class="text-xs text-slate-400 mt-1">ปล่อย: ${formatDate(cycle.startDate)}</div>
            </div>

            <!-- Fish Info -->
            <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50">
              <h3 class="font-semibold text-slate-200 mb-3">🐟 ข้อมูลปลา</h3>
              <div class="grid grid-cols-2 gap-2 text-sm">
                <div><span class="text-slate-400">ชนิด:</span> <span class="text-slate-200">${cycle.fishTypeName}</span></div>
                <div><span class="text-slate-400">จำนวนปล่อย:</span> <span class="text-slate-200">${formatNumber(cycle.initialCount)} ตัว</span></div>
                <div><span class="text-slate-400">น้ำหนักเริ่มต้น:</span> <span class="text-slate-200">${formatNumber(cycle.initialWeight || 0, 1)} กรัม/ตัว</span></div>
                <div><span class="text-slate-400">ราคา/ตัว:</span> <span class="text-slate-200">${formatCurrency(cycle.pricePerFish)}</span></div>
              </div>
            </div>

            <!-- Feed Summary -->
            <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50">
              <h3 class="font-semibold text-slate-200 mb-3">🍽️ อาหารสะสม</h3>
              <div class="grid grid-cols-2 gap-2 text-sm">
                <div><span class="text-slate-400">อาหารรวม:</span> <span class="text-slate-200">${formatNumber(stats.totalFeed, 1)} กก.</span></div>
                <div><span class="text-slate-400">ค่าอาหาร:</span> <span class="text-slate-200">${formatCurrency(stats.feedCost)}</span></div>
                <div><span class="text-slate-400">ค่าวิตามิน:</span> <span class="text-slate-200">${formatCurrency(stats.suppCost)}</span></div>
                <div><span class="text-slate-400">วันนี้:</span> <span class="text-cyan-400">${todayLogs.length} มื้อ (${formatNumber(todayFeed, 1)} กก.)</span></div>
              </div>
              ${db.feedingLogs.getLatest(cycle.id) ? `<div class="mt-3 pt-3 border-t border-slate-700/50 text-xs text-slate-400">🕐 ให้อาหารล่าสุด: ${db.feedingLogs.getLatest(cycle.id).time} น.</div>` : ''}
              ${(() => {
                const dailyFeed = calculations.getDailyFeedSummary(cycle.id, 7);
                const chartData = Object.entries(dailyFeed).map(([date, amount]) => ({
                  value: amount,
                  label: date.split('-')[2]
                }));
                if (chartData.length >= 2) {
                  return `
                    <div class="mt-3 pt-3 border-t border-slate-700/50">
                      <div class="text-xs text-slate-400 mb-2">📊 อาหาร 7 วันล่าสุด (กก./วัน)</div>
                      ${createChart(chartData, { color: '#22d3ee', label: 'feed' })}
                    </div>
                  `;
                }
                return '';
              })()}
            </div>

            <!-- Water Quality -->
            ${stats.waterQuality ? `
              <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="font-semibold text-slate-200">💧 คุณภาพน้ำล่าสุด</h3>
                  <span class="text-xs text-slate-400">${stats.waterQuality.time} น.</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <div class="text-center p-2 bg-slate-700/30 rounded-xl">
                    <div class="text-xl font-bold text-orange-400">${stats.waterQuality.temperature || '-'}°C</div>
                    <div class="text-xs text-slate-400">อุณหภูมิ</div>
                  </div>
                  <div class="text-center p-2 bg-slate-700/30 rounded-xl">
                    <div class="text-xl font-bold text-cyan-400">${stats.waterQuality.doLevel || '-'}</div>
                    <div class="text-xs text-slate-400">DO (mg/L)</div>
                  </div>
                  <div class="text-center p-2 bg-slate-700/30 rounded-xl">
                    <div class="text-xl font-bold text-green-400">${stats.waterQuality.ph || '-'}</div>
                    <div class="text-xs text-slate-400">pH</div>
                  </div>
                </div>
                ${(() => {
                  const wqHistory = db.waterQuality.getByCycle(cycle.id).slice(0, 10).reverse();
                  if (wqHistory.length >= 2) {
                    return `
                      <div class="mt-4 pt-3 border-t border-slate-700/50">
                        <div class="text-xs text-slate-400 mb-2">📊 แนวโน้มอุณหภูมิ (${wqHistory.length} รายการ)</div>
                        ${createChart(wqHistory.map(w => ({ value: w.temperature || 0, label: w.date?.split('-')[2] || '' })), { color: '#fb923c', label: 'temp' })}
                      </div>
                    `;
                  }
                  return '';
                })()}
              </div>
            ` : ''}

            <!-- Metrics -->
            <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50">
              <h3 class="font-semibold text-slate-200 mb-3">📈 ตัวชี้วัด</h3>
              <div class="grid grid-cols-2 gap-3 text-sm">
                <div class="bg-slate-700/30 rounded-xl p-3 text-center">
                  <div class="text-xl font-bold text-cyan-400 font-mono">${stats.fcr}</div>
                  <div class="text-xs text-slate-400">FCR</div>
                </div>
                <div class="bg-slate-700/30 rounded-xl p-3 text-center">
                  <div class="text-xl font-bold text-amber-400">${formatCurrency(stats.costPerFish)}</div>
                  <div class="text-xs text-slate-400">ต้นทุน/ตัว</div>
                </div>
                <div class="bg-slate-700/30 rounded-xl p-3 text-center">
                  <div class="text-xl font-bold ${stats.totalMortality > 0 ? 'text-red-400' : 'text-green-400'}">${formatNumber(stats.totalMortality)}</div>
                  <div class="text-xs text-slate-400">ปลาตาย</div>
                </div>
                <div class="bg-slate-700/30 rounded-xl p-3 text-center">
                  <div class="text-xl font-bold text-green-400">${formatNumber(stats.survivingCount)}</div>
                  <div class="text-xs text-slate-400">เหลือ (${stats.survivalRate || '~95'}%)</div>
                </div>
              </div>
              <div class="mt-3 pt-3 border-t border-slate-700/50">
                <div class="flex justify-between text-sm">
                  <span class="text-slate-400">ต้นทุนสะสมทั้งหมด</span>
                  <span class="text-amber-400 font-medium">${formatCurrency(stats.totalCost)}</span>
                </div>
              </div>
            </div>

            <!-- Cost Breakdown -->
            <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50">
              <h3 class="font-semibold text-slate-200 mb-3">💰 รายละเอียดต้นทุน</h3>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between"><span class="text-slate-400">ค่าลูกปลา</span><span>${formatCurrency(stats.fishCost)}</span></div>
                <div class="flex justify-between"><span class="text-slate-400">ค่าอาหาร</span><span>${formatCurrency(stats.feedCost)}</span></div>
                <div class="flex justify-between"><span class="text-slate-400">ค่าวิตามิน</span><span>${formatCurrency(stats.suppCost)}</span></div>
                <div class="flex justify-between"><span class="text-slate-400">ค่าใช้จ่ายอื่น</span><span>${formatCurrency(stats.otherCost)}</span></div>
                <div class="flex justify-between pt-2 border-t border-slate-700/50 font-medium">
                  <span class="text-slate-300">รวมทั้งหมด</span>
                  <span class="text-amber-400">${formatCurrency(stats.totalCost)}</span>
                </div>
              </div>
            </div>

            <!-- Harvest Summary if any -->
            ${stats.harvestData.totalWeight > 0 ? `
              <div class="bg-green-500/10 rounded-2xl p-4 border border-green-500/30">
                <h3 class="font-semibold text-green-400 mb-3">🎣 สรุปการจับปลา</h3>
                <div class="grid grid-cols-2 gap-2 text-sm">
                  <div><span class="text-slate-400">น้ำหนักรวม:</span> <span class="text-slate-200">${formatNumber(stats.harvestData.totalWeight, 1)} กก.</span></div>
                  <div><span class="text-slate-400">จำนวน:</span> <span class="text-slate-200">${formatNumber(stats.harvestData.totalCount)} ตัว</span></div>
                  <div><span class="text-slate-400">รายได้:</span> <span class="text-green-400">${formatCurrency(stats.harvestData.totalRevenue)}</span></div>
                  <div><span class="text-slate-400">กำไร/ขาดทุน:</span> <span class="${stats.profit >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(stats.profit)}</span></div>
                </div>
              </div>
            ` : ''}

            <!-- Today's Logs -->
            ${todayLogs.length > 0 ? `
              <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50">
                <h3 class="font-semibold text-slate-200 mb-3">🕐 บันทึกวันนี้</h3>
                <div class="space-y-2">
                  ${todayLogs.map(log => {
                    const feed = feeds.find(f => f.id === log.feedId);
                    const isMedOnly = log.medicineOnly || false;
                    return `
                      <div class="bg-slate-700/30 rounded-xl p-3 ${isMedOnly ? 'border-l-2 border-rose-500' : ''}">
                        <div class="flex items-center justify-between">
                          <div class="flex items-center gap-2 flex-wrap">
                            <span class="${isMedOnly ? 'text-rose-400' : 'text-cyan-400'} font-mono text-sm">${log.time}</span>
                            ${isMedOnly ? `
                              <span class="text-rose-300">💉 ให้ยาอย่างเดียว</span>
                            ` : `
                              <span class="text-slate-300">${feed?.name || 'อาหาร'}</span>
                              <span class="text-slate-400">${log.weightKg} กก.</span>
                            `}
                          </div>
                          <div class="flex items-center gap-1">
                            ${!isMedOnly ? `<button onclick="editFeedingLog('${log.id}')" class="p-1.5 text-slate-400 hover:text-cyan-400 rounded-lg">✏️</button>` : ''}
                            <button onclick="deleteFeedingLog('${log.id}')" class="p-1.5 text-slate-400 hover:text-red-400 rounded-lg">🗑️</button>
                          </div>
                        </div>
                        ${!isMedOnly && log.supplements?.length > 0 ? `<div class="mt-1 text-xs text-slate-400">💊 ${log.supplements.map(s => supplements.find(sp => sp.id === s.supplementId)?.name).join(', ')}</div>` : ''}
                        ${log.medicines?.length > 0 ? `<div class="mt-1 text-xs text-rose-400">💉 ${log.medicines.map(m => {
                          const med = db.medicines.getById(m.medicineId);
                          return med ? med.name + ' (' + m.amount + ' ' + m.unit + ')' : '';
                        }).filter(Boolean).join(', ')}</div>` : ''}
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : ''}

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 gap-3">
              <button onclick="setState({modal:'feeding'})" class="flex items-center justify-center gap-2 p-4 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-2xl transition-colors font-medium">🍽️ ให้อาหาร</button>
              <button onclick="setState({modal:'waterQuality'})" class="flex items-center justify-center gap-2 p-4 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 rounded-2xl transition-colors font-medium">💧 คุณภาพน้ำ</button>
              <button onclick="setState({modal:'expense'})" class="flex items-center justify-center gap-2 p-4 bg-amber-500/20 hover:bg-amber-500/30 text-amber-400 rounded-2xl transition-colors font-medium">💸 ค่าใช้จ่าย</button>
              <button onclick="setState({modal:'mortality'})" class="flex items-center justify-center gap-2 p-4 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-2xl transition-colors font-medium">💀 ปลาตาย</button>
              <button onclick="setState({modal:'harvest'})" class="flex items-center justify-center gap-2 p-4 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-2xl transition-colors font-medium col-span-2">🎣 จับปลา</button>
            </div>

            <!-- Reset Button -->
            <button onclick="resetPond()" class="w-full p-3 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-xl transition-colors text-sm flex items-center justify-center gap-2">
              🗑️ รีเซ็ตบ่อ (ลบข้อมูลรอบนี้)
            </button>
          </div>
        </div>
      `;
    };

    const renderCompletedCycles = (pondId) => {
      const completed = db.cycles.getCompleted(pondId);
      if (completed.length === 0) return '';

      return `
        <div class="mt-8 text-left">
          <h3 class="font-semibold text-slate-300 mb-3">📋 ประวัติการเลี้ยง</h3>
          <div class="space-y-2">
            ${completed.slice(0, 5).map(c => {
              const stats = calculations.getCycleStats(c.id);
              return `
                <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                  <div class="flex justify-between items-center">
                    <div>
                      <div class="text-sm text-slate-300">${c.fishTypeName}</div>
                      <div class="text-xs text-slate-500">${formatDate(c.startDate)} - ${formatDate(c.endDate)}</div>
                    </div>
                    <div class="text-right">
                      <div class="text-sm ${stats?.profit >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(stats?.profit || 0)}</div>
                      <div class="text-xs text-slate-500">FCR: ${stats?.fcr || '-'}</div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    };

    const renderInventory = () => {
      const feeds = db.feeds.getAll();
      const supplements = db.supplements.getAll();
      const medicines = db.medicines.getAll();
      const fishTypes = db.fishTypes.getAll();

      // Get collapsed state from state or default all expanded
      const collapsed = state.inventoryCollapsed || {};

      const renderSection = (id, icon, title, count, color, addModal, content) => {
        const isCollapsed = collapsed[id];
        return `
          <div class="mb-4">
            <div class="flex items-center justify-between bg-slate-800/60 rounded-xl p-3 border border-slate-700/50 cursor-pointer hover:bg-slate-700/50 transition-colors" onclick="toggleInventorySection('${id}')">
              <div class="flex items-center gap-3">
                <span class="text-xl">${icon}</span>
                <div>
                  <h2 class="font-semibold text-slate-200">${title}</h2>
                  <span class="text-xs text-slate-500">${count} รายการ</span>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="event.stopPropagation(); setState({modal:'${addModal}'})" class="flex items-center gap-1 px-3 py-1.5 ${color} rounded-lg text-sm">+ เพิ่ม</button>
                <span class="text-slate-400 text-lg">${isCollapsed ? '▶' : '▼'}</span>
              </div>
            </div>
            ${!isCollapsed ? `<div class="mt-2 space-y-2">${content}</div>` : ''}
          </div>
        `;
      };

      // Fish Types content
      const fishTypesContent = fishTypes.length === 0
        ? '<p class="text-slate-500 text-sm text-center py-4">ยังไม่มีข้อมูลชนิดปลา</p>'
        : fishTypes.map(ft => `
          <div class="flex items-center justify-between bg-slate-800/40 rounded-xl p-3 border border-slate-700/30">
            <div class="flex-1">
              <div class="flex items-center gap-2">
                <span class="font-medium text-slate-200">${ft.name}</span>
                <span class="px-2 py-0.5 rounded text-xs ${ft.feedType === 'fresh' ? 'bg-orange-500/20 text-orange-400' : 'bg-blue-500/20 text-blue-400'}">${ft.feedType === 'fresh' ? 'อาหารสด' : 'อาหารเม็ด'}</span>
              </div>
              <div class="text-xs text-slate-400 mt-0.5">น้ำหนักเฉลี่ย: ${formatNumber(ft.avgWeight)} กรัม/ตัว</div>
            </div>
            <div class="flex items-center gap-1">
              <button onclick="editFishType('${ft.id}')" class="p-1.5 text-slate-400 hover:text-cyan-400 rounded-lg">✏️</button>
              <button onclick="deleteFishType('${ft.id}')" class="p-1.5 text-slate-400 hover:text-red-400 rounded-lg">🗑️</button>
              ${ft.editHistory?.length > 0 ? `<button onclick="showFishTypeHistory('${ft.id}')" class="p-1.5 text-slate-400 hover:text-amber-400 rounded-lg" title="ดูประวัติ">📜</button>` : ''}
            </div>
          </div>
        `).join('');

      // Feeds content
      const feedsContent = feeds.length === 0
        ? '<p class="text-slate-500 text-sm text-center py-4">ยังไม่มีข้อมูลอาหาร</p>'
        : feeds.map(f => `
          <div class="flex items-center justify-between bg-slate-800/40 rounded-xl p-3 border border-slate-700/30">
            <div>
              <div class="flex items-center gap-2">
                <span class="px-2 py-0.5 rounded text-xs ${f.type === 'fresh' ? 'bg-orange-500/20 text-orange-400' : 'bg-blue-500/20 text-blue-400'}">${f.type === 'fresh' ? 'สด' : 'เม็ด'}</span>
                <span class="font-medium text-slate-200">${f.name}</span>
              </div>
              ${f.type === 'pellet' && (f.brand || f.sizeNumber || f.bagSize) ? `<div class="text-xs text-slate-400 mt-0.5">${f.brand || ''} ${f.sizeNumber ? `เบอร์ ${f.sizeNumber}` : ''} ${f.useBag && f.bagSize ? `(${f.bagSize}กก./กระสอบ)` : ''}</div>` : ''}
            </div>
            <div class="flex items-center gap-2">
              <span class="text-slate-300 text-sm">${formatCurrency(f.pricePerKg)}/กก.</span>
              <button onclick="editFeed('${f.id}')" class="text-slate-400 hover:text-cyan-400" title="แก้ไข">✏️</button>
              ${f.editHistory && f.editHistory.length > 0 ? `<button onclick="viewFeedHistory('${f.id}')" class="text-slate-400 hover:text-amber-400" title="ดูประวัติการแก้ไข">📜</button>` : ''}
              <button onclick="deleteFeed('${f.id}')" class="text-slate-400 hover:text-red-400" title="ลบ">🗑️</button>
            </div>
          </div>
        `).join('');

      // Supplements content
      const supplementsContent = supplements.length === 0
        ? '<p class="text-slate-500 text-sm text-center py-4">ยังไม่มีข้อมูลวิตามิน</p>'
        : supplements.map(s => `
          <div class="flex items-center justify-between bg-slate-800/40 rounded-xl p-3 border border-slate-700/30">
            <div>
              <div class="flex items-center gap-2">
                <span class="font-medium text-slate-200">${s.name}</span>
                <span class="px-2 py-0.5 rounded text-xs ${s.suppType === 'liquid' ? 'bg-blue-500/20 text-blue-400' : 'bg-cyan-500/20 text-cyan-400'}">${s.suppType === 'liquid' ? '💧 น้ำ' : '💊 เม็ด'}</span>
              </div>
              ${s.description ? `<div class="text-xs text-slate-400">${s.description}</div>` : ''}
            </div>
            <div class="flex items-center gap-2">
              <span class="text-slate-300 text-sm">${formatCurrency(s.price)}/${s.packageSize || 100}${s.unit}</span>
              <button onclick="editSupplement('${s.id}')" class="text-slate-400 hover:text-cyan-400" title="แก้ไข">✏️</button>
              ${s.editHistory && s.editHistory.length > 0 ? `<button onclick="viewSupplementHistory('${s.id}')" class="text-slate-400 hover:text-amber-400" title="ดูประวัติการแก้ไข">📜</button>` : ''}
              <button onclick="deleteSupplement('${s.id}')" class="text-slate-400 hover:text-red-400" title="ลบ">🗑️</button>
            </div>
          </div>
        `).join('');

      // Medicines content
      const medicinesContent = medicines.length === 0
        ? '<p class="text-slate-500 text-sm text-center py-4">ยังไม่มีข้อมูลยารักษาโรค</p>'
        : medicines.map(m => `
          <div class="bg-slate-800/40 rounded-xl p-3 border border-slate-700/30">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                <span class="font-medium text-slate-200">${m.name}</span>
                <span class="px-2 py-0.5 rounded text-xs ${m.medType === 'liquid' ? 'bg-blue-500/20 text-blue-400' : 'bg-rose-500/20 text-rose-400'}">${m.medType === 'liquid' ? '💧 น้ำ' : '💊 เม็ด/ผง'}</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-slate-300 text-sm">${formatCurrency(m.price)}/${m.packageSize || 100}${m.unit}</span>
                <button onclick="editMedicine('${m.id}')" class="text-slate-400 hover:text-rose-400" title="แก้ไข">✏️</button>
                ${m.editHistory && m.editHistory.length > 0 ? `<button onclick="viewMedicineHistory('${m.id}')" class="text-slate-400 hover:text-amber-400" title="ดูประวัติการแก้ไข">📜</button>` : ''}
                <button onclick="deleteMedicine('${m.id}')" class="text-slate-400 hover:text-red-400" title="ลบ">🗑️</button>
              </div>
            </div>
            ${m.description ? `<div class="text-xs text-slate-400 mb-1">${m.description}</div>` : ''}
            <div class="text-xs text-rose-300 bg-rose-500/10 rounded-lg p-2 mt-2">
              <span class="text-rose-400 font-medium">📋 วิธีใช้:</span> ${m.usageDetails}
            </div>
          </div>
        `).join('');

      const totalItems = fishTypes.length + feeds.length + supplements.length + medicines.length;

      return `
        <div class="p-4 max-w-lg mx-auto fade-in">
          <div class="flex items-center justify-between mb-4">
            <h1 class="text-xl font-bold">📦 คลังข้อมูล</h1>
            <span class="text-xs text-slate-500 bg-slate-800/50 px-2 py-1 rounded-lg">${totalItems} รายการ</span>
          </div>

          <!-- Quick Search -->
          <div class="mb-4">
            <input type="text" id="inventorySearch" placeholder="🔍 ค้นหา..." oninput="filterInventory(this.value)" class="w-full bg-slate-800/50 border border-slate-700/50 rounded-xl px-4 py-2.5 text-slate-100 placeholder-slate-500 text-sm">
          </div>

          <div id="inventorySections">
            ${renderSection('fishTypes', '🐟', 'ชนิดปลา', fishTypes.length, 'bg-cyan-500/20 text-cyan-400', 'addFishType', fishTypesContent)}
            ${renderSection('feeds', '🥫', 'อาหาร', feeds.length, 'bg-cyan-500/20 text-cyan-400', 'addFeed', feedsContent)}
            ${renderSection('supplements', '💊', 'วิตามิน/อาหารเสริม', supplements.length, 'bg-cyan-500/20 text-cyan-400', 'addSupplement', supplementsContent)}
            ${renderSection('medicines', '💉', 'ยารักษาโรค', medicines.length, 'bg-rose-500/20 text-rose-400', 'addMedicine', medicinesContent)}
          </div>

          <!-- Collapse/Expand All -->
          <div class="flex gap-2 mt-4">
            <button onclick="collapseAllInventory()" class="flex-1 py-2 bg-slate-800/50 hover:bg-slate-700/50 text-slate-400 rounded-xl text-sm transition-colors">▶ ย่อทั้งหมด</button>
            <button onclick="expandAllInventory()" class="flex-1 py-2 bg-slate-800/50 hover:bg-slate-700/50 text-slate-400 rounded-xl text-sm transition-colors">▼ ขยายทั้งหมด</button>
          </div>
        </div>
      `;
    };

    const renderReports = () => {
      const ponds = db.ponds.getAll();
      const activePonds = ponds.filter(p => p.status === 'active');

      return `
        <div class="p-4 max-w-lg mx-auto fade-in">
          <h1 class="text-xl font-bold mb-6">📊 รายงาน</h1>

          <div class="flex gap-3 mb-6">
            <button onclick="exportReport('text')" class="flex-1 flex items-center justify-center gap-2 p-3 bg-slate-800/50 hover:bg-slate-700/50 rounded-xl border border-slate-700/50 transition-colors">
              📄 Export Text
            </button>
            <button onclick="exportReport('json')" class="flex-1 flex items-center justify-center gap-2 p-3 bg-slate-800/50 hover:bg-slate-700/50 rounded-xl border border-slate-700/50 transition-colors">
              📑 Backup JSON
            </button>
          </div>

          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-2">นำเข้าข้อมูล (Restore)</label>
            <input type="file" id="importFile" accept=".json" onchange="importData(event)" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100 file:mr-4 file:py-1 file:px-3 file:rounded-lg file:border-0 file:bg-cyan-500/20 file:text-cyan-400">
          </div>

          ${activePonds.length > 0 ? `
            <div class="space-y-4">
              <h2 class="font-semibold text-slate-200">📈 สรุปบ่อที่กำลังเลี้ยง</h2>
              ${activePonds.map(p => {
                const cycle = db.cycles.getActive(p.id);
                const stats = calculations.getCycleStats(cycle.id);
                const startDate = new Date(cycle.startDate);
                const today = new Date();
                const endDateStr = today.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
                const startDateStr = startDate.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
                return `
                  <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                    <div class="flex items-center justify-between mb-2">
                      <h3 class="font-medium text-cyan-400">${p.name}</h3>
                      <span class="text-xs text-slate-400 bg-slate-700/50 px-2 py-1 rounded">${stats.days} วัน</span>
                    </div>
                    <div class="text-xs text-slate-500 mb-3 flex items-center gap-1">
                      📅 ${startDateStr} - ${endDateStr}
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                      <div><span class="text-slate-400">ชนิด:</span> ${cycle.fishTypeName}</div>
                      <div><span class="text-slate-400">จำนวน:</span> ${formatNumber(cycle.initialCount)} ตัว</div>
                      <div><span class="text-slate-400">อาหารรวม:</span> ${formatNumber(stats.totalFeed, 1)} กก.</div>
                      <div><span class="text-slate-400">FCR:</span> ${stats.fcr}</div>
                      <div><span class="text-slate-400">ต้นทุน/ตัว:</span> <span class="text-amber-400">${formatCurrency(stats.costPerFish)}</span></div>
                      <div><span class="text-slate-400">ต้นทุนรวม:</span> <span class="text-amber-400">${formatCurrency(stats.totalCost)}</span></div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          ` : `
            <div class="text-center py-8 text-slate-400">
              <div class="text-4xl mb-3">📊</div>
              <p>ไม่มีบ่อที่กำลังเลี้ยง</p>
            </div>
          `}
        </div>
      `;
    };

    const renderSettings = () => {
      const storageUsage = storage.getStorageUsage();
      const ponds = db.ponds.getAll();
      const feeds = db.feeds.getAll();
      const supplements = db.supplements.getAll();
      const medicines = db.medicines.getAll();
      const fishTypes = db.fishTypes.getAll();
      const cycles = storage.get(KEYS.CYCLES);
      const feedingLogs = storage.get(KEYS.FEEDING_LOGS);
      const waterQuality = storage.get(KEYS.WATER_QUALITY);
      const expenses = storage.get(KEYS.EXPENSES);
      const harvests = storage.get(KEYS.HARVESTS);

      return `
        <div class="p-4 max-w-lg mx-auto fade-in">
          <h1 class="text-xl font-bold mb-6">⚙️ ตั้งค่า</h1>

          <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50 mb-4">
            <h3 class="font-semibold mb-3">เกี่ยวกับแอป</h3>
            <div class="text-sm text-slate-400 space-y-1">
              <p>🐟 Fish Farm Pro v1.2</p>
              <p>ระบบจัดการบ่อเลี้ยงปลา</p>
            </div>
          </div>

          <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50 mb-4">
            <h3 class="font-semibold mb-3">🎨 ธีมสี</h3>
            <div class="flex gap-3">
              <button onclick="setTheme('dark')" id="btnThemeDark" class="flex-1 p-3 rounded-xl border ${getCurrentTheme() === 'dark' ? 'bg-slate-700/50 border-cyan-500/50 text-cyan-400' : 'bg-slate-700/30 border-slate-600 text-slate-400'} transition-colors text-sm">
                🌙 มืด (Dark)
              </button>
              <button onclick="setTheme('pastel')" id="btnThemePastel" class="flex-1 p-3 rounded-xl border ${getCurrentTheme() === 'pastel' ? 'bg-cyan-500/20 border-cyan-500/50 text-cyan-400' : 'bg-slate-700/30 border-slate-600 text-slate-400'} transition-colors text-sm">
                🌸 พาสเทล (Pastel)
              </button>
            </div>
          </div>

          <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50 mb-4">
            <h3 class="font-semibold mb-3">📊 ข้อมูลทั้งหมด</h3>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div class="bg-slate-700/30 rounded-lg p-2 flex justify-between">
                <span class="text-slate-400">🔲 บ่อเลี้ยง</span>
                <span class="text-cyan-400 font-medium">${ponds.length}</span>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2 flex justify-between">
                <span class="text-slate-400">🐟 ชนิดปลา</span>
                <span class="text-cyan-400 font-medium">${fishTypes.length}</span>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2 flex justify-between">
                <span class="text-slate-400">🥫 อาหาร</span>
                <span class="text-cyan-400 font-medium">${feeds.length}</span>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2 flex justify-between">
                <span class="text-slate-400">💊 วิตามิน</span>
                <span class="text-cyan-400 font-medium">${supplements.length}</span>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2 flex justify-between">
                <span class="text-slate-400">💉 ยารักษาโรค</span>
                <span class="text-cyan-400 font-medium">${medicines.length}</span>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2 flex justify-between">
                <span class="text-slate-400">🔄 รอบการเลี้ยง</span>
                <span class="text-cyan-400 font-medium">${cycles.length}</span>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2 flex justify-between">
                <span class="text-slate-400">🍽️ บันทึกอาหาร</span>
                <span class="text-cyan-400 font-medium">${feedingLogs.length}</span>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2 flex justify-between">
                <span class="text-slate-400">💧 บันทึกน้ำ</span>
                <span class="text-cyan-400 font-medium">${waterQuality.length}</span>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2 flex justify-between">
                <span class="text-slate-400">💰 ค่าใช้จ่าย</span>
                <span class="text-cyan-400 font-medium">${expenses.length}</span>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2 flex justify-between col-span-2">
                <span class="text-slate-400">🎣 บันทึกจับปลา</span>
                <span class="text-cyan-400 font-medium">${harvests.length}</span>
              </div>
            </div>
          </div>

          <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50 mb-4">
            <h3 class="font-semibold mb-3">💾 พื้นที่เก็บข้อมูล</h3>
            <div class="text-sm text-slate-400">
              <div class="flex items-center justify-between mb-2">
                <span>ข้อมูลแอปใช้:</span>
                <span class="text-cyan-400 font-medium">${storageUsage} KB</span>
              </div>
              <div id="diskSpaceInfo" class="mt-2">
                <div class="text-xs text-slate-500">กำลังโหลดข้อมูลพื้นที่...</div>
              </div>
              <div class="mt-3 text-xs text-slate-500" id="dataPathInfo"></div>
            </div>
          </div>

          <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50 mb-4">
            <h3 class="font-semibold mb-3">☁️ Firebase Cloud Sync</h3>
            <p class="text-sm text-slate-400 mb-3">Sync ข้อมูลข้ามอุปกรณ์อัตโนมัติ</p>

            ${isLocalOnly() ? `
              <!-- Offline Mode -->
              <div class="flex items-center gap-3 p-4 bg-slate-700/30 border border-slate-600 rounded-xl mb-4">
                <div class="w-12 h-12 rounded-full bg-slate-600/50 flex items-center justify-center text-2xl">📴</div>
                <div class="flex-1">
                  <div class="font-medium text-slate-300">โหมด Offline</div>
                  <div class="text-xs text-slate-500">ข้อมูลเก็บในเครื่องเท่านั้น</div>
                </div>
              </div>
              <button onclick="showFirebaseSetupWizard()" class="w-full p-4 bg-gradient-to-r from-cyan-500/20 to-blue-500/20 hover:from-cyan-500/30 hover:to-blue-500/30 border border-cyan-500/30 text-cyan-400 rounded-xl transition-all text-sm font-medium flex items-center justify-center gap-2">
                <span class="text-xl">☁️</span>
                <span>เปิดใช้งาน Cloud Sync</span>
              </button>
            ` : `
              <!-- Online Mode -->
              <div class="flex items-center gap-3 p-4 ${isOnline ? 'bg-green-500/10 border-green-500/30' : 'bg-amber-500/10 border-amber-500/30'} border rounded-xl mb-4">
                <div class="w-12 h-12 rounded-full ${isOnline ? 'bg-green-500/20' : 'bg-amber-500/20'} flex items-center justify-center text-2xl">
                  ${isOnline ? '✅' : '⏳'}
                </div>
                <div class="flex-1">
                  <div class="font-medium ${isOnline ? 'text-green-400' : 'text-amber-400'}">
                    ${isOnline ? 'เชื่อมต่อแล้ว' : 'กำลังเชื่อมต่อ...'}
                  </div>
                  <div class="text-xs ${isOnline ? 'text-green-500/70' : 'text-amber-500/70'}">
                    ${isOnline ? 'ข้อมูลจะ sync อัตโนมัติ' : 'รอสัญญาณ...'}
                  </div>
                </div>
                <div class="text-2xl ${isOnline ? '' : 'animate-pulse'}">
                  ${isOnline ? '🟢' : '🟡'}
                </div>
              </div>

              <!-- Sync Actions -->
              <div class="grid grid-cols-2 gap-2 mb-4">
                <button onclick="manualSyncUpload()" class="p-3 bg-blue-500/10 hover:bg-blue-500/20 border border-blue-500/30 text-blue-400 rounded-xl transition-colors text-sm flex flex-col items-center gap-1" ${!isOnline ? 'disabled' : ''}>
                  <span class="text-xl">📤</span>
                  <span>อัพโหลดขึ้น Cloud</span>
                </button>
                <button onclick="manualSyncDownload()" class="p-3 bg-purple-500/10 hover:bg-purple-500/20 border border-purple-500/30 text-purple-400 rounded-xl transition-colors text-sm flex flex-col items-center gap-1" ${!isOnline ? 'disabled' : ''}>
                  <span class="text-xl">📥</span>
                  <span>ดาวน์โหลดจาก Cloud</span>
                </button>
              </div>

              <!-- Firebase Info -->
              <div class="bg-slate-700/30 rounded-xl p-3 mb-4">
                <div class="text-xs text-slate-500 mb-1">Project ID</div>
                <div class="text-sm text-slate-300 font-mono truncate">${getFirebaseConfig()?.projectId || '-'}</div>
              </div>

              <!-- Reset Button -->
              <button onclick="confirmResetFirebase()" class="w-full p-3 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 text-red-400 rounded-xl transition-colors text-sm flex items-center justify-center gap-2">
                <span>🔄</span>
                <span>รีเซ็ตการตั้งค่า Firebase</span>
              </button>
            `}
          </div>

          <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50 mb-4">
            <h3 class="font-semibold mb-3">🔐 รหัสผ่านลบ Stock</h3>
            <p class="text-sm text-slate-400 mb-3">ใช้รหัสผ่านป้องกันการลบ Stock อาหารโดยไม่ตั้งใจ</p>
            ${db.stockPassword.isEnabled() ? `
              <div class="flex items-center justify-between p-3 bg-green-500/10 border border-green-500/30 rounded-xl mb-3">
                <span class="text-green-400 text-sm">✅ เปิดใช้งานอยู่</span>
              </div>
              <button onclick="setState({modal:'stockPasswordManage'})" class="w-full p-3 bg-cyan-500/10 hover:bg-cyan-500/20 text-cyan-400 rounded-xl transition-colors text-sm">
                ⚙️ จัดการรหัสผ่าน
              </button>
            ` : `
              <div class="flex items-center justify-between p-3 bg-slate-700/30 border border-slate-600 rounded-xl mb-3">
                <span class="text-slate-400 text-sm">❌ ยังไม่ได้เปิดใช้งาน</span>
              </div>
              <button onclick="setState({modal:'stockPasswordManage'})" class="w-full p-3 bg-cyan-500/10 hover:bg-cyan-500/20 text-cyan-400 rounded-xl transition-colors text-sm">
                🔐 ตั้งค่ารหัสผ่าน
              </button>
            `}
          </div>

          <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50 mb-4">
            <h3 class="font-semibold mb-3">📤 ส่งออกข้อมูล (Export)</h3>
            <p class="text-sm text-slate-400 mb-3">ดาวน์โหลดข้อมูลเป็นไฟล์</p>
            <div class="space-y-2">
              <button onclick="exportFeedingData()" class="w-full p-3 bg-orange-500/10 hover:bg-orange-500/20 text-orange-400 rounded-xl transition-colors text-sm flex items-center justify-center gap-2">
                <span>🍽️</span>
                <span>ส่งออกข้อมูลการให้อาหาร</span>
              </button>
              <button onclick="exportStockData()" class="w-full p-3 bg-green-500/10 hover:bg-green-500/20 text-green-400 rounded-xl transition-colors text-sm flex items-center justify-center gap-2">
                <span>📦</span>
                <span>ส่งออกข้อมูลคลังอาหาร</span>
              </button>
              <button onclick="exportAllDataCSV()" class="w-full p-3 bg-cyan-500/10 hover:bg-cyan-500/20 text-cyan-400 rounded-xl transition-colors text-sm flex items-center justify-center gap-2">
                <span>📊</span>
                <span>ส่งออกข้อมูลทั้งหมด (CSV)</span>
              </button>
              <button onclick="exportAllDataJSON()" class="w-full p-3 bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 rounded-xl transition-colors text-sm flex items-center justify-center gap-2">
                <span>💾</span>
                <span>สำรองข้อมูลทั้งหมด (JSON)</span>
              </button>
            </div>
          </div>

          <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50">
            <h3 class="font-semibold mb-3">จัดการข้อมูล</h3>
            <button onclick="clearAllData()" class="w-full p-3 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-xl transition-colors text-sm">
              🗑️ ล้างข้อมูลทั้งหมด
            </button>
          </div>
        </div>
      `;
    };

    const renderBottomNav = () => {
      const tabs = [
        { id: 'home', icon: '🏠', label: 'บ่อเลี้ยง' },
        { id: 'inventory', icon: '📦', label: 'คลัง' },
        { id: 'reports', icon: '📊', label: 'รายงาน' },
        { id: 'settings', icon: '⚙️', label: 'ตั้งค่า' }
      ];

      return `
        <nav class="fixed bottom-0 left-0 right-0 bg-slate-800/95 backdrop-blur-xl border-t border-slate-700/50 z-50">
          <div class="max-w-lg mx-auto flex justify-around py-2">
            ${tabs.map(t => `
              <button onclick="setState({tab:'${t.id}'})" class="flex flex-col items-center py-2 px-5 rounded-xl transition-all ${state.tab === t.id ? 'text-cyan-400 bg-cyan-500/10' : 'text-slate-400'}">
                <span class="text-xl">${t.icon}</span>
                <span class="text-xs mt-1">${t.label}</span>
              </button>
            `).join('')}
          </div>
        </nav>
      `;
    };

    const renderModal = () => {
      const modals = {
        createPond: renderCreatePondModal,
        startCycle: renderStartCycleModal,
        feeding: renderFeedingModal,
        waterQuality: renderWaterQualityModal,
        expense: renderExpenseModal,
        harvest: renderHarvestModal,
        addFeed: renderAddFeedModal,
        addSupplement: renderAddSupplementModal,
        addMedicine: renderAddMedicineModal,
        editFeeding: renderEditFeedingModal,
        addFishType: renderAddFishTypeModal,
        editFishType: renderEditFishTypeModal,
        fishTypeHistory: renderFishTypeHistoryModal,
        editFeed: renderEditFeedModal,
        feedHistory: renderFeedHistoryModal,
        editSupplement: renderEditSupplementModal,
        supplementHistory: renderSupplementHistoryModal,
        editMedicine: renderEditMedicineModal,
        medicineHistory: renderMedicineHistoryModal,
        mortality: renderMortalityModal,
        addFeedStock: renderAddFeedStockModal,
        editFeedStock: renderEditFeedStockModal,
        stockHistory: renderStockHistoryModal,
        stockPasswordConfirm: renderStockPasswordConfirmModal,
        stockPasswordManage: renderStockPasswordManageModal
      };

      const modalFn = modals[state.modal];
      if (!modalFn) return '';

      return `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-4" onclick="if(event.target===this)setState({modal:null})">
          <div class="bg-slate-800 rounded-t-3xl sm:rounded-2xl w-full max-w-md max-h-[85vh] overflow-hidden flex flex-col slide-up" onclick="event.stopPropagation()">
            ${modalFn()}
          </div>
        </div>
      `;
    };

    const renderModalHeader = (title) => `
      <div class="flex items-center justify-between p-4 border-b border-slate-700/50 flex-shrink-0">
        <h2 class="text-lg font-semibold">${title}</h2>
        <button onclick="setState({modal:null})" class="p-2 hover:bg-slate-700 rounded-lg transition-colors">✕</button>
      </div>
    `;

    const renderCreatePondModal = () => `
      ${renderModalHeader('🔲 สร้างบ่อใหม่')}
      <div class="p-4 overflow-y-auto">
        <form onsubmit="createPond(event)">
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">ชื่อบ่อ <span class="text-red-400">*</span></label>
            <input type="text" name="name" placeholder="เช่น บ่อ A" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100 placeholder-slate-500 focus:outline-none focus:border-cyan-500 transition-colors">
          </div>
          <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">สร้างบ่อ</button>
        </form>
      </div>
    `;

    const renderStartCycleModal = () => {
      const fishTypes = db.fishTypes.getAll();
      return `
        ${renderModalHeader('🐟 เริ่มปล่อยปลา')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="startCycle(event)">
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">ชนิดปลา <span class="text-red-400">*</span></label>
              <select name="fishType" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
                ${fishTypes.map(f => `<option value="${f.id}">${f.name}</option>`).join('')}
              </select>
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">วันที่ปล่อย <span class="text-red-400">*</span></label>
              <input type="date" name="startDate" value="${new Date().toISOString().split('T')[0]}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">จำนวน (ตัว) <span class="text-red-400">*</span></label>
              <input type="number" name="count" placeholder="5000" min="1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">น้ำหนักเริ่มต้น (กรัม/ตัว) <span class="text-red-400">*</span></label>
              <input type="number" step="0.1" name="initialWeight" placeholder="5" min="0.1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">ราคา/ตัว (บาท) <span class="text-red-400">*</span></label>
              <input type="number" step="0.01" name="price" placeholder="0.60" min="0.01" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">เริ่มรอบการเลี้ยง</button>
          </form>
        </div>
      `;
    };

    const renderFeedingModal = () => {
      const pond = db.ponds.getById(state.selectedPond);
      const cycle = db.cycles.getActive(pond?.id);
      if (!cycle) return '';

      const fishType = db.fishTypes.getById(cycle.fishType);
      const defaultFeedType = fishType?.feedType || 'pellet';
      // Only show feeds with stock > 0
      const allFeeds = db.feeds.getAll().map(f => ({
        ...f,
        stock: db.feedStock.getStock(f.id)
      }));
      const pelletFeeds = allFeeds.filter(f => f.type === 'pellet' && f.stock > 0);
      const freshFeeds = allFeeds.filter(f => f.type === 'fresh' && f.stock > 0);
      const supplements = db.supplements.getAll();
      const medicines = db.medicines.getAll();

      return `
        ${renderModalHeader('🍽️ บันทึกให้อาหาร')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="addFeeding(event)">
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">เวลา</label>
              <input type="time" name="time" value="${new Date().toTimeString().slice(0,5)}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>

            ${medicines.length > 0 ? `
            <!-- Medicine Only Toggle -->
            <div class="mb-4 p-3 bg-rose-500/10 border border-rose-500/30 rounded-xl">
              <label class="flex items-center gap-3 cursor-pointer">
                <input type="checkbox" name="medicineOnly" id="medicineOnlyToggle" class="w-5 h-5 rounded bg-slate-600 accent-rose-500" onchange="toggleMedicineOnlyMode(this.checked)">
                <span class="text-rose-300 font-medium">💉 ให้ยาอย่างเดียว (ไม่ให้อาหาร)</span>
              </label>
            </div>
            ` : ''}

            <!-- Feed Section (hidden when medicine-only) -->
            <div id="feedSection">
              <!-- Feed Type Tabs -->
              <div class="mb-4">
                <label class="block text-sm text-slate-400 mb-2">ประเภทอาหาร</label>
                <div class="flex gap-2 mb-3">
                  <button type="button" id="tabPellet" onclick="switchFeedTab('pellet')" class="flex-1 p-2 rounded-xl border ${defaultFeedType === 'pellet' ? 'bg-blue-500/20 border-blue-500/50 text-blue-400' : 'bg-slate-700/50 border-slate-600 text-slate-400'} transition-colors text-sm">
                    🔵 อาหารเม็ด
                  </button>
                  <button type="button" id="tabFresh" onclick="switchFeedTab('fresh')" class="flex-1 p-2 rounded-xl border ${defaultFeedType === 'fresh' ? 'bg-orange-500/20 border-orange-500/50 text-orange-400' : 'bg-slate-700/50 border-slate-600 text-slate-400'} transition-colors text-sm">
                    🟠 อาหารสด
                  </button>
                </div>
                <input type="hidden" name="feedType" value="${defaultFeedType}">

              <!-- Pellet Feeds -->
              <div id="pelletFeeds" class="${defaultFeedType === 'pellet' ? '' : 'hidden'}">
                ${pelletFeeds.length > 0 ? `
                  <div class="space-y-2 max-h-32 overflow-y-auto">
                    ${pelletFeeds.map((f, i) => `
                      <label class="flex items-center gap-3 bg-slate-700/30 rounded-xl p-3 cursor-pointer hover:bg-slate-700/50">
                        <input type="radio" name="feedId" value="${f.id}" ${i === 0 && defaultFeedType === 'pellet' ? 'checked' : ''} class="w-4 h-4 accent-cyan-500">
                        <div class="flex-1">
                          <span class="text-slate-200">${f.name} ${f.brand ? `(${f.brand})` : ''}</span>
                          <div class="text-xs ${f.stock < 10 ? 'text-red-400' : f.stock < 30 ? 'text-amber-400' : 'text-green-400'}">สต็อก: ${formatNumber(f.stock, 1)} กก.</div>
                        </div>
                        <span class="text-xs text-slate-400">${formatCurrency(f.pricePerKg)}/กก.</span>
                      </label>
                    `).join('')}
                  </div>
                ` : '<p class="text-amber-500 text-sm text-center py-2">⚠️ ไม่มีอาหารเม็ดในสต็อก</p>'}
              </div>

              <!-- Fresh Feeds -->
              <div id="freshFeeds" class="${defaultFeedType === 'fresh' ? '' : 'hidden'}">
                ${freshFeeds.length > 0 ? `
                  <div class="space-y-2 max-h-32 overflow-y-auto">
                    ${freshFeeds.map((f, i) => `
                      <label class="flex items-center gap-3 bg-slate-700/30 rounded-xl p-3 cursor-pointer hover:bg-slate-700/50">
                        <input type="radio" name="feedId" value="${f.id}" ${i === 0 && defaultFeedType === 'fresh' ? 'checked' : ''} class="w-4 h-4 accent-cyan-500">
                        <div class="flex-1">
                          <span class="text-slate-200">${f.name}</span>
                          <div class="text-xs ${f.stock < 10 ? 'text-red-400' : f.stock < 30 ? 'text-amber-400' : 'text-green-400'}">สต็อก: ${formatNumber(f.stock, 1)} กก.</div>
                        </div>
                        <span class="text-xs text-slate-400">${formatCurrency(f.pricePerKg)}/กก.</span>
                      </label>
                    `).join('')}
                  </div>
                ` : '<p class="text-amber-500 text-sm text-center py-2">⚠️ ไม่มีอาหารสดในสต็อก</p>'}
              </div>
              </div>

              <div class="mb-4" id="feedWeightDiv">
                <label class="block text-sm text-slate-400 mb-1">น้ำหนัก (กก.) <span class="text-red-400">*</span></label>
                <input type="number" step="0.1" name="weight" id="feedWeight" placeholder="15" min="0.1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
              </div>
            </div>

            <!-- Supplements Section -->
            ${supplements.length > 0 ? `
              <div class="mb-4">
                <label class="block text-sm text-slate-400 mb-2">💊 วิตามิน/อาหารเสริม (เลือกได้หลายรายการ)</label>
                <div class="space-y-2 max-h-40 overflow-y-auto">
                  ${supplements.map(s => `
                    <div class="flex items-center gap-3 bg-slate-700/30 rounded-xl p-3">
                      <input type="checkbox" name="supp_${s.id}" id="supp_${s.id}" class="w-5 h-5 rounded bg-slate-600 accent-cyan-500" onchange="toggleSuppInput('${s.id}')">
                      <label for="supp_${s.id}" class="flex-1 text-slate-200 cursor-pointer">
                        ${s.name}
                        <span class="text-xs ${s.suppType === 'liquid' ? 'text-blue-400' : 'text-cyan-400'}">${s.suppType === 'liquid' ? '💧' : '💊'}</span>
                      </label>
                      <input type="number" id="suppAmt_${s.id}" name="suppAmt_${s.id}" value="10" min="1" disabled class="w-16 bg-slate-600 rounded-lg px-2 py-1 text-sm disabled:opacity-50">
                      <span class="text-xs text-slate-400 w-8">${s.unit}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            <!-- Medicines Section -->
            ${medicines.length > 0 ? `
              <div class="mb-4">
                <label class="block text-sm text-slate-400 mb-2">💉 ยารักษาโรค (เลือกได้หลายรายการ)</label>
                <div class="space-y-2 max-h-40 overflow-y-auto">
                  ${medicines.map(m => `
                    <div class="bg-slate-700/30 rounded-xl p-3">
                      <div class="flex items-center gap-3">
                        <input type="checkbox" name="med_${m.id}" id="med_${m.id}" class="w-5 h-5 rounded bg-slate-600 accent-rose-500" onchange="toggleMedInput('${m.id}')">
                        <label for="med_${m.id}" class="flex-1 text-slate-200 cursor-pointer">
                          ${m.name}
                          <span class="text-xs ${m.medType === 'liquid' ? 'text-blue-400' : 'text-rose-400'}">${m.medType === 'liquid' ? '💧' : '💊'}</span>
                        </label>
                        <input type="number" id="medAmt_${m.id}" name="medAmt_${m.id}" value="10" min="1" disabled class="w-16 bg-slate-600 rounded-lg px-2 py-1 text-sm disabled:opacity-50">
                        <span class="text-xs text-slate-400 w-8">${m.unit}</span>
                      </div>
                      <div class="text-xs text-rose-300/70 mt-1 pl-8">📋 ${m.usageDetails}</div>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">หมายเหตุ</label>
              <input type="text" name="notes" placeholder="บันทึกเพิ่มเติม" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <button type="submit" id="feedingSubmitBtn" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">+ เพิ่มมื้ออาหาร</button>
          </form>
        </div>
      `;
    };

    const renderEditFeedingModal = () => {
      const log = state.editingLog;
      if (!log) return '';
      const feeds = db.feeds.getAll();

      return `
        ${renderModalHeader('✏️ แก้ไขมื้ออาหาร')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="updateFeeding(event, '${log.id}')">
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">เวลา</label>
              <input type="time" name="time" value="${log.time}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">เลือกอาหาร</label>
              <select name="feedId" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
                ${feeds.map(f => `<option value="${f.id}" ${f.id === log.feedId ? 'selected' : ''}>${f.name}</option>`).join('')}
              </select>
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">น้ำหนัก (กก.)</label>
              <input type="number" step="0.1" name="weight" value="${log.weightKg}" min="0.1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">💾 บันทึกการแก้ไข</button>
          </form>
        </div>
      `;
    };

    const renderWaterQualityModal = () => `
      ${renderModalHeader('💧 บันทึกคุณภาพน้ำ')}
      <div class="p-4 overflow-y-auto">
        <form onsubmit="addWaterQuality(event)">
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">เวลา</label>
            <input type="time" name="time" value="${new Date().toTimeString().slice(0,5)}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="grid grid-cols-3 gap-3 mb-4">
            <div>
              <label class="block text-sm text-slate-400 mb-1">Temp (°C)</label>
              <input type="number" step="0.1" name="temp" placeholder="28.5" min="0" max="50" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div>
              <label class="block text-sm text-slate-400 mb-1">DO (mg/L)</label>
              <input type="number" step="0.1" name="do" placeholder="5.2" min="0" max="20" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div>
              <label class="block text-sm text-slate-400 mb-1">pH</label>
              <input type="number" step="0.1" name="ph" placeholder="7.8" min="0" max="14" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">หมายเหตุ</label>
            <input type="text" name="notes" placeholder="บันทึกเพิ่มเติม" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">💾 บันทึก</button>
        </form>
      </div>
    `;

    const renderExpenseModal = () => `
      ${renderModalHeader('💸 เพิ่มค่าใช้จ่าย')}
      <div class="p-4 overflow-y-auto">
        <form onsubmit="addExpense(event)">
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">วันที่</label>
            <input type="date" name="date" value="${new Date().toISOString().split('T')[0]}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">หมวดหมู่</label>
            <select name="category" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
              ${EXPENSE_CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('')}
            </select>
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">รายละเอียด <span class="text-red-400">*</span></label>
            <input type="text" name="description" placeholder="อธิบายค่าใช้จ่าย" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">จำนวนเงิน (บาท) <span class="text-red-400">*</span></label>
            <input type="number" name="amount" placeholder="500" min="1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">+ เพิ่มค่าใช้จ่าย</button>
        </form>
      </div>
    `;

    const renderHarvestModal = () => {
      const pond = db.ponds.getById(state.selectedPond);
      const cycle = db.cycles.getActive(pond?.id);
      const fishType = cycle ? db.fishTypes.getById(cycle.fishType) : null;
      const defaultAvgWeight = fishType?.avgWeight || 150;

      return `
        ${renderModalHeader('🎣 บันทึกการจับปลา')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="addHarvest(event)">
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">วันที่จับ</label>
              <input type="date" name="date" value="${new Date().toISOString().split('T')[0]}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>

            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">น้ำหนักเฉลี่ย/ตัว (กรัม) <span class="text-red-400">*</span></label>
              <input type="number" step="1" name="avgWeight" id="harvestAvgWeight" placeholder="${defaultAvgWeight}" value="${defaultAvgWeight}" min="1" required oninput="calculateHarvestCount()" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
              <p class="text-xs text-slate-500 mt-1">น้ำหนักเฉลี่ยปลาที่จับได้ต่อตัว</p>
            </div>

            <div class="bg-slate-700/30 rounded-xl p-4 mb-4 border border-slate-600/50">
              <h4 class="text-sm font-medium text-green-400 mb-3">🎯 ปลาที่ขาย (ได้ขนาด)</h4>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-sm text-slate-400 mb-1">น้ำหนัก (กก.) <span class="text-red-400">*</span></label>
                  <input type="number" step="0.1" name="soldWeight" id="harvestSoldWeight" placeholder="450" min="0" required oninput="calculateHarvestCount()" class="w-full bg-slate-600 border border-slate-500 rounded-xl px-4 py-3 text-slate-100">
                </div>
                <div>
                  <label class="block text-sm text-slate-400 mb-1">ราคา (บาท/กก.) <span class="text-red-400">*</span></label>
                  <input type="number" step="0.1" name="soldPrice" placeholder="55" min="0.1" required class="w-full bg-slate-600 border border-slate-500 rounded-xl px-4 py-3 text-slate-100">
                </div>
              </div>
              <div class="mt-2 text-sm text-slate-300">
                จำนวน: <span id="soldCount" class="text-green-400 font-medium">0</span> ตัว
              </div>
            </div>

            <div class="bg-slate-700/30 rounded-xl p-4 mb-4 border border-slate-600/50">
              <h4 class="text-sm font-medium text-amber-400 mb-3">📦 ปลาไม่ได้ขนาด</h4>
              <div class="mb-3">
                <label class="block text-sm text-slate-400 mb-1">น้ำหนัก (กก.)</label>
                <input type="number" step="0.1" name="undersizedWeight" id="harvestUndersizedWeight" placeholder="0" value="0" min="0" oninput="calculateHarvestCount()" class="w-full bg-slate-600 border border-slate-500 rounded-xl px-4 py-3 text-slate-100">
              </div>
              <div class="flex gap-3 mb-3">
                <label class="flex-1 flex items-center gap-2 cursor-pointer bg-slate-600/50 rounded-xl p-3 border border-slate-500/50" onclick="selectUndersizedAction('sell')">
                  <input type="radio" name="undersizedAction" value="sell" id="actionSell" class="accent-green-500">
                  <span class="text-sm text-slate-200">ขาย</span>
                </label>
                <label class="flex-1 flex items-center gap-2 cursor-pointer bg-slate-600/50 rounded-xl p-3 border border-slate-500/50" onclick="selectUndersizedAction('keep')">
                  <input type="radio" name="undersizedAction" value="keep" id="actionKeep" checked class="accent-amber-500">
                  <span class="text-sm text-slate-200">เลี้ยงต่อ</span>
                </label>
              </div>
              <div id="undersizedPriceSection" class="hidden">
                <label class="block text-sm text-slate-400 mb-1">ราคา (บาท/กก.)</label>
                <input type="number" step="0.1" name="undersizedPrice" id="harvestUndersizedPrice" placeholder="35" value="0" min="0" class="w-full bg-slate-600 border border-slate-500 rounded-xl px-4 py-3 text-slate-100">
              </div>
              <div class="mt-2 text-sm text-slate-300">
                จำนวน: <span id="undersizedCount" class="text-amber-400 font-medium">0</span> ตัว
                <span id="undersizedActionText" class="text-amber-400/70 ml-1">(เลี้ยงต่อ)</span>
              </div>
            </div>

            <div class="bg-cyan-500/10 rounded-xl p-3 mb-4 border border-cyan-500/30">
              <div class="flex justify-between text-sm">
                <span class="text-slate-300">รวมน้ำหนักทั้งหมด:</span>
                <span id="totalHarvestWeight" class="text-cyan-400 font-bold">0 กก.</span>
              </div>
              <div class="flex justify-between text-sm mt-1">
                <span class="text-slate-300">รวมจำนวนทั้งหมด:</span>
                <span id="totalHarvestCount" class="text-cyan-400 font-bold">0 ตัว</span>
              </div>
            </div>

            <div class="mb-4 flex items-center gap-3 bg-amber-500/10 border border-amber-500/30 rounded-xl p-3">
              <input type="checkbox" name="isFinal" class="w-5 h-5 rounded accent-amber-500">
              <div>
                <div class="text-amber-400 font-medium">จับหมดบ่อ</div>
                <div class="text-xs text-slate-400">ข้อมูลจะถูกสรุปและจบรอบ</div>
              </div>
            </div>
            <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">💾 บันทึกการจับ</button>
          </form>
        </div>
      `;
    };

    const renderAddFeedModal = () => `
      ${renderModalHeader('🥫 เพิ่มอาหาร')}
      <div class="p-4 overflow-y-auto">
        <form onsubmit="addFeed(event)">
          <div class="flex gap-3 mb-4">
            <button type="button" id="btnFresh" onclick="selectFeedType('fresh')" class="flex-1 p-3 rounded-xl border bg-orange-500/20 border-orange-500/50 text-orange-400 transition-colors">อาหารสด</button>
            <button type="button" id="btnPellet" onclick="selectFeedType('pellet')" class="flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors">อาหารเม็ด</button>
            <input type="hidden" name="type" value="fresh">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">ชื่ออาหาร <span class="text-red-400">*</span></label>
            <input type="text" name="name" placeholder="เช่น ปลาเป็ด, CP 9950" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">ยี่ห้อ (สำหรับอาหารเม็ด)</label>
            <input type="text" name="brand" placeholder="CP, Betagro" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">เบอร์ (สำหรับอาหารเม็ด)</label>
            <input type="text" name="sizeNumber" placeholder="1, 2, 3" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div id="bagSizeSection" class="mb-4 hidden">
            <div class="mb-3">
              <label class="flex items-center gap-3 cursor-pointer bg-slate-700/30 rounded-xl p-3">
                <input type="checkbox" name="useBag" id="useBagCheckbox" checked class="w-5 h-5 rounded bg-slate-600 accent-blue-500" onchange="toggleBagSizeInput(this.checked)">
                <span class="text-slate-200">ซื้อเป็นกระสอบ</span>
              </label>
            </div>
            <div id="bagSizeInput">
              <label class="block text-sm text-slate-400 mb-1">น้ำหนักต่อกระสอบ (กก.)</label>
              <input type="number" step="0.1" name="bagSize" placeholder="20" value="20" min="1" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">ราคา (บาท/กก.) <span class="text-red-400">*</span></label>
            <input type="number" step="0.1" name="price" placeholder="15" min="0.1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">+ เพิ่มอาหาร</button>
        </form>
      </div>
    `;

    const renderAddSupplementModal = () => `
      ${renderModalHeader('💊 เพิ่มวิตามิน/อาหารเสริม')}
      <div class="p-4 overflow-y-auto">
        <form onsubmit="addSupplement(event)">
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">ชื่อ <span class="text-red-400">*</span></label>
            <input type="text" name="name" placeholder="Vitamin C" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">รายละเอียด</label>
            <input type="text" name="description" placeholder="เสริมภูมิคุ้มกัน" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">ประเภท</label>
            <div class="flex gap-3">
              <button type="button" id="btnSuppLiquid" onclick="selectSuppType('liquid')" class="flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors">💧 ของเหลว</button>
              <button type="button" id="btnSuppSolid" onclick="selectSuppType('solid')" class="flex-1 p-3 rounded-xl border bg-cyan-500/20 border-cyan-500/50 text-cyan-400 transition-colors">💊 ของแข็ง/เม็ด</button>
              <input type="hidden" name="suppType" value="solid">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3 mb-4">
            <div>
              <label class="block text-sm text-slate-400 mb-1">ปริมาณต่อขวด/ห่อ <span class="text-red-400">*</span></label>
              <input type="number" step="0.1" name="packageSize" placeholder="500" min="1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div>
              <label class="block text-sm text-slate-400 mb-1">หน่วย</label>
              <select name="unit" id="suppUnitSelect" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
                <option value="กรัม">กรัม</option>
                <option value="กก.">กก.</option>
              </select>
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">ราคาต่อขวด/ห่อ (บาท) <span class="text-red-400">*</span></label>
            <input type="number" step="0.1" name="price" placeholder="150" min="0.1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">+ เพิ่มวิตามิน</button>
        </form>
      </div>
    `;

    // Medicine Modals
    const renderAddMedicineModal = () => `
      ${renderModalHeader('💉 เพิ่มยารักษาโรค')}
      <div class="p-4 overflow-y-auto">
        <form onsubmit="addMedicine(event)">
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">ชื่อยา <span class="text-red-400">*</span></label>
            <input type="text" name="name" placeholder="เช่น ฟอร์มาลิน" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">รายละเอียด</label>
            <input type="text" name="description" placeholder="รักษาปรสิตภายนอก" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">ประเภท</label>
            <div class="flex gap-3">
              <button type="button" id="btnMedLiquid" onclick="selectMedType('liquid')" class="flex-1 p-3 rounded-xl border bg-blue-500/20 border-blue-500/50 text-blue-400 transition-colors">💧 ของเหลว</button>
              <button type="button" id="btnMedSolid" onclick="selectMedType('solid')" class="flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors">💊 ของแข็ง/ผง</button>
              <input type="hidden" name="medType" value="liquid">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3 mb-4">
            <div>
              <label class="block text-sm text-slate-400 mb-1">ปริมาณต่อขวด/ห่อ <span class="text-red-400">*</span></label>
              <input type="number" step="0.1" name="packageSize" placeholder="1000" min="1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div>
              <label class="block text-sm text-slate-400 mb-1">หน่วย</label>
              <select name="unit" id="medUnitSelect" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
                <option value="มล.">มล.</option>
                <option value="ลิตร">ลิตร</option>
                <option value="กรัม">กรัม</option>
                <option value="กก.">กก.</option>
              </select>
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">ราคาต่อขวด/ห่อ (บาท) <span class="text-red-400">*</span></label>
            <input type="number" step="0.1" name="price" placeholder="120" min="0.1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">วิธีใช้/ขนาดยา <span class="text-red-400">*</span></label>
            <textarea name="usageDetails" placeholder="เช่น ใช้ 25-50 มล./น้ำ 1,000 ลิตร แช่ 30-60 นาที" required rows="3" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100 resize-none"></textarea>
          </div>
          <button type="submit" class="w-full py-3 bg-rose-500 hover:bg-rose-600 text-white rounded-xl font-medium transition-colors">+ เพิ่มยารักษาโรค</button>
        </form>
      </div>
    `;

    const renderEditMedicineModal = () => {
      const m = state.editingMedicine;
      if (!m) return '';
      return `
        ${renderModalHeader('✏️ แก้ไขยารักษาโรค')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="updateMedicine(event, '${m.id}')">
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">ชื่อยา <span class="text-red-400">*</span></label>
              <input type="text" name="name" value="${m.name}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">รายละเอียด</label>
              <input type="text" name="description" value="${m.description || ''}" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">ประเภท</label>
              <div class="flex gap-3">
                <button type="button" id="btnMedLiquid" onclick="selectMedType('liquid')" class="flex-1 p-3 rounded-xl border ${m.medType === 'liquid' ? 'bg-blue-500/20 border-blue-500/50 text-blue-400' : 'bg-slate-700/50 border-slate-600 text-slate-400'} transition-colors">💧 ของเหลว</button>
                <button type="button" id="btnMedSolid" onclick="selectMedType('solid')" class="flex-1 p-3 rounded-xl border ${m.medType === 'solid' ? 'bg-rose-500/20 border-rose-500/50 text-rose-400' : 'bg-slate-700/50 border-slate-600 text-slate-400'} transition-colors">💊 ของแข็ง/ผง</button>
                <input type="hidden" name="medType" value="${m.medType}">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
              <div>
                <label class="block text-sm text-slate-400 mb-1">ปริมาณต่อขวด/ห่อ</label>
                <input type="number" step="0.1" name="packageSize" value="${m.packageSize || ''}" min="1" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
              </div>
              <div>
                <label class="block text-sm text-slate-400 mb-1">หน่วย</label>
                <select name="unit" id="medUnitSelect" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
                  <option value="มล." ${m.unit === 'มล.' ? 'selected' : ''}>มล.</option>
                  <option value="ลิตร" ${m.unit === 'ลิตร' ? 'selected' : ''}>ลิตร</option>
                  <option value="กรัม" ${m.unit === 'กรัม' ? 'selected' : ''}>กรัม</option>
                  <option value="กก." ${m.unit === 'กก.' ? 'selected' : ''}>กก.</option>
                </select>
              </div>
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">ราคาต่อขวด/ห่อ (บาท)</label>
              <input type="number" step="0.1" name="price" value="${m.price || ''}" min="0.1" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">วิธีใช้/ขนาดยา <span class="text-red-400">*</span></label>
              <textarea name="usageDetails" required rows="3" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100 resize-none">${m.usageDetails || ''}</textarea>
            </div>
            <button type="submit" class="w-full py-3 bg-rose-500 hover:bg-rose-600 text-white rounded-xl font-medium transition-colors">💾 บันทึกการแก้ไข</button>
          </form>
        </div>
      `;
    };

    const renderMedicineHistoryModal = () => {
      const m = state.viewingMedicineHistory;
      if (!m || !m.editHistory || m.editHistory.length === 0) return '';
      return `
        ${renderModalHeader('📜 ประวัติการแก้ไขยา')}
        <div class="p-4 overflow-y-auto">
          <div class="space-y-3">
            ${m.editHistory.map((h, i) => `
              <div class="bg-slate-700/50 rounded-xl p-3 border border-slate-600/50">
                <div class="text-xs text-slate-400 mb-2">แก้ไขเมื่อ ${new Date(h.editedAt).toLocaleString('th-TH')}</div>
                <div class="text-sm text-slate-300">
                  <div>ชื่อ: ${h.prev.name}</div>
                  ${h.prev.description ? `<div>รายละเอียด: ${h.prev.description}</div>` : ''}
                  <div>ประเภท: ${h.prev.medType === 'liquid' ? '💧 ของเหลว' : '💊 ของแข็ง/ผง'}</div>
                  <div>ราคา: ${formatCurrency(h.prev.price)}/${h.prev.unit || 'หน่วย'}</div>
                  <div>วิธีใช้: ${h.prev.usageDetails || '-'}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    };

    // Mortality Modal
    const renderMortalityModal = () => {
      const pond = db.ponds.getById(state.selectedPond);
      const cycle = db.cycles.getActive(pond?.id);
      if (!cycle) return '';

      const recentMorts = db.mortalities.getByCycle(cycle.id).slice(0, 5);
      const totalMorts = db.mortalities.getTotalByCycle(cycle.id);

      return `
        ${renderModalHeader('💀 บันทึกปลาตาย')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="addMortality(event)">
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">วันที่</label>
              <input type="date" name="date" value="${new Date().toISOString().split('T')[0]}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">จำนวนปลาตาย (ตัว) <span class="text-red-400">*</span></label>
              <input type="number" name="count" placeholder="จำนวนตัว" min="1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">สาเหตุ/หมายเหตุ</label>
              <input type="text" name="reason" placeholder="เช่น โรคจุดขาว, น้ำเสีย" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <button type="submit" class="w-full py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-medium transition-colors">💀 บันทึกปลาตาย</button>
          </form>

          ${totalMorts > 0 ? `
            <div class="mt-6 pt-4 border-t border-slate-700/50">
              <div class="flex items-center justify-between mb-3">
                <h4 class="text-sm font-semibold text-slate-300">📋 ประวัติการตาย</h4>
                <span class="text-xs text-red-400 bg-red-500/20 px-2 py-1 rounded-lg">รวม ${formatNumber(totalMorts)} ตัว</span>
              </div>
              <div class="space-y-2 max-h-40 overflow-y-auto">
                ${recentMorts.map(m => `
                  <div class="flex items-center justify-between bg-slate-700/30 rounded-xl p-2.5">
                    <div>
                      <span class="text-sm text-slate-300">${new Date(m.date).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' })}</span>
                      <span class="text-red-400 font-medium ml-2">${m.count} ตัว</span>
                      ${m.reason ? `<span class="text-xs text-slate-500 ml-2">(${m.reason})</span>` : ''}
                    </div>
                    <button onclick="deleteMortality('${m.id}')" class="text-slate-400 hover:text-red-400 text-sm">🗑️</button>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      `;
    };

    // Feed Stock Modals
    const renderAddFeedStockModal = () => {
      const feeds = db.feeds.getAll();
      if (feeds.length === 0) {
        return `
          ${renderModalHeader('📦 เพิ่มสต็อกอาหาร')}
          <div class="p-4 overflow-y-auto text-center">
            <div class="text-4xl mb-4">🥫</div>
            <p class="text-slate-400 mb-4">ยังไม่มีรายการอาหาร</p>
            <p class="text-slate-500 text-sm mb-4">กรุณาเพิ่มอาหารในหน้าตั้งค่าก่อน</p>
            <button onclick="setState({modal:null})" class="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-medium transition-colors">ปิด</button>
          </div>
        `;
      }

      return `
        ${renderModalHeader('📦 เพิ่มสต็อกอาหาร')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="addFeedStock(event)">
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">เลือกอาหาร <span class="text-red-400">*</span></label>
              <select name="feedId" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
                ${feeds.map(f => `
                  <option value="${f.id}">${f.type === 'fresh' ? '🟠' : '🔵'} ${f.name} ${f.brand ? `(${f.brand})` : ''} - สต็อก: ${formatNumber(db.feedStock.getStock(f.id), 1)} กก.</option>
                `).join('')}
              </select>
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">จำนวนที่เพิ่ม (กก.) <span class="text-red-400">*</span></label>
              <input type="number" step="0.1" name="quantity" placeholder="50" min="0.1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">หมายเหตุ</label>
              <input type="text" name="note" placeholder="เช่น ซื้อจากร้าน..." class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <button type="submit" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl font-medium transition-colors">+ เพิ่มสต็อก</button>
          </form>
        </div>
      `;
    };

    const renderEditFeedStockModal = () => {
      const feedId = state.editingStockFeedId;
      if (!feedId) return '';
      const feed = db.feeds.getById(feedId);
      if (!feed) return '';
      const currentStock = db.feedStock.getStock(feedId);

      return `
        ${renderModalHeader('✏️ แก้ไขสต็อก: ' + feed.name)}
        <div class="p-4 overflow-y-auto">
          <div class="bg-slate-700/30 rounded-xl p-4 mb-4">
            <div class="flex items-center gap-3 mb-3">
              <span class="text-2xl">${feed.type === 'fresh' ? '🟠' : '🔵'}</span>
              <div>
                <div class="font-medium text-slate-200">${feed.name}</div>
                ${feed.brand ? `<div class="text-xs text-slate-400">${feed.brand}</div>` : ''}
              </div>
            </div>
            <div class="text-center py-3 bg-slate-800/50 rounded-xl">
              <div class="text-xs text-slate-400 mb-1">สต็อกปัจจุบัน</div>
              <div class="text-3xl font-bold ${currentStock < 10 ? 'text-red-400' : currentStock < 30 ? 'text-amber-400' : 'text-green-400'}">${formatNumber(currentStock, 1)} <span class="text-lg text-slate-400">กก.</span></div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3 mb-4">
            <button type="button" onclick="showAddStockForm('${feedId}')" id="btnAddStock" class="p-3 rounded-xl border bg-green-500/20 border-green-500/50 text-green-400 transition-colors text-sm font-medium">+ เพิ่มสต็อก</button>
            <button type="button" onclick="showSetStockForm('${feedId}')" id="btnSetStock" class="p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors text-sm font-medium">✏️ ตั้งค่าใหม่</button>
          </div>

          <form id="stockForm" onsubmit="submitStockEdit(event, '${feedId}')">
            <input type="hidden" name="action" value="add">
            <div class="mb-4">
              <label id="stockLabel" class="block text-sm text-slate-400 mb-1">จำนวนที่เพิ่ม (กก.) <span class="text-red-400">*</span></label>
              <input type="number" step="0.1" name="quantity" placeholder="10" min="0" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <button type="submit" id="stockSubmitBtn" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl font-medium transition-colors">+ เพิ่มสต็อก</button>
          </form>
        </div>
      `;
    };

    // Stock History Modal
    const renderStockHistoryModal = () => {
      const stocks = db.feedStock.getAll();
      const feeds = db.feeds.getAll();
      const historyLimit = state.stockHistoryLimit || 20;

      // Collect all history entries with feed info
      const allHistory = [];
      stocks.forEach(stock => {
        const feed = feeds.find(f => f.id === stock.feedId);
        if (stock.history && feed) {
          stock.history.forEach(h => {
            allHistory.push({
              ...h,
              feedName: feed.name,
              feedType: feed.type,
              feedId: stock.feedId
            });
          });
        }
      });

      // Sort by date descending
      allHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

      // Calculate summary
      const summary = {
        totalAdd: 0,
        totalDeduct: 0,
        byFeed: {},
        byType: { fresh: { add: 0, deduct: 0 }, pellet: { add: 0, deduct: 0 } }
      };
      allHistory.forEach(h => {
        if (h.type === 'add') {
          summary.totalAdd += h.quantity;
          summary.byType[h.feedType].add += h.quantity;
        } else if (h.type === 'deduct') {
          summary.totalDeduct += h.quantity;
          summary.byType[h.feedType].deduct += h.quantity;
        }
        if (!summary.byFeed[h.feedName]) {
          summary.byFeed[h.feedName] = { add: 0, deduct: 0, type: h.feedType };
        }
        if (h.type === 'add') summary.byFeed[h.feedName].add += h.quantity;
        if (h.type === 'deduct') summary.byFeed[h.feedName].deduct += h.quantity;
      });

      // Group by week for chart
      const weeklyData = {};
      const now = new Date();
      for (let i = 6; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(d.getDate() - i);
        const key = d.toISOString().split('T')[0];
        weeklyData[key] = { add: 0, deduct: 0 };
      }

      allHistory.forEach(h => {
        const dateKey = h.date.split('T')[0];
        if (weeklyData[dateKey]) {
          if (h.type === 'add') {
            weeklyData[dateKey].add += h.quantity;
          } else if (h.type === 'deduct') {
            weeklyData[dateKey].deduct += h.quantity;
          }
        }
      });

      const weekDays = ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'];
      const chartData = Object.entries(weeklyData).map(([date, data]) => {
        const d = new Date(date);
        return {
          label: weekDays[d.getDay()],
          date: date,
          add: data.add,
          deduct: data.deduct
        };
      });

      const maxValue = Math.max(...chartData.map(d => Math.max(d.add, d.deduct)), 1);
      const displayHistory = allHistory.slice(0, historyLimit);
      const hasMore = allHistory.length > historyLimit;

      return `
        ${renderModalHeader('📊 ประวัติคลังอาหาร')}
        <div class="p-4 overflow-y-auto">
          <!-- Summary Section -->
          <div class="bg-slate-700/30 rounded-xl p-4 mb-4">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-slate-300">📊 สรุปภาพรวม</h4>
              <button onclick="downloadStockHistory()" class="px-3 py-1.5 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg text-xs font-medium transition-colors flex items-center gap-1">
                <span>⬇️</span> ดาวน์โหลด
              </button>
            </div>
            <div class="grid grid-cols-3 gap-2 mb-3">
              <div class="bg-green-500/10 rounded-lg p-2 text-center">
                <div class="text-lg font-bold text-green-400">${formatNumber(summary.totalAdd, 1)}</div>
                <div class="text-[10px] text-slate-500">เพิ่ม (กก.)</div>
              </div>
              <div class="bg-red-500/10 rounded-lg p-2 text-center">
                <div class="text-lg font-bold text-red-400">${formatNumber(summary.totalDeduct, 1)}</div>
                <div class="text-[10px] text-slate-500">ใช้ (กก.)</div>
              </div>
              <div class="bg-slate-600/30 rounded-lg p-2 text-center">
                <div class="text-lg font-bold ${summary.totalAdd - summary.totalDeduct >= 0 ? 'text-cyan-400' : 'text-amber-400'}">${summary.totalAdd - summary.totalDeduct >= 0 ? '+' : ''}${formatNumber(summary.totalAdd - summary.totalDeduct, 1)}</div>
                <div class="text-[10px] text-slate-500">สุทธิ (กก.)</div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <div class="bg-orange-500/10 rounded-lg p-2">
                <div class="flex items-center gap-1 mb-1">
                  <span>🟠</span>
                  <span class="text-slate-400">อาหารสด</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-green-400">+${formatNumber(summary.byType.fresh.add, 1)}</span>
                  <span class="text-red-400">-${formatNumber(summary.byType.fresh.deduct, 1)}</span>
                </div>
              </div>
              <div class="bg-blue-500/10 rounded-lg p-2">
                <div class="flex items-center gap-1 mb-1">
                  <span>🔵</span>
                  <span class="text-slate-400">อาหารเม็ด</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-green-400">+${formatNumber(summary.byType.pellet.add, 1)}</span>
                  <span class="text-red-400">-${formatNumber(summary.byType.pellet.deduct, 1)}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Weekly Chart -->
          <div class="bg-slate-700/30 rounded-xl p-4 mb-4">
            <h4 class="text-sm font-medium text-slate-300 mb-3">📈 อาหาร 7 วันล่าสุด</h4>
            <div class="flex items-end justify-between gap-1" style="height: 100px;">
              ${chartData.map(d => {
                const addHeight = (d.add / maxValue) * 80;
                const deductHeight = (d.deduct / maxValue) * 80;
                return `
                  <div class="flex-1 flex flex-col items-center">
                    <div class="flex gap-0.5 items-end" style="height: 80px;">
                      <div class="w-2 bg-green-500/60 rounded-t" style="height: ${addHeight}px;" title="เพิ่ม: ${formatNumber(d.add, 1)} กก."></div>
                      <div class="w-2 bg-red-500/60 rounded-t" style="height: ${deductHeight}px;" title="ใช้: ${formatNumber(d.deduct, 1)} กก."></div>
                    </div>
                    <div class="text-[10px] text-slate-500 mt-1">${d.label}</div>
                  </div>
                `;
              }).join('')}
            </div>
            <div class="flex justify-center gap-4 mt-3 text-xs">
              <span class="flex items-center gap-1"><span class="w-2 h-2 bg-green-500/60 rounded"></span> เพิ่ม</span>
              <span class="flex items-center gap-1"><span class="w-2 h-2 bg-red-500/60 rounded"></span> ใช้</span>
            </div>
          </div>

          <!-- History List -->
          <div class="flex items-center justify-between mb-3">
            <h4 class="text-sm font-medium text-slate-300">📋 รายการทั้งหมด</h4>
            <span class="text-xs text-slate-500">${allHistory.length} รายการ</span>
          </div>
          ${allHistory.length === 0 ? `
            <div class="text-center py-6 text-slate-500">
              <div class="text-3xl mb-2">📦</div>
              <p class="text-sm">ยังไม่มีประวัติ</p>
            </div>
          ` : `
            <div id="stockHistoryList" class="space-y-2 max-h-72 overflow-y-auto">
              ${displayHistory.map(h => {
                const date = new Date(h.date);
                const dateStr = date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
                const timeStr = date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                const icon = h.type === 'add' ? '➕' : h.type === 'deduct' ? '➖' : '🔄';
                const color = h.type === 'add' ? 'text-green-400' : h.type === 'deduct' ? 'text-red-400' : 'text-amber-400';
                const typeText = h.type === 'add' ? 'เพิ่ม' : h.type === 'deduct' ? 'ใช้' : 'ปรับ';
                const qty = h.type === 'adjust' ? `${formatNumber(h.oldQuantity, 1)} → ${formatNumber(h.newQuantity, 1)}` : formatNumber(h.quantity, 1);

                return `
                  <div class="bg-slate-700/30 rounded-lg p-2.5 flex items-center gap-2">
                    <span class="${h.feedType === 'fresh' ? 'text-orange-400' : 'text-blue-400'}">${h.feedType === 'fresh' ? '🟠' : '🔵'}</span>
                    <div class="flex-1 min-w-0">
                      <div class="text-sm text-slate-200 truncate">${h.feedName}</div>
                      <div class="text-xs text-slate-500">${dateStr} ${timeStr} ${h.note ? `• ${h.note}` : ''}</div>
                    </div>
                    <div class="text-right">
                      <div class="${color} text-sm font-medium">${icon} ${qty} กก.</div>
                      <div class="text-xs text-slate-500">${typeText}</div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
            ${hasMore ? `
              <button onclick="loadMoreStockHistory()" class="w-full mt-3 py-2.5 bg-slate-700/50 hover:bg-slate-600/50 text-slate-300 rounded-xl text-sm font-medium transition-colors flex items-center justify-center gap-2">
                <span>⬇️</span> โหลดเพิ่ม (${allHistory.length - historyLimit} รายการ)
              </button>
            ` : `
              <div class="text-center mt-3 text-xs text-slate-500">— แสดงทั้งหมดแล้ว —</div>
            `}
          `}
        </div>
      `;
    };

    // Stock Password Modals
    const renderStockPasswordConfirmModal = () => {
      const feedId = state.pendingStockDelete;
      if (!feedId) return '';
      const feed = db.feeds.getById(feedId);
      if (!feed) return '';
      const currentStock = db.feedStock.getStock(feedId);

      return `
        ${renderModalHeader('🔐 ยืนยันการลบสต็อก')}
        <div class="p-4 overflow-y-auto">
          <div class="bg-red-500/10 border border-red-500/30 rounded-xl p-4 mb-4">
            <div class="text-center">
              <div class="text-3xl mb-2">⚠️</div>
              <div class="text-red-400 font-medium mb-2">ต้องการลบสต็อกนี้?</div>
              <div class="text-slate-300">${feed.type === 'fresh' ? '🟠' : '🔵'} ${feed.name}</div>
              <div class="text-2xl font-bold text-red-400 mt-2">${formatNumber(currentStock, 1)} กก.</div>
            </div>
          </div>

          ${db.stockPassword.isEnabled() ? `
            <form onsubmit="confirmDeleteStock(event, '${feedId}')">
              <div class="mb-4">
                <label class="block text-sm text-slate-400 mb-1">กรอกรหัสผ่าน <span class="text-red-400">*</span></label>
                <input type="password" name="password" placeholder="รหัสผ่าน" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
              </div>
              <div class="grid grid-cols-2 gap-3">
                <button type="button" onclick="setState({modal:null, pendingStockDelete:null})" class="py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-medium transition-colors">ยกเลิก</button>
                <button type="submit" class="py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-medium transition-colors">🗑️ ลบสต็อก</button>
              </div>
            </form>
          ` : `
            <div class="grid grid-cols-2 gap-3">
              <button type="button" onclick="setState({modal:null, pendingStockDelete:null})" class="py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-medium transition-colors">ยกเลิก</button>
              <button type="button" onclick="executeDeleteStock('${feedId}')" class="py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-medium transition-colors">🗑️ ลบสต็อก</button>
            </div>
          `}
        </div>
      `;
    };

    const renderStockPasswordManageModal = () => {
      const isEnabled = db.stockPassword.isEnabled();

      return `
        ${renderModalHeader('🔐 จัดการรหัสผ่านสต็อก')}
        <div class="p-4 overflow-y-auto">
          <div class="bg-slate-700/30 rounded-xl p-4 mb-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="font-medium text-slate-200">สถานะการใช้งานรหัสผ่าน</div>
                <div class="text-xs text-slate-400">ใช้ยืนยันก่อนลบสต็อก</div>
              </div>
              <div class="text-lg font-bold ${isEnabled ? 'text-green-400' : 'text-slate-500'}">
                ${isEnabled ? '✅ เปิดใช้งาน' : '❌ ปิดใช้งาน'}
              </div>
            </div>
          </div>

          ${isEnabled ? `
            <!-- Change Password -->
            <div class="mb-4">
              <h4 class="text-sm font-medium text-slate-300 mb-3">เปลี่ยนรหัสผ่าน</h4>
              <form onsubmit="changeStockPassword(event)">
                <div class="mb-3">
                  <label class="block text-xs text-slate-400 mb-1">รหัสผ่านเดิม</label>
                  <input type="password" name="oldPassword" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-2 text-slate-100">
                </div>
                <div class="mb-3">
                  <label class="block text-xs text-slate-400 mb-1">รหัสผ่านใหม่</label>
                  <input type="password" name="newPassword" required minlength="4" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-2 text-slate-100">
                </div>
                <div class="mb-3">
                  <label class="block text-xs text-slate-400 mb-1">ยืนยันรหัสผ่านใหม่</label>
                  <input type="password" name="confirmPassword" required minlength="4" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-2 text-slate-100">
                </div>
                <button type="submit" class="w-full py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors text-sm">💾 เปลี่ยนรหัสผ่าน</button>
              </form>
            </div>

            <!-- Disable Password -->
            <div class="border-t border-slate-700/50 pt-4">
              <h4 class="text-sm font-medium text-slate-300 mb-3">ยกเลิกใช้งานรหัสผ่าน</h4>
              <form onsubmit="disableStockPassword(event)">
                <div class="mb-3">
                  <label class="block text-xs text-slate-400 mb-1">กรอกรหัสผ่านปัจจุบันเพื่อยืนยัน</label>
                  <input type="password" name="password" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-2 text-slate-100">
                </div>
                <button type="submit" class="w-full py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-xl font-medium transition-colors text-sm">🔓 ยกเลิกใช้รหัสผ่าน</button>
              </form>
            </div>
          ` : `
            <!-- Set New Password -->
            <div class="mb-4">
              <h4 class="text-sm font-medium text-slate-300 mb-3">ตั้งรหัสผ่านใหม่</h4>
              <form onsubmit="setStockPassword(event)">
                <div class="mb-3">
                  <label class="block text-xs text-slate-400 mb-1">รหัสผ่าน (อย่างน้อย 4 ตัว)</label>
                  <input type="password" name="password" required minlength="4" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-2 text-slate-100">
                </div>
                <div class="mb-3">
                  <label class="block text-xs text-slate-400 mb-1">ยืนยันรหัสผ่าน</label>
                  <input type="password" name="confirmPassword" required minlength="4" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-2 text-slate-100">
                </div>
                <button type="submit" class="w-full py-2 bg-green-500 hover:bg-green-600 text-white rounded-xl font-medium transition-colors text-sm">🔒 ตั้งรหัสผ่าน</button>
              </form>
            </div>
          `}

          <button onclick="setState({modal:null})" class="w-full mt-4 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-medium transition-colors">ปิด</button>
        </div>
      `;
    };

    // Fish Type Modals
    const renderAddFishTypeModal = () => `
      ${renderModalHeader('🐟 เพิ่มชนิดปลา')}
      <div class="p-4 overflow-y-auto">
        <form onsubmit="addFishType(event)">
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">ชื่อชนิดปลา <span class="text-red-400">*</span></label>
            <input type="text" name="name" placeholder="เช่น ปลาดุกบิ๊กอุย" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">ประเภทอาหารหลัก</label>
            <div class="flex gap-3">
              <button type="button" id="btnFreshFish" onclick="selectFishFeedType('fresh')" class="flex-1 p-3 rounded-xl border bg-orange-500/20 border-orange-500/50 text-orange-400 transition-colors">อาหารสด</button>
              <button type="button" id="btnPelletFish" onclick="selectFishFeedType('pellet')" class="flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors">อาหารเม็ด</button>
              <input type="hidden" name="feedType" value="fresh">
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">น้ำหนักเฉลี่ยเมื่อโต (กรัม/ตัว) <span class="text-red-400">*</span></label>
            <input type="number" step="1" name="avgWeight" placeholder="150" min="1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">+ เพิ่มชนิดปลา</button>
        </form>
      </div>
    `;

    const renderEditFishTypeModal = () => {
      const ft = state.editingFishType;
      if (!ft) return '';
      return `
        ${renderModalHeader('✏️ แก้ไขชนิดปลา')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="updateFishType(event, '${ft.id}')">
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">ชื่อชนิดปลา <span class="text-red-400">*</span></label>
              <input type="text" name="name" value="${ft.name}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">ประเภทอาหารหลัก</label>
              <div class="flex gap-3">
                <button type="button" id="btnFreshFish" onclick="selectFishFeedType('fresh')" class="flex-1 p-3 rounded-xl border ${ft.feedType === 'fresh' ? 'bg-orange-500/20 border-orange-500/50 text-orange-400' : 'bg-slate-700/50 border-slate-600 text-slate-400'} transition-colors">อาหารสด</button>
                <button type="button" id="btnPelletFish" onclick="selectFishFeedType('pellet')" class="flex-1 p-3 rounded-xl border ${ft.feedType === 'pellet' ? 'bg-blue-500/20 border-blue-500/50 text-blue-400' : 'bg-slate-700/50 border-slate-600 text-slate-400'} transition-colors">อาหารเม็ด</button>
                <input type="hidden" name="feedType" value="${ft.feedType}">
              </div>
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">น้ำหนักเฉลี่ยเมื่อโต (กรัม/ตัว) <span class="text-red-400">*</span></label>
              <input type="number" step="1" name="avgWeight" value="${ft.avgWeight}" min="1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">💾 บันทึกการแก้ไข</button>
          </form>
        </div>
      `;
    };

    const renderFishTypeHistoryModal = () => {
      const ft = state.viewingFishTypeHistory;
      if (!ft || !ft.editHistory || ft.editHistory.length === 0) return '';
      return `
        ${renderModalHeader('📜 ประวัติการแก้ไข: ' + ft.name)}
        <div class="p-4 overflow-y-auto">
          <div class="space-y-3">
            ${ft.editHistory.map((h, i) => `
              <div class="bg-slate-700/30 rounded-xl p-3">
                <div class="text-xs text-slate-400 mb-2">แก้ไขเมื่อ: ${formatDate(h.editedAt)} ${new Date(h.editedAt).toLocaleTimeString('th-TH')}</div>
                <div class="text-sm space-y-1">
                  <div><span class="text-slate-400">ชื่อเดิม:</span> <span class="text-slate-200">${h.prev.name}</span></div>
                  <div><span class="text-slate-400">ประเภทอาหาร:</span> <span class="text-slate-200">${h.prev.feedType === 'fresh' ? 'อาหารสด' : 'อาหารเม็ด'}</span></div>
                  <div><span class="text-slate-400">น้ำหนักเฉลี่ย:</span> <span class="text-slate-200">${formatNumber(h.prev.avgWeight)} กรัม</span></div>
                </div>
              </div>
            `).reverse().join('')}
          </div>
          <button onclick="setState({modal:null,viewingFishTypeHistory:null})" class="w-full mt-4 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-medium transition-colors">ปิด</button>
        </div>
      `;
    };

    const renderEditFeedModal = () => {
      const f = state.editingFeed;
      if (!f) return '';
      const isPellet = f.type === 'pellet';
      const useBag = f.useBag || false;
      return `
        ${renderModalHeader('✏️ แก้ไขอาหาร')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="updateFeed(event)">
            <div class="flex gap-3 mb-4">
              <button type="button" id="btnFresh" onclick="selectFeedType('fresh')" class="flex-1 p-3 rounded-xl border ${f.type === 'fresh' ? 'bg-orange-500/20 border-orange-500/50 text-orange-400' : 'bg-slate-700/50 border-slate-600 text-slate-400'} transition-colors">อาหารสด</button>
              <button type="button" id="btnPellet" onclick="selectFeedType('pellet')" class="flex-1 p-3 rounded-xl border ${f.type === 'pellet' ? 'bg-blue-500/20 border-blue-500/50 text-blue-400' : 'bg-slate-700/50 border-slate-600 text-slate-400'} transition-colors">อาหารเม็ด</button>
              <input type="hidden" name="type" value="${f.type}">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">ชื่ออาหาร <span class="text-red-400">*</span></label>
              <input type="text" name="name" value="${f.name}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">ยี่ห้อ (สำหรับอาหารเม็ด)</label>
              <input type="text" name="brand" value="${f.brand || ''}" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">เบอร์ (สำหรับอาหารเม็ด)</label>
              <input type="text" name="sizeNumber" value="${f.sizeNumber || ''}" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div id="bagSizeSection" class="mb-4 ${isPellet ? '' : 'hidden'}">
              <div class="mb-3">
                <label class="flex items-center gap-3 cursor-pointer bg-slate-700/30 rounded-xl p-3">
                  <input type="checkbox" name="useBag" id="useBagCheckbox" ${useBag ? 'checked' : ''} class="w-5 h-5 rounded bg-slate-600 accent-blue-500" onchange="toggleBagSizeInput(this.checked)">
                  <span class="text-slate-200">ซื้อเป็นกระสอบ</span>
                </label>
              </div>
              <div id="bagSizeInput" style="display: ${useBag ? 'block' : 'none'}">
                <label class="block text-sm text-slate-400 mb-1">น้ำหนักต่อกระสอบ (กก.)</label>
                <input type="number" step="0.1" name="bagSize" value="${f.bagSize || 20}" min="1" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
              </div>
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">ราคา (บาท/กก.) <span class="text-red-400">*</span></label>
              <input type="number" step="0.1" name="price" value="${f.pricePerKg}" min="0.1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">💾 บันทึกการแก้ไข</button>
          </form>
        </div>
      `;
    };

    const renderFeedHistoryModal = () => {
      const f = state.viewingFeedHistory;
      if (!f || !f.editHistory || f.editHistory.length === 0) return '';
      return `
        ${renderModalHeader('📜 ประวัติการแก้ไข: ' + f.name)}
        <div class="p-4 overflow-y-auto">
          <div class="space-y-3">
            ${f.editHistory.map((h, i) => `
              <div class="bg-slate-700/30 rounded-xl p-3">
                <div class="text-xs text-slate-400 mb-2">แก้ไขเมื่อ: ${formatDate(h.editedAt)} ${new Date(h.editedAt).toLocaleTimeString('th-TH')}</div>
                <div class="text-sm space-y-1">
                  <div><span class="text-slate-400">ชื่อเดิม:</span> <span class="text-slate-200">${h.prev.name}</span></div>
                  <div><span class="text-slate-400">ประเภท:</span> <span class="text-slate-200">${h.prev.type === 'fresh' ? 'อาหารสด' : 'อาหารเม็ด'}</span></div>
                  ${h.prev.brand ? `<div><span class="text-slate-400">ยี่ห้อ:</span> <span class="text-slate-200">${h.prev.brand}</span></div>` : ''}
                  ${h.prev.sizeNumber ? `<div><span class="text-slate-400">เบอร์:</span> <span class="text-slate-200">${h.prev.sizeNumber}</span></div>` : ''}
                  <div><span class="text-slate-400">ราคา:</span> <span class="text-slate-200">${formatCurrency(h.prev.pricePerKg)}/กก.</span></div>
                </div>
              </div>
            `).reverse().join('')}
          </div>
          <button onclick="setState({modal:null,viewingFeedHistory:null})" class="w-full mt-4 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-medium transition-colors">ปิด</button>
        </div>
      `;
    };

    const renderEditSupplementModal = () => {
      const s = state.editingSupplement;
      if (!s) return '';
      const isLiquid = s.suppType === 'liquid';
      return `
        ${renderModalHeader('✏️ แก้ไขวิตามิน/อาหารเสริม')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="updateSupplement(event)">
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">ชื่อ <span class="text-red-400">*</span></label>
              <input type="text" name="name" value="${s.name}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">รายละเอียด</label>
              <input type="text" name="description" value="${s.description || ''}" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">ประเภท</label>
              <div class="flex gap-3">
                <button type="button" id="btnSuppLiquid" onclick="selectSuppType('liquid')" class="flex-1 p-3 rounded-xl border ${isLiquid ? 'bg-blue-500/20 border-blue-500/50 text-blue-400' : 'bg-slate-700/50 border-slate-600 text-slate-400'} transition-colors">💧 ของเหลว</button>
                <button type="button" id="btnSuppSolid" onclick="selectSuppType('solid')" class="flex-1 p-3 rounded-xl border ${!isLiquid ? 'bg-cyan-500/20 border-cyan-500/50 text-cyan-400' : 'bg-slate-700/50 border-slate-600 text-slate-400'} transition-colors">💊 ของแข็ง/เม็ด</button>
                <input type="hidden" name="suppType" value="${s.suppType || 'solid'}">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
              <div>
                <label class="block text-sm text-slate-400 mb-1">ปริมาณต่อขวด/ห่อ <span class="text-red-400">*</span></label>
                <input type="number" step="0.1" name="packageSize" value="${s.packageSize || 100}" min="1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
              </div>
              <div>
                <label class="block text-sm text-slate-400 mb-1">หน่วย</label>
                <select id="suppUnitSelect" name="unit" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
                  ${isLiquid ? `
                    <option value="มล." selected>มล.</option>
                  ` : `
                    <option value="กรัม" ${s.unit === 'กรัม' ? 'selected' : ''}>กรัม</option>
                    <option value="กก." ${s.unit === 'กก.' ? 'selected' : ''}>กก.</option>
                  `}
                </select>
              </div>
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">ราคาต่อขวด/ห่อ (บาท) <span class="text-red-400">*</span></label>
              <input type="number" step="0.1" name="price" value="${s.price}" min="0.1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">💾 บันทึกการแก้ไข</button>
          </form>
        </div>
      `;
    };

    const renderSupplementHistoryModal = () => {
      const s = state.viewingSupplementHistory;
      if (!s || !s.editHistory || s.editHistory.length === 0) return '';
      return `
        ${renderModalHeader('📜 ประวัติการแก้ไข: ' + s.name)}
        <div class="p-4 overflow-y-auto">
          <div class="space-y-3">
            ${s.editHistory.map((h, i) => `
              <div class="bg-slate-700/30 rounded-xl p-3">
                <div class="text-xs text-slate-400 mb-2">แก้ไขเมื่อ: ${formatDate(h.editedAt)} ${new Date(h.editedAt).toLocaleTimeString('th-TH')}</div>
                <div class="text-sm space-y-1">
                  <div><span class="text-slate-400">ชื่อเดิม:</span> <span class="text-slate-200">${h.prev.name}</span></div>
                  ${h.prev.description ? `<div><span class="text-slate-400">รายละเอียด:</span> <span class="text-slate-200">${h.prev.description}</span></div>` : ''}
                  <div><span class="text-slate-400">ประเภท:</span> <span class="text-slate-200">${h.prev.suppType === 'liquid' ? '💧 ของเหลว' : '💊 ของแข็ง/เม็ด'}</span></div>
                  <div><span class="text-slate-400">ราคา:</span> <span class="text-slate-200">${formatCurrency(h.prev.price)}/100${h.prev.unit}</span></div>
                </div>
              </div>
            `).reverse().join('')}
          </div>
          <button onclick="setState({modal:null,viewingSupplementHistory:null})" class="w-full mt-4 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-medium transition-colors">ปิด</button>
        </div>
      `;
    };

    // ===== Event Handlers =====
    window.selectFeedType = (type) => {
      const form = document.querySelector('form');
      form.querySelector('[name=type]').value = type;
      const btnFresh = document.getElementById('btnFresh');
      const btnPellet = document.getElementById('btnPellet');
      const bagSizeSection = document.getElementById('bagSizeSection');

      if (type === 'fresh') {
        btnFresh.className = 'flex-1 p-3 rounded-xl border bg-orange-500/20 border-orange-500/50 text-orange-400 transition-colors';
        btnPellet.className = 'flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors';
        if (bagSizeSection) bagSizeSection.classList.add('hidden');
      } else {
        btnPellet.className = 'flex-1 p-3 rounded-xl border bg-blue-500/20 border-blue-500/50 text-blue-400 transition-colors';
        btnFresh.className = 'flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors';
        if (bagSizeSection) bagSizeSection.classList.remove('hidden');
      }
    };

    window.toggleBagSizeInput = (checked) => {
      const bagSizeInput = document.getElementById('bagSizeInput');
      if (bagSizeInput) {
        bagSizeInput.style.display = checked ? 'block' : 'none';
      }
    };

    window.switchFeedTab = (type) => {
      const tabPellet = document.getElementById('tabPellet');
      const tabFresh = document.getElementById('tabFresh');
      const pelletFeeds = document.getElementById('pelletFeeds');
      const freshFeeds = document.getElementById('freshFeeds');
      const feedTypeInput = document.querySelector('[name=feedType]');

      if (type === 'pellet') {
        tabPellet.className = 'flex-1 p-2 rounded-xl border bg-blue-500/20 border-blue-500/50 text-blue-400 transition-colors text-sm';
        tabFresh.className = 'flex-1 p-2 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors text-sm';
        pelletFeeds.classList.remove('hidden');
        freshFeeds.classList.add('hidden');
      } else {
        tabFresh.className = 'flex-1 p-2 rounded-xl border bg-orange-500/20 border-orange-500/50 text-orange-400 transition-colors text-sm';
        tabPellet.className = 'flex-1 p-2 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors text-sm';
        freshFeeds.classList.remove('hidden');
        pelletFeeds.classList.add('hidden');
      }
      feedTypeInput.value = type;
    };

    window.toggleSuppInput = (id) => {
      const checkbox = document.getElementById('supp_' + id);
      const input = document.getElementById('suppAmt_' + id);
      input.disabled = !checkbox.checked;
      if (checkbox.checked) {
        input.focus();
      }
    };

    window.toggleMedInput = (id) => {
      const checkbox = document.getElementById('med_' + id);
      const input = document.getElementById('medAmt_' + id);
      input.disabled = !checkbox.checked;
      if (checkbox.checked) {
        input.focus();
      }
    };

    window.toggleMedicineOnlyMode = (isChecked) => {
      const feedSection = document.getElementById('feedSection');
      const feedWeight = document.getElementById('feedWeight');
      const submitBtn = document.getElementById('feedingSubmitBtn');

      if (feedSection) {
        feedSection.style.display = isChecked ? 'none' : 'block';
      }
      if (feedWeight) {
        feedWeight.required = !isChecked;
        feedWeight.disabled = isChecked;
        if (isChecked) feedWeight.value = '';
      }
      if (submitBtn) {
        submitBtn.textContent = isChecked ? '💉 บันทึกการให้ยา' : '+ เพิ่มมื้ออาหาร';
        submitBtn.className = isChecked
          ? 'w-full py-3 bg-rose-500 hover:bg-rose-600 text-white rounded-xl font-medium transition-colors'
          : 'w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors';
      }
    };

    window.selectFishFeedType = (type) => {
      const form = document.querySelector('form');
      form.querySelector('[name=feedType]').value = type;
      const btnFresh = document.getElementById('btnFreshFish');
      const btnPellet = document.getElementById('btnPelletFish');

      if (type === 'fresh') {
        btnFresh.className = 'flex-1 p-3 rounded-xl border bg-orange-500/20 border-orange-500/50 text-orange-400 transition-colors';
        btnPellet.className = 'flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors';
      } else {
        btnPellet.className = 'flex-1 p-3 rounded-xl border bg-blue-500/20 border-blue-500/50 text-blue-400 transition-colors';
        btnFresh.className = 'flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors';
      }
    };

    window.selectSuppType = (type) => {
      const form = document.querySelector('form');
      form.querySelector('[name=suppType]').value = type;
      const btnLiquid = document.getElementById('btnSuppLiquid');
      const btnSolid = document.getElementById('btnSuppSolid');
      const unitSelect = document.getElementById('suppUnitSelect');

      // Update button styles
      if (type === 'liquid') {
        btnLiquid.className = 'flex-1 p-3 rounded-xl border bg-blue-500/20 border-blue-500/50 text-blue-400 transition-colors';
        btnSolid.className = 'flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors';
        // Update unit options for liquid
        unitSelect.innerHTML = '<option value="มล.">มล.</option>';
      } else {
        btnSolid.className = 'flex-1 p-3 rounded-xl border bg-cyan-500/20 border-cyan-500/50 text-cyan-400 transition-colors';
        btnLiquid.className = 'flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors';
        // Update unit options for solid
        unitSelect.innerHTML = '<option value="กรัม">กรัม</option><option value="กก.">กก.</option>';
      }
    };

    window.addFishType = (e) => {
      e.preventDefault();
      const form = e.target;
      const result = db.fishTypes.create({
        name: form.name.value,
        feedType: form.feedType.value,
        avgWeight: parseFloat(form.avgWeight.value)
      });
      if (result) setState({ modal: null });
    };

    // Inventory Section Controls
    window.toggleInventorySection = (sectionId) => {
      const collapsed = state.inventoryCollapsed || {};
      collapsed[sectionId] = !collapsed[sectionId];
      setState({ inventoryCollapsed: { ...collapsed } });
    };

    window.collapseAllInventory = () => {
      setState({
        inventoryCollapsed: {
          fishTypes: true,
          feeds: true,
          supplements: true,
          medicines: true
        }
      });
    };

    window.expandAllInventory = () => {
      setState({ inventoryCollapsed: {} });
    };

    window.filterInventory = (query) => {
      const sections = document.getElementById('inventorySections');
      if (!sections) return;

      const items = sections.querySelectorAll('.bg-slate-800\\/40');
      const q = query.toLowerCase().trim();

      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (q === '' || text.includes(q)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    };

    window.editFishType = (id) => {
      const ft = db.fishTypes.getById(id);
      if (ft) {
        setState({ modal: 'editFishType', editingFishType: ft });
      }
    };

    window.updateFishType = (e, id) => {
      e.preventDefault();
      const form = e.target;
      db.fishTypes.update(id, {
        name: form.name.value,
        feedType: form.feedType.value,
        avgWeight: parseFloat(form.avgWeight.value)
      });
      setState({ modal: null, editingFishType: null });
    };

    window.deleteFishType = (id) => {
      showConfirm('ลบชนิดปลา?', 'ข้อมูลชนิดปลานี้จะถูกลบ', () => {
        db.fishTypes.delete(id);
        render();
      }, 'warning');
    };

    window.showFishTypeHistory = (id) => {
      const ft = db.fishTypes.getById(id);
      if (ft && ft.editHistory?.length > 0) {
        setState({ modal: 'fishTypeHistory', viewingFishTypeHistory: ft });
      }
    };

    window.createPond = (e) => {
      e.preventDefault();
      const form = e.target;
      const result = db.ponds.create(form.name.value);
      if (result) setState({ modal: null });
    };

    window.deletePond = (id) => {
      showConfirm('ลบบ่อ?', 'ข้อมูลทั้งหมดของบ่อนี้จะถูกลบ', () => {
        db.ponds.delete(id);
        setState({ selectedPond: null });
      }, 'danger');
    };

    window.startCycle = (e) => {
      e.preventDefault();
      const form = e.target;
      const fishType = db.fishTypes.getById(form.fishType.value);
      const result = db.cycles.create({
        pondId: state.selectedPond,
        fishType: form.fishType.value,
        fishTypeName: fishType?.name || form.fishType.value,
        startDate: form.startDate.value,
        initialCount: parseInt(form.count.value),
        initialWeight: parseFloat(form.initialWeight.value),
        pricePerFish: parseFloat(form.price.value),
        status: 'active'
      });
      if (result) setState({ modal: null });
    };

    window.addFeeding = (e) => {
      e.preventDefault();
      const form = e.target;
      const pond = db.ponds.getById(state.selectedPond);
      const cycle = db.cycles.getActive(pond?.id);
      if (!cycle) return;

      const isMedicineOnly = form.medicineOnly?.checked || false;
      const feedId = isMedicineOnly ? null : form.feedId?.value;
      const weightKg = isMedicineOnly ? 0 : parseFloat(form.weight.value);

      // Check stock before adding feeding (only if not medicine-only mode)
      if (!isMedicineOnly && feedId) {
        const currentStock = db.feedStock.getStock(feedId);
        if (currentStock < weightKg) {
          showToast(`สต็อกไม่เพียงพอ (เหลือ ${formatNumber(currentStock, 1)} กก.)`, 'error');
          return;
        }
      }

      const supplements = db.supplements.getAll();
      const selectedSupps = isMedicineOnly ? [] : supplements.filter(s => form[`supp_${s.id}`]?.checked).map(s => ({
        supplementId: s.id,
        amount: parseFloat(form[`suppAmt_${s.id}`]?.value || 100),
        unit: s.unit
      }));

      const medicines = db.medicines.getAll();
      const selectedMeds = medicines.filter(m => form[`med_${m.id}`]?.checked).map(m => ({
        medicineId: m.id,
        amount: parseFloat(form[`medAmt_${m.id}`]?.value || 10),
        unit: m.unit
      }));

      const result = db.feedingLogs.create({
        cycleId: cycle.id,
        date: new Date().toISOString(),
        time: form.time.value,
        feedId: feedId,
        weightKg: weightKg,
        supplements: selectedSupps,
        medicines: selectedMeds,
        medicineOnly: isMedicineOnly,
        notes: form.notes.value
      });

      // Deduct stock after successful feeding record
      if (result && !isMedicineOnly && feedId && weightKg > 0) {
        db.feedStock.deduct(feedId, weightKg);
      }

      if (result) setState({ modal: null });
    };

    window.addWaterQuality = (e) => {
      e.preventDefault();
      const form = e.target;
      const pond = db.ponds.getById(state.selectedPond);
      const cycle = db.cycles.getActive(pond?.id);
      if (!cycle) return;

      db.waterQuality.create({
        cycleId: cycle.id,
        date: new Date().toISOString(),
        time: form.time.value,
        temperature: form.temp.value ? parseFloat(form.temp.value) : null,
        doLevel: form.do.value ? parseFloat(form.do.value) : null,
        ph: form.ph.value ? parseFloat(form.ph.value) : null,
        notes: form.notes.value
      });
      setState({ modal: null });
    };

    window.addExpense = (e) => {
      e.preventDefault();
      const form = e.target;
      const pond = db.ponds.getById(state.selectedPond);
      const cycle = db.cycles.getActive(pond?.id);
      if (!cycle) return;

      const result = db.expenses.create({
        cycleId: cycle.id,
        date: form.date.value,
        category: form.category.value,
        description: form.description.value,
        amount: parseFloat(form.amount.value)
      });
      if (result) setState({ modal: null });
    };

    window.calculateHarvestCount = () => {
      const avgWeight = parseFloat(document.getElementById('harvestAvgWeight')?.value) || 150;
      const soldWeight = parseFloat(document.getElementById('harvestSoldWeight')?.value) || 0;
      const undersizedWeight = parseFloat(document.getElementById('harvestUndersizedWeight')?.value) || 0;

      // Calculate counts (weight in kg * 1000 / avgWeight in grams)
      const soldCount = avgWeight > 0 ? Math.round((soldWeight * 1000) / avgWeight) : 0;
      const undersizedCount = avgWeight > 0 ? Math.round((undersizedWeight * 1000) / avgWeight) : 0;
      const totalWeight = soldWeight + undersizedWeight;
      const totalCount = soldCount + undersizedCount;

      // Update display
      const soldCountEl = document.getElementById('soldCount');
      const undersizedCountEl = document.getElementById('undersizedCount');
      const totalWeightEl = document.getElementById('totalHarvestWeight');
      const totalCountEl = document.getElementById('totalHarvestCount');

      if (soldCountEl) soldCountEl.textContent = formatNumber(soldCount);
      if (undersizedCountEl) undersizedCountEl.textContent = formatNumber(undersizedCount);
      if (totalWeightEl) totalWeightEl.textContent = formatNumber(totalWeight, 1) + ' กก.';
      if (totalCountEl) totalCountEl.textContent = formatNumber(totalCount) + ' ตัว';
    };

    window.selectUndersizedAction = (action) => {
      const priceSection = document.getElementById('undersizedPriceSection');
      const actionText = document.getElementById('undersizedActionText');
      const sellRadio = document.getElementById('actionSell');
      const keepRadio = document.getElementById('actionKeep');

      if (action === 'sell') {
        priceSection?.classList.remove('hidden');
        if (actionText) actionText.textContent = '(ขาย)';
        if (sellRadio) sellRadio.checked = true;
        if (keepRadio) keepRadio.checked = false;
      } else {
        priceSection?.classList.add('hidden');
        if (actionText) actionText.textContent = '(เลี้ยงต่อ)';
        if (sellRadio) sellRadio.checked = false;
        if (keepRadio) keepRadio.checked = true;
      }
    };

    window.addHarvest = (e) => {
      e.preventDefault();
      const form = e.target;
      const pond = db.ponds.getById(state.selectedPond);
      const cycle = db.cycles.getActive(pond?.id);
      if (!cycle) return;

      const avgWeight = parseFloat(form.avgWeight.value) || 150;
      const soldWeight = parseFloat(form.soldWeight.value) || 0;
      const undersizedWeight = parseFloat(form.undersizedWeight.value) || 0;
      const soldPrice = parseFloat(form.soldPrice.value) || 0;
      const undersizedAction = form.undersizedAction?.value || 'keep';
      const undersizedPrice = undersizedAction === 'sell' ? (parseFloat(form.undersizedPrice?.value) || 0) : 0;

      // Calculate counts
      const soldCount = avgWeight > 0 ? Math.round((soldWeight * 1000) / avgWeight) : 0;
      const undersizedCount = avgWeight > 0 ? Math.round((undersizedWeight * 1000) / avgWeight) : 0;

      const totalWeight = soldWeight + undersizedWeight;
      const totalCount = soldCount + undersizedCount;

      // Calculate total revenue (undersized fish only if sold)
      const totalRevenue = (soldWeight * soldPrice) + (undersizedAction === 'sell' ? undersizedWeight * undersizedPrice : 0);

      const result = db.harvests.create({
        cycleId: cycle.id,
        date: form.date.value,
        avgWeightPerFish: avgWeight,
        weightKg: totalWeight,
        count: totalCount,
        soldWeight: soldWeight,
        soldCount: soldCount,
        soldPrice: soldPrice,
        undersizedWeight: undersizedWeight,
        undersizedCount: undersizedCount,
        undersizedPrice: undersizedPrice,
        undersizedAction: undersizedAction,
        pricePerKg: soldWeight > 0 ? soldPrice : undersizedPrice,
        totalRevenue: totalRevenue,
        isFinalHarvest: form.isFinal.checked
      });

      if (result) {
        if (form.isFinal.checked) {
          setState({ modal: null, selectedPond: null });
        } else {
          setState({ modal: null });
        }
      }
    };

    window.addFeed = (e) => {
      e.preventDefault();
      const form = e.target;
      const isPellet = form.type.value === 'pellet';
      const useBag = isPellet && form.useBag?.checked;
      const bagSize = useBag && form.bagSize && form.bagSize.value ? parseFloat(form.bagSize.value) : null;
      const result = db.feeds.create({
        type: form.type.value,
        name: form.name.value,
        brand: form.brand.value || null,
        sizeNumber: form.sizeNumber.value || null,
        useBag: useBag,
        bagSize: bagSize,
        pricePerKg: parseFloat(form.price.value)
      });
      if (result) setState({ modal: null });
    };

    window.addSupplement = (e) => {
      e.preventDefault();
      const form = e.target;
      const packageSize = parseFloat(form.packageSize.value);
      const price = parseFloat(form.price.value);
      const result = db.supplements.create({
        name: form.name.value,
        description: form.description.value,
        suppType: form.suppType.value,
        packageSize: packageSize,
        price: price,
        pricePerUnit: price / packageSize,
        unit: form.unit.value
      });
      if (result) setState({ modal: null });
    };

    window.deleteFeedingLog = (id) => {
      showConfirm('ลบมื้ออาหาร?', 'การดำเนินการนี้ไม่สามารถย้อนกลับได้', () => {
        db.feedingLogs.delete(id);
        render();
      }, 'warning');
    };

    window.editFeedingLog = (id) => {
      const logs = storage.get(KEYS.FEEDING_LOGS);
      const log = logs.find(l => l.id === id);
      if (log) {
        setState({ modal: 'editFeeding', editingLog: log });
      }
    };

    window.updateFeeding = (e, id) => {
      e.preventDefault();
      const form = e.target;
      db.feedingLogs.update(id, {
        time: form.time.value,
        feedId: form.feedId.value,
        weightKg: parseFloat(form.weight.value)
      });
      setState({ modal: null, editingLog: null });
    };

    window.deleteFeed = (id) => {
      showConfirm('ลบอาหาร?', 'ข้อมูลอาหารนี้จะถูกลบ', () => {
        db.feeds.delete(id);
        render();
      }, 'warning');
    };

    window.deleteSupplement = (id) => {
      showConfirm('ลบวิตามิน?', 'ข้อมูลวิตามินนี้จะถูกลบ', () => {
        db.supplements.delete(id);
        render();
      }, 'warning');
    };

    window.editFeed = (id) => {
      const feed = db.feeds.getAll().find(f => f.id === id);
      if (feed) {
        setState({ modal: 'editFeed', editingFeed: feed });
      }
    };

    window.viewFeedHistory = (id) => {
      const feed = db.feeds.getAll().find(f => f.id === id);
      if (feed && feed.editHistory && feed.editHistory.length > 0) {
        setState({ modal: 'feedHistory', viewingFeedHistory: feed });
      }
    };

    window.updateFeed = (e) => {
      e.preventDefault();
      const form = e.target;
      const isPellet = form.type.value === 'pellet';
      const useBag = isPellet && form.useBag?.checked;
      const bagSize = useBag && form.bagSize && form.bagSize.value ? parseFloat(form.bagSize.value) : null;
      db.feeds.update(state.editingFeed.id, {
        type: form.type.value,
        name: form.name.value,
        brand: form.brand.value || null,
        sizeNumber: form.sizeNumber.value || null,
        useBag: useBag,
        bagSize: bagSize,
        pricePerKg: parseFloat(form.price.value)
      });
      setState({ modal: null, editingFeed: null });
    };

    window.editSupplement = (id) => {
      const supp = db.supplements.getAll().find(s => s.id === id);
      if (supp) {
        setState({ modal: 'editSupplement', editingSupplement: supp });
      }
    };

    window.viewSupplementHistory = (id) => {
      const supp = db.supplements.getAll().find(s => s.id === id);
      if (supp && supp.editHistory && supp.editHistory.length > 0) {
        setState({ modal: 'supplementHistory', viewingSupplementHistory: supp });
      }
    };

    window.updateSupplement = (e) => {
      e.preventDefault();
      const form = e.target;
      const packageSize = parseFloat(form.packageSize.value);
      const price = parseFloat(form.price.value);
      db.supplements.update(state.editingSupplement.id, {
        name: form.name.value,
        description: form.description.value || null,
        suppType: form.suppType.value,
        packageSize: packageSize,
        price: price,
        pricePerUnit: price / packageSize,
        unit: form.unit.value
      });
      setState({ modal: null, editingSupplement: null });
    };

    // Medicine Functions
    window.addMedicine = (e) => {
      e.preventDefault();
      const form = e.target;
      const packageSize = parseFloat(form.packageSize.value);
      const price = parseFloat(form.price.value);
      const result = db.medicines.create({
        name: form.name.value,
        description: form.description.value,
        medType: form.medType.value,
        packageSize: packageSize,
        price: price,
        pricePerUnit: price / packageSize,
        unit: form.unit.value,
        usageDetails: form.usageDetails.value
      });
      if (result) setState({ modal: null });
    };

    window.deleteMedicine = (id) => {
      showConfirm('ลบยารักษาโรค?', 'ข้อมูลยานี้จะถูกลบ', () => {
        db.medicines.delete(id);
        render();
      }, 'warning');
    };

    window.editMedicine = (id) => {
      const med = db.medicines.getAll().find(m => m.id === id);
      if (med) {
        setState({ modal: 'editMedicine', editingMedicine: med });
      }
    };

    window.viewMedicineHistory = (id) => {
      const med = db.medicines.getAll().find(m => m.id === id);
      if (med && med.editHistory && med.editHistory.length > 0) {
        setState({ modal: 'medicineHistory', viewingMedicineHistory: med });
      }
    };

    window.updateMedicine = (e, id) => {
      e.preventDefault();
      const form = e.target;
      const packageSize = parseFloat(form.packageSize.value) || 0;
      const price = parseFloat(form.price.value) || 0;
      db.medicines.update(id, {
        name: form.name.value,
        description: form.description.value || null,
        medType: form.medType.value,
        packageSize: packageSize,
        price: price,
        pricePerUnit: packageSize > 0 ? price / packageSize : 0,
        unit: form.unit.value,
        usageDetails: form.usageDetails.value
      });
      setState({ modal: null, editingMedicine: null });
    };

    window.selectMedType = (type) => {
      const btnLiquid = document.getElementById('btnMedLiquid');
      const btnSolid = document.getElementById('btnMedSolid');
      const hiddenInput = document.querySelector('input[name="medType"]');
      const unitSelect = document.getElementById('medUnitSelect');

      if (type === 'liquid') {
        btnLiquid.className = 'flex-1 p-3 rounded-xl border bg-blue-500/20 border-blue-500/50 text-blue-400 transition-colors';
        btnSolid.className = 'flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors';
        if (unitSelect) unitSelect.value = 'มล.';
      } else {
        btnSolid.className = 'flex-1 p-3 rounded-xl border bg-rose-500/20 border-rose-500/50 text-rose-400 transition-colors';
        btnLiquid.className = 'flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors';
        if (unitSelect) unitSelect.value = 'กรัม';
      }
      if (hiddenInput) hiddenInput.value = type;
    };

    // Mortality Functions
    window.addMortality = (e) => {
      e.preventDefault();
      const form = e.target;
      const pond = db.ponds.getById(state.selectedPond);
      const cycle = db.cycles.getActive(pond?.id);
      if (!cycle) return;

      const result = db.mortalities.create({
        cycleId: cycle.id,
        date: form.date.value,
        count: parseInt(form.count.value),
        reason: form.reason.value || null
      });
      if (result) {
        form.count.value = '';
        form.reason.value = '';
        render();
      }
    };

    window.deleteMortality = (id) => {
      showConfirm('ลบบันทึกปลาตาย?', 'การดำเนินการนี้ไม่สามารถย้อนกลับได้', () => {
        db.mortalities.delete(id);
        render();
      }, 'warning');
    };

    // Feed Stock Functions
    window.addFeedStock = (e) => {
      e.preventDefault();
      const form = e.target;
      const feedId = form.feedId.value;
      const quantity = parseFloat(form.quantity.value);
      const note = form.note?.value || '';

      if (db.feedStock.add(feedId, quantity, note)) {
        setState({ modal: null });
      }
    };

    window.showAddStockForm = (feedId) => {
      const btnAdd = document.getElementById('btnAddStock');
      const btnSet = document.getElementById('btnSetStock');
      const label = document.getElementById('stockLabel');
      const submitBtn = document.getElementById('stockSubmitBtn');
      const form = document.getElementById('stockForm');

      btnAdd.className = 'p-3 rounded-xl border bg-green-500/20 border-green-500/50 text-green-400 transition-colors text-sm font-medium';
      btnSet.className = 'p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors text-sm font-medium';
      label.innerHTML = 'จำนวนที่เพิ่ม (กก.) <span class="text-red-400">*</span>';
      submitBtn.textContent = '+ เพิ่มสต็อก';
      submitBtn.className = 'w-full py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl font-medium transition-colors';
      form.querySelector('[name=action]').value = 'add';
      form.querySelector('[name=quantity]').value = '';
      form.querySelector('[name=quantity]').min = '0.1';
    };

    window.showSetStockForm = (feedId) => {
      const btnAdd = document.getElementById('btnAddStock');
      const btnSet = document.getElementById('btnSetStock');
      const label = document.getElementById('stockLabel');
      const submitBtn = document.getElementById('stockSubmitBtn');
      const form = document.getElementById('stockForm');
      const currentStock = db.feedStock.getStock(feedId);

      btnSet.className = 'p-3 rounded-xl border bg-cyan-500/20 border-cyan-500/50 text-cyan-400 transition-colors text-sm font-medium';
      btnAdd.className = 'p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors text-sm font-medium';
      label.innerHTML = 'ตั้งค่าจำนวนใหม่ (กก.) <span class="text-red-400">*</span>';
      submitBtn.textContent = '💾 บันทึก';
      submitBtn.className = 'w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors';
      form.querySelector('[name=action]').value = 'set';
      form.querySelector('[name=quantity]').value = currentStock;
      form.querySelector('[name=quantity]').min = '0';
    };

    window.submitStockEdit = (e, feedId) => {
      e.preventDefault();
      const form = e.target;
      const action = form.action.value;
      const quantity = parseFloat(form.quantity.value);

      if (action === 'add') {
        if (db.feedStock.add(feedId, quantity)) {
          setState({ modal: null, editingStockFeedId: null });
        }
      } else {
        if (db.feedStock.setQuantity(feedId, quantity)) {
          setState({ modal: null, editingStockFeedId: null });
        }
      }
    };

    // Stock History Functions
    window.loadMoreStockHistory = () => {
      const currentLimit = state.stockHistoryLimit || 20;
      setState({ stockHistoryLimit: currentLimit + 20 });
    };

    window.downloadStockHistory = () => {
      const stocks = db.feedStock.getAll();
      const feeds = db.feeds.getAll();

      // Collect all history
      const allHistory = [];
      stocks.forEach(stock => {
        const feed = feeds.find(f => f.id === stock.feedId);
        if (stock.history && feed) {
          stock.history.forEach(h => {
            allHistory.push({
              ...h,
              feedName: feed.name,
              feedType: feed.type
            });
          });
        }
      });

      // Sort by date descending
      allHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

      // Calculate summary
      let totalAdd = 0, totalDeduct = 0;
      const byFeed = {};
      allHistory.forEach(h => {
        if (h.type === 'add') totalAdd += h.quantity;
        if (h.type === 'deduct') totalDeduct += h.quantity;
        if (!byFeed[h.feedName]) byFeed[h.feedName] = { add: 0, deduct: 0, type: h.feedType };
        if (h.type === 'add') byFeed[h.feedName].add += h.quantity;
        if (h.type === 'deduct') byFeed[h.feedName].deduct += h.quantity;
      });

      // Generate report
      const now = new Date();
      const dateStr = now.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });

      let report = `รายงานประวัติคลังอาหาร\n`;
      report += `วันที่ออกรายงาน: ${dateStr}\n`;
      report += `${'='.repeat(50)}\n\n`;

      report += `📊 สรุปภาพรวม\n`;
      report += `-`.repeat(30) + `\n`;
      report += `เพิ่มทั้งหมด: ${formatNumber(totalAdd, 1)} กก.\n`;
      report += `ใช้ทั้งหมด: ${formatNumber(totalDeduct, 1)} กก.\n`;
      report += `สุทธิ: ${formatNumber(totalAdd - totalDeduct, 1)} กก.\n\n`;

      report += `📦 สรุปตามอาหาร\n`;
      report += `-`.repeat(30) + `\n`;
      Object.entries(byFeed).forEach(([name, data]) => {
        const typeIcon = data.type === 'fresh' ? '🟠' : '🔵';
        report += `${typeIcon} ${name}\n`;
        report += `   เพิ่ม: +${formatNumber(data.add, 1)} กก. | ใช้: -${formatNumber(data.deduct, 1)} กก.\n`;
      });

      report += `\n📋 รายการทั้งหมด (${allHistory.length} รายการ)\n`;
      report += `-`.repeat(30) + `\n`;
      allHistory.forEach(h => {
        const date = new Date(h.date);
        const dateStr = date.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: '2-digit' });
        const timeStr = date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
        const typeIcon = h.feedType === 'fresh' ? '🟠' : '🔵';
        const actionIcon = h.type === 'add' ? '➕' : h.type === 'deduct' ? '➖' : '🔄';
        const qty = h.type === 'adjust' ? `${formatNumber(h.oldQuantity, 1)} → ${formatNumber(h.newQuantity, 1)}` : formatNumber(h.quantity, 1);
        report += `${dateStr} ${timeStr} | ${typeIcon} ${h.feedName} | ${actionIcon} ${qty} กก.${h.note ? ` (${h.note})` : ''}\n`;
      });

      // Download as text file
      const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `stock-history-${now.toISOString().split('T')[0]}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('ดาวน์โหลดรายงานสำเร็จ', 'success');
    };

    // Export Functions
    window.exportFeedingData = () => {
      const feedingLogs = storage.get(KEYS.FEEDING_LOGS);
      const feeds = db.feeds.getAll();
      const supplements = db.supplements.getAll();
      const medicines = db.medicines.getAll();
      const ponds = db.ponds.getAll();
      const cycles = storage.get(KEYS.CYCLES);

      if (feedingLogs.length === 0) {
        showToast('ไม่มีข้อมูลการให้อาหาร', 'error');
        return;
      }

      const now = new Date();
      const dateStr = now.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });

      // Generate detailed report
      let report = `รายงานการให้อาหาร - Fish Farm Pro\n`;
      report += `วันที่ออกรายงาน: ${dateStr}\n`;
      report += `${'='.repeat(60)}\n\n`;

      // Summary
      const totalFeedings = feedingLogs.filter(l => !l.medicineOnly).length;
      const totalWeight = feedingLogs.reduce((s, l) => s + (l.weightKg || 0), 0);
      const medicineOnlyCount = feedingLogs.filter(l => l.medicineOnly).length;

      report += `📊 สรุปภาพรวม\n`;
      report += `-`.repeat(40) + `\n`;
      report += `จำนวนมื้ออาหารทั้งหมด: ${totalFeedings} มื้อ\n`;
      report += `น้ำหนักอาหารรวม: ${formatNumber(totalWeight, 2)} กก.\n`;
      report += `จำนวนครั้งให้ยา (ไม่มีอาหาร): ${medicineOnlyCount} ครั้ง\n\n`;

      // Group by pond/cycle
      const byCycle = {};
      feedingLogs.forEach(log => {
        if (!byCycle[log.cycleId]) byCycle[log.cycleId] = [];
        byCycle[log.cycleId].push(log);
      });

      Object.entries(byCycle).forEach(([cycleId, logs]) => {
        const cycle = cycles.find(c => c.id === cycleId);
        const pond = cycle ? ponds.find(p => p.id === cycle.pondId) : null;
        const pondName = pond?.name || 'บ่อไม่ระบุ';
        const cycleStart = cycle ? new Date(cycle.startDate).toLocaleDateString('th-TH') : '-';

        report += `\n🔲 ${pondName} (เริ่ม: ${cycleStart})\n`;
        report += `-`.repeat(40) + `\n`;

        const cycleWeight = logs.reduce((s, l) => s + (l.weightKg || 0), 0);
        report += `รวม: ${logs.length} มื้อ, ${formatNumber(cycleWeight, 2)} กก.\n\n`;

        logs.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(log => {
          const date = new Date(log.date);
          const dateStr = date.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: '2-digit' });
          const feed = feeds.find(f => f.id === log.feedId);
          const feedName = feed?.name || (log.medicineOnly ? 'ให้ยาอย่างเดียว' : '-');

          report += `${dateStr} ${log.time} | ${feedName}`;
          if (!log.medicineOnly) report += ` | ${formatNumber(log.weightKg, 2)} กก.`;

          // Supplements
          if (log.supplements?.length > 0) {
            const suppList = log.supplements.map(s => {
              const supp = supplements.find(sp => sp.id === s.supplementId);
              return `${supp?.name || '-'} ${s.amount}${s.unit}`;
            }).join(', ');
            report += ` | วิตามิน: ${suppList}`;
          }

          // Medicines
          if (log.medicines?.length > 0) {
            const medList = log.medicines.map(m => {
              const med = medicines.find(md => md.id === m.medicineId);
              return `${med?.name || '-'} ${m.amount}${m.unit}`;
            }).join(', ');
            report += ` | ยา: ${medList}`;
          }

          if (log.notes) report += ` | หมายเหตุ: ${log.notes}`;
          report += `\n`;

          // Edit history
          if (log.editHistory?.length > 0) {
            log.editHistory.forEach(h => {
              const editDate = new Date(h.editedAt).toLocaleDateString('th-TH');
              report += `   └ แก้ไขเมื่อ ${editDate}: ${formatNumber(h.prev.weightKg, 2)} กก. → ปัจจุบัน\n`;
            });
          }
        });
      });

      // Download
      downloadFile(report, `feeding-data-${now.toISOString().split('T')[0]}.txt`, 'text/plain');
      showToast('ส่งออกข้อมูลการให้อาหารสำเร็จ', 'success');
    };

    window.exportStockData = () => {
      const stocks = db.feedStock.getAll();
      const feeds = db.feeds.getAll();

      if (stocks.length === 0) {
        showToast('ไม่มีข้อมูลคลังอาหาร', 'error');
        return;
      }

      const now = new Date();
      const dateStr = now.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });

      let report = `รายงานคลังอาหาร - Fish Farm Pro\n`;
      report += `วันที่ออกรายงาน: ${dateStr}\n`;
      report += `${'='.repeat(60)}\n\n`;

      // Current stock summary
      report += `📦 สต็อกปัจจุบัน\n`;
      report += `-`.repeat(40) + `\n`;

      let totalStock = 0;
      stocks.forEach(stock => {
        const feed = feeds.find(f => f.id === stock.feedId);
        if (feed) {
          const typeIcon = feed.type === 'fresh' ? '🟠' : '🔵';
          report += `${typeIcon} ${feed.name}: ${formatNumber(stock.stock, 2)} กก.\n`;
          totalStock += stock.stock;
        }
      });
      report += `\nรวมทั้งหมด: ${formatNumber(totalStock, 2)} กก.\n\n`;

      // History by feed
      stocks.forEach(stock => {
        const feed = feeds.find(f => f.id === stock.feedId);
        if (!feed || !stock.history?.length) return;

        const typeIcon = feed.type === 'fresh' ? '🟠' : '🔵';
        report += `\n${typeIcon} ${feed.name} - ประวัติการเปลี่ยนแปลง\n`;
        report += `-`.repeat(40) + `\n`;

        const totalAdd = stock.history.filter(h => h.type === 'add').reduce((s, h) => s + h.quantity, 0);
        const totalDeduct = stock.history.filter(h => h.type === 'deduct').reduce((s, h) => s + h.quantity, 0);
        report += `สรุป: เพิ่ม ${formatNumber(totalAdd, 2)} กก. | ใช้ ${formatNumber(totalDeduct, 2)} กก.\n\n`;

        stock.history.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(h => {
          const date = new Date(h.date);
          const dateStr = date.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: '2-digit' });
          const timeStr = date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
          const actionIcon = h.type === 'add' ? '➕' : h.type === 'deduct' ? '➖' : '🔄';
          const qty = h.type === 'adjust' ? `${formatNumber(h.oldQuantity, 2)} → ${formatNumber(h.newQuantity, 2)}` : formatNumber(h.quantity, 2);

          report += `${dateStr} ${timeStr} | ${actionIcon} ${qty} กก.`;
          if (h.note) report += ` | ${h.note}`;
          if (h.pondName) report += ` | บ่อ: ${h.pondName}`;
          report += `\n`;
        });
      });

      downloadFile(report, `stock-data-${now.toISOString().split('T')[0]}.txt`, 'text/plain');
      showToast('ส่งออกข้อมูลคลังอาหารสำเร็จ', 'success');
    };

    window.exportAllDataCSV = () => {
      const feedingLogs = storage.get(KEYS.FEEDING_LOGS);
      const stocks = db.feedStock.getAll();
      const feeds = db.feeds.getAll();
      const ponds = db.ponds.getAll();
      const cycles = storage.get(KEYS.CYCLES);
      const supplements = db.supplements.getAll();
      const medicines = db.medicines.getAll();

      const now = new Date();

      // Feeding Logs CSV
      let feedingCSV = 'วันที่,เวลา,บ่อ,ชนิดปลา,อาหาร,น้ำหนัก(กก.),วิตามิน,ยา,หมายเหตุ\n';
      feedingLogs.forEach(log => {
        const cycle = cycles.find(c => c.id === log.cycleId);
        const pond = cycle ? ponds.find(p => p.id === cycle.pondId) : null;
        const feed = feeds.find(f => f.id === log.feedId);
        const date = new Date(log.date).toLocaleDateString('th-TH');
        const suppList = (log.supplements || []).map(s => {
          const supp = supplements.find(sp => sp.id === s.supplementId);
          return `${supp?.name || '-'}(${s.amount}${s.unit})`;
        }).join('; ');
        const medList = (log.medicines || []).map(m => {
          const med = medicines.find(md => md.id === m.medicineId);
          return `${med?.name || '-'}(${m.amount}${m.unit})`;
        }).join('; ');

        feedingCSV += `"${date}","${log.time}","${pond?.name || '-'}","${cycle?.fishType || '-'}","${feed?.name || (log.medicineOnly ? 'ให้ยาอย่างเดียว' : '-')}",${log.weightKg || 0},"${suppList}","${medList}","${log.notes || ''}"\n`;
      });

      // Stock History CSV
      let stockCSV = 'วันที่,เวลา,อาหาร,ประเภท,การกระทำ,จำนวน(กก.),หมายเหตุ,บ่อ\n';
      stocks.forEach(stock => {
        const feed = feeds.find(f => f.id === stock.feedId);
        if (!feed || !stock.history) return;

        stock.history.forEach(h => {
          const date = new Date(h.date);
          const dateStr = date.toLocaleDateString('th-TH');
          const timeStr = date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
          const action = h.type === 'add' ? 'เพิ่ม' : h.type === 'deduct' ? 'ใช้' : 'ปรับ';
          const qty = h.type === 'adjust' ? `${h.oldQuantity} → ${h.newQuantity}` : h.quantity;

          stockCSV += `"${dateStr}","${timeStr}","${feed.name}","${feed.type === 'fresh' ? 'อาหารสด' : 'อาหารเม็ด'}","${action}",${qty},"${h.note || ''}","${h.pondName || ''}"\n`;
        });
      });

      // Create zip-like combined file
      const combined = `=== ข้อมูลการให้อาหาร ===\n${feedingCSV}\n\n=== ข้อมูลคลังอาหาร ===\n${stockCSV}`;

      downloadFile(combined, `fish-farm-data-${now.toISOString().split('T')[0]}.csv`, 'text/csv');
      showToast('ส่งออกข้อมูล CSV สำเร็จ', 'success');
    };

    window.exportAllDataJSON = () => {
      const allData = {
        exportDate: new Date().toISOString(),
        appVersion: 'Fish Farm Pro v1.2',
        data: {
          ponds: db.ponds.getAll(),
          fishTypes: db.fishTypes.getAll(),
          feeds: db.feeds.getAll(),
          supplements: db.supplements.getAll(),
          medicines: db.medicines.getAll(),
          cycles: storage.get(KEYS.CYCLES),
          feedingLogs: storage.get(KEYS.FEEDING_LOGS),
          feedStock: db.feedStock.getAll(),
          waterQuality: storage.get(KEYS.WATER_QUALITY),
          expenses: storage.get(KEYS.EXPENSES),
          harvests: storage.get(KEYS.HARVESTS)
        }
      };

      const json = JSON.stringify(allData, null, 2);
      downloadFile(json, `fish-farm-backup-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
      showToast('สำรองข้อมูลสำเร็จ', 'success');
    };

    // Helper function to download files
    const downloadFile = (content, filename, mimeType) => {
      const blob = new Blob([content], { type: `${mimeType};charset=utf-8` });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    // Stock Password Functions
    window.requestDeleteStock = (feedId) => {
      setState({ modal: 'stockPasswordConfirm', pendingStockDelete: feedId });
    };

    window.confirmDeleteStock = (e, feedId) => {
      e.preventDefault();
      const form = e.target;
      const password = form.password.value;

      if (db.stockPassword.check(password)) {
        executeDeleteStock(feedId);
      } else {
        showToast('รหัสผ่านไม่ถูกต้อง', 'error');
      }
    };

    window.executeDeleteStock = (feedId) => {
      db.feedStock.delete(feedId);
      showToast('ลบสต็อกสำเร็จ', 'success');
      setState({ modal: null, pendingStockDelete: null });
    };

    window.setStockPassword = (e) => {
      e.preventDefault();
      const form = e.target;
      const password = form.password.value;
      const confirmPassword = form.confirmPassword.value;

      if (password !== confirmPassword) {
        showToast('รหัสผ่านไม่ตรงกัน', 'error');
        return;
      }

      if (password.length < 4) {
        showToast('รหัสผ่านต้องมีอย่างน้อย 4 ตัว', 'error');
        return;
      }

      db.stockPassword.set(password);
      render();
    };

    window.changeStockPassword = (e) => {
      e.preventDefault();
      const form = e.target;
      const oldPassword = form.oldPassword.value;
      const newPassword = form.newPassword.value;
      const confirmPassword = form.confirmPassword.value;

      if (newPassword !== confirmPassword) {
        showToast('รหัสผ่านใหม่ไม่ตรงกัน', 'error');
        return;
      }

      if (newPassword.length < 4) {
        showToast('รหัสผ่านต้องมีอย่างน้อย 4 ตัว', 'error');
        return;
      }

      if (db.stockPassword.change(oldPassword, newPassword)) {
        render();
      }
    };

    window.disableStockPassword = (e) => {
      e.preventDefault();
      const form = e.target;
      const password = form.password.value;

      if (db.stockPassword.check(password)) {
        db.stockPassword.disable();
        render();
      } else {
        showToast('รหัสผ่านไม่ถูกต้อง', 'error');
      }
    };

    window.resetPond = () => {
      showConfirm('รีเซ็ตบ่อ?', 'ข้อมูลทั้งหมดของรอบนี้จะถูกลบ!', () => {
        db.cycles.reset(state.selectedPond);
        render();
      }, 'danger');
    };

    // Theme Functions
    window.getCurrentTheme = () => {
      return localStorage.getItem('ff_theme') || 'dark';
    };

    window.setTheme = (theme) => {
      localStorage.setItem('ff_theme', theme);
      if (theme === 'pastel') {
        document.body.classList.add('pastel-theme');
      } else {
        document.body.classList.remove('pastel-theme');
      }
      render();
      showToast(theme === 'pastel' ? 'เปลี่ยนเป็นธีมพาสเทล' : 'เปลี่ยนเป็นธีมมืด', 'success');
    };

    window.initTheme = () => {
      const theme = getCurrentTheme();
      if (theme === 'pastel') {
        document.body.classList.add('pastel-theme');
      }
    };

    window.clearAllData = () => {
      showConfirm('ล้างข้อมูลทั้งหมด?', 'การดำเนินการนี้ไม่สามารถย้อนกลับได้!', () => {
        Object.values(KEYS).forEach(key => localStorage.removeItem(key));
        showToast('ล้างข้อมูลสำเร็จ', 'success');
        setTimeout(() => location.reload(), 500);
      }, 'danger');
    };

    window.exportReport = (type) => {
      const ponds = db.ponds.getAll();
      const feeds = db.feeds.getAll();

      if (type === 'json') {
        const backup = {};
        Object.entries(KEYS).forEach(([name, key]) => {
          backup[name] = storage.get(key);
        });
        backup.exportDate = new Date().toISOString();
        backup.version = '1.1';

        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `fish-farm-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('สำรองข้อมูลสำเร็จ', 'success');
        return;
      }

      let report = '=== รายงานสรุปฟาร์ม ===\n';
      report += `วันที่: ${formatDate(new Date())}\n\n`;

      ponds.forEach(pond => {
        const cycle = db.cycles.getActive(pond.id);
        if (cycle) {
          const stats = calculations.getCycleStats(cycle.id);
          report += `📍 ${pond.name}\n`;
          report += `   ชนิด: ${cycle.fishTypeName}\n`;
          report += `   วันที่เลี้ยง: ${stats.days} วัน\n`;
          report += `   จำนวนปล่อย: ${formatNumber(cycle.initialCount)} ตัว\n`;
          report += `   อาหารรวม: ${formatNumber(stats.totalFeed, 1)} กก.\n`;
          report += `   FCR: ${stats.fcr}\n`;
          report += `   ต้นทุน: ${formatCurrency(stats.totalCost)}\n\n`;
        }
      });

      const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `fish-farm-report-${new Date().toISOString().split('T')[0]}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('ส่งออกรายงานสำเร็จ', 'success');
    };

    window.importData = (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (!data.version) {
            showToast('ไฟล์ไม่ถูกต้อง', 'error');
            return;
          }

          showConfirm('นำเข้าข้อมูล?', 'ข้อมูลปัจจุบันจะถูกแทนที่ด้วยข้อมูลจากไฟล์', () => {
            Object.entries(KEYS).forEach(([name, key]) => {
              if (data[name]) {
                storage.set(key, data[name]);
              }
            });
            showToast('นำเข้าข้อมูลสำเร็จ', 'success');
            setTimeout(() => location.reload(), 500);
          }, 'warning');
        } catch (err) {
          showToast('ไม่สามารถอ่านไฟล์ได้', 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    };

    // ===== Initialize =====
    initData();
    initTheme();
    render();

    // ===== PWA Service Worker Registration =====
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then((registration) => {
            console.log('ServiceWorker registered:', registration.scope);
          })
          .catch((error) => {
            console.log('ServiceWorker registration failed:', error);
          });
      });
    }

    // ===== PWA Install Prompt =====
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      // Show install button in settings if available
      console.log('PWA install available');
    });

    window.installPWA = () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            showToast('ติดตั้งแอพสำเร็จ!', 'success');
          }
          deferredPrompt = null;
        });
      }
    };

    // ===== Cloud Sync is handled by firebase-sync.js =====
    // Manual sync functions use cloudSync from firebase-sync.js
    window.manualSyncUpload = async () => {
      if (!window.cloudSync?.isOnline()) {
        showToast('ไม่สามารถเชื่อมต่อ Cloud ได้', 'error');
        return;
      }
      showConfirm('📤 อัพโหลดข้อมูล', 'ข้อมูลในเครื่องจะถูกส่งไปแทนที่ข้อมูลบน Cloud', async () => {
        showToast('กำลังอัพโหลด...', 'info');
        await window.cloudSync.syncToCloud();
        showToast('✅ อัพโหลดสำเร็จ', 'success');
      }, 'warning');
    };

    window.manualSyncDownload = async () => {
      showConfirm('📥 ดาวน์โหลดข้อมูล', '⚠️ ข้อมูลในเครื่องจะถูกแทนที่ด้วยข้อมูลจาก Cloud', async () => {
        showToast('กำลังดาวน์โหลด...', 'info');
        await window.cloudSync.syncFromCloud();
        showToast('✅ ดาวน์โหลดสำเร็จ', 'success');
        render();
      }, 'warning');
    };

    window.confirmResetFirebase = () => {
      window.cloudSync?.reset();
    };

    // Show cloud sync setup
    window.showFirebaseSetupWizard = () => {
      window.cloudSync?.showSetup();
    };

    window.showFirebaseSetup = () => {
      window.cloudSync?.showSetup();
    };
  </script>

  <!-- Cloud Sync Module -->
  <script src="firebase-sync.js"></script>
</body>
</html>
