<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Fish Farm Pro - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏õ‡∏•‡∏≤</title>

  <!-- PWA Meta Tags -->
  <meta name="description" content="‡πÅ‡∏≠‡∏û‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏õ‡∏•‡∏≤ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ô‡πâ‡∏≥ ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢">
  <meta name="theme-color" content="#0ea5e9">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Fish Farm">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Fish Farm Pro">
  <meta name="msapplication-TileColor" content="#0ea5e9">
  <meta name="msapplication-tap-highlight" content="no">

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Icons -->
  <link rel="icon" type="image/svg+xml" href="icons/icon.svg">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-192x192.png">

  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Cloud Database SDKs (Multi-Provider Support) -->
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- PocketBase -->
  <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.1/dist/pocketbase.umd.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700&display=swap');
    * { font-family: 'IBM Plex Sans Thai', -apple-system, sans-serif; }

    /* Default Dark Theme */
    :root {
      --bg-gradient-1: #0f172a;
      --bg-gradient-2: #1e293b;
      --scrollbar-track: #1e293b;
      --scrollbar-thumb: #475569;
      --text-color: #e2e8f0;
    }

    /* Pastel Blue Theme - readable version */
    body.pastel-theme {
      --bg-gradient-1: #bfdbfe;
      --bg-gradient-2: #dbeafe;
      --scrollbar-track: #93c5fd;
      --scrollbar-thumb: #3b82f6;
      --text-color: #1e293b;
    }
    body.pastel-theme { color: var(--text-color) !important; }
    /* Text colors - dark for readability */
    body.pastel-theme .text-slate-100 { color: #0f172a !important; }
    body.pastel-theme .text-slate-200 { color: #1e293b !important; }
    body.pastel-theme .text-slate-300 { color: #334155 !important; }
    body.pastel-theme .text-slate-400 { color: #475569 !important; }
    body.pastel-theme .text-slate-500 { color: #64748b !important; }
    /* Background colors - use white/light with shadows for contrast */
    body.pastel-theme .bg-slate-700 { background-color: rgba(255, 255, 255, 0.9) !important; color: #1e293b !important; }
    body.pastel-theme .bg-slate-700\/30 { background-color: rgba(255, 255, 255, 0.7) !important; }
    body.pastel-theme .bg-slate-700\/50 { background-color: rgba(255, 255, 255, 0.8) !important; }
    body.pastel-theme .bg-slate-800 { background-color: #ffffff !important; }
    body.pastel-theme .bg-slate-800\/50 { background-color: rgba(255, 255, 255, 0.95) !important; }
    body.pastel-theme .bg-slate-900 { background-color: #f8fafc !important; }
    body.pastel-theme .bg-slate-900\/95 { background-color: rgba(248, 250, 252, 0.98) !important; }
    body.pastel-theme .bg-slate-600 { background-color: rgba(255, 255, 255, 0.85) !important; color: #1e293b !important; }
    /* Borders */
    body.pastel-theme .border-slate-500 { border-color: #93c5fd !important; }
    body.pastel-theme .border-slate-600 { border-color: #bfdbfe !important; }
    body.pastel-theme .border-slate-700 { border-color: #e2e8f0 !important; }
    body.pastel-theme .border-slate-700\/50 { border-color: rgba(203, 213, 225, 0.8) !important; }
    body.pastel-theme .hover\:bg-slate-700:hover { background-color: rgba(255, 255, 255, 0.95) !important; }
    body.pastel-theme .hover\:bg-slate-700\/50:hover { background-color: rgba(255, 255, 255, 0.9) !important; }
    /* Pastel accent colors - vibrant for readability */
    body.pastel-theme .text-cyan-400 { color: #0284c7 !important; }
    body.pastel-theme .text-cyan-500 { color: #0369a1 !important; }
    body.pastel-theme .bg-cyan-500 { background-color: #0ea5e9 !important; color: #ffffff !important; }
    body.pastel-theme .bg-cyan-500\/20 { background-color: rgba(14, 165, 233, 0.2) !important; }
    body.pastel-theme .hover\:bg-cyan-500\/30:hover { background-color: rgba(14, 165, 233, 0.3) !important; }
    body.pastel-theme .hover\:bg-cyan-600:hover { background-color: #0284c7 !important; }
    body.pastel-theme .text-rose-400 { color: #e11d48 !important; }
    body.pastel-theme .text-rose-300 { color: #f43f5e !important; }
    body.pastel-theme .bg-rose-500 { background-color: #f43f5e !important; color: #ffffff !important; }
    body.pastel-theme .bg-rose-500\/20 { background-color: rgba(244, 63, 94, 0.2) !important; }
    body.pastel-theme .bg-rose-500\/10 { background-color: rgba(244, 63, 94, 0.15) !important; }
    body.pastel-theme .text-amber-400 { color: #d97706 !important; }
    body.pastel-theme .bg-amber-500\/20 { background-color: rgba(245, 158, 11, 0.2) !important; }
    body.pastel-theme .bg-amber-500\/10 { background-color: rgba(245, 158, 11, 0.15) !important; }
    body.pastel-theme .hover\:bg-amber-500\/30:hover { background-color: rgba(245, 158, 11, 0.3) !important; }
    body.pastel-theme .text-green-400 { color: #16a34a !important; }
    body.pastel-theme .bg-green-500\/20 { background-color: rgba(34, 197, 94, 0.2) !important; }
    body.pastel-theme .hover\:bg-green-500\/30:hover { background-color: rgba(34, 197, 94, 0.3) !important; }
    body.pastel-theme .text-blue-400 { color: #2563eb !important; }
    body.pastel-theme .bg-blue-500\/20 { background-color: rgba(59, 130, 246, 0.2) !important; }
    body.pastel-theme .hover\:bg-blue-500\/30:hover { background-color: rgba(59, 130, 246, 0.3) !important; }
    body.pastel-theme .text-red-400 { color: #dc2626 !important; }
    body.pastel-theme .bg-red-500 { background-color: #ef4444 !important; color: #ffffff !important; }
    body.pastel-theme .bg-red-500\/20 { background-color: rgba(239, 68, 68, 0.2) !important; }
    body.pastel-theme .bg-red-500\/10 { background-color: rgba(239, 68, 68, 0.15) !important; }
    body.pastel-theme .hover\:bg-red-500\/20:hover { background-color: rgba(239, 68, 68, 0.25) !important; }
    body.pastel-theme .hover\:bg-red-500\/30:hover { background-color: rgba(239, 68, 68, 0.35) !important; }
    /* Input text colors */
    body.pastel-theme input, body.pastel-theme select, body.pastel-theme textarea {
      color: #1e293b !important;
      background-color: rgba(255, 255, 255, 0.9) !important;
    }
    body.pastel-theme input::placeholder { color: #94a3b8 !important; }
    /* Font weight for better readability */
    body.pastel-theme .font-medium { font-weight: 600 !important; }
    body.pastel-theme .font-semibold { font-weight: 700 !important; }
    body.pastel-theme .font-bold { font-weight: 800 !important; }
    /* Card backgrounds - white with shadow for contrast */
    body.pastel-theme .bg-slate-800\/50 { background-color: rgba(255, 255, 255, 0.85) !important; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important; }
    body.pastel-theme .bg-slate-700\/30 { background-color: rgba(255, 255, 255, 0.75) !important; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06) !important; }
    body.pastel-theme .bg-slate-700\/50 { background-color: rgba(255, 255, 255, 0.8) !important; }
    body.pastel-theme .text-xs.text-slate-400 { color: #64748b !important; }
    body.pastel-theme .text-xs.text-slate-500 { color: #94a3b8 !important; }
    /* Cards and sections with shadow */
    body.pastel-theme .rounded-2xl.border { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important; background-color: rgba(255, 255, 255, 0.9) !important; }
    body.pastel-theme .rounded-xl.border { box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06) !important; }
    /* Stats boxes - white bg for contrast */
    body.pastel-theme .bg-slate-700\/30.rounded-xl.p-3 { background-color: rgba(255, 255, 255, 0.8) !important; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important; }
    body.pastel-theme .bg-slate-700\/30.rounded-xl.p-2 { background-color: rgba(255, 255, 255, 0.8) !important; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important; }
    /* Modal background */
    body.pastel-theme .bg-slate-800 { background-color: #ffffff !important; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15) !important; }
    /* Bottom nav */
    body.pastel-theme nav.fixed.bottom-0 { background-color: rgba(255, 255, 255, 0.98) !important; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.08) !important; }
    /* Header */
    body.pastel-theme header { background-color: rgba(255, 255, 255, 0.98) !important; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06) !important; }
    /* Text on colored buttons */
    body.pastel-theme .bg-cyan-500\/20 .text-cyan-400 { color: #0369a1 !important; }
    body.pastel-theme .bg-blue-500\/20 .text-blue-400 { color: #1d4ed8 !important; }
    body.pastel-theme .bg-green-500\/20 .text-green-400 { color: #15803d !important; }
    body.pastel-theme .bg-amber-500\/20 .text-amber-400 { color: #b45309 !important; }
    body.pastel-theme .bg-red-500\/20 .text-red-400 { color: #dc2626 !important; }
    body.pastel-theme .bg-rose-500\/20 .text-rose-400 { color: #be123c !important; }
    /* Accent info boxes */
    body.pastel-theme .bg-cyan-500\/10 { background-color: rgba(14, 165, 233, 0.15) !important; border-color: rgba(14, 165, 233, 0.4) !important; }
    body.pastel-theme .bg-amber-500\/10 { background-color: rgba(245, 158, 11, 0.15) !important; }
    /* Toast notifications */
    body.pastel-theme .bg-green-500 { background-color: #16a34a !important; color: white !important; }
    body.pastel-theme .bg-red-500 { background-color: #dc2626 !important; color: white !important; }
    body.pastel-theme .bg-amber-500 { background-color: #d97706 !important; color: white !important; }
    /* Orange text */
    body.pastel-theme .text-orange-400 { color: #ea580c !important; }

    body { background: linear-gradient(135deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 50%, var(--bg-gradient-1) 100%); min-height: 100vh; transition: background 0.3s ease; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
    ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 2px; }
    input, select { font-size: 16px; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 5px #22d3ee40; } 50% { box-shadow: 0 0 15px #22d3ee60; } }
    .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
    .slide-up { animation: slideUp 0.3s ease-out; }
    @keyframes toastIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
    @keyframes toastOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
    .toast-in { animation: toastIn 0.3s ease-out; }
    .toast-out { animation: toastOut 0.3s ease-out forwards; }
  </style>
</head>
<body class="text-slate-100">
  <div id="app"></div>
  <div id="toast-container" class="fixed top-4 right-4 z-[100] space-y-2"></div>
  <div id="confirm-modal"></div>

  <script>
    // ===== Constants =====
    const KEYS = {
      PONDS: 'ff_ponds',
      CYCLES: 'ff_cycles',
      FEEDS: 'ff_feeds',
      FEED_STOCK: 'ff_feed_stock',
      SUPPLEMENTS: 'ff_supplements',
      MEDICINES: 'ff_medicines',
      FEEDING_LOGS: 'ff_feeding_logs',
      WATER_QUALITY: 'ff_water_quality',
      EXPENSES: 'ff_expenses',
      HARVESTS: 'ff_harvests',
      MORTALITIES: 'ff_mortalities',
      SETTINGS: 'ff_settings',
      FISH_TYPES: 'ff_fish_types',
      STOCK_PASSWORD: 'ff_stock_password',
      GUIDES: 'ff_guides'
    };

    // Guide categories
    const GUIDE_CATEGORIES = {
      fish: { id: 'fish', name: '‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏õ‡∏•‡∏≤', icon: 'üêü', color: 'cyan' },
      supplement: { id: 'supplement', name: '‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô/‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°', icon: 'üíä', color: 'green' },
      disease: { id: 'disease', name: '‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤', icon: 'üè•', color: 'red' },
      other: { id: 'other', name: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', icon: 'üìö', color: 'purple' }
    };

    // Default fish types (will be loaded from storage)
    const DEFAULT_FISH_TYPES = [
      { id: 'catfish', name: '‡∏õ‡∏•‡∏≤‡∏î‡∏∏‡∏Å', feedType: 'fresh', avgWeight: 150 },
      { id: 'tilapia', name: '‡∏õ‡∏•‡∏≤‡∏ô‡∏¥‡∏•', feedType: 'pellet', avgWeight: 500 },
      { id: 'red_tilapia', name: '‡∏õ‡∏•‡∏≤‡∏ó‡∏±‡∏ö‡∏ó‡∏¥‡∏°', feedType: 'pellet', avgWeight: 600 }
    ];

    // Helper to get fish types from storage (filters deleted)
    const getFishTypes = () => {
      const types = storage.get(KEYS.FISH_TYPES).filter(t => !t?.deleted);
      return types.length > 0 ? types : DEFAULT_FISH_TYPES;
    };

    const EXPENSE_CATEGORIES = ['‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü', '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥', '‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á', '‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤/‡πÄ‡∏Ñ‡∏°‡∏µ', '‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'];

    // ===== Utils =====
    const generateId = () => `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    const formatCurrency = (n) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', minimumFractionDigits: 0 }).format(n || 0);
    const formatNumber = (n, d = 0) => new Intl.NumberFormat('th-TH', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n || 0);
    const formatDate = (date) => new Date(date).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
    const calculateDays = (start) => Math.max(1, Math.ceil((new Date().getTime() - new Date(start).getTime()) / (1000 * 60 * 60 * 24)));

    // Improved storage with error handling
    const storage = {
      get: (key) => {
        try {
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          console.error(`Storage read error for ${key}:`, e);
          return [];
        }
      },
      set: (key, data) => {
        try {
          localStorage.setItem(key, JSON.stringify(data));
          // Trigger auto-save to file for Electron
          if (window.autoSaveToFile) window.autoSaveToFile();
          return true;
        } catch (e) {
          if (e.name === 'QuotaExceededError') {
            showToast('‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏ï‡πá‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤', 'error');
          } else {
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
          }
          console.error(`Storage write error for ${key}:`, e);
          return false;
        }
      },
      getStorageUsage: () => {
        let total = 0;
        Object.values(KEYS).forEach(key => {
          const item = localStorage.getItem(key);
          if (item) total += item.length * 2; // UTF-16
        });
        return (total / 1024).toFixed(2); // KB
      }
    };
    window.storage = storage; // Export for firebase-sync.js

    // ===== Toast Notification System =====
    const showToast = (message, type = 'success', duration = 3000) => {
      const container = document.getElementById('toast-container');
      const id = generateId();
      const colors = {
        success: 'bg-green-500/90 border-green-400',
        error: 'bg-red-500/90 border-red-400',
        warning: 'bg-amber-500/90 border-amber-400',
        info: 'bg-cyan-500/90 border-cyan-400'
      };
      const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };

      const toast = document.createElement('div');
      toast.id = `toast-${id}`;
      toast.className = `toast-in flex items-center gap-2 px-4 py-3 rounded-xl border ${colors[type]} text-white shadow-lg backdrop-blur`;
      toast.innerHTML = `<span class="text-lg">${icons[type]}</span><span>${message}</span>`;
      container.appendChild(toast);

      setTimeout(() => {
        toast.classList.remove('toast-in');
        toast.classList.add('toast-out');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    };
    window.showToast = showToast; // Export for firebase-sync.js

    // ===== Custom Confirm Dialog =====
    const showConfirm = (title, message, onConfirm, type = 'warning') => {
      const modal = document.getElementById('confirm-modal');
      const colors = {
        warning: { bg: 'bg-amber-500', hover: 'hover:bg-amber-600' },
        danger: { bg: 'bg-red-500', hover: 'hover:bg-red-600' }
      };

      modal.innerHTML = `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[90] flex items-center justify-center p-4" onclick="closeConfirm()">
          <div class="bg-slate-800 rounded-2xl w-full max-w-sm p-6 fade-in" onclick="event.stopPropagation()">
            <div class="text-center mb-4">
              <div class="text-4xl mb-2">${type === 'danger' ? '‚ö†Ô∏è' : '‚ùì'}</div>
              <h3 class="text-lg font-semibold">${title}</h3>
              <p class="text-slate-400 text-sm mt-2">${message}</p>
            </div>
            <div class="flex gap-3">
              <button onclick="closeConfirm()" class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button onclick="confirmAction()" class="flex-1 py-3 ${colors[type].bg} ${colors[type].hover} text-white rounded-xl transition-colors">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
          </div>
        </div>
      `;
      window._confirmCallback = onConfirm;
    };

    window.closeConfirm = () => {
      document.getElementById('confirm-modal').innerHTML = '';
      window._confirmCallback = null;
    };

    window.confirmAction = () => {
      if (window._confirmCallback) window._confirmCallback();
      closeConfirm();
    };

    // ===== Validation =====
    const validate = {
      required: (value, fieldName) => {
        if (!value || (typeof value === 'string' && !value.trim())) {
          showToast(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ${fieldName}`, 'error');
          return false;
        }
        return true;
      },
      number: (value, fieldName, min = 0, max = Infinity) => {
        const num = parseFloat(value);
        if (isNaN(num) || num < min || num > max) {
          showToast(`${fieldName} ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ${min}-${max}`, 'error');
          return false;
        }
        return true;
      },
      positiveNumber: (value, fieldName) => {
        const num = parseFloat(value);
        if (isNaN(num) || num <= 0) {
          showToast(`${fieldName} ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0`, 'error');
          return false;
        }
        return true;
      }
    };

    // ===== Helper: Filter deleted records =====
    // Helper function to filter out soft-deleted records
    const filterDeleted = (items) => (items || []).filter(item => !item?.deleted);

    // ===== Database with validation =====
    const db = {
      ponds: {
        getAll: () => filterDeleted(storage.get(KEYS.PONDS)),
        getById: (id) => filterDeleted(storage.get(KEYS.PONDS)).find(p => p.id === id),
        create: (name) => {
          if (!validate.required(name, '‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πà‡∏≠')) return null;
          const ponds = storage.get(KEYS.PONDS);
          if (ponds.some(p => p.name.toLowerCase() === name.trim().toLowerCase())) {
            showToast('‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πà‡∏≠‡∏ã‡πâ‡∏≥', 'error');
            return null;
          }
          const p = { id: generateId(), name: name.trim(), status: 'empty', createdAt: new Date().toISOString() };
          ponds.push(p);
          if (storage.set(KEYS.PONDS, ponds)) {
            showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            return p;
          }
          return null;
        },
        update: (id, data) => {
          const ponds = storage.get(KEYS.PONDS);
          const i = ponds.findIndex(p => p.id === id);
          if (i >= 0) {
            ponds[i] = { ...ponds[i], ...data, updatedAt: new Date().toISOString() };
            storage.set(KEYS.PONDS, ponds);
          }
        },
        delete: (id) => {
          // Cascading soft delete: related cycles and their data
          const cycles = storage.get(KEYS.CYCLES).filter(c => c.pondId === id && !c.deleted);
          cycles.forEach(cycle => {
            // Soft delete related records
            storage.get(KEYS.FEEDING_LOGS).filter(l => l.cycleId === cycle.id && !l.deleted).forEach(l => window.markAsDeleted?.(KEYS.FEEDING_LOGS, l.id));
            storage.get(KEYS.WATER_QUALITY).filter(w => w.cycleId === cycle.id && !w.deleted).forEach(w => window.markAsDeleted?.(KEYS.WATER_QUALITY, w.id));
            storage.get(KEYS.EXPENSES).filter(e => e.cycleId === cycle.id && !e.deleted).forEach(e => window.markAsDeleted?.(KEYS.EXPENSES, e.id));
            storage.get(KEYS.HARVESTS).filter(h => h.cycleId === cycle.id && !h.deleted).forEach(h => window.markAsDeleted?.(KEYS.HARVESTS, h.id));
            window.markAsDeleted?.(KEYS.CYCLES, cycle.id);
          });
          window.markAsDeleted?.(KEYS.PONDS, id);
          showToast('‡∏•‡∏ö‡∏ö‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }
      },
      fishTypes: {
        getAll: () => getFishTypes(),
        getById: (id) => getFishTypes().find(f => f.id === id),
        create: (data) => {
          if (!validate.required(data.name, '‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏•‡∏≤')) return null;
          const types = storage.get(KEYS.FISH_TYPES);
          if (types.length === 0) {
            // First time - copy defaults
            DEFAULT_FISH_TYPES.forEach(t => types.push(t));
          }
          if (types.some(t => t.name.toLowerCase() === data.name.trim().toLowerCase())) {
            showToast('‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏•‡∏≤‡∏ã‡πâ‡∏≥', 'error');
            return null;
          }
          const ft = {
            id: generateId(),
            name: data.name.trim(),
            feedType: data.feedType || 'pellet',
            avgWeight: parseFloat(data.avgWeight) || 100,
            createdAt: new Date().toISOString(),
            editHistory: []
          };
          types.push(ft);
          if (storage.set(KEYS.FISH_TYPES, types)) {
            showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            return ft;
          }
          return null;
        },
        update: (id, data) => {
          let types = storage.get(KEYS.FISH_TYPES);
          if (types.length === 0) {
            types = [...DEFAULT_FISH_TYPES];
          }
          const i = types.findIndex(t => t.id === id);
          if (i >= 0) {
            const old = types[i];
            const history = [...(old.editHistory || []), {
              editedAt: new Date().toISOString(),
              prev: { name: old.name, feedType: old.feedType, avgWeight: old.avgWeight }
            }];
            types[i] = { ...old, ...data, editHistory: history, updatedAt: new Date().toISOString() };
            if (storage.set(KEYS.FISH_TYPES, types)) {
              showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            }
          }
        },
        delete: (id) => {
          let types = storage.get(KEYS.FISH_TYPES);
          if (types.length === 0) {
            types = [...DEFAULT_FISH_TYPES];
          }
          window.markAsDeleted?.(KEYS.FISH_TYPES, id);
          showToast('‡∏•‡∏ö‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }
      },
      cycles: {
        getAll: () => filterDeleted(storage.get(KEYS.CYCLES)),
        getActive: (pondId) => filterDeleted(storage.get(KEYS.CYCLES)).find(c => c.pondId === pondId && c.status === 'active'),
        getCompleted: (pondId) => filterDeleted(storage.get(KEYS.CYCLES)).filter(c => c.pondId === pondId && c.status === 'completed'),
        create: (data) => {
          if (!validate.positiveNumber(data.initialCount, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏•‡∏≤')) return null;
          if (!validate.positiveNumber(data.pricePerFish, '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ï‡∏±‡∏ß')) return null;

          const cycles = storage.get(KEYS.CYCLES);
          const c = { ...data, id: generateId() };
          cycles.push(c);
          if (storage.set(KEYS.CYCLES, cycles)) {
            db.ponds.update(data.pondId, { status: 'active' });
            showToast('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            return c;
          }
          return null;
        },
        complete: (id) => {
          const cycles = storage.get(KEYS.CYCLES);
          const i = cycles.findIndex(c => c.id === id);
          if (i >= 0) {
            cycles[i].status = 'completed';
            cycles[i].endDate = new Date().toISOString();
            cycles[i].updatedAt = new Date().toISOString();
            storage.set(KEYS.CYCLES, cycles);
            db.ponds.update(cycles[i].pondId, { status: 'empty' });
          }
        },
        reset: (pondId) => {
          const cycle = db.cycles.getActive(pondId);
          if (cycle) {
            // Soft delete related records
            storage.get(KEYS.FEEDING_LOGS).filter(l => l.cycleId === cycle.id && !l.deleted).forEach(l => window.markAsDeleted?.(KEYS.FEEDING_LOGS, l.id));
            storage.get(KEYS.WATER_QUALITY).filter(w => w.cycleId === cycle.id && !w.deleted).forEach(w => window.markAsDeleted?.(KEYS.WATER_QUALITY, w.id));
            storage.get(KEYS.EXPENSES).filter(e => e.cycleId === cycle.id && !e.deleted).forEach(e => window.markAsDeleted?.(KEYS.EXPENSES, e.id));
            storage.get(KEYS.HARVESTS).filter(h => h.cycleId === cycle.id && !h.deleted).forEach(h => window.markAsDeleted?.(KEYS.HARVESTS, h.id));
            window.markAsDeleted?.(KEYS.CYCLES, cycle.id);
            db.ponds.update(pondId, { status: 'empty' });
            showToast('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ö‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
          }
        }
      },
      feeds: {
        getAll: () => filterDeleted(storage.get(KEYS.FEEDS)),
        getById: (id) => filterDeleted(storage.get(KEYS.FEEDS)).find(f => f.id === id),
        create: (data) => {
          if (!validate.required(data.name, '‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£')) return null;
          if (!validate.positiveNumber(data.pricePerKg, '‡∏£‡∏≤‡∏Ñ‡∏≤')) return null;

          const feeds = storage.get(KEYS.FEEDS);
          const f = { ...data, id: generateId(), createdAt: new Date().toISOString(), editHistory: [] };
          feeds.push(f);
          if (storage.set(KEYS.FEEDS, feeds)) {
            showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            return f;
          }
          return null;
        },
        update: (id, data) => {
          const feeds = storage.get(KEYS.FEEDS);
          const i = feeds.findIndex(f => f.id === id);
          if (i >= 0) {
            const old = feeds[i];
            const history = [...(old.editHistory || []), {
              editedAt: new Date().toISOString(),
              prev: { name: old.name, type: old.type, brand: old.brand, sizeNumber: old.sizeNumber, pricePerKg: old.pricePerKg }
            }];
            feeds[i] = { ...old, ...data, editHistory: history, updatedAt: new Date().toISOString() };
            if (storage.set(KEYS.FEEDS, feeds)) {
              showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            }
          }
        },
        delete: (id) => {
          window.markAsDeleted?.(KEYS.FEEDS, id);
          showToast('‡∏•‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }
      },
      supplements: {
        getAll: () => filterDeleted(storage.get(KEYS.SUPPLEMENTS)),
        getById: (id) => filterDeleted(storage.get(KEYS.SUPPLEMENTS)).find(s => s.id === id),
        create: (data) => {
          if (!validate.required(data.name, '‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô')) return null;

          const supps = storage.get(KEYS.SUPPLEMENTS);
          const s = { ...data, id: generateId(), createdAt: new Date().toISOString(), editHistory: [] };
          supps.push(s);
          if (storage.set(KEYS.SUPPLEMENTS, supps)) {
            showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            return s;
          }
          return null;
        },
        update: (id, data) => {
          const supps = storage.get(KEYS.SUPPLEMENTS);
          const i = supps.findIndex(s => s.id === id);
          if (i >= 0) {
            const old = supps[i];
            const history = [...(old.editHistory || []), {
              editedAt: new Date().toISOString(),
              prev: { name: old.name, description: old.description, suppType: old.suppType, price: old.price, unit: old.unit }
            }];
            supps[i] = { ...old, ...data, editHistory: history, updatedAt: new Date().toISOString() };
            if (storage.set(KEYS.SUPPLEMENTS, supps)) {
              showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            }
          }
        },
        delete: (id) => {
          window.markAsDeleted?.(KEYS.SUPPLEMENTS, id);
          showToast('‡∏•‡∏ö‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }
      },
      medicines: {
        getAll: () => filterDeleted(storage.get(KEYS.MEDICINES)),
        getById: (id) => filterDeleted(storage.get(KEYS.MEDICINES)).find(m => m.id === id),
        create: (data) => {
          if (!validate.required(data.name, '‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤')) return null;
          if (!validate.required(data.usageDetails, '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ')) return null;

          const meds = storage.get(KEYS.MEDICINES);
          const m = { ...data, id: generateId(), createdAt: new Date().toISOString(), editHistory: [] };
          meds.push(m);
          if (storage.set(KEYS.MEDICINES, meds)) {
            showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            return m;
          }
          return null;
        },
        update: (id, data) => {
          const meds = storage.get(KEYS.MEDICINES);
          const i = meds.findIndex(m => m.id === id);
          if (i >= 0) {
            const old = meds[i];
            const history = [...(old.editHistory || []), {
              editedAt: new Date().toISOString(),
              prev: { name: old.name, description: old.description, medType: old.medType, price: old.price, unit: old.unit, usageDetails: old.usageDetails }
            }];
            meds[i] = { ...old, ...data, editHistory: history, updatedAt: new Date().toISOString() };
            if (storage.set(KEYS.MEDICINES, meds)) {
              showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            }
          }
        },
        delete: (id) => {
          window.markAsDeleted?.(KEYS.MEDICINES, id);
          showToast('‡∏•‡∏ö‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }
      },
      feedingLogs: {
        getByCycle: (cycleId) => storage.get(KEYS.FEEDING_LOGS)
          .filter(l => l.cycleId === cycleId && !l.deleted)
          .sort((a, b) => new Date(b.date) - new Date(a.date) || b.time.localeCompare(a.time)),
        create: (data) => {
          // Allow medicine-only records without feed weight
          if (!data.medicineOnly && !validate.positiveNumber(data.weightKg, '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£')) return null;
          if (data.medicineOnly && (!data.medicines || data.medicines.length === 0)) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'error');
            return null;
          }

          const logs = storage.get(KEYS.FEEDING_LOGS);
          const l = { ...data, id: generateId(), createdAt: new Date().toISOString(), editHistory: [] };
          logs.push(l);
          if (storage.set(KEYS.FEEDING_LOGS, logs)) {
            showToast(data.medicineOnly ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            return l;
          }
          return null;
        },
        update: (id, data) => {
          const logs = storage.get(KEYS.FEEDING_LOGS);
          const i = logs.findIndex(l => l.id === id);
          if (i >= 0) {
            const old = logs[i];
            const history = [...(old.editHistory || []), {
              editedAt: new Date().toISOString(),
              prev: { feedId: old.feedId, weightKg: old.weightKg, time: old.time }
            }];
            logs[i] = { ...old, ...data, editHistory: history, updatedAt: new Date().toISOString() };
            if (storage.set(KEYS.FEEDING_LOGS, logs)) {
              showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            }
          }
        },
        delete: (id) => {
          window.markAsDeleted?.(KEYS.FEEDING_LOGS, id);
          showToast('‡∏•‡∏ö‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        },
        getLatest: (cycleId) => db.feedingLogs.getByCycle(cycleId)[0],
        getByDate: (cycleId, date) => {
          const dateStr = new Date(date).toDateString();
          return storage.get(KEYS.FEEDING_LOGS)
            .filter(l => l.cycleId === cycleId && new Date(l.date).toDateString() === dateStr && !l.deleted)
            .sort((a, b) => a.time.localeCompare(b.time));
        }
      },
      waterQuality: {
        getByCycle: (cycleId) => storage.get(KEYS.WATER_QUALITY)
          .filter(w => w.cycleId === cycleId && !w.deleted)
          .sort((a, b) => new Date(b.date) - new Date(a.date)),
        create: (data) => {
          const records = storage.get(KEYS.WATER_QUALITY);
          const w = { ...data, id: generateId(), createdAt: new Date().toISOString() };
          records.push(w);
          if (storage.set(KEYS.WATER_QUALITY, records)) {
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ô‡πâ‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            return w;
          }
          return null;
        },
        getLatest: (cycleId) => db.waterQuality.getByCycle(cycleId)[0]
      },
      expenses: {
        getByCycle: (cycleId) => storage.get(KEYS.EXPENSES).filter(e => e.cycleId === cycleId && !e.deleted),
        create: (data) => {
          if (!validate.positiveNumber(data.amount, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô')) return null;

          const exps = storage.get(KEYS.EXPENSES);
          const e = { ...data, id: generateId(), createdAt: new Date().toISOString() };
          exps.push(e);
          if (storage.set(KEYS.EXPENSES, exps)) {
            showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            return e;
          }
          return null;
        },
        delete: (id) => {
          window.markAsDeleted?.(KEYS.EXPENSES, id);
          showToast('‡∏•‡∏ö‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }
      },
      harvests: {
        getByCycle: (cycleId) => storage.get(KEYS.HARVESTS).filter(h => h.cycleId === cycleId && !h.deleted),
        create: (data) => {
          if (!validate.positiveNumber(data.weightKg, '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å')) return null;
          if (!validate.positiveNumber(data.pricePerKg, '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢')) return null;

          const harvests = storage.get(KEYS.HARVESTS);
          const h = { ...data, id: generateId(), createdAt: new Date().toISOString() };
          harvests.push(h);
          if (storage.set(KEYS.HARVESTS, harvests)) {
            if (data.isFinalHarvest) {
              const cycle = storage.get(KEYS.CYCLES).find(c => c.id === data.cycleId);
              if (cycle) db.cycles.complete(cycle.id);
              showToast('‡∏à‡∏±‡∏ö‡∏õ‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏ö‡∏£‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } else {
              showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏õ‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            }
            return h;
          }
          return null;
        },
        getTotalByPond: (cycleId) => {
          const harvests = db.harvests.getByCycle(cycleId);
          return {
            totalWeight: harvests.reduce((s, h) => s + h.weightKg, 0),
            totalCount: harvests.reduce((s, h) => s + h.count, 0),
            totalRevenue: harvests.reduce((s, h) => s + (h.weightKg * h.pricePerKg), 0)
          };
        }
      },
      mortalities: {
        getByCycle: (cycleId) => storage.get(KEYS.MORTALITIES)
          .filter(m => m.cycleId === cycleId && !m.deleted)
          .sort((a, b) => new Date(b.date) - new Date(a.date)),
        create: (data) => {
          if (!validate.positiveNumber(data.count, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏•‡∏≤‡∏ï‡∏≤‡∏¢')) return null;

          const morts = storage.get(KEYS.MORTALITIES);
          const m = { ...data, id: generateId(), createdAt: new Date().toISOString() };
          morts.push(m);
          if (storage.set(KEYS.MORTALITIES, morts)) {
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏•‡∏≤‡∏ï‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            return m;
          }
          return null;
        },
        delete: (id) => {
          window.markAsDeleted?.(KEYS.MORTALITIES, id);
          showToast('‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        },
        getTotalByCycle: (cycleId) => {
          const morts = storage.get(KEYS.MORTALITIES).filter(m => m.cycleId === cycleId && !m.deleted);
          return morts.reduce((sum, m) => sum + m.count, 0);
        },
        getToday: (cycleId) => {
          const today = new Date().toDateString();
          return storage.get(KEYS.MORTALITIES)
            .filter(m => m.cycleId === cycleId && new Date(m.date).toDateString() === today && !m.deleted);
        }
      },
      feedStock: {
        getAll: () => storage.get(KEYS.FEED_STOCK),
        getByFeedId: (feedId) => storage.get(KEYS.FEED_STOCK).find(s => s.feedId === feedId),
        getStock: (feedId) => {
          const stock = storage.get(KEYS.FEED_STOCK).find(s => s.feedId === feedId);
          return stock ? stock.quantity : 0;
        },
        getFeedsWithStock: () => {
          const stocks = storage.get(KEYS.FEED_STOCK);
          const feeds = db.feeds.getAll();
          return feeds.filter(f => {
            const stock = stocks.find(s => s.feedId === f.id);
            return stock && stock.quantity > 0;
          }).map(f => {
            const stock = stocks.find(s => s.feedId === f.id);
            return { ...f, stockQuantity: stock.quantity };
          });
        },
        add: (feedId, quantity, note = '') => {
          if (!validate.positiveNumber(quantity, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô')) return null;
          const stocks = storage.get(KEYS.FEED_STOCK);
          const existingIndex = stocks.findIndex(s => s.feedId === feedId);

          if (existingIndex >= 0) {
            stocks[existingIndex].quantity += parseFloat(quantity);
            stocks[existingIndex].lastUpdated = new Date().toISOString();
            stocks[existingIndex].updatedAt = Date.now();
            stocks[existingIndex].history = stocks[existingIndex].history || [];
            stocks[existingIndex].history.push({
              type: 'add',
              quantity: parseFloat(quantity),
              note: note,
              date: new Date().toISOString()
            });
          } else {
            stocks.push({
              id: generateId(),
              feedId: feedId,
              quantity: parseFloat(quantity),
              lastUpdated: new Date().toISOString(),
              updatedAt: Date.now(),
              history: [{
                type: 'add',
                quantity: parseFloat(quantity),
                note: note,
                date: new Date().toISOString()
              }]
            });
          }

          if (storage.set(KEYS.FEED_STOCK, stocks)) {
            showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            return true;
          }
          return null;
        },
        deduct: (feedId, quantity) => {
          const stocks = storage.get(KEYS.FEED_STOCK);
          const existingIndex = stocks.findIndex(s => s.feedId === feedId);

          if (existingIndex >= 0) {
            const newQty = stocks[existingIndex].quantity - parseFloat(quantity);
            if (newQty < 0) {
              showToast('‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠', 'error');
              return false;
            }
            stocks[existingIndex].quantity = newQty;
            stocks[existingIndex].lastUpdated = new Date().toISOString();
            stocks[existingIndex].updatedAt = Date.now();
            stocks[existingIndex].history = stocks[existingIndex].history || [];
            stocks[existingIndex].history.push({
              type: 'deduct',
              quantity: parseFloat(quantity),
              date: new Date().toISOString()
            });
            storage.set(KEYS.FEED_STOCK, stocks);
            return true;
          }
          return false;
        },
        setQuantity: (feedId, quantity) => {
          if (quantity < 0) {
            showToast('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö', 'error');
            return null;
          }
          const stocks = storage.get(KEYS.FEED_STOCK);
          const existingIndex = stocks.findIndex(s => s.feedId === feedId);

          if (existingIndex >= 0) {
            const oldQty = stocks[existingIndex].quantity;
            stocks[existingIndex].quantity = parseFloat(quantity);
            stocks[existingIndex].lastUpdated = new Date().toISOString();
            stocks[existingIndex].updatedAt = Date.now();
            stocks[existingIndex].history = stocks[existingIndex].history || [];
            stocks[existingIndex].history.push({
              type: 'adjust',
              oldQuantity: oldQty,
              newQuantity: parseFloat(quantity),
              date: new Date().toISOString()
            });
          } else {
            stocks.push({
              id: generateId(),
              feedId: feedId,
              quantity: parseFloat(quantity),
              lastUpdated: new Date().toISOString(),
              updatedAt: Date.now(),
              history: [{
                type: 'set',
                quantity: parseFloat(quantity),
                date: new Date().toISOString()
              }]
            });
          }

          if (storage.set(KEYS.FEED_STOCK, stocks)) {
            showToast('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            return true;
          }
          return null;
        },
        delete: (feedId) => {
          const stock = storage.get(KEYS.FEED_STOCK).find(s => s.feedId === feedId);
          if (stock && stock.id && window.markAsDeleted) {
            window.markAsDeleted(KEYS.FEED_STOCK, stock.id);
          }
        }
      },
      stockPassword: {
        get: () => {
          const data = localStorage.getItem(KEYS.STOCK_PASSWORD);
          return data ? JSON.parse(data) : { enabled: false, password: '' };
        },
        set: (password) => {
          const data = { enabled: true, password: password };
          localStorage.setItem(KEYS.STOCK_PASSWORD, JSON.stringify(data));
          showToast('‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
          return true;
        },
        check: (inputPassword) => {
          const data = db.stockPassword.get();
          if (!data.enabled) return true;
          return data.password === inputPassword;
        },
        isEnabled: () => {
          return db.stockPassword.get().enabled;
        },
        disable: () => {
          localStorage.setItem(KEYS.STOCK_PASSWORD, JSON.stringify({ enabled: false, password: '' }));
          showToast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
          return true;
        },
        change: (oldPassword, newPassword) => {
          const data = db.stockPassword.get();
          if (data.enabled && data.password !== oldPassword) {
            showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            return false;
          }
          db.stockPassword.set(newPassword);
          return true;
        }
      },
      guides: {
        getAll: () => storage.get(KEYS.GUIDES),
        getByCategory: (category) => storage.get(KEYS.GUIDES).filter(g => g.category === category && !g.deleted),
        getById: (id) => storage.get(KEYS.GUIDES).find(g => g.id === id),
        add: (guide) => {
          const guides = storage.get(KEYS.GUIDES);
          const newGuide = {
            ...guide,
            id: generateId(),
            createdAt: Date.now(),
            updatedAt: Date.now()
          };
          guides.push(newGuide);
          if (storage.set(KEYS.GUIDES, guides)) {
            showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            return newGuide;
          }
          return null;
        },
        update: (id, updates) => {
          const guides = storage.get(KEYS.GUIDES);
          const index = guides.findIndex(g => g.id === id);
          if (index !== -1) {
            guides[index] = { ...guides[index], ...updates, updatedAt: Date.now() };
            if (storage.set(KEYS.GUIDES, guides)) {
              showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
              return true;
            }
          }
          return false;
        },
        delete: (id) => {
          const guides = storage.get(KEYS.GUIDES);
          const index = guides.findIndex(g => g.id === id);
          if (index !== -1) {
            guides[index] = { ...guides[index], deleted: true, deletedAt: Date.now(), updatedAt: Date.now() };
            if (storage.set(KEYS.GUIDES, guides)) {
              showToast('‡∏•‡∏ö‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
              return true;
            }
          }
          return false;
        }
      }
    };

    // ===== Calculations =====
    // Chart Helper - Simple SVG Line Chart
    const createChart = (data, options = {}) => {
      const { width = 280, height = 80, color = '#22d3ee', showDots = true, label = '' } = options;
      if (!data || data.length < 2) return '';

      const values = data.map(d => d.value);
      const max = Math.max(...values);
      const min = Math.min(...values);
      const range = max - min || 1;

      const points = data.map((d, i) => {
        const x = (i / (data.length - 1)) * (width - 20) + 10;
        const y = height - 10 - ((d.value - min) / range) * (height - 25);
        return { x, y, label: d.label, value: d.value };
      });

      const pathD = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');

      return `
        <svg width="${width}" height="${height}" class="w-full">
          <defs>
            <linearGradient id="grad-${label}" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style="stop-color:${color};stop-opacity:0.3" />
              <stop offset="100%" style="stop-color:${color};stop-opacity:0" />
            </linearGradient>
          </defs>
          <path d="${pathD} L ${points[points.length-1].x} ${height-5} L ${points[0].x} ${height-5} Z" fill="url(#grad-${label})" />
          <path d="${pathD}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          ${showDots ? points.map(p => `<circle cx="${p.x}" cy="${p.y}" r="3" fill="${color}" />`).join('') : ''}
          <text x="10" y="${height - 2}" fill="#64748b" font-size="10">${points[0].label || ''}</text>
          <text x="${width - 10}" y="${height - 2}" fill="#64748b" font-size="10" text-anchor="end">${points[points.length-1].label || ''}</text>
        </svg>
      `;
    };

    const calculations = {
      getCycleStats: (cycleId) => {
        const cycle = storage.get(KEYS.CYCLES).find(c => c.id === cycleId);
        if (!cycle) return null;

        const feeds = db.feeds.getAll();
        const supplements = db.supplements.getAll();
        const logs = db.feedingLogs.getByCycle(cycleId);
        const expenses = db.expenses.getByCycle(cycleId);
        const harvests = db.harvests.getByCycle(cycleId);
        const waterQuality = db.waterQuality.getLatest(cycleId);

        const totalFeed = logs.reduce((s, l) => s + l.weightKg, 0);
        const feedCost = logs.reduce((s, l) => s + l.weightKg * (feeds.find(f => f.id === l.feedId)?.pricePerKg || 0), 0);
        const suppCost = logs.reduce((sum, log) => {
          return sum + (log.supplements?.reduce((s, fs) => {
            const supp = supplements.find(sp => sp.id === fs.supplementId);
            // Use pricePerUnit if available, otherwise fallback to old calculation (price/100)
            const unitPrice = supp?.pricePerUnit || (supp?.price || 0) / (supp?.packageSize || 100);
            return s + unitPrice * fs.amount;
          }, 0) || 0);
        }, 0);
        const fishCost = cycle.initialCount * cycle.pricePerFish;
        const otherCost = expenses.reduce((s, e) => s + e.amount, 0);
        const totalCost = fishCost + feedCost + suppCost + otherCost;

        const harvestData = db.harvests.getTotalByPond(cycleId);
        const days = calculateDays(cycle.startDate);

        // Calculate FCR based on actual harvest weight or estimated
        const fishTypeData = db.fishTypes.getById(cycle.fishType);
        const avgWeightKg = (fishTypeData?.avgWeight || 150) / 1000; // Convert grams to kg
        const estimatedWeight = harvestData.totalWeight > 0
          ? harvestData.totalWeight
          : cycle.initialCount * avgWeightKg * 0.95;
        const fcr = totalFeed > 0 && estimatedWeight > 0 ? (totalFeed / estimatedWeight).toFixed(2) : '-';

        // Mortality tracking
        const totalMortality = db.mortalities.getTotalByCycle(cycleId);

        // Survival rate - use actual mortality if available
        const survivingCount = cycle.initialCount - totalMortality;
        const survivalRate = harvestData.totalCount > 0
          ? ((harvestData.totalCount / cycle.initialCount) * 100).toFixed(1)
          : totalMortality > 0 ? ((survivingCount / cycle.initialCount) * 100).toFixed(1) : null;

        // Cost per fish - based on actual surviving fish (after mortality) or estimated 95%
        const estimatedSurviving = totalMortality > 0
          ? survivingCount
          : Math.floor(cycle.initialCount * 0.95);
        const costPerFish = estimatedSurviving > 0 ? totalCost / estimatedSurviving : 0;

        return {
          cycle,
          days,
          totalFeed,
          feedCost,
          suppCost,
          fishCost,
          otherCost,
          totalCost,
          fcr,
          harvestData,
          survivalRate,
          waterQuality,
          costPerFish,
          estimatedSurviving,
          totalMortality,
          survivingCount,
          profit: harvestData.totalRevenue - totalCost
        };
      },

      getTodayLogs: (cycleId) => {
        return db.feedingLogs.getByDate(cycleId, new Date());
      },

      getDailyFeedSummary: (cycleId, days = 7) => {
        const logs = db.feedingLogs.getByCycle(cycleId);
        const summary = {};

        for (let i = 0; i < days; i++) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          const dateStr = date.toISOString().split('T')[0];
          const dayLogs = logs.filter(l => l.date.split('T')[0] === dateStr);
          summary[dateStr] = {
            totalWeight: dayLogs.reduce((s, l) => s + l.weightKg, 0),
            mealCount: dayLogs.length
          };
        }
        return summary;
      }
    };

    // Init default data
    const initData = () => {
      if (db.feeds.getAll().length === 0) {
        db.feeds.create({ type: 'fresh', name: '‡∏õ‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏î', pricePerKg: 15 });
        db.feeds.create({ type: 'fresh', name: '‡πÄ‡∏®‡∏©‡πÑ‡∏Å‡πà', pricePerKg: 12 });
        db.feeds.create({ type: 'fresh', name: '‡∏´‡∏±‡∏ß‡∏õ‡∏•‡∏≤', pricePerKg: 8 });
        db.feeds.create({ type: 'pellet', name: 'CP 9950', brand: 'CP', sizeNumber: '2', pricePerKg: 32 });
        db.feeds.create({ type: 'pellet', name: 'Betagro', brand: 'Betagro', sizeNumber: '2', pricePerKg: 28 });
      }
      if (db.supplements.getAll().length === 0) {
        db.supplements.create({ name: 'Vitamin C', description: '‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏†‡∏π‡∏°‡∏¥‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô', suppType: 'solid', price: 45, unit: '‡∏Å‡∏£‡∏±‡∏°' });
        db.supplements.create({ name: '‡πÅ‡∏£‡πà‡∏ò‡∏≤‡∏ï‡∏∏‡∏£‡∏ß‡∏°', description: '‡πÅ‡∏£‡πà‡∏ò‡∏≤‡∏ï‡∏∏‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô', suppType: 'solid', price: 35, unit: '‡∏Å‡∏£‡∏±‡∏°' });
        db.supplements.create({ name: '‡πÇ‡∏õ‡∏£‡πÑ‡∏ö‡πÇ‡∏≠‡∏ï‡∏¥‡∏Å', description: '‡∏à‡∏∏‡∏•‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå', suppType: 'liquid', price: 60, unit: '‡∏°‡∏•.' });
      }
      if (db.medicines.getAll().length === 0) {
        db.medicines.create({ name: '‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≤‡∏•‡∏¥‡∏ô', description: '‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏õ‡∏£‡∏™‡∏¥‡∏ï‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å', medType: 'liquid', price: 120, unit: '‡∏°‡∏•.', packageSize: 1000, usageDetails: '‡πÉ‡∏ä‡πâ 25-50 ‡∏°‡∏•./‡∏ô‡πâ‡∏≥ 1,000 ‡∏•‡∏¥‡∏ï‡∏£ ‡πÅ‡∏ä‡πà 30-60 ‡∏ô‡∏≤‡∏ó‡∏µ' });
        db.medicines.create({ name: '‡πÄ‡∏Å‡∏•‡∏∑‡∏≠', description: '‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', medType: 'solid', price: 10, unit: '‡∏Å‡∏£‡∏±‡∏°', packageSize: 25000, usageDetails: '‡πÉ‡∏ä‡πâ 0.5-1% ‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥ ‡πÅ‡∏ä‡πà 24-48 ‡∏ä‡∏°.' });
        db.medicines.create({ name: '‡∏î‡πà‡∏≤‡∏á‡∏ó‡∏±‡∏ö‡∏ó‡∏¥‡∏°', description: '‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÅ‡∏ö‡∏Ñ‡∏ó‡∏µ‡πÄ‡∏£‡∏µ‡∏¢', medType: 'solid', price: 250, unit: '‡∏Å‡∏£‡∏±‡∏°', packageSize: 100, usageDetails: '‡πÉ‡∏ä‡πâ 2-4 ‡∏Å‡∏£‡∏±‡∏°/‡∏ô‡πâ‡∏≥ 1,000 ‡∏•‡∏¥‡∏ï‡∏£ ‡πÅ‡∏ä‡πà 30 ‡∏ô‡∏≤‡∏ó‡∏µ' });
      }
      // Load default guides from JSON if empty
      if (db.guides.getAll().length === 0) {
        loadDefaultGuides();
      }
    };

    // Load guides from guides.json
    const loadDefaultGuides = async () => {
      try {
        const response = await fetch('guides.json');
        if (!response.ok) throw new Error('Failed to load guides.json');
        const data = await response.json();

        if (data.guides && Array.isArray(data.guides)) {
          const existingGuides = db.guides.getAll();
          const existingIds = new Set(existingGuides.map(g => g.id));

          data.guides.forEach(guide => {
            // Skip if already exists
            if (existingIds.has(guide.id)) return;

            // Add guide with predefined ID
            const guides = storage.get(KEYS.GUIDES);
            guides.push({
              ...guide,
              createdAt: Date.now(),
              updatedAt: Date.now()
            });
            storage.set(KEYS.GUIDES, guides);
          });

          console.log(`Loaded ${data.guides.length} default guides`);
          if (typeof smartRender === 'function') smartRender();
        }
      } catch (err) {
        console.warn('Could not load default guides:', err.message);
      }
    };

    // ===== App State =====
    let state = {
      tab: 'home',
      selectedPond: null,
      modal: null,
      editingLog: null,
      editingFishType: null,
      viewingFishTypeHistory: null,
      editingFeed: null,
      viewingFeedHistory: null,
      editingSupplement: null,
      viewingSupplementHistory: null,
      editingMedicine: null,
      viewingMedicineHistory: null,
      editingStockFeedId: null,
      pendingStockDelete: null,
      loading: false
    };

    const setState = (newState) => {
      state = { ...state, ...newState };
      render();
    };

    // ===== Render Functions =====
    const render = () => {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="min-h-screen pb-24">
          ${state.selectedPond ? renderPondDetail() : renderMainContent()}
        </div>
        ${!state.selectedPond ? renderBottomNav() : ''}
        ${state.modal ? renderModal() : ''}
      `;

      // Post-render actions for settings page
      if (state.tab === 'settings' && !state.selectedPond) {
        loadDiskSpaceInfo();
      }
    };
    window.render = render; // Export for firebase-sync.js

    // Load disk space info for settings page
    const loadDiskSpaceInfo = async () => {
      const diskSpaceEl = document.getElementById('diskSpaceInfo');
      const dataPathEl = document.getElementById('dataPathInfo');
      if (!diskSpaceEl) return;

      if (window.electronAPI && window.electronAPI.getDiskSpace) {
        try {
          const space = await window.electronAPI.getDiskSpace();
          const path = await window.electronAPI.getDataPath();
          diskSpaceEl.innerHTML = `
            <div class="grid grid-cols-3 gap-2 text-center">
              <div class="bg-slate-700/30 rounded-lg p-2">
                <div class="text-lg font-bold text-cyan-400">${space.total} GB</div>
                <div class="text-xs text-slate-500">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2">
                <div class="text-lg font-bold text-amber-400">${space.used} GB</div>
                <div class="text-xs text-slate-500">‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß</div>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2">
                <div class="text-lg font-bold text-green-400">${space.free} GB</div>
                <div class="text-xs text-slate-500">‡∏ß‡πà‡∏≤‡∏á</div>
              </div>
            </div>
          `;
          if (dataPathEl) {
            dataPathEl.innerHTML = `üìÅ ‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: <span class="text-slate-400">${path}</span>`;
          }
        } catch (e) {
          diskSpaceEl.innerHTML = '<div class="text-xs text-slate-500">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ</div>';
        }
      } else {
        diskSpaceEl.innerHTML = `
          <div class="flex items-center gap-2 p-2 bg-green-500/10 rounded-lg border border-green-500/30">
            <span class="text-green-400 text-lg">‚ôæÔ∏è</span>
            <div>
              <p class="text-green-400 font-medium">‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</p>
              <p class="text-xs text-slate-500">‡πÉ‡∏ä‡πâ localStorage ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå</p>
            </div>
          </div>
        `;
      }
    };

    // Auto-save to file (for Electron)
    window.autoSaveToFile = async () => {
      if (window.electronAPI && window.electronAPI.saveData) {
        const backup = { version: '1.2', savedAt: new Date().toISOString() };
        Object.entries(KEYS).forEach(([name, key]) => {
          backup[name] = storage.get(key);
        });
        await window.electronAPI.saveData(backup);
      }
    };

    const renderMainContent = () => {
      if (state.tab === 'home') return renderHome();
      if (state.tab === 'inventory') return renderInventory();
      if (state.tab === 'guides') return renderGuides();
      if (state.tab === 'reports') return renderReports();
      if (state.tab === 'settings') return renderSettings();
      return '';
    };

    const renderHome = () => {
      const ponds = db.ponds.getAll();
      const activePonds = ponds.filter(p => p.status === 'active');
      let totalCost = 0;
      let totalFcrSum = 0;
      let fcrCount = 0;

      // FCR by fish type
      const fcrByFishType = {};

      activePonds.forEach(p => {
        const cycle = db.cycles.getActive(p.id);
        if (cycle) {
          const stats = calculations.getCycleStats(cycle.id);
          if (stats) {
            totalCost += stats.totalCost;
            if (stats.fcr !== '-') {
              const fcrValue = parseFloat(stats.fcr);
              totalFcrSum += fcrValue;
              fcrCount++;

              // Group by fish type
              const fishTypeName = cycle.fishTypeName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
              if (!fcrByFishType[fishTypeName]) {
                fcrByFishType[fishTypeName] = { sum: 0, count: 0 };
              }
              fcrByFishType[fishTypeName].sum += fcrValue;
              fcrByFishType[fishTypeName].count++;
            }
          }
        }
      });

      const avgFcr = fcrCount > 0 ? (totalFcrSum / fcrCount).toFixed(2) : '-';

      // Calculate average FCR for each fish type
      const fishTypeFcrList = Object.entries(fcrByFishType).map(([name, data]) => ({
        name,
        fcr: (data.sum / data.count).toFixed(2),
        count: data.count
      }));

      return `
        <div class="p-4 max-w-lg mx-auto fade-in">
          <header class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-2xl font-bold bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent flex items-center gap-2">
                Fish Farm Pro
              </h1>
              <p class="text-slate-400 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏õ‡∏•‡∏≤</p>
            </div>
          </header>

          <div class="grid grid-cols-4 gap-2 mb-6">
            <div class="bg-slate-800/60 rounded-2xl p-3 border border-slate-700/50 text-center">
              <div class="text-lg">üî≤</div>
              <div class="text-lg font-bold">${ponds.length}</div>
              <div class="text-[10px] text-slate-400">‡∏ö‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
            <div class="bg-slate-800/60 rounded-2xl p-3 border border-slate-700/50 text-center">
              <div class="text-lg">üü¢</div>
              <div class="text-lg font-bold">${activePonds.length}</div>
              <div class="text-[10px] text-slate-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</div>
            </div>
            <div class="bg-slate-800/60 rounded-2xl p-3 border border-slate-700/50 text-center">
              <div class="text-lg">üí∞</div>
              <div class="text-xs font-bold">${formatCurrency(totalCost)}</div>
              <div class="text-[10px] text-slate-400">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</div>
            </div>
            <div class="bg-slate-800/60 rounded-2xl p-3 border border-slate-700/50 text-center">
              <div class="text-lg">üìä</div>
              <div class="text-lg font-bold">${avgFcr}</div>
              <div class="text-[10px] text-slate-400">FCR ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
            </div>
          </div>

          ${fishTypeFcrList.length > 1 ? `
          <!-- FCR by Fish Type -->
          <div class="mb-6">
            <h3 class="text-sm font-medium text-slate-400 mb-2">üìä FCR ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏•‡∏≤</h3>
            <div class="grid grid-cols-${Math.min(fishTypeFcrList.length, 3)} gap-2">
              ${fishTypeFcrList.map(ft => {
                const fcrNum = parseFloat(ft.fcr);
                const fcrColor = fcrNum < 1.5 ? 'text-green-400 border-green-500/30' : fcrNum < 2 ? 'text-cyan-400 border-cyan-500/30' : fcrNum < 2.5 ? 'text-amber-400 border-amber-500/30' : 'text-red-400 border-red-500/30';
                return `
                  <div class="bg-slate-800/40 rounded-xl p-3 border ${fcrColor.split(' ')[1]} text-center">
                    <div class="text-xs text-slate-400 mb-1">${ft.name}</div>
                    <div class="text-xl font-bold ${fcrColor.split(' ')[0]}">${ft.fcr}</div>
                    <div class="text-[10px] text-slate-500">${ft.count} ‡∏ö‡πà‡∏≠</div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
          ` : ''}

          <!-- Feed Stock Section -->
          <div class="mb-6">
            ${(() => {
              const feeds = db.feeds.getAll();
              const feedsWithStock = feeds.map(f => ({
                ...f,
                stock: db.feedStock.getStock(f.id)
              })).filter(f => f.stock > 0);

              const showCollapseBtn = feedsWithStock.length > 4;
              const isCollapsed = state.feedStockCollapsed !== undefined ? state.feedStockCollapsed : showCollapseBtn;
              const displayFeeds = isCollapsed ? feedsWithStock.slice(0, 4) : feedsWithStock;
              const hiddenCount = feedsWithStock.length - 4;
              const totalStock = feedsWithStock.reduce((sum, f) => sum + f.stock, 0);

              if (feedsWithStock.length === 0) {
                return `
                  <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-semibold">üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h2>
                    <button onclick="setState({modal:'addFeedStock'})" class="flex items-center gap-1 px-3 py-1.5 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg text-sm font-medium transition-colors">
                      + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å
                    </button>
                  </div>
                  <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50 text-center">
                    <div class="text-3xl mb-2">üì¶</div>
                    <p class="text-slate-400 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</p>
                    <p class="text-slate-500 text-xs mt-1">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
                  </div>
                `;
              }

              return `
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-2">
                    <h2 class="text-lg font-semibold">üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h2>
                    <span class="text-xs text-slate-500 bg-slate-800/50 px-2 py-0.5 rounded">${feedsWithStock.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ ${formatNumber(totalStock, 1)} ‡∏Å‡∏Å.</span>
                  </div>
                  <div class="flex items-center gap-1">
                    <button onclick="setState({modal:'stockHistory', stockHistoryLimit: 20})" class="p-1.5 bg-slate-700/50 hover:bg-slate-600/50 text-slate-300 rounded-lg text-sm transition-colors" title="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥">üìä</button>
                    <button onclick="setState({modal:'addFeedStock'})" class="px-2 py-1 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg text-xs font-medium transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
                  </div>
                </div>
                <div class="grid grid-cols-3 sm:grid-cols-4 gap-2">
                  ${displayFeeds.map(f => {
                    const stockColor = f.stock < 10 ? 'border-red-500/40 bg-red-500/5' : f.stock < 30 ? 'border-amber-500/40 bg-amber-500/5' : 'border-green-500/40 bg-green-500/5';
                    const textColor = f.stock < 10 ? 'text-red-400' : f.stock < 30 ? 'text-amber-400' : 'text-green-400';
                    return `
                      <div onclick="setState({modal:'editFeedStock', editingStockFeedId:'${f.id}'})" class="bg-slate-800/60 rounded-xl p-2 border ${stockColor} hover:bg-slate-700/50 cursor-pointer transition-all relative group">
                        <button onclick="event.stopPropagation(); requestDeleteStock('${f.id}')" class="absolute -top-1 -right-1 w-5 h-5 bg-slate-700 hover:bg-red-500/80 text-slate-400 hover:text-white rounded-full text-[10px] sm:opacity-0 sm:group-hover:opacity-100 transition-all flex items-center justify-center" title="‡∏•‡∏ö">‚úï</button>
                        <div class="flex items-center gap-1.5 mb-1">
                          <span class="text-sm">${f.type === 'fresh' ? 'üü†' : 'üîµ'}</span>
                          <span class="text-xs font-medium text-slate-300 truncate flex-1">${f.name}</span>
                        </div>
                        <div class="flex items-baseline gap-0.5">
                          <span class="text-base font-bold ${textColor}">${formatNumber(f.stock, 1)}</span>
                          <span class="text-[10px] text-slate-500">‡∏Å‡∏Å.</span>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
                ${showCollapseBtn ? `
                  <button onclick="setState({feedStockCollapsed: ${!isCollapsed}})" class="w-full mt-2 py-1.5 bg-slate-800/40 hover:bg-slate-700/40 text-slate-400 rounded-lg text-xs transition-colors flex items-center justify-center gap-1">
                    ${isCollapsed ? `‚ñº ‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏° (${hiddenCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)` : '‚ñ≤ ‡∏¢‡πà‡∏≠'}
                  </button>
                ` : ''}
              `;
            })()}
          </div>

          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">üî≤ ‡∏ö‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</h2>
            <button onclick="setState({modal:'createPond'})" class="flex items-center gap-1.5 px-4 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-xl transition-colors text-sm font-medium">
              + ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡πà‡∏≠
            </button>
          </div>

          <div class="space-y-3">
            ${ponds.length === 0 ? `
              <div class="text-center py-12 text-slate-400">
                <div class="text-5xl mb-3">üêü</div>
                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</p>
                <p class="text-sm">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡πà‡∏≠" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>
              </div>
            ` : ponds.map(p => renderPondCard(p)).join('')}
          </div>
        </div>
      `;
    };

    const renderPondCard = (pond) => {
      const cycle = db.cycles.getActive(pond.id);
      const isActive = pond.status === 'active';

      if (!cycle) {
        return `
          <button onclick="setState({selectedPond:'${pond.id}'})" class="w-full bg-slate-800/50 backdrop-blur rounded-2xl p-4 border border-slate-700/50 hover:border-cyan-500/40 hover:bg-slate-800/70 transition-all text-left group">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="w-2.5 h-2.5 rounded-full bg-slate-500"></span>
                  <h3 class="font-semibold text-slate-100">${pond.name}</h3>
                </div>
                <p class="text-sm text-slate-500">‡∏ß‡πà‡∏≤‡∏á - ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏õ‡∏•‡∏≤</p>
              </div>
              <span class="text-slate-500 group-hover:text-cyan-400 transition-colors">‚Ä∫</span>
            </div>
          </button>
        `;
      }

      const stats = calculations.getCycleStats(cycle.id);
      const todayLogs = calculations.getTodayLogs(cycle.id);
      const todayFeed = todayLogs.reduce((s, l) => s + l.weightKg, 0);
      const lastLog = db.feedingLogs.getLatest(cycle.id);

      return `
        <button onclick="setState({selectedPond:'${pond.id}'})" class="w-full bg-slate-800/50 backdrop-blur rounded-2xl p-4 border border-slate-700/50 hover:border-cyan-500/40 hover:bg-slate-800/70 transition-all text-left group">
          <div class="flex items-center justify-between">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class="w-2.5 h-2.5 rounded-full flex-shrink-0 bg-green-400 pulse-glow"></span>
                <h3 class="font-semibold text-slate-100 truncate">${pond.name}</h3>
              </div>
              <div class="space-y-1">
                <div class="flex items-center gap-2 text-sm text-slate-300 flex-wrap">
                  <span>${cycle.fishTypeName}</span>
                  <span class="text-slate-500">‚îÇ</span>
                  <span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${stats.days}</span>
                  <span class="text-slate-500">‚îÇ</span>
                  <span>${formatNumber(cycle.initialCount)} ‡∏ï‡∏±‡∏ß</span>
                </div>
                <div class="flex items-center gap-3 text-xs text-slate-400 flex-wrap">
                  <span>üçΩÔ∏è ${formatNumber(stats.totalFeed, 1)} ‡∏Å‡∏Å.</span>
                  <span>üí∞ ${formatCurrency(stats.totalCost)}</span>
                  <span>FCR: ${stats.fcr}</span>
                </div>
                ${lastLog ? `
                  <div class="flex items-center gap-1 text-xs text-cyan-400/70 mt-1">
                    üïê ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${lastLog.time} ‡∏ô. (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ${todayLogs.length} ‡∏°‡∏∑‡πâ‡∏≠)
                  </div>
                ` : ''}
              </div>
            </div>
            <span class="text-slate-500 group-hover:text-cyan-400 transition-colors">‚Ä∫</span>
          </div>
        </button>
      `;
    };

    const renderPondDetail = () => {
      const pond = db.ponds.getById(state.selectedPond);
      if (!pond) {
        setState({ selectedPond: null });
        return '';
      }

      const cycle = db.cycles.getActive(pond.id);

      if (!cycle) {
        return `
          <div class="fade-in">
            <header class="sticky top-0 bg-slate-900/95 backdrop-blur-xl border-b border-slate-700/50 z-40">
              <div class="flex items-center justify-between p-4 max-w-lg mx-auto">
                <button onclick="setState({selectedPond:null})" class="text-slate-400 hover:text-slate-200">‚Äπ ‡∏Å‡∏•‡∏±‡∏ö</button>
                <h1 class="font-semibold">${pond.name}</h1>
                <button onclick="deletePond('${pond.id}')" class="text-red-400 hover:text-red-300 text-sm">‡∏•‡∏ö‡∏ö‡πà‡∏≠</button>
              </div>
            </header>
            <div class="p-4 text-center py-16 max-w-lg mx-auto">
              <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-slate-800 flex items-center justify-center text-4xl">üêü</div>
              <h2 class="text-xl font-semibold mb-2">‡∏ö‡πà‡∏≠‡∏ß‡πà‡∏≤‡∏á</h2>
              <p class="text-slate-400 mb-6">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà</p>
              <button onclick="setState({modal:'startCycle'})" class="px-6 py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">
                üêü ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏õ‡∏•‡∏≤
              </button>

              ${renderCompletedCycles(pond.id)}
            </div>
          </div>
        `;
      }

      const stats = calculations.getCycleStats(cycle.id);
      const todayLogs = calculations.getTodayLogs(cycle.id);
      const todayFeed = todayLogs.reduce((s, l) => s + l.weightKg, 0);
      const feeds = db.feeds.getAll();
      const supplements = db.supplements.getAll();

      return `
        <div class="fade-in">
          <header class="sticky top-0 bg-slate-900/95 backdrop-blur-xl border-b border-slate-700/50 z-40">
            <div class="flex items-center justify-between p-4 max-w-lg mx-auto">
              <button onclick="setState({selectedPond:null})" class="text-slate-400 hover:text-slate-200">‚Äπ ‡∏Å‡∏•‡∏±‡∏ö</button>
              <h1 class="font-semibold truncate max-w-[200px]">${pond.name} - ${cycle.fishTypeName}</h1>
              <div class="w-12"></div>
            </div>
          </header>

          <div class="p-4 max-w-lg mx-auto space-y-4">
            <!-- Days Banner -->
            <div class="bg-gradient-to-r from-cyan-500/20 to-blue-500/20 rounded-2xl p-4 border border-cyan-500/30 text-center">
              <div class="text-4xl font-bold text-cyan-400">${stats.days}</div>
              <div class="text-sm text-slate-300">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</div>
              <div class="text-xs text-slate-400 mt-1">‡∏õ‡∏•‡πà‡∏≠‡∏¢: ${formatDate(cycle.startDate)}</div>
            </div>

            <!-- Fish Info -->
            <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50">
              <h3 class="font-semibold text-slate-200 mb-3">üêü ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏•‡∏≤</h3>
              <div class="grid grid-cols-2 gap-2 text-sm">
                <div><span class="text-slate-400">‡∏ä‡∏ô‡∏¥‡∏î:</span> <span class="text-slate-200">${cycle.fishTypeName}</span></div>
                <div><span class="text-slate-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏•‡πà‡∏≠‡∏¢:</span> <span class="text-slate-200">${formatNumber(cycle.initialCount)} ‡∏ï‡∏±‡∏ß</span></div>
                <div><span class="text-slate-400">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</span> <span class="text-slate-200">${formatNumber(cycle.initialWeight || 0, 1)} ‡∏Å‡∏£‡∏±‡∏°/‡∏ï‡∏±‡∏ß</span></div>
                <div><span class="text-slate-400">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ï‡∏±‡∏ß:</span> <span class="text-slate-200">${formatCurrency(cycle.pricePerFish)}</span></div>
              </div>
            </div>

            <!-- Feed Summary -->
            <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50">
              <h3 class="font-semibold text-slate-200 mb-3">üçΩÔ∏è ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏∞‡∏™‡∏°</h3>
              <div class="grid grid-cols-2 gap-2 text-sm">
                <div><span class="text-slate-400">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏£‡∏ß‡∏°:</span> <span class="text-slate-200">${formatNumber(stats.totalFeed, 1)} ‡∏Å‡∏Å.</span></div>
                <div><span class="text-slate-400">‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£:</span> <span class="text-slate-200">${formatCurrency(stats.feedCost)}</span></div>
                <div><span class="text-slate-400">‡∏Ñ‡πà‡∏≤‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô:</span> <span class="text-slate-200">${formatCurrency(stats.suppCost)}</span></div>
                <div><span class="text-slate-400">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</span> <span class="text-cyan-400">${todayLogs.length} ‡∏°‡∏∑‡πâ‡∏≠ (${formatNumber(todayFeed, 1)} ‡∏Å‡∏Å.)</span></div>
              </div>
              ${db.feedingLogs.getLatest(cycle.id) ? `<div class="mt-3 pt-3 border-t border-slate-700/50 text-xs text-slate-400">üïê ‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${db.feedingLogs.getLatest(cycle.id).time} ‡∏ô.</div>` : ''}
              ${(() => {
                const dailyFeed = calculations.getDailyFeedSummary(cycle.id, 7);
                const chartData = Object.entries(dailyFeed).map(([date, amount]) => ({
                  value: amount,
                  label: date.split('-')[2]
                }));
                if (chartData.length >= 2) {
                  return `
                    <div class="mt-3 pt-3 border-t border-slate-700/50">
                      <div class="text-xs text-slate-400 mb-2">üìä ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏Å‡∏Å./‡∏ß‡∏±‡∏ô)</div>
                      ${createChart(chartData, { color: '#22d3ee', label: 'feed' })}
                    </div>
                  `;
                }
                return '';
              })()}
            </div>

            <!-- Water Quality -->
            ${stats.waterQuality ? `
              <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="font-semibold text-slate-200">üíß ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ô‡πâ‡∏≥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                  <span class="text-xs text-slate-400">${stats.waterQuality.time} ‡∏ô.</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <div class="text-center p-2 bg-slate-700/30 rounded-xl">
                    <div class="text-xl font-bold text-orange-400">${stats.waterQuality.temperature || '-'}¬∞C</div>
                    <div class="text-xs text-slate-400">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</div>
                  </div>
                  <div class="text-center p-2 bg-slate-700/30 rounded-xl">
                    <div class="text-xl font-bold text-cyan-400">${stats.waterQuality.doLevel || '-'}</div>
                    <div class="text-xs text-slate-400">DO (mg/L)</div>
                  </div>
                  <div class="text-center p-2 bg-slate-700/30 rounded-xl">
                    <div class="text-xl font-bold text-green-400">${stats.waterQuality.ph || '-'}</div>
                    <div class="text-xs text-slate-400">pH</div>
                  </div>
                </div>
                ${(() => {
                  const wqHistory = db.waterQuality.getByCycle(cycle.id).slice(0, 10).reverse();
                  if (wqHistory.length >= 2) {
                    return `
                      <div class="mt-4 pt-3 border-t border-slate-700/50">
                        <div class="text-xs text-slate-400 mb-2">üìä ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (${wqHistory.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>
                        ${createChart(wqHistory.map(w => ({ value: w.temperature || 0, label: w.date?.split('-')[2] || '' })), { color: '#fb923c', label: 'temp' })}
                      </div>
                    `;
                  }
                  return '';
                })()}
              </div>
            ` : ''}

            <!-- Metrics -->
            <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50">
              <h3 class="font-semibold text-slate-200 mb-3">üìà ‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î</h3>
              <div class="grid grid-cols-2 gap-3 text-sm">
                <div class="bg-slate-700/30 rounded-xl p-3 text-center">
                  <div class="text-xl font-bold text-cyan-400 font-mono">${stats.fcr}</div>
                  <div class="text-xs text-slate-400">FCR</div>
                </div>
                <div class="bg-slate-700/30 rounded-xl p-3 text-center">
                  <div class="text-xl font-bold text-amber-400">${formatCurrency(stats.costPerFish)}</div>
                  <div class="text-xs text-slate-400">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ï‡∏±‡∏ß</div>
                </div>
                <div class="bg-slate-700/30 rounded-xl p-3 text-center">
                  <div class="text-xl font-bold ${stats.totalMortality > 0 ? 'text-red-400' : 'text-green-400'}">${formatNumber(stats.totalMortality)}</div>
                  <div class="text-xs text-slate-400">‡∏õ‡∏•‡∏≤‡∏ï‡∏≤‡∏¢</div>
                </div>
                <div class="bg-slate-700/30 rounded-xl p-3 text-center">
                  <div class="text-xl font-bold text-green-400">${formatNumber(stats.survivingCount)}</div>
                  <div class="text-xs text-slate-400">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (${stats.survivalRate || '~95'}%)</div>
                </div>
              </div>
              <div class="mt-3 pt-3 border-t border-slate-700/50">
                <div class="flex justify-between text-sm">
                  <span class="text-slate-400">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                  <span class="text-amber-400 font-medium">${formatCurrency(stats.totalCost)}</span>
                </div>
              </div>
            </div>

            <!-- Cost Breakdown (Clickable) -->
            <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50">
              <h3 class="font-semibold text-slate-200 mb-3">üí∞ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô <span class="text-xs text-slate-500">(‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</span></h3>
              <div class="space-y-2 text-sm">
                <button onclick="showCostDetail('fish', '${pond.id}')" class="w-full flex justify-between items-center p-2 -mx-2 rounded-lg hover:bg-slate-700/50 transition-colors">
                  <span class="text-slate-400">üêü ‡∏Ñ‡πà‡∏≤‡∏•‡∏π‡∏Å‡∏õ‡∏•‡∏≤</span>
                  <span class="flex items-center gap-1">${formatCurrency(stats.fishCost)} <span class="text-slate-500">‚Ä∫</span></span>
                </button>
                <button onclick="showCostDetail('feed', '${pond.id}')" class="w-full flex justify-between items-center p-2 -mx-2 rounded-lg hover:bg-slate-700/50 transition-colors">
                  <span class="text-slate-400">üçΩÔ∏è ‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
                  <span class="flex items-center gap-1">${formatCurrency(stats.feedCost)} <span class="text-slate-500">‚Ä∫</span></span>
                </button>
                <button onclick="showCostDetail('supplement', '${pond.id}')" class="w-full flex justify-between items-center p-2 -mx-2 rounded-lg hover:bg-slate-700/50 transition-colors">
                  <span class="text-slate-400">üíä ‡∏Ñ‡πà‡∏≤‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô</span>
                  <span class="flex items-center gap-1">${formatCurrency(stats.suppCost)} <span class="text-slate-500">‚Ä∫</span></span>
                </button>
                <button onclick="showCostDetail('other', '${pond.id}')" class="w-full flex justify-between items-center p-2 -mx-2 rounded-lg hover:bg-slate-700/50 transition-colors">
                  <span class="text-slate-400">üìã ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô</span>
                  <span class="flex items-center gap-1">${formatCurrency(stats.otherCost)} <span class="text-slate-500">‚Ä∫</span></span>
                </button>
                <div class="flex justify-between pt-2 border-t border-slate-700/50 font-medium">
                  <span class="text-slate-300">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                  <span class="text-amber-400">${formatCurrency(stats.totalCost)}</span>
                </div>
              </div>
            </div>

            <!-- Harvest Summary if any -->
            ${stats.harvestData.totalWeight > 0 ? `
              <div class="bg-green-500/10 rounded-2xl p-4 border border-green-500/30">
                <h3 class="font-semibold text-green-400 mb-3">üé£ ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏õ‡∏•‡∏≤</h3>
                <div class="grid grid-cols-2 gap-2 text-sm">
                  <div><span class="text-slate-400">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°:</span> <span class="text-slate-200">${formatNumber(stats.harvestData.totalWeight, 1)} ‡∏Å‡∏Å.</span></div>
                  <div><span class="text-slate-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</span> <span class="text-slate-200">${formatNumber(stats.harvestData.totalCount)} ‡∏ï‡∏±‡∏ß</span></div>
                  <div><span class="text-slate-400">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ:</span> <span class="text-green-400">${formatCurrency(stats.harvestData.totalRevenue)}</span></div>
                  <div><span class="text-slate-400">‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô:</span> <span class="${stats.profit >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(stats.profit)}</span></div>
                </div>
              </div>
            ` : ''}

            <!-- Today's Logs -->
            ${todayLogs.length > 0 ? `
              <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50">
                <h3 class="font-semibold text-slate-200 mb-3">üïê ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                <div class="space-y-2">
                  ${todayLogs.map(log => {
                    const feed = feeds.find(f => f.id === log.feedId);
                    const isMedOnly = log.medicineOnly || false;
                    return `
                      <div class="bg-slate-700/30 rounded-xl p-3 ${isMedOnly ? 'border-l-2 border-rose-500' : ''}">
                        <div class="flex items-center justify-between">
                          <div class="flex items-center gap-2 flex-wrap">
                            <span class="${isMedOnly ? 'text-rose-400' : 'text-cyan-400'} font-mono text-sm">${log.time}</span>
                            ${isMedOnly ? `
                              <span class="text-rose-300">üíâ ‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</span>
                            ` : `
                              <span class="text-slate-300">${feed?.name || '‡∏≠‡∏≤‡∏´‡∏≤‡∏£'}</span>
                              <span class="text-slate-400">${log.weightKg} ‡∏Å‡∏Å.</span>
                            `}
                          </div>
                          <div class="flex items-center gap-1">
                            ${!isMedOnly ? `<button onclick="editFeedingLog('${log.id}')" class="p-1.5 text-slate-400 hover:text-cyan-400 rounded-lg">‚úèÔ∏è</button>` : ''}
                            <button onclick="deleteFeedingLog('${log.id}')" class="p-1.5 text-slate-400 hover:text-red-400 rounded-lg">üóëÔ∏è</button>
                          </div>
                        </div>
                        ${!isMedOnly && log.supplements?.length > 0 ? `<div class="mt-1 text-xs text-slate-400">üíä ${log.supplements.map(s => supplements.find(sp => sp.id === s.supplementId)?.name).join(', ')}</div>` : ''}
                        ${log.medicines?.length > 0 ? `<div class="mt-1 text-xs text-rose-400">üíâ ${log.medicines.map(m => {
                          const med = db.medicines.getById(m.medicineId);
                          return med ? med.name + ' (' + m.amount + ' ' + m.unit + ')' : '';
                        }).filter(Boolean).join(', ')}</div>` : ''}
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : ''}

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 gap-3">
              <button onclick="setState({modal:'feeding'})" class="flex items-center justify-center gap-2 p-4 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-2xl transition-colors font-medium">üçΩÔ∏è ‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
              <button onclick="setState({modal:'waterQuality'})" class="flex items-center justify-center gap-2 p-4 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 rounded-2xl transition-colors font-medium">üíß ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ô‡πâ‡∏≥</button>
              <button onclick="setState({modal:'expense'})" class="flex items-center justify-center gap-2 p-4 bg-amber-500/20 hover:bg-amber-500/30 text-amber-400 rounded-2xl transition-colors font-medium">üí∏ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</button>
              <button onclick="setState({modal:'mortality'})" class="flex items-center justify-center gap-2 p-4 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-2xl transition-colors font-medium">üíÄ ‡∏õ‡∏•‡∏≤‡∏ï‡∏≤‡∏¢</button>
              <button onclick="setState({modal:'harvest'})" class="flex items-center justify-center gap-2 p-4 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-2xl transition-colors font-medium col-span-2">üé£ ‡∏à‡∏±‡∏ö‡∏õ‡∏•‡∏≤</button>
            </div>

            <!-- Reset Button -->
            <button onclick="resetPond()" class="w-full p-3 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-xl transition-colors text-sm flex items-center justify-center gap-2">
              üóëÔ∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ö‡πà‡∏≠ (‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ)
            </button>
          </div>
        </div>
      `;
    };

    const renderCompletedCycles = (pondId) => {
      const completed = db.cycles.getCompleted(pondId);
      if (completed.length === 0) return '';

      return `
        <div class="mt-8 text-left">
          <h3 class="font-semibold text-slate-300 mb-3">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</h3>
          <div class="space-y-2">
            ${completed.slice(0, 5).map(c => {
              const stats = calculations.getCycleStats(c.id);
              return `
                <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                  <div class="flex justify-between items-center">
                    <div>
                      <div class="text-sm text-slate-300">${c.fishTypeName}</div>
                      <div class="text-xs text-slate-500">${formatDate(c.startDate)} - ${formatDate(c.endDate)}</div>
                    </div>
                    <div class="text-right">
                      <div class="text-sm ${stats?.profit >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(stats?.profit || 0)}</div>
                      <div class="text-xs text-slate-500">FCR: ${stats?.fcr || '-'}</div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    };

    const renderInventory = () => {
      const feeds = db.feeds.getAll();
      const supplements = db.supplements.getAll();
      const medicines = db.medicines.getAll();
      const fishTypes = db.fishTypes.getAll();

      // Get collapsed state from state or default all expanded
      const collapsed = state.inventoryCollapsed || {};

      const renderSection = (id, icon, title, count, color, addModal, content) => {
        const isCollapsed = collapsed[id];
        return `
          <div class="mb-4">
            <div class="flex items-center justify-between bg-slate-800/60 rounded-xl p-3 border border-slate-700/50 cursor-pointer hover:bg-slate-700/50 transition-colors" onclick="toggleInventorySection('${id}')">
              <div class="flex items-center gap-3">
                <span class="text-xl">${icon}</span>
                <div>
                  <h2 class="font-semibold text-slate-200">${title}</h2>
                  <span class="text-xs text-slate-500">${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="event.stopPropagation(); setState({modal:'${addModal}'})" class="flex items-center gap-1 px-3 py-1.5 ${color} rounded-lg text-sm">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                <span class="text-slate-400 text-lg">${isCollapsed ? '‚ñ∂' : '‚ñº'}</span>
              </div>
            </div>
            ${!isCollapsed ? `<div class="mt-2 space-y-2">${content}</div>` : ''}
          </div>
        `;
      };

      // Fish Types content
      const fishTypesContent = fishTypes.length === 0
        ? '<p class="text-slate-500 text-sm text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏•‡∏≤</p>'
        : fishTypes.map(ft => `
          <div class="flex items-center justify-between bg-slate-800/40 rounded-xl p-3 border border-slate-700/30">
            <div class="flex-1">
              <div class="flex items-center gap-2">
                <span class="font-medium text-slate-200">${ft.name}</span>
                <span class="px-2 py-0.5 rounded text-xs ${ft.feedType === 'fresh' ? 'bg-orange-500/20 text-orange-400' : 'bg-blue-500/20 text-blue-400'}">${ft.feedType === 'fresh' ? '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏î' : '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏°‡πá‡∏î'}</span>
              </div>
              <div class="text-xs text-slate-400 mt-0.5">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${formatNumber(ft.avgWeight)} ‡∏Å‡∏£‡∏±‡∏°/‡∏ï‡∏±‡∏ß</div>
            </div>
            <div class="flex items-center gap-1">
              <button onclick="editFishType('${ft.id}')" class="p-1.5 text-slate-400 hover:text-cyan-400 rounded-lg">‚úèÔ∏è</button>
              <button onclick="deleteFishType('${ft.id}')" class="p-1.5 text-slate-400 hover:text-red-400 rounded-lg">üóëÔ∏è</button>
              ${ft.editHistory?.length > 0 ? `<button onclick="showFishTypeHistory('${ft.id}')" class="p-1.5 text-slate-400 hover:text-amber-400 rounded-lg" title="‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥">üìú</button>` : ''}
            </div>
          </div>
        `).join('');

      // Feeds content
      const feedsContent = feeds.length === 0
        ? '<p class="text-slate-500 text-sm text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>'
        : feeds.map(f => `
          <div class="flex items-center justify-between bg-slate-800/40 rounded-xl p-3 border border-slate-700/30">
            <div>
              <div class="flex items-center gap-2">
                <span class="px-2 py-0.5 rounded text-xs ${f.type === 'fresh' ? 'bg-orange-500/20 text-orange-400' : 'bg-blue-500/20 text-blue-400'}">${f.type === 'fresh' ? '‡∏™‡∏î' : '‡πÄ‡∏°‡πá‡∏î'}</span>
                <span class="font-medium text-slate-200">${f.name}</span>
              </div>
              ${f.type === 'pellet' && (f.brand || f.sizeNumber || f.bagSize) ? `<div class="text-xs text-slate-400 mt-0.5">${f.brand || ''} ${f.sizeNumber ? `‡πÄ‡∏ö‡∏≠‡∏£‡πå ${f.sizeNumber}` : ''} ${f.useBag && f.bagSize ? `(${f.bagSize}‡∏Å‡∏Å./‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö)` : ''}</div>` : ''}
            </div>
            <div class="flex items-center gap-2">
              <span class="text-slate-300 text-sm">${formatCurrency(f.pricePerKg)}/‡∏Å‡∏Å.</span>
              <button onclick="editFeed('${f.id}')" class="text-slate-400 hover:text-cyan-400" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
              ${f.editHistory && f.editHistory.length > 0 ? `<button onclick="viewFeedHistory('${f.id}')" class="text-slate-400 hover:text-amber-400" title="‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">üìú</button>` : ''}
              <button onclick="deleteFeed('${f.id}')" class="text-slate-400 hover:text-red-400" title="‡∏•‡∏ö">üóëÔ∏è</button>
            </div>
          </div>
        `).join('');

      // Supplements content
      const supplementsContent = supplements.length === 0
        ? '<p class="text-slate-500 text-sm text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô</p>'
        : supplements.map(s => `
          <div class="flex items-center justify-between bg-slate-800/40 rounded-xl p-3 border border-slate-700/30">
            <div>
              <div class="flex items-center gap-2">
                <span class="font-medium text-slate-200">${s.name}</span>
                <span class="px-2 py-0.5 rounded text-xs ${s.suppType === 'liquid' ? 'bg-blue-500/20 text-blue-400' : 'bg-cyan-500/20 text-cyan-400'}">${s.suppType === 'liquid' ? 'üíß ‡∏ô‡πâ‡∏≥' : 'üíä ‡πÄ‡∏°‡πá‡∏î'}</span>
              </div>
              ${s.description ? `<div class="text-xs text-slate-400">${s.description}</div>` : ''}
            </div>
            <div class="flex items-center gap-2">
              <span class="text-slate-300 text-sm">${formatCurrency(s.price)}/${s.packageSize || 100}${s.unit}</span>
              <button onclick="editSupplement('${s.id}')" class="text-slate-400 hover:text-cyan-400" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
              ${s.editHistory && s.editHistory.length > 0 ? `<button onclick="viewSupplementHistory('${s.id}')" class="text-slate-400 hover:text-amber-400" title="‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">üìú</button>` : ''}
              <button onclick="deleteSupplement('${s.id}')" class="text-slate-400 hover:text-red-400" title="‡∏•‡∏ö">üóëÔ∏è</button>
            </div>
          </div>
        `).join('');

      // Medicines content
      const medicinesContent = medicines.length === 0
        ? '<p class="text-slate-500 text-sm text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ</p>'
        : medicines.map(m => `
          <div class="bg-slate-800/40 rounded-xl p-3 border border-slate-700/30">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                <span class="font-medium text-slate-200">${m.name}</span>
                <span class="px-2 py-0.5 rounded text-xs ${m.medType === 'liquid' ? 'bg-blue-500/20 text-blue-400' : 'bg-rose-500/20 text-rose-400'}">${m.medType === 'liquid' ? 'üíß ‡∏ô‡πâ‡∏≥' : 'üíä ‡πÄ‡∏°‡πá‡∏î/‡∏ú‡∏á'}</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-slate-300 text-sm">${formatCurrency(m.price)}/${m.packageSize || 100}${m.unit}</span>
                <button onclick="editMedicine('${m.id}')" class="text-slate-400 hover:text-rose-400" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
                ${m.editHistory && m.editHistory.length > 0 ? `<button onclick="viewMedicineHistory('${m.id}')" class="text-slate-400 hover:text-amber-400" title="‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">üìú</button>` : ''}
                <button onclick="deleteMedicine('${m.id}')" class="text-slate-400 hover:text-red-400" title="‡∏•‡∏ö">üóëÔ∏è</button>
              </div>
            </div>
            ${m.description ? `<div class="text-xs text-slate-400 mb-1">${m.description}</div>` : ''}
            <div class="text-xs text-rose-300 bg-rose-500/10 rounded-lg p-2 mt-2">
              <span class="text-rose-400 font-medium">üìã ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:</span> ${m.usageDetails}
            </div>
          </div>
        `).join('');

      const totalItems = fishTypes.length + feeds.length + supplements.length + medicines.length;

      return `
        <div class="p-4 max-w-lg mx-auto fade-in">
          <div class="flex items-center justify-between mb-4">
            <h1 class="text-xl font-bold">üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h1>
            <span class="text-xs text-slate-500 bg-slate-800/50 px-2 py-1 rounded-lg">${totalItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
          </div>

          <!-- Quick Search -->
          <div class="mb-4">
            <input type="text" id="inventorySearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." oninput="filterInventory(this.value)" class="w-full bg-slate-800/50 border border-slate-700/50 rounded-xl px-4 py-2.5 text-slate-100 placeholder-slate-500 text-sm">
          </div>

          <div id="inventorySections">
            ${renderSection('fishTypes', 'üêü', '‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏•‡∏≤', fishTypes.length, 'bg-cyan-500/20 text-cyan-400', 'addFishType', fishTypesContent)}
            ${renderSection('feeds', 'ü•´', '‡∏≠‡∏≤‡∏´‡∏≤‡∏£', feeds.length, 'bg-cyan-500/20 text-cyan-400', 'addFeed', feedsContent)}
            ${renderSection('supplements', 'üíä', '‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô/‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°', supplements.length, 'bg-cyan-500/20 text-cyan-400', 'addSupplement', supplementsContent)}
            ${renderSection('medicines', 'üíâ', '‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ', medicines.length, 'bg-rose-500/20 text-rose-400', 'addMedicine', medicinesContent)}
          </div>

          <!-- Collapse/Expand All -->
          <div class="flex gap-2 mt-4">
            <button onclick="collapseAllInventory()" class="flex-1 py-2 bg-slate-800/50 hover:bg-slate-700/50 text-slate-400 rounded-xl text-sm transition-colors">‚ñ∂ ‡∏¢‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button onclick="expandAllInventory()" class="flex-1 py-2 bg-slate-800/50 hover:bg-slate-700/50 text-slate-400 rounded-xl text-sm transition-colors">‚ñº ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          </div>

          <!-- Delete All Data -->
          <div class="mt-6 pt-4 border-t border-slate-700/50">
            <button onclick="confirmDeleteAllInventory()" class="w-full py-3 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-xl text-sm font-medium transition-colors border border-red-500/30">
              üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏±‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
          </div>
        </div>
      `;
    };

    // ===== Guides Tab =====
    const renderGuides = () => {
      const allGuides = filterDeleted(db.guides.getAll());
      const selectedCategory = state.guideCategory || 'all';
      const selectedGuide = state.selectedGuide ? db.guides.getById(state.selectedGuide) : null;

      // If viewing a specific guide
      if (selectedGuide) {
        return renderGuideDetail(selectedGuide);
      }

      const filteredGuides = selectedCategory === 'all'
        ? allGuides
        : allGuides.filter(g => g.category === selectedCategory);

      const categoryColors = {
        fish: 'cyan',
        supplement: 'green',
        disease: 'red',
        other: 'purple'
      };

      return `
        <div class="p-4 max-w-lg mx-auto fade-in pb-24">
          <div class="flex items-center justify-between mb-4">
            <h1 class="text-xl font-bold">üìñ ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</h1>
            <button onclick="setState({modal:'addGuide'})" class="px-3 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-xl text-sm font-medium transition-colors flex items-center gap-1">
              ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠
            </button>
          </div>

          <!-- Category Filter -->
          <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
            <button onclick="setState({guideCategory:'all'})" class="px-3 py-1.5 rounded-lg text-sm whitespace-nowrap transition-colors ${selectedCategory === 'all' ? 'bg-slate-600 text-white' : 'bg-slate-800/50 text-slate-400 hover:bg-slate-700/50'}">
              üìö ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${allGuides.length})
            </button>
            ${Object.values(GUIDE_CATEGORIES).map(cat => {
              const count = allGuides.filter(g => g.category === cat.id).length;
              return `
                <button onclick="setState({guideCategory:'${cat.id}'})" class="px-3 py-1.5 rounded-lg text-sm whitespace-nowrap transition-colors ${selectedCategory === cat.id ? `bg-${cat.color}-500/30 text-${cat.color}-400` : 'bg-slate-800/50 text-slate-400 hover:bg-slate-700/50'}">
                  ${cat.icon} ${cat.name} (${count})
                </button>
              `;
            }).join('')}
          </div>

          <!-- Guide List -->
          ${filteredGuides.length === 0 ? `
            <div class="text-center py-12 text-slate-500">
              <div class="text-4xl mb-3">üìñ</div>
              <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠</p>
              <p class="text-sm mt-1">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>
            </div>
          ` : `
            <div class="space-y-3">
              ${filteredGuides.map(guide => {
                const cat = GUIDE_CATEGORIES[guide.category] || GUIDE_CATEGORIES.other;
                return `
                  <div onclick="setState({selectedGuide:'${guide.id}'})" class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50 hover:bg-slate-700/50 cursor-pointer transition-all">
                    <div class="flex items-start gap-3">
                      <div class="text-2xl">${cat.icon}</div>
                      <div class="flex-1 min-w-0">
                        <h3 class="font-semibold text-slate-100 truncate">${guide.title}</h3>
                        <p class="text-sm text-slate-400 mt-1 line-clamp-2">${guide.summary || ''}</p>
                        <div class="flex items-center gap-2 mt-2">
                          <span class="px-2 py-0.5 bg-${cat.color}-500/20 text-${cat.color}-400 rounded text-xs">${cat.name}</span>
                          ${guide.fishType ? `<span class="text-xs text-slate-500">üêü ${guide.fishType}</span>` : ''}
                        </div>
                      </div>
                      <span class="text-slate-500">‚Ä∫</span>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `}

          <!-- Reload Default Guides -->
          <div class="mt-6 pt-4 border-t border-slate-700/50">
            <button onclick="reloadDefaultGuides()" class="w-full py-2 bg-slate-800/50 hover:bg-slate-700/50 text-slate-400 rounded-xl text-sm transition-colors flex items-center justify-center gap-2">
              üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà
            </button>
          </div>
        </div>
      `;
    };

    const renderGuideDetail = (guide) => {
      const cat = GUIDE_CATEGORIES[guide.category] || GUIDE_CATEGORIES.other;

      return `
        <div class="p-4 max-w-lg mx-auto fade-in pb-24">
          <button onclick="setState({selectedGuide:null})" class="flex items-center gap-2 text-slate-400 hover:text-slate-300 mb-4">
            ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠
          </button>

          <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
            <div class="flex items-center gap-2 mb-3">
              <span class="text-2xl">${cat.icon}</span>
              <span class="px-2 py-0.5 bg-${cat.color}-500/20 text-${cat.color}-400 rounded text-xs">${cat.name}</span>
              ${guide.fishType ? `<span class="text-xs text-slate-500">üêü ${guide.fishType}</span>` : ''}
            </div>

            <h1 class="text-xl font-bold text-slate-100 mb-2">${guide.title}</h1>
            ${guide.summary ? `<p class="text-slate-400 mb-4">${guide.summary}</p>` : ''}

            <div class="prose prose-invert prose-sm max-w-none">
              <div class="text-slate-300 whitespace-pre-wrap leading-relaxed">${guide.content || ''}</div>
            </div>

            <div class="flex gap-2 mt-6 pt-4 border-t border-slate-700/50">
              <button onclick="setState({modal:'editGuide', editingGuideId:'${guide.id}'})" class="flex-1 py-2 bg-amber-500/20 hover:bg-amber-500/30 text-amber-400 rounded-lg text-sm font-medium transition-colors">
                ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
              </button>
              <button onclick="confirmDeleteGuide('${guide.id}')" class="flex-1 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg text-sm font-medium transition-colors">
                üóëÔ∏è ‡∏•‡∏ö
              </button>
            </div>

            <div class="text-xs text-slate-500 mt-4 text-center">
              ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(guide.createdAt).toLocaleDateString('th-TH')}
              ${guide.updatedAt !== guide.createdAt ? ` ‚Ä¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date(guide.updatedAt).toLocaleDateString('th-TH')}` : ''}
            </div>
          </div>
        </div>
      `;
    };

    const renderReports = () => {
      const ponds = db.ponds.getAll();
      const activePonds = ponds.filter(p => p.status === 'active');

      return `
        <div class="p-4 max-w-lg mx-auto fade-in">
          <h1 class="text-xl font-bold mb-6">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h1>

          <div class="flex gap-3 mb-6">
            <button onclick="exportReport('text')" class="flex-1 flex items-center justify-center gap-2 p-3 bg-slate-800/50 hover:bg-slate-700/50 rounded-xl border border-slate-700/50 transition-colors">
              üìÑ Export Text
            </button>
            <button onclick="exportReport('json')" class="flex-1 flex items-center justify-center gap-2 p-3 bg-slate-800/50 hover:bg-slate-700/50 rounded-xl border border-slate-700/50 transition-colors">
              üìë Backup JSON
            </button>
          </div>

          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-2">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Restore)</label>
            <input type="file" id="importFile" accept=".json" onchange="importData(event)" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100 file:mr-4 file:py-1 file:px-3 file:rounded-lg file:border-0 file:bg-cyan-500/20 file:text-cyan-400">
          </div>

          ${activePonds.length > 0 ? `
            <div class="space-y-4">
              <h2 class="font-semibold text-slate-200">üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</h2>
              ${activePonds.map(p => {
                const cycle = db.cycles.getActive(p.id);
                const stats = calculations.getCycleStats(cycle.id);
                const startDate = new Date(cycle.startDate);
                const today = new Date();
                const endDateStr = today.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
                const startDateStr = startDate.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
                return `
                  <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                    <div class="flex items-center justify-between mb-2">
                      <h3 class="font-medium text-cyan-400">${p.name}</h3>
                      <span class="text-xs text-slate-400 bg-slate-700/50 px-2 py-1 rounded">${stats.days} ‡∏ß‡∏±‡∏ô</span>
                    </div>
                    <div class="text-xs text-slate-500 mb-3 flex items-center gap-1">
                      üìÖ ${startDateStr} - ${endDateStr}
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                      <div><span class="text-slate-400">‡∏ä‡∏ô‡∏¥‡∏î:</span> ${cycle.fishTypeName}</div>
                      <div><span class="text-slate-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</span> ${formatNumber(cycle.initialCount)} ‡∏ï‡∏±‡∏ß</div>
                      <div><span class="text-slate-400">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏£‡∏ß‡∏°:</span> ${formatNumber(stats.totalFeed, 1)} ‡∏Å‡∏Å.</div>
                      <div><span class="text-slate-400">FCR:</span> ${stats.fcr}</div>
                      <div><span class="text-slate-400">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ï‡∏±‡∏ß:</span> <span class="text-amber-400">${formatCurrency(stats.costPerFish)}</span></div>
                      <div><span class="text-slate-400">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°:</span> <span class="text-amber-400">${formatCurrency(stats.totalCost)}</span></div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          ` : `
            <div class="text-center py-8 text-slate-400">
              <div class="text-4xl mb-3">üìä</div>
              <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</p>
            </div>
          `}
        </div>
      `;
    };

    const renderSettings = () => {
      const storageUsage = storage.getStorageUsage();
      const ponds = db.ponds.getAll();
      const feeds = db.feeds.getAll();
      const supplements = db.supplements.getAll();
      const medicines = db.medicines.getAll();
      const fishTypes = db.fishTypes.getAll();
      const cycles = storage.get(KEYS.CYCLES);
      const feedingLogs = storage.get(KEYS.FEEDING_LOGS);
      const waterQuality = storage.get(KEYS.WATER_QUALITY);
      const expenses = storage.get(KEYS.EXPENSES);
      const harvests = storage.get(KEYS.HARVESTS);

      return `
        <div class="p-4 max-w-lg mx-auto fade-in">
          <h1 class="text-xl font-bold mb-6">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h1>

          <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50 mb-4">
            <h3 class="font-semibold mb-3">‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÅ‡∏≠‡∏õ</h3>
            <div class="text-sm text-slate-400 space-y-1">
              <p>üêü Fish Farm Pro v1.2</p>
              <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏õ‡∏•‡∏≤</p>
            </div>
          </div>

          <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50 mb-4">
            <h3 class="font-semibold mb-3">üé® ‡∏ò‡∏µ‡∏°‡∏™‡∏µ</h3>
            <div class="flex gap-3">
              <button onclick="setTheme('dark')" id="btnThemeDark" class="flex-1 p-3 rounded-xl border ${getCurrentTheme() === 'dark' ? 'bg-slate-700/50 border-cyan-500/50 text-cyan-400' : 'bg-slate-700/30 border-slate-600 text-slate-400'} transition-colors text-sm">
                üåô ‡∏°‡∏∑‡∏î (Dark)
              </button>
              <button onclick="setTheme('pastel')" id="btnThemePastel" class="flex-1 p-3 rounded-xl border ${getCurrentTheme() === 'pastel' ? 'bg-cyan-500/20 border-cyan-500/50 text-cyan-400' : 'bg-slate-700/30 border-slate-600 text-slate-400'} transition-colors text-sm">
                üå∏ ‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏• (Pastel)
              </button>
            </div>
          </div>

          <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50 mb-4">
            <h3 class="font-semibold mb-3">üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div class="bg-slate-700/30 rounded-lg p-2 flex justify-between">
                <span class="text-slate-400">üî≤ ‡∏ö‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</span>
                <span class="text-cyan-400 font-medium">${ponds.length}</span>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2 flex justify-between">
                <span class="text-slate-400">üêü ‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏•‡∏≤</span>
                <span class="text-cyan-400 font-medium">${fishTypes.length}</span>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2 flex justify-between">
                <span class="text-slate-400">ü•´ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
                <span class="text-cyan-400 font-medium">${feeds.length}</span>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2 flex justify-between">
                <span class="text-slate-400">üíä ‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô</span>
                <span class="text-cyan-400 font-medium">${supplements.length}</span>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2 flex justify-between">
                <span class="text-slate-400">üíâ ‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ</span>
                <span class="text-cyan-400 font-medium">${medicines.length}</span>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2 flex justify-between">
                <span class="text-slate-400">üîÑ ‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</span>
                <span class="text-cyan-400 font-medium">${cycles.length}</span>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2 flex justify-between">
                <span class="text-slate-400">üçΩÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
                <span class="text-cyan-400 font-medium">${feedingLogs.length}</span>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2 flex justify-between">
                <span class="text-slate-400">üíß ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥</span>
                <span class="text-cyan-400 font-medium">${waterQuality.length}</span>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2 flex justify-between">
                <span class="text-slate-400">üí∞ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</span>
                <span class="text-cyan-400 font-medium">${expenses.length}</span>
              </div>
              <div class="bg-slate-700/30 rounded-lg p-2 flex justify-between col-span-2">
                <span class="text-slate-400">üé£ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏±‡∏ö‡∏õ‡∏•‡∏≤</span>
                <span class="text-cyan-400 font-medium">${harvests.length}</span>
              </div>
            </div>
          </div>

          <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50 mb-4">
            <h3 class="font-semibold mb-3">üíæ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <div class="text-sm text-slate-400">
              <div class="flex items-center justify-between mb-2">
                <span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏≠‡∏õ‡πÉ‡∏ä‡πâ:</span>
                <span class="text-cyan-400 font-medium">${storageUsage} KB</span>
              </div>
              <div id="diskSpaceInfo" class="mt-2">
                <div class="text-xs text-slate-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà...</div>
              </div>
              <div class="mt-3 text-xs text-slate-500" id="dataPathInfo"></div>
            </div>
          </div>

          <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50 mb-4">
            <h3 class="font-semibold mb-3">‚òÅÔ∏è Firebase Cloud Sync</h3>
            <p class="text-sm text-slate-400 mb-3">Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≤‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>

            ${isLocalOnly() ? `
              <!-- Offline Mode -->
              <div class="flex items-center gap-3 p-4 bg-slate-700/30 border border-slate-600 rounded-xl mb-4">
                <div class="w-12 h-12 rounded-full bg-slate-600/50 flex items-center justify-center text-2xl">üì¥</div>
                <div class="flex-1">
                  <div class="font-medium text-slate-300">‡πÇ‡∏´‡∏°‡∏î Offline</div>
                  <div class="text-xs text-slate-500">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
                </div>
              </div>
              <button onclick="showFirebaseSetupWizard()" class="w-full p-4 bg-gradient-to-r from-cyan-500/20 to-blue-500/20 hover:from-cyan-500/30 hover:to-blue-500/30 border border-cyan-500/30 text-cyan-400 rounded-xl transition-all text-sm font-medium flex items-center justify-center gap-2">
                <span class="text-xl">‚òÅÔ∏è</span>
                <span>‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Cloud Sync</span>
              </button>
            ` : `
              <!-- Online Mode -->
              <div class="flex items-center gap-3 p-4 ${isOnline() ? 'bg-green-500/10 border-green-500/30' : 'bg-amber-500/10 border-amber-500/30'} border rounded-xl mb-4">
                <div class="w-12 h-12 rounded-full ${isOnline() ? 'bg-green-500/20' : 'bg-amber-500/20'} flex items-center justify-center text-2xl">
                  ${isOnline() ? '‚úÖ' : '‚è≥'}
                </div>
                <div class="flex-1">
                  <div class="font-medium ${isOnline() ? 'text-green-400' : 'text-amber-400'}">
                    ${isOnline() ? '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...'}
                  </div>
                  <div class="text-xs ${isOnline() ? 'text-green-500/70' : 'text-amber-500/70'}">
                    ${isOnline() ? '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞ sync ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥' : '‡∏£‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì...'}
                  </div>
                </div>
                <div class="text-2xl ${isOnline() ? '' : 'animate-pulse'}">
                  ${isOnline() ? 'üü¢' : 'üü°'}
                </div>
              </div>

              <!-- Sync Actions -->
              <div class="grid grid-cols-2 gap-2 mb-4">
                <button onclick="manualSyncUpload()" class="p-3 bg-blue-500/10 hover:bg-blue-500/20 border border-blue-500/30 text-blue-400 rounded-xl transition-colors text-sm flex flex-col items-center gap-1" ${!isOnline() ? 'disabled' : ''}>
                  <span class="text-xl">üì§</span>
                  <span>‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡∏∂‡πâ‡∏ô Cloud</span>
                </button>
                <button onclick="manualSyncDownload()" class="p-3 bg-purple-500/10 hover:bg-purple-500/20 border border-purple-500/30 text-purple-400 rounded-xl transition-colors text-sm flex flex-col items-center gap-1" ${!isOnline() ? 'disabled' : ''}>
                  <span class="text-xl">üì•</span>
                  <span>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Cloud</span>
                </button>
              </div>

              <!-- Firebase Info -->
              <div class="bg-slate-700/30 rounded-xl p-3 mb-4">
                <div class="text-xs text-slate-500 mb-1">Project ID</div>
                <div class="text-sm text-slate-300 font-mono truncate">${getFirebaseConfig()?.projectId || '-'}</div>
              </div>

              <!-- Reset Button -->
              <button onclick="confirmResetFirebase()" class="w-full p-3 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 text-red-400 rounded-xl transition-colors text-sm flex items-center justify-center gap-2">
                <span>üîÑ</span>
                <span>‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase</span>
              </button>
            `}
          </div>

          <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50 mb-4">
            <h3 class="font-semibold mb-3">üîê ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏•‡∏ö Stock</h3>
            <p class="text-sm text-slate-400 mb-3">‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö Stock ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à</p>
            ${db.stockPassword.isEnabled() ? `
              <div class="flex items-center justify-between p-3 bg-green-500/10 border border-green-500/30 rounded-xl mb-3">
                <span class="text-green-400 text-sm">‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</span>
              </div>
              <button onclick="setState({modal:'stockPasswordManage'})" class="w-full p-3 bg-cyan-500/10 hover:bg-cyan-500/20 text-cyan-400 rounded-xl transition-colors text-sm">
                ‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
              </button>
            ` : `
              <div class="flex items-center justify-between p-3 bg-slate-700/30 border border-slate-600 rounded-xl mb-3">
                <span class="text-slate-400 text-sm">‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
              </div>
              <button onclick="setState({modal:'stockPasswordManage'})" class="w-full p-3 bg-cyan-500/10 hover:bg-cyan-500/20 text-cyan-400 rounded-xl transition-colors text-sm">
                üîê ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
              </button>
            `}
          </div>

          <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50 mb-4">
            <h3 class="font-semibold mb-3">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Export)</h3>
            <p class="text-sm text-slate-400 mb-3">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå</p>
            <div class="space-y-2">
              <button onclick="exportFeedingData()" class="w-full p-3 bg-orange-500/10 hover:bg-orange-500/20 text-orange-400 rounded-xl transition-colors text-sm flex items-center justify-center gap-2">
                <span>üçΩÔ∏è</span>
                <span>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
              </button>
              <button onclick="exportStockData()" class="w-full p-3 bg-green-500/10 hover:bg-green-500/20 text-green-400 rounded-xl transition-colors text-sm flex items-center justify-center gap-2">
                <span>üì¶</span>
                <span>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
              </button>
              <button onclick="exportAllDataCSV()" class="w-full p-3 bg-cyan-500/10 hover:bg-cyan-500/20 text-cyan-400 rounded-xl transition-colors text-sm flex items-center justify-center gap-2">
                <span>üìä</span>
                <span>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (CSV)</span>
              </button>
              <button onclick="exportAllDataJSON()" class="w-full p-3 bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 rounded-xl transition-colors text-sm flex items-center justify-center gap-2">
                <span>üíæ</span>
                <span>‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (JSON)</span>
              </button>
            </div>
          </div>

          <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50">
            <h3 class="font-semibold mb-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <button onclick="clearAllData()" class="w-full p-3 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-xl transition-colors text-sm">
              üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
          </div>
        </div>
      `;
    };

    const renderBottomNav = () => {
      const tabs = [
        { id: 'home', icon: 'üè†', label: '‡∏ö‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á' },
        { id: 'inventory', icon: 'üì¶', label: '‡∏Ñ‡∏•‡∏±‡∏á' },
        { id: 'guides', icon: 'üìñ', label: '‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠' },
        { id: 'reports', icon: 'üìä', label: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô' },
        { id: 'settings', icon: '‚öôÔ∏è', label: '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤' }
      ];

      return `
        <nav class="fixed bottom-0 left-0 right-0 bg-slate-800/95 backdrop-blur-xl border-t border-slate-700/50 z-50">
          <div class="max-w-lg mx-auto flex justify-around py-2">
            ${tabs.map(t => `
              <button onclick="setState({tab:'${t.id}'})" class="flex flex-col items-center py-2 px-5 rounded-xl transition-all ${state.tab === t.id ? 'text-cyan-400 bg-cyan-500/10' : 'text-slate-400'}">
                <span class="text-xl">${t.icon}</span>
                <span class="text-xs mt-1">${t.label}</span>
              </button>
            `).join('')}
          </div>
        </nav>
      `;
    };

    const renderModal = () => {
      const modals = {
        createPond: renderCreatePondModal,
        startCycle: renderStartCycleModal,
        feeding: renderFeedingModal,
        waterQuality: renderWaterQualityModal,
        expense: renderExpenseModal,
        harvest: renderHarvestModal,
        addFeed: renderAddFeedModal,
        addSupplement: renderAddSupplementModal,
        addMedicine: renderAddMedicineModal,
        editFeeding: renderEditFeedingModal,
        addFishType: renderAddFishTypeModal,
        editFishType: renderEditFishTypeModal,
        fishTypeHistory: renderFishTypeHistoryModal,
        editFeed: renderEditFeedModal,
        feedHistory: renderFeedHistoryModal,
        editSupplement: renderEditSupplementModal,
        supplementHistory: renderSupplementHistoryModal,
        editMedicine: renderEditMedicineModal,
        medicineHistory: renderMedicineHistoryModal,
        mortality: renderMortalityModal,
        addFeedStock: renderAddFeedStockModal,
        editFeedStock: renderEditFeedStockModal,
        stockHistory: renderStockHistoryModal,
        stockPasswordConfirm: renderStockPasswordConfirmModal,
        stockPasswordManage: renderStockPasswordManageModal,
        addGuide: renderAddGuideModal,
        editGuide: renderEditGuideModal
      };

      const modalFn = modals[state.modal];
      if (!modalFn) return '';

      return `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-4" onclick="if(event.target===this)setState({modal:null})">
          <div class="bg-slate-800 rounded-t-3xl sm:rounded-2xl w-full max-w-md max-h-[85vh] overflow-hidden flex flex-col slide-up" onclick="event.stopPropagation()">
            ${modalFn()}
          </div>
        </div>
      `;
    };

    const renderModalHeader = (title) => `
      <div class="flex items-center justify-between p-4 border-b border-slate-700/50 flex-shrink-0">
        <h2 class="text-lg font-semibold">${title}</h2>
        <button onclick="setState({modal:null})" class="p-2 hover:bg-slate-700 rounded-lg transition-colors">‚úï</button>
      </div>
    `;

    const renderCreatePondModal = () => `
      ${renderModalHeader('üî≤ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà')}
      <div class="p-4 overflow-y-auto">
        <form onsubmit="createPond(event)">
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πà‡∏≠ <span class="text-red-400">*</span></label>
            <input type="text" name="name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡πà‡∏≠ A" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100 placeholder-slate-500 focus:outline-none focus:border-cyan-500 transition-colors">
          </div>
          <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡πà‡∏≠</button>
        </form>
      </div>
    `;

    const renderStartCycleModal = () => {
      const fishTypes = db.fishTypes.getAll();
      return `
        ${renderModalHeader('üêü ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏õ‡∏•‡∏≤')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="startCycle(event)">
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏•‡∏≤ <span class="text-red-400">*</span></label>
              <select name="fishType" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
                ${fishTypes.map(f => `<option value="${f.id}">${f.name}</option>`).join('')}
              </select>
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡πà‡∏≠‡∏¢ <span class="text-red-400">*</span></label>
              <input type="date" name="startDate" value="${new Date().toISOString().split('T')[0]}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ï‡∏±‡∏ß) <span class="text-red-400">*</span></label>
              <input type="number" name="count" placeholder="5000" min="1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏Å‡∏£‡∏±‡∏°/‡∏ï‡∏±‡∏ß) <span class="text-red-400">*</span></label>
              <input type="number" step="0.1" name="initialWeight" placeholder="5" min="0.1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ï‡∏±‡∏ß (‡∏ö‡∏≤‡∏ó) <span class="text-red-400">*</span></label>
              <input type="number" step="0.01" name="price" placeholder="0.60" min="0.01" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</button>
          </form>
        </div>
      `;
    };

    const renderFeedingModal = () => {
      const pond = db.ponds.getById(state.selectedPond);
      const cycle = db.cycles.getActive(pond?.id);
      if (!cycle) return '';

      const fishType = db.fishTypes.getById(cycle.fishType);
      const defaultFeedType = fishType?.feedType || 'pellet';
      // Only show feeds with stock > 0
      const allFeeds = db.feeds.getAll().map(f => ({
        ...f,
        stock: db.feedStock.getStock(f.id)
      }));
      const pelletFeeds = allFeeds.filter(f => f.type === 'pellet' && f.stock > 0);
      const freshFeeds = allFeeds.filter(f => f.type === 'fresh' && f.stock > 0);
      const supplements = db.supplements.getAll();
      const medicines = db.medicines.getAll();

      return `
        ${renderModalHeader('üçΩÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="addFeeding(event)">
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡πÄ‡∏ß‡∏•‡∏≤</label>
              <input type="time" name="time" value="${new Date().toTimeString().slice(0,5)}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>

            ${medicines.length > 0 ? `
            <!-- Medicine Only Toggle -->
            <div class="mb-4 p-3 bg-rose-500/10 border border-rose-500/30 rounded-xl">
              <label class="flex items-center gap-3 cursor-pointer">
                <input type="checkbox" name="medicineOnly" id="medicineOnlyToggle" class="w-5 h-5 rounded bg-slate-600 accent-rose-500" onchange="toggleMedicineOnlyMode(this.checked)">
                <span class="text-rose-300 font-medium">üíâ ‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£)</span>
              </label>
            </div>
            ` : ''}

            <!-- Feed Section (hidden when medicine-only) -->
            <div id="feedSection">
              <!-- Feed Type Tabs -->
              <div class="mb-4">
                <label class="block text-sm text-slate-400 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏´‡∏≤‡∏£</label>
                <div class="flex gap-2 mb-3">
                  <button type="button" id="tabPellet" onclick="switchFeedTab('pellet')" class="flex-1 p-2 rounded-xl border ${defaultFeedType === 'pellet' ? 'bg-blue-500/20 border-blue-500/50 text-blue-400' : 'bg-slate-700/50 border-slate-600 text-slate-400'} transition-colors text-sm">
                    üîµ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏°‡πá‡∏î
                  </button>
                  <button type="button" id="tabFresh" onclick="switchFeedTab('fresh')" class="flex-1 p-2 rounded-xl border ${defaultFeedType === 'fresh' ? 'bg-orange-500/20 border-orange-500/50 text-orange-400' : 'bg-slate-700/50 border-slate-600 text-slate-400'} transition-colors text-sm">
                    üü† ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏î
                  </button>
                </div>
                <input type="hidden" name="feedType" value="${defaultFeedType}">

              <!-- Pellet Feeds -->
              <div id="pelletFeeds" class="${defaultFeedType === 'pellet' ? '' : 'hidden'}">
                ${pelletFeeds.length > 0 ? `
                  <div class="space-y-2 max-h-32 overflow-y-auto">
                    ${pelletFeeds.map((f, i) => `
                      <label class="flex items-center gap-3 bg-slate-700/30 rounded-xl p-3 cursor-pointer hover:bg-slate-700/50">
                        <input type="radio" name="feedId" value="${f.id}" ${i === 0 && defaultFeedType === 'pellet' ? 'checked' : ''} class="w-4 h-4 accent-cyan-500">
                        <div class="flex-1">
                          <span class="text-slate-200">${f.name} ${f.brand ? `(${f.brand})` : ''}</span>
                          <div class="text-xs ${f.stock < 10 ? 'text-red-400' : f.stock < 30 ? 'text-amber-400' : 'text-green-400'}">‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${formatNumber(f.stock, 1)} ‡∏Å‡∏Å.</div>
                        </div>
                        <span class="text-xs text-slate-400">${formatCurrency(f.pricePerKg)}/‡∏Å‡∏Å.</span>
                      </label>
                    `).join('')}
                  </div>
                ` : '<p class="text-amber-500 text-sm text-center py-2">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏°‡πá‡∏î‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</p>'}
              </div>

              <!-- Fresh Feeds -->
              <div id="freshFeeds" class="${defaultFeedType === 'fresh' ? '' : 'hidden'}">
                ${freshFeeds.length > 0 ? `
                  <div class="space-y-2 max-h-32 overflow-y-auto">
                    ${freshFeeds.map((f, i) => `
                      <label class="flex items-center gap-3 bg-slate-700/30 rounded-xl p-3 cursor-pointer hover:bg-slate-700/50">
                        <input type="radio" name="feedId" value="${f.id}" ${i === 0 && defaultFeedType === 'fresh' ? 'checked' : ''} class="w-4 h-4 accent-cyan-500">
                        <div class="flex-1">
                          <span class="text-slate-200">${f.name}</span>
                          <div class="text-xs ${f.stock < 10 ? 'text-red-400' : f.stock < 30 ? 'text-amber-400' : 'text-green-400'}">‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${formatNumber(f.stock, 1)} ‡∏Å‡∏Å.</div>
                        </div>
                        <span class="text-xs text-slate-400">${formatCurrency(f.pricePerKg)}/‡∏Å‡∏Å.</span>
                      </label>
                    `).join('')}
                  </div>
                ` : '<p class="text-amber-500 text-sm text-center py-2">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏î‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</p>'}
              </div>
              </div>

              <div class="mb-4" id="feedWeightDiv">
                <label class="block text-sm text-slate-400 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.) <span class="text-red-400">*</span></label>
                <input type="number" step="0.1" name="weight" id="feedWeight" placeholder="15" min="0.1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
              </div>
            </div>

            <!-- Supplements Section -->
            ${supplements.length > 0 ? `
              <div class="mb-4">
                <label class="block text-sm text-slate-400 mb-2">üíä ‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô/‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</label>
                <div class="space-y-2 max-h-40 overflow-y-auto">
                  ${supplements.map(s => `
                    <div class="flex items-center gap-3 bg-slate-700/30 rounded-xl p-3">
                      <input type="checkbox" name="supp_${s.id}" id="supp_${s.id}" class="w-5 h-5 rounded bg-slate-600 accent-cyan-500" onchange="toggleSuppInput('${s.id}')">
                      <label for="supp_${s.id}" class="flex-1 text-slate-200 cursor-pointer">
                        ${s.name}
                        <span class="text-xs ${s.suppType === 'liquid' ? 'text-blue-400' : 'text-cyan-400'}">${s.suppType === 'liquid' ? 'üíß' : 'üíä'}</span>
                      </label>
                      <input type="number" id="suppAmt_${s.id}" name="suppAmt_${s.id}" value="10" min="1" disabled class="w-16 bg-slate-600 rounded-lg px-2 py-1 text-sm disabled:opacity-50">
                      <span class="text-xs text-slate-400 w-8">${s.unit}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            <!-- Medicines Section -->
            ${medicines.length > 0 ? `
              <div class="mb-4">
                <label class="block text-sm text-slate-400 mb-2">üíâ ‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</label>
                <div class="space-y-2 max-h-40 overflow-y-auto">
                  ${medicines.map(m => `
                    <div class="bg-slate-700/30 rounded-xl p-3">
                      <div class="flex items-center gap-3">
                        <input type="checkbox" name="med_${m.id}" id="med_${m.id}" class="w-5 h-5 rounded bg-slate-600 accent-rose-500" onchange="toggleMedInput('${m.id}')">
                        <label for="med_${m.id}" class="flex-1 text-slate-200 cursor-pointer">
                          ${m.name}
                          <span class="text-xs ${m.medType === 'liquid' ? 'text-blue-400' : 'text-rose-400'}">${m.medType === 'liquid' ? 'üíß' : 'üíä'}</span>
                        </label>
                        <input type="number" id="medAmt_${m.id}" name="medAmt_${m.id}" value="10" min="1" disabled class="w-16 bg-slate-600 rounded-lg px-2 py-1 text-sm disabled:opacity-50">
                        <span class="text-xs text-slate-400 w-8">${m.unit}</span>
                      </div>
                      <div class="text-xs text-rose-300/70 mt-1 pl-8">üìã ${m.usageDetails}</div>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
              <input type="text" name="notes" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <button type="submit" id="feedingSubmitBtn" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
          </form>
        </div>
      `;
    };

    const renderEditFeedingModal = () => {
      const log = state.editingLog;
      if (!log) return '';
      const feeds = db.feeds.getAll();

      return `
        ${renderModalHeader('‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="updateFeeding(event, '${log.id}')">
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡πÄ‡∏ß‡∏•‡∏≤</label>
              <input type="time" name="time" value="${log.time}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£</label>
              <select name="feedId" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
                ${feeds.map(f => `<option value="${f.id}" ${f.id === log.feedId ? 'selected' : ''}>${f.name}</option>`).join('')}
              </select>
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label>
              <input type="number" step="0.1" name="weight" value="${log.weightKg}" min="0.1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          </form>
        </div>
      `;
    };

    const renderWaterQualityModal = () => `
      ${renderModalHeader('üíß ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ô‡πâ‡∏≥')}
      <div class="p-4 overflow-y-auto">
        <form onsubmit="addWaterQuality(event)">
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡πÄ‡∏ß‡∏•‡∏≤</label>
            <input type="time" name="time" value="${new Date().toTimeString().slice(0,5)}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="grid grid-cols-3 gap-3 mb-4">
            <div>
              <label class="block text-sm text-slate-400 mb-1">Temp (¬∞C)</label>
              <input type="number" step="0.1" name="temp" placeholder="28.5" min="0" max="50" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div>
              <label class="block text-sm text-slate-400 mb-1">DO (mg/L)</label>
              <input type="number" step="0.1" name="do" placeholder="5.2" min="0" max="20" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div>
              <label class="block text-sm text-slate-400 mb-1">pH</label>
              <input type="number" step="0.1" name="ph" placeholder="7.8" min="0" max="14" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            <input type="text" name="notes" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </form>
      </div>
    `;

    const renderExpenseModal = () => `
      ${renderModalHeader('üí∏ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢')}
      <div class="p-4 overflow-y-auto">
        <form onsubmit="addExpense(event)">
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" name="date" value="${new Date().toISOString().split('T')[0]}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
            <select name="category" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
              ${EXPENSE_CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('')}
            </select>
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î <span class="text-red-400">*</span></label>
            <input type="text" name="description" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó) <span class="text-red-400">*</span></label>
            <input type="number" name="amount" placeholder="500" min="1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</button>
        </form>
      </div>
    `;

    const renderHarvestModal = () => {
      const pond = db.ponds.getById(state.selectedPond);
      const cycle = db.cycles.getActive(pond?.id);
      const fishType = cycle ? db.fishTypes.getById(cycle.fishType) : null;
      const defaultAvgWeight = fishType?.avgWeight || 150;

      return `
        ${renderModalHeader('üé£ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏õ‡∏•‡∏≤')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="addHarvest(event)">
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö</label>
              <input type="date" name="date" value="${new Date().toISOString().split('T')[0]}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>

            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ï‡∏±‡∏ß (‡∏Å‡∏£‡∏±‡∏°) <span class="text-red-400">*</span></label>
              <input type="number" step="1" name="avgWeight" id="harvestAvgWeight" placeholder="${defaultAvgWeight}" value="${defaultAvgWeight}" min="1" required oninput="calculateHarvestCount()" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
              <p class="text-xs text-slate-500 mt-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏õ‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡∏ï‡∏±‡∏ß</p>
            </div>

            <div class="bg-slate-700/30 rounded-xl p-4 mb-4 border border-slate-600/50">
              <h4 class="text-sm font-medium text-green-400 mb-3">üéØ ‡∏õ‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢ (‡πÑ‡∏î‡πâ‡∏Ç‡∏ô‡∏≤‡∏î)</h4>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-sm text-slate-400 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.) <span class="text-red-400">*</span></label>
                  <input type="number" step="0.1" name="soldWeight" id="harvestSoldWeight" placeholder="450" min="0" required oninput="calculateHarvestCount()" class="w-full bg-slate-600 border border-slate-500 rounded-xl px-4 py-3 text-slate-100">
                </div>
                <div>
                  <label class="block text-sm text-slate-400 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.) <span class="text-red-400">*</span></label>
                  <input type="number" step="0.1" name="soldPrice" placeholder="55" min="0.1" required class="w-full bg-slate-600 border border-slate-500 rounded-xl px-4 py-3 text-slate-100">
                </div>
              </div>
              <div class="mt-2 text-sm text-slate-300">
                ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: <span id="soldCount" class="text-green-400 font-medium">0</span> ‡∏ï‡∏±‡∏ß
              </div>
            </div>

            <div class="bg-slate-700/30 rounded-xl p-4 mb-4 border border-slate-600/50">
              <h4 class="text-sm font-medium text-amber-400 mb-3">üì¶ ‡∏õ‡∏•‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ç‡∏ô‡∏≤‡∏î</h4>
              <div class="mb-3">
                <label class="block text-sm text-slate-400 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label>
                <input type="number" step="0.1" name="undersizedWeight" id="harvestUndersizedWeight" placeholder="0" value="0" min="0" oninput="calculateHarvestCount()" class="w-full bg-slate-600 border border-slate-500 rounded-xl px-4 py-3 text-slate-100">
              </div>
              <div class="flex gap-3 mb-3">
                <label class="flex-1 flex items-center gap-2 cursor-pointer bg-slate-600/50 rounded-xl p-3 border border-slate-500/50" onclick="selectUndersizedAction('sell')">
                  <input type="radio" name="undersizedAction" value="sell" id="actionSell" class="accent-green-500">
                  <span class="text-sm text-slate-200">‡∏Ç‡∏≤‡∏¢</span>
                </label>
                <label class="flex-1 flex items-center gap-2 cursor-pointer bg-slate-600/50 rounded-xl p-3 border border-slate-500/50" onclick="selectUndersizedAction('keep')">
                  <input type="radio" name="undersizedAction" value="keep" id="actionKeep" checked class="accent-amber-500">
                  <span class="text-sm text-slate-200">‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ï‡πà‡∏≠</span>
                </label>
              </div>
              <div id="undersizedPriceSection" class="hidden">
                <label class="block text-sm text-slate-400 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.)</label>
                <input type="number" step="0.1" name="undersizedPrice" id="harvestUndersizedPrice" placeholder="35" value="0" min="0" class="w-full bg-slate-600 border border-slate-500 rounded-xl px-4 py-3 text-slate-100">
              </div>
              <div class="mt-2 text-sm text-slate-300">
                ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: <span id="undersizedCount" class="text-amber-400 font-medium">0</span> ‡∏ï‡∏±‡∏ß
                <span id="undersizedActionText" class="text-amber-400/70 ml-1">(‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ï‡πà‡∏≠)</span>
              </div>
            </div>

            <div class="bg-cyan-500/10 rounded-xl p-3 mb-4 border border-cyan-500/30">
              <div class="flex justify-between text-sm">
                <span class="text-slate-300">‡∏£‡∏ß‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                <span id="totalHarvestWeight" class="text-cyan-400 font-bold">0 ‡∏Å‡∏Å.</span>
              </div>
              <div class="flex justify-between text-sm mt-1">
                <span class="text-slate-300">‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                <span id="totalHarvestCount" class="text-cyan-400 font-bold">0 ‡∏ï‡∏±‡∏ß</span>
              </div>
            </div>

            <div class="mb-4 flex items-center gap-3 bg-amber-500/10 border border-amber-500/30 rounded-xl p-3">
              <input type="checkbox" name="isFinal" class="w-5 h-5 rounded accent-amber-500">
              <div>
                <div class="text-amber-400 font-medium">‡∏à‡∏±‡∏ö‡∏´‡∏°‡∏î‡∏ö‡πà‡∏≠</div>
                <div class="text-xs text-slate-400">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡∏à‡∏ö‡∏£‡∏≠‡∏ö</div>
              </div>
            </div>
            <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö</button>
          </form>
        </div>
      `;
    };

    const renderAddFeedModal = () => `
      ${renderModalHeader('ü•´ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£')}
      <div class="p-4 overflow-y-auto">
        <form onsubmit="addFeed(event)">
          <div class="flex gap-3 mb-4">
            <button type="button" id="btnFresh" onclick="selectFeedType('fresh')" class="flex-1 p-3 rounded-xl border bg-orange-500/20 border-orange-500/50 text-orange-400 transition-colors">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏î</button>
            <button type="button" id="btnPellet" onclick="selectFeedType('pellet')" class="flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏°‡πá‡∏î</button>
            <input type="hidden" name="type" value="fresh">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£ <span class="text-red-400">*</span></label>
            <input type="text" name="name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏î, CP 9950" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏°‡πá‡∏î)</label>
            <input type="text" name="brand" placeholder="CP, Betagro" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏°‡πá‡∏î)</label>
            <input type="text" name="sizeNumber" placeholder="1, 2, 3" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div id="bagSizeSection" class="mb-4 hidden">
            <div class="mb-3">
              <label class="flex items-center gap-3 cursor-pointer bg-slate-700/30 rounded-xl p-3">
                <input type="checkbox" name="useBag" id="useBagCheckbox" checked class="w-5 h-5 rounded bg-slate-600 accent-blue-500" onchange="toggleBagSizeInput(this.checked)">
                <span class="text-slate-200">‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</span>
              </label>
            </div>
            <div id="bagSizeInput">
              <label class="block text-sm text-slate-400 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö (‡∏Å‡∏Å.)</label>
              <input type="number" step="0.1" name="bagSize" placeholder="20" value="20" min="1" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.) <span class="text-red-400">*</span></label>
            <input type="number" step="0.1" name="price" placeholder="15" min="0.1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
        </form>
      </div>
    `;

    const renderAddSupplementModal = () => `
      ${renderModalHeader('üíä ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô/‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°')}
      <div class="p-4 overflow-y-auto">
        <form onsubmit="addSupplement(event)">
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏ä‡∏∑‡πà‡∏≠ <span class="text-red-400">*</span></label>
            <input type="text" name="name" placeholder="Vitamin C" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
            <input type="text" name="description" placeholder="‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏†‡∏π‡∏°‡∏¥‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
            <div class="flex gap-3">
              <button type="button" id="btnSuppLiquid" onclick="selectSuppType('liquid')" class="flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors">üíß ‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß</button>
              <button type="button" id="btnSuppSolid" onclick="selectSuppType('solid')" class="flex-1 p-3 rounded-xl border bg-cyan-500/20 border-cyan-500/50 text-cyan-400 transition-colors">üíä ‡∏Ç‡∏≠‡∏á‡πÅ‡∏Ç‡πá‡∏á/‡πÄ‡∏°‡πá‡∏î</button>
              <input type="hidden" name="suppType" value="solid">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3 mb-4">
            <div>
              <label class="block text-sm text-slate-400 mb-1">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ï‡πà‡∏≠‡∏Ç‡∏ß‡∏î/‡∏´‡πà‡∏≠ <span class="text-red-400">*</span></label>
              <input type="number" step="0.1" name="packageSize" placeholder="500" min="1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div>
              <label class="block text-sm text-slate-400 mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
              <select name="unit" id="suppUnitSelect" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
                <option value="‡∏Å‡∏£‡∏±‡∏°">‡∏Å‡∏£‡∏±‡∏°</option>
                <option value="‡∏Å‡∏Å.">‡∏Å‡∏Å.</option>
              </select>
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Ç‡∏ß‡∏î/‡∏´‡πà‡∏≠ (‡∏ö‡∏≤‡∏ó) <span class="text-red-400">*</span></label>
            <input type="number" step="0.1" name="price" placeholder="150" min="0.1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô</button>
        </form>
      </div>
    `;

    // Medicine Modals
    const renderAddMedicineModal = () => `
      ${renderModalHeader('üíâ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ')}
      <div class="p-4 overflow-y-auto">
        <form onsubmit="addMedicine(event)">
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ <span class="text-red-400">*</span></label>
            <input type="text" name="name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≤‡∏•‡∏¥‡∏ô" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
            <input type="text" name="description" placeholder="‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏õ‡∏£‡∏™‡∏¥‡∏ï‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
            <div class="flex gap-3">
              <button type="button" id="btnMedLiquid" onclick="selectMedType('liquid')" class="flex-1 p-3 rounded-xl border bg-blue-500/20 border-blue-500/50 text-blue-400 transition-colors">üíß ‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß</button>
              <button type="button" id="btnMedSolid" onclick="selectMedType('solid')" class="flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors">üíä ‡∏Ç‡∏≠‡∏á‡πÅ‡∏Ç‡πá‡∏á/‡∏ú‡∏á</button>
              <input type="hidden" name="medType" value="liquid">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3 mb-4">
            <div>
              <label class="block text-sm text-slate-400 mb-1">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ï‡πà‡∏≠‡∏Ç‡∏ß‡∏î/‡∏´‡πà‡∏≠ <span class="text-red-400">*</span></label>
              <input type="number" step="0.1" name="packageSize" placeholder="1000" min="1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div>
              <label class="block text-sm text-slate-400 mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
              <select name="unit" id="medUnitSelect" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
                <option value="‡∏°‡∏•.">‡∏°‡∏•.</option>
                <option value="‡∏•‡∏¥‡∏ï‡∏£">‡∏•‡∏¥‡∏ï‡∏£</option>
                <option value="‡∏Å‡∏£‡∏±‡∏°">‡∏Å‡∏£‡∏±‡∏°</option>
                <option value="‡∏Å‡∏Å.">‡∏Å‡∏Å.</option>
              </select>
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Ç‡∏ß‡∏î/‡∏´‡πà‡∏≠ (‡∏ö‡∏≤‡∏ó) <span class="text-red-400">*</span></label>
            <input type="number" step="0.1" name="price" placeholder="120" min="0.1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ/‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤ <span class="text-red-400">*</span></label>
            <textarea name="usageDetails" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏ä‡πâ 25-50 ‡∏°‡∏•./‡∏ô‡πâ‡∏≥ 1,000 ‡∏•‡∏¥‡∏ï‡∏£ ‡πÅ‡∏ä‡πà 30-60 ‡∏ô‡∏≤‡∏ó‡∏µ" required rows="3" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100 resize-none"></textarea>
          </div>
          <button type="submit" class="w-full py-3 bg-rose-500 hover:bg-rose-600 text-white rounded-xl font-medium transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ</button>
        </form>
      </div>
    `;

    const renderEditMedicineModal = () => {
      const m = state.editingMedicine;
      if (!m) return '';
      return `
        ${renderModalHeader('‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="updateMedicine(event, '${m.id}')">
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ <span class="text-red-400">*</span></label>
              <input type="text" name="name" value="${m.name}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
              <input type="text" name="description" value="${m.description || ''}" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
              <div class="flex gap-3">
                <button type="button" id="btnMedLiquid" onclick="selectMedType('liquid')" class="flex-1 p-3 rounded-xl border ${m.medType === 'liquid' ? 'bg-blue-500/20 border-blue-500/50 text-blue-400' : 'bg-slate-700/50 border-slate-600 text-slate-400'} transition-colors">üíß ‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß</button>
                <button type="button" id="btnMedSolid" onclick="selectMedType('solid')" class="flex-1 p-3 rounded-xl border ${m.medType === 'solid' ? 'bg-rose-500/20 border-rose-500/50 text-rose-400' : 'bg-slate-700/50 border-slate-600 text-slate-400'} transition-colors">üíä ‡∏Ç‡∏≠‡∏á‡πÅ‡∏Ç‡πá‡∏á/‡∏ú‡∏á</button>
                <input type="hidden" name="medType" value="${m.medType}">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
              <div>
                <label class="block text-sm text-slate-400 mb-1">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ï‡πà‡∏≠‡∏Ç‡∏ß‡∏î/‡∏´‡πà‡∏≠</label>
                <input type="number" step="0.1" name="packageSize" value="${m.packageSize || ''}" min="1" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
              </div>
              <div>
                <label class="block text-sm text-slate-400 mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                <select name="unit" id="medUnitSelect" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
                  <option value="‡∏°‡∏•." ${m.unit === '‡∏°‡∏•.' ? 'selected' : ''}>‡∏°‡∏•.</option>
                  <option value="‡∏•‡∏¥‡∏ï‡∏£" ${m.unit === '‡∏•‡∏¥‡∏ï‡∏£' ? 'selected' : ''}>‡∏•‡∏¥‡∏ï‡∏£</option>
                  <option value="‡∏Å‡∏£‡∏±‡∏°" ${m.unit === '‡∏Å‡∏£‡∏±‡∏°' ? 'selected' : ''}>‡∏Å‡∏£‡∏±‡∏°</option>
                  <option value="‡∏Å‡∏Å." ${m.unit === '‡∏Å‡∏Å.' ? 'selected' : ''}>‡∏Å‡∏Å.</option>
                </select>
              </div>
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Ç‡∏ß‡∏î/‡∏´‡πà‡∏≠ (‡∏ö‡∏≤‡∏ó)</label>
              <input type="number" step="0.1" name="price" value="${m.price || ''}" min="0.1" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ/‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤ <span class="text-red-400">*</span></label>
              <textarea name="usageDetails" required rows="3" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100 resize-none">${m.usageDetails || ''}</textarea>
            </div>
            <button type="submit" class="w-full py-3 bg-rose-500 hover:bg-rose-600 text-white rounded-xl font-medium transition-colors">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          </form>
        </div>
      `;
    };

    const renderMedicineHistoryModal = () => {
      const m = state.viewingMedicineHistory;
      if (!m || !m.editHistory || m.editHistory.length === 0) return '';
      return `
        ${renderModalHeader('üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≤')}
        <div class="p-4 overflow-y-auto">
          <div class="space-y-3">
            ${m.editHistory.map((h, i) => `
              <div class="bg-slate-700/50 rounded-xl p-3 border border-slate-600/50">
                <div class="text-xs text-slate-400 mb-2">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${new Date(h.editedAt).toLocaleString('th-TH')}</div>
                <div class="text-sm text-slate-300">
                  <div>‡∏ä‡∏∑‡πà‡∏≠: ${h.prev.name}</div>
                  ${h.prev.description ? `<div>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${h.prev.description}</div>` : ''}
                  <div>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${h.prev.medType === 'liquid' ? 'üíß ‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß' : 'üíä ‡∏Ç‡∏≠‡∏á‡πÅ‡∏Ç‡πá‡∏á/‡∏ú‡∏á'}</div>
                  <div>‡∏£‡∏≤‡∏Ñ‡∏≤: ${formatCurrency(h.prev.price)}/${h.prev.unit || '‡∏´‡∏ô‡πà‡∏ß‡∏¢'}</div>
                  <div>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ${h.prev.usageDetails || '-'}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    };

    // Mortality Modal
    const renderMortalityModal = () => {
      const pond = db.ponds.getById(state.selectedPond);
      const cycle = db.cycles.getActive(pond?.id);
      if (!cycle) return '';

      const recentMorts = db.mortalities.getByCycle(cycle.id).slice(0, 5);
      const totalMorts = db.mortalities.getTotalByCycle(cycle.id);

      return `
        ${renderModalHeader('üíÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏•‡∏≤‡∏ï‡∏≤‡∏¢')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="addMortality(event)">
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
              <input type="date" name="date" value="${new Date().toISOString().split('T')[0]}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏•‡∏≤‡∏ï‡∏≤‡∏¢ (‡∏ï‡∏±‡∏ß) <span class="text-red-400">*</span></label>
              <input type="number" name="count" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß" min="1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
              <input type="text" name="reason" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏£‡∏Ñ‡∏à‡∏∏‡∏î‡∏Ç‡∏≤‡∏ß, ‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <button type="submit" class="w-full py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-medium transition-colors">üíÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏•‡∏≤‡∏ï‡∏≤‡∏¢</button>
          </form>

          ${totalMorts > 0 ? `
            <div class="mt-6 pt-4 border-t border-slate-700/50">
              <div class="flex items-center justify-between mb-3">
                <h4 class="text-sm font-semibold text-slate-300">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏¢</h4>
                <span class="text-xs text-red-400 bg-red-500/20 px-2 py-1 rounded-lg">‡∏£‡∏ß‡∏° ${formatNumber(totalMorts)} ‡∏ï‡∏±‡∏ß</span>
              </div>
              <div class="space-y-2 max-h-40 overflow-y-auto">
                ${recentMorts.map(m => `
                  <div class="flex items-center justify-between bg-slate-700/30 rounded-xl p-2.5">
                    <div>
                      <span class="text-sm text-slate-300">${new Date(m.date).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' })}</span>
                      <span class="text-red-400 font-medium ml-2">${m.count} ‡∏ï‡∏±‡∏ß</span>
                      ${m.reason ? `<span class="text-xs text-slate-500 ml-2">(${m.reason})</span>` : ''}
                    </div>
                    <button onclick="deleteMortality('${m.id}')" class="text-slate-400 hover:text-red-400 text-sm">üóëÔ∏è</button>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      `;
    };

    // Feed Stock Modals
    const renderAddFeedStockModal = () => {
      const feeds = db.feeds.getAll();
      if (feeds.length === 0) {
        return `
          ${renderModalHeader('üì¶ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£')}
          <div class="p-4 overflow-y-auto text-center">
            <div class="text-4xl mb-4">ü•´</div>
            <p class="text-slate-400 mb-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
            <p class="text-slate-500 text-sm mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô</p>
            <button onclick="setState({modal:null})" class="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-medium transition-colors">‡∏õ‡∏¥‡∏î</button>
          </div>
        `;
      }

      return `
        ${renderModalHeader('üì¶ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="addFeedStock(event)">
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£ <span class="text-red-400">*</span></label>
              <select name="feedId" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
                ${feeds.map(f => `
                  <option value="${f.id}">${f.type === 'fresh' ? 'üü†' : 'üîµ'} ${f.name} ${f.brand ? `(${f.brand})` : ''} - ‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${formatNumber(db.feedStock.getStock(f.id), 1)} ‡∏Å‡∏Å.</option>
                `).join('')}
              </select>
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏Å‡∏Å.) <span class="text-red-400">*</span></label>
              <input type="number" step="0.1" name="quantity" placeholder="50" min="0.1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
              <input type="text" name="note" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô..." class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <button type="submit" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl font-medium transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
          </form>
        </div>
      `;
    };

    const renderEditFeedStockModal = () => {
      const feedId = state.editingStockFeedId;
      if (!feedId) return '';
      const feed = db.feeds.getById(feedId);
      if (!feed) return '';
      const currentStock = db.feedStock.getStock(feedId);

      return `
        ${renderModalHeader('‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ï‡πá‡∏≠‡∏Å: ' + feed.name)}
        <div class="p-4 overflow-y-auto">
          <div class="bg-slate-700/30 rounded-xl p-4 mb-4">
            <div class="flex items-center gap-3 mb-3">
              <span class="text-2xl">${feed.type === 'fresh' ? 'üü†' : 'üîµ'}</span>
              <div>
                <div class="font-medium text-slate-200">${feed.name}</div>
                ${feed.brand ? `<div class="text-xs text-slate-400">${feed.brand}</div>` : ''}
              </div>
            </div>
            <div class="text-center py-3 bg-slate-800/50 rounded-xl">
              <div class="text-xs text-slate-400 mb-1">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
              <div class="text-3xl font-bold ${currentStock < 10 ? 'text-red-400' : currentStock < 30 ? 'text-amber-400' : 'text-green-400'}">${formatNumber(currentStock, 1)} <span class="text-lg text-slate-400">‡∏Å‡∏Å.</span></div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3 mb-4">
            <button type="button" onclick="showAddStockForm('${feedId}')" id="btnAddStock" class="p-3 rounded-xl border bg-green-500/20 border-green-500/50 text-green-400 transition-colors text-sm font-medium">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
            <button type="button" onclick="showSetStockForm('${feedId}')" id="btnSetStock" class="p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors text-sm font-medium">‚úèÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
          </div>

          <form id="stockForm" onsubmit="submitStockEdit(event, '${feedId}')">
            <input type="hidden" name="action" value="add">
            <div class="mb-4">
              <label id="stockLabel" class="block text-sm text-slate-400 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏Å‡∏Å.) <span class="text-red-400">*</span></label>
              <input type="number" step="0.1" name="quantity" placeholder="10" min="0" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <button type="submit" id="stockSubmitBtn" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl font-medium transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
          </form>
        </div>
      `;
    };

    // Stock History Modal
    const renderStockHistoryModal = () => {
      const stocks = db.feedStock.getAll();
      const feeds = db.feeds.getAll();
      const historyLimit = state.stockHistoryLimit || 20;

      // Collect all history entries with feed info
      const allHistory = [];
      stocks.forEach(stock => {
        const feed = feeds.find(f => f.id === stock.feedId);
        if (stock.history && feed) {
          stock.history.forEach(h => {
            allHistory.push({
              ...h,
              feedName: feed.name,
              feedType: feed.type,
              feedId: stock.feedId
            });
          });
        }
      });

      // Sort by date descending
      allHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

      // Calculate summary
      const summary = {
        totalAdd: 0,
        totalDeduct: 0,
        byFeed: {},
        byType: { fresh: { add: 0, deduct: 0 }, pellet: { add: 0, deduct: 0 } }
      };
      allHistory.forEach(h => {
        if (h.type === 'add') {
          summary.totalAdd += h.quantity;
          summary.byType[h.feedType].add += h.quantity;
        } else if (h.type === 'deduct') {
          summary.totalDeduct += h.quantity;
          summary.byType[h.feedType].deduct += h.quantity;
        }
        if (!summary.byFeed[h.feedName]) {
          summary.byFeed[h.feedName] = { add: 0, deduct: 0, type: h.feedType };
        }
        if (h.type === 'add') summary.byFeed[h.feedName].add += h.quantity;
        if (h.type === 'deduct') summary.byFeed[h.feedName].deduct += h.quantity;
      });

      // Group by week for chart
      const weeklyData = {};
      const now = new Date();
      for (let i = 6; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(d.getDate() - i);
        const key = d.toISOString().split('T')[0];
        weeklyData[key] = { add: 0, deduct: 0 };
      }

      allHistory.forEach(h => {
        const dateKey = h.date.split('T')[0];
        if (weeklyData[dateKey]) {
          if (h.type === 'add') {
            weeklyData[dateKey].add += h.quantity;
          } else if (h.type === 'deduct') {
            weeklyData[dateKey].deduct += h.quantity;
          }
        }
      });

      const weekDays = ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'];
      const chartData = Object.entries(weeklyData).map(([date, data]) => {
        const d = new Date(date);
        return {
          label: weekDays[d.getDay()],
          date: date,
          add: data.add,
          deduct: data.deduct
        };
      });

      const maxValue = Math.max(...chartData.map(d => Math.max(d.add, d.deduct)), 1);
      const displayHistory = allHistory.slice(0, historyLimit);
      const hasMore = allHistory.length > historyLimit;

      return `
        ${renderModalHeader('üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£')}
        <div class="p-4 overflow-y-auto">
          <!-- Summary Section -->
          <div class="bg-slate-700/30 rounded-xl p-4 mb-4">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-sm font-medium text-slate-300">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h4>
              <button onclick="downloadStockHistory()" class="px-3 py-1.5 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg text-xs font-medium transition-colors flex items-center gap-1">
                <span>‚¨áÔ∏è</span> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
              </button>
            </div>
            <div class="grid grid-cols-3 gap-2 mb-3">
              <div class="bg-green-500/10 rounded-lg p-2 text-center">
                <div class="text-lg font-bold text-green-400">${formatNumber(summary.totalAdd, 1)}</div>
                <div class="text-[10px] text-slate-500">‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏Å‡∏Å.)</div>
              </div>
              <div class="bg-red-500/10 rounded-lg p-2 text-center">
                <div class="text-lg font-bold text-red-400">${formatNumber(summary.totalDeduct, 1)}</div>
                <div class="text-[10px] text-slate-500">‡πÉ‡∏ä‡πâ (‡∏Å‡∏Å.)</div>
              </div>
              <div class="bg-slate-600/30 rounded-lg p-2 text-center">
                <div class="text-lg font-bold ${summary.totalAdd - summary.totalDeduct >= 0 ? 'text-cyan-400' : 'text-amber-400'}">${summary.totalAdd - summary.totalDeduct >= 0 ? '+' : ''}${formatNumber(summary.totalAdd - summary.totalDeduct, 1)}</div>
                <div class="text-[10px] text-slate-500">‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏Å‡∏Å.)</div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <div class="bg-orange-500/10 rounded-lg p-2">
                <div class="flex items-center gap-1 mb-1">
                  <span>üü†</span>
                  <span class="text-slate-400">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏î</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-green-400">+${formatNumber(summary.byType.fresh.add, 1)}</span>
                  <span class="text-red-400">-${formatNumber(summary.byType.fresh.deduct, 1)}</span>
                </div>
              </div>
              <div class="bg-blue-500/10 rounded-lg p-2">
                <div class="flex items-center gap-1 mb-1">
                  <span>üîµ</span>
                  <span class="text-slate-400">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏°‡πá‡∏î</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-green-400">+${formatNumber(summary.byType.pellet.add, 1)}</span>
                  <span class="text-red-400">-${formatNumber(summary.byType.pellet.deduct, 1)}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Weekly Chart -->
          <div class="bg-slate-700/30 rounded-xl p-4 mb-4">
            <h4 class="text-sm font-medium text-slate-300 mb-3">üìà ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4>
            <div class="flex items-end justify-between gap-1" style="height: 100px;">
              ${chartData.map(d => {
                const addHeight = (d.add / maxValue) * 80;
                const deductHeight = (d.deduct / maxValue) * 80;
                return `
                  <div class="flex-1 flex flex-col items-center">
                    <div class="flex gap-0.5 items-end" style="height: 80px;">
                      <div class="w-2 bg-green-500/60 rounded-t" style="height: ${addHeight}px;" title="‡πÄ‡∏û‡∏¥‡πà‡∏°: ${formatNumber(d.add, 1)} ‡∏Å‡∏Å."></div>
                      <div class="w-2 bg-red-500/60 rounded-t" style="height: ${deductHeight}px;" title="‡πÉ‡∏ä‡πâ: ${formatNumber(d.deduct, 1)} ‡∏Å‡∏Å."></div>
                    </div>
                    <div class="text-[10px] text-slate-500 mt-1">${d.label}</div>
                  </div>
                `;
              }).join('')}
            </div>
            <div class="flex justify-center gap-4 mt-3 text-xs">
              <span class="flex items-center gap-1"><span class="w-2 h-2 bg-green-500/60 rounded"></span> ‡πÄ‡∏û‡∏¥‡πà‡∏°</span>
              <span class="flex items-center gap-1"><span class="w-2 h-2 bg-red-500/60 rounded"></span> ‡πÉ‡∏ä‡πâ</span>
            </div>
          </div>

          <!-- History List -->
          <div class="flex items-center justify-between mb-3">
            <h4 class="text-sm font-medium text-slate-300">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
            <span class="text-xs text-slate-500">${allHistory.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
          </div>
          ${allHistory.length === 0 ? `
            <div class="text-center py-6 text-slate-500">
              <div class="text-3xl mb-2">üì¶</div>
              <p class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>
            </div>
          ` : `
            <div id="stockHistoryList" class="space-y-2 max-h-72 overflow-y-auto">
              ${displayHistory.map(h => {
                const date = new Date(h.date);
                const dateStr = date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
                const timeStr = date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                const icon = h.type === 'add' ? '‚ûï' : h.type === 'deduct' ? '‚ûñ' : 'üîÑ';
                const color = h.type === 'add' ? 'text-green-400' : h.type === 'deduct' ? 'text-red-400' : 'text-amber-400';
                const typeText = h.type === 'add' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°' : h.type === 'deduct' ? '‡πÉ‡∏ä‡πâ' : '‡∏õ‡∏£‡∏±‡∏ö';
                const qty = h.type === 'adjust' ? `${formatNumber(h.oldQuantity, 1)} ‚Üí ${formatNumber(h.newQuantity, 1)}` : formatNumber(h.quantity, 1);

                return `
                  <div class="bg-slate-700/30 rounded-lg p-2.5 flex items-center gap-2">
                    <span class="${h.feedType === 'fresh' ? 'text-orange-400' : 'text-blue-400'}">${h.feedType === 'fresh' ? 'üü†' : 'üîµ'}</span>
                    <div class="flex-1 min-w-0">
                      <div class="text-sm text-slate-200 truncate">${h.feedName}</div>
                      <div class="text-xs text-slate-500">${dateStr} ${timeStr} ${h.note ? `‚Ä¢ ${h.note}` : ''}</div>
                    </div>
                    <div class="text-right">
                      <div class="${color} text-sm font-medium">${icon} ${qty} ‡∏Å‡∏Å.</div>
                      <div class="text-xs text-slate-500">${typeText}</div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
            ${hasMore ? `
              <button onclick="loadMoreStockHistory()" class="w-full mt-3 py-2.5 bg-slate-700/50 hover:bg-slate-600/50 text-slate-300 rounded-xl text-sm font-medium transition-colors flex items-center justify-center gap-2">
                <span>‚¨áÔ∏è</span> ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏° (${allHistory.length - historyLimit} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
              </button>
            ` : `
              <div class="text-center mt-3 text-xs text-slate-500">‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ‚Äî</div>
            `}
          `}
        </div>
      `;
    };

    // Stock Password Modals
    const renderStockPasswordConfirmModal = () => {
      const feedId = state.pendingStockDelete;
      if (!feedId) return '';
      const feed = db.feeds.getById(feedId);
      if (!feed) return '';
      const currentStock = db.feedStock.getStock(feedId);

      return `
        ${renderModalHeader('üîê ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å')}
        <div class="p-4 overflow-y-auto">
          <div class="bg-red-500/10 border border-red-500/30 rounded-xl p-4 mb-4">
            <div class="text-center">
              <div class="text-3xl mb-2">‚ö†Ô∏è</div>
              <div class="text-red-400 font-medium mb-2">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ô‡∏µ‡πâ?</div>
              <div class="text-slate-300">${feed.type === 'fresh' ? 'üü†' : 'üîµ'} ${feed.name}</div>
              <div class="text-2xl font-bold text-red-400 mt-2">${formatNumber(currentStock, 1)} ‡∏Å‡∏Å.</div>
            </div>
          </div>

          ${db.stockPassword.isEnabled() ? `
            <form onsubmit="confirmDeleteStock(event, '${feedId}')">
              <div class="mb-4">
                <label class="block text-sm text-slate-400 mb-1">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô <span class="text-red-400">*</span></label>
                <input type="password" name="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required autocomplete="current-password" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
              </div>
              <div class="grid grid-cols-2 gap-3">
                <button type="button" onclick="setState({modal:null, pendingStockDelete:null})" class="py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-medium transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="submit" class="py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-medium transition-colors">üóëÔ∏è ‡∏•‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
              </div>
            </form>
          ` : `
            <div class="grid grid-cols-2 gap-3">
              <button type="button" onclick="setState({modal:null, pendingStockDelete:null})" class="py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-medium transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button type="button" onclick="executeDeleteStock('${feedId}')" class="py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-medium transition-colors">üóëÔ∏è ‡∏•‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
            </div>
          `}
        </div>
      `;
    };

    const renderStockPasswordManageModal = () => {
      const isEnabled = db.stockPassword.isEnabled();

      return `
        ${renderModalHeader('üîê ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å')}
        <div class="p-4 overflow-y-auto">
          <div class="bg-slate-700/30 rounded-xl p-4 mb-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="font-medium text-slate-200">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</div>
                <div class="text-xs text-slate-400">‡πÉ‡∏ä‡πâ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>
              </div>
              <div class="text-lg font-bold ${isEnabled ? 'text-green-400' : 'text-slate-500'}">
                ${isEnabled ? '‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‚ùå ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'}
              </div>
            </div>
          </div>

          ${isEnabled ? `
            <!-- Change Password -->
            <div class="mb-4">
              <h4 class="text-sm font-medium text-slate-300 mb-3">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h4>
              <form onsubmit="changeStockPassword(event)">
                <div class="mb-3">
                  <label class="block text-xs text-slate-400 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°</label>
                  <input type="password" name="oldPassword" required autocomplete="current-password" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-2 text-slate-100">
                </div>
                <div class="mb-3">
                  <label class="block text-xs text-slate-400 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                  <input type="password" name="newPassword" required minlength="4" autocomplete="new-password" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-2 text-slate-100">
                </div>
                <div class="mb-3">
                  <label class="block text-xs text-slate-400 mb-1">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                  <input type="password" name="confirmPassword" required minlength="4" autocomplete="new-password" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-2 text-slate-100">
                </div>
                <button type="submit" class="w-full py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors text-sm">üíæ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
              </form>
            </div>

            <!-- Disable Password -->
            <div class="border-t border-slate-700/50 pt-4">
              <h4 class="text-sm font-medium text-slate-300 mb-3">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h4>
              <form onsubmit="disableStockPassword(event)">
                <div class="mb-3">
                  <label class="block text-xs text-slate-400 mb-1">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</label>
                  <input type="password" name="password" required autocomplete="current-password" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-2 text-slate-100">
                </div>
                <button type="submit" class="w-full py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-xl font-medium transition-colors text-sm">üîì ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
              </form>
            </div>
          ` : `
            <!-- Set New Password -->
            <div class="mb-4">
              <h4 class="text-sm font-medium text-slate-300 mb-3">‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h4>
              <form onsubmit="setStockPassword(event)">
                <div class="mb-3">
                  <label class="block text-xs text-slate-400 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß)</label>
                  <input type="password" name="password" required minlength="4" autocomplete="new-password" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-2 text-slate-100">
                </div>
                <div class="mb-3">
                  <label class="block text-xs text-slate-400 mb-1">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                  <input type="password" name="confirmPassword" required minlength="4" autocomplete="new-password" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-2 text-slate-100">
                </div>
                <button type="submit" class="w-full py-2 bg-green-500 hover:bg-green-600 text-white rounded-xl font-medium transition-colors text-sm">üîí ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
              </form>
            </div>
          `}

          <button onclick="setState({modal:null})" class="w-full mt-4 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-medium transition-colors">‡∏õ‡∏¥‡∏î</button>
        </div>
      `;
    };

    // ===== Guide Modals =====
    const renderAddGuideModal = () => {
      const fishTypes = filterDeleted(db.fishTypes.getAll());

      return `
        ${renderModalHeader('üìñ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="addGuide(event)">
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà <span class="text-red-400">*</span></label>
              <select name="category" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
                ${Object.values(GUIDE_CATEGORIES).map(cat => `
                  <option value="${cat.id}">${cat.icon} ${cat.name}</option>
                `).join('')}
              </select>
            </div>

            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ <span class="text-red-400">*</span></label>
              <input type="text" name="title" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏õ‡∏•‡∏≤‡∏î‡∏∏‡∏Å‡∏ß‡∏±‡∏¢‡∏≠‡πà‡∏≠‡∏ô" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>

            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏•‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
              <select name="fishType" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
                <option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ --</option>
                ${fishTypes.map(f => `<option value="${f.name}">${f.name}</option>`).join('')}
              </select>
            </div>

            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡πà‡∏≠</label>
              <input type="text" name="summary" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>

            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ <span class="text-red-400">*</span></label>
              <textarea name="content" rows="10" required placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠..." class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100 resize-none"></textarea>
            </div>

            <div class="flex gap-3">
              <button type="button" onclick="setState({modal:null})" class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-medium transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button type="submit" class="flex-1 py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
          </form>
        </div>
      `;
    };

    const renderEditGuideModal = () => {
      const guide = db.guides.getById(state.editingGuideId);
      if (!guide) return '';

      const fishTypes = filterDeleted(db.fishTypes.getAll());

      return `
        ${renderModalHeader('‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="updateGuide(event, '${guide.id}')">
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà <span class="text-red-400">*</span></label>
              <select name="category" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
                ${Object.values(GUIDE_CATEGORIES).map(cat => `
                  <option value="${cat.id}" ${guide.category === cat.id ? 'selected' : ''}>${cat.icon} ${cat.name}</option>
                `).join('')}
              </select>
            </div>

            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ <span class="text-red-400">*</span></label>
              <input type="text" name="title" value="${guide.title || ''}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>

            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏•‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
              <select name="fishType" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
                <option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ --</option>
                ${fishTypes.map(f => `<option value="${f.name}" ${guide.fishType === f.name ? 'selected' : ''}>${f.name}</option>`).join('')}
              </select>
            </div>

            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡πà‡∏≠</label>
              <input type="text" name="summary" value="${guide.summary || ''}" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>

            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ <span class="text-red-400">*</span></label>
              <textarea name="content" rows="10" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100 resize-none">${guide.content || ''}</textarea>
            </div>

            <div class="flex gap-3">
              <button type="button" onclick="setState({modal:null})" class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-medium transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button type="submit" class="flex-1 py-3 bg-amber-500 hover:bg-amber-600 text-white rounded-xl font-medium transition-colors">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
          </form>
        </div>
      `;
    };

    // Fish Type Modals
    const renderAddFishTypeModal = () => `
      ${renderModalHeader('üêü ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏•‡∏≤')}
      <div class="p-4 overflow-y-auto">
        <form onsubmit="addFishType(event)">
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏•‡∏≤ <span class="text-red-400">*</span></label>
            <input type="text" name="name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏•‡∏≤‡∏î‡∏∏‡∏Å‡∏ö‡∏¥‡πä‡∏Å‡∏≠‡∏∏‡∏¢" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å</label>
            <div class="flex gap-3">
              <button type="button" id="btnFreshFish" onclick="selectFishFeedType('fresh')" class="flex-1 p-3 rounded-xl border bg-orange-500/20 border-orange-500/50 text-orange-400 transition-colors">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏î</button>
              <button type="button" id="btnPelletFish" onclick="selectFishFeedType('pellet')" class="flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏°‡πá‡∏î</button>
              <input type="hidden" name="feedType" value="fresh">
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-sm text-slate-400 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏ï (‡∏Å‡∏£‡∏±‡∏°/‡∏ï‡∏±‡∏ß) <span class="text-red-400">*</span></label>
            <input type="number" step="1" name="avgWeight" placeholder="150" min="1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
          </div>
          <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏•‡∏≤</button>
        </form>
      </div>
    `;

    const renderEditFishTypeModal = () => {
      const ft = state.editingFishType;
      if (!ft) return '';
      return `
        ${renderModalHeader('‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏•‡∏≤')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="updateFishType(event, '${ft.id}')">
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏•‡∏≤ <span class="text-red-400">*</span></label>
              <input type="text" name="name" value="${ft.name}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å</label>
              <div class="flex gap-3">
                <button type="button" id="btnFreshFish" onclick="selectFishFeedType('fresh')" class="flex-1 p-3 rounded-xl border ${ft.feedType === 'fresh' ? 'bg-orange-500/20 border-orange-500/50 text-orange-400' : 'bg-slate-700/50 border-slate-600 text-slate-400'} transition-colors">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏î</button>
                <button type="button" id="btnPelletFish" onclick="selectFishFeedType('pellet')" class="flex-1 p-3 rounded-xl border ${ft.feedType === 'pellet' ? 'bg-blue-500/20 border-blue-500/50 text-blue-400' : 'bg-slate-700/50 border-slate-600 text-slate-400'} transition-colors">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏°‡πá‡∏î</button>
                <input type="hidden" name="feedType" value="${ft.feedType}">
              </div>
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏ï (‡∏Å‡∏£‡∏±‡∏°/‡∏ï‡∏±‡∏ß) <span class="text-red-400">*</span></label>
              <input type="number" step="1" name="avgWeight" value="${ft.avgWeight}" min="1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          </form>
        </div>
      `;
    };

    const renderFishTypeHistoryModal = () => {
      const ft = state.viewingFishTypeHistory;
      if (!ft || !ft.editHistory || ft.editHistory.length === 0) return '';
      return `
        ${renderModalHeader('üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ' + ft.name)}
        <div class="p-4 overflow-y-auto">
          <div class="space-y-3">
            ${ft.editHistory.map((h, i) => `
              <div class="bg-slate-700/30 rounded-xl p-3">
                <div class="text-xs text-slate-400 mb-2">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatDate(h.editedAt)} ${new Date(h.editedAt).toLocaleTimeString('th-TH')}</div>
                <div class="text-sm space-y-1">
                  <div><span class="text-slate-400">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°:</span> <span class="text-slate-200">${h.prev.name}</span></div>
                  <div><span class="text-slate-400">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏´‡∏≤‡∏£:</span> <span class="text-slate-200">${h.prev.feedType === 'fresh' ? '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏î' : '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏°‡πá‡∏î'}</span></div>
                  <div><span class="text-slate-400">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span> <span class="text-slate-200">${formatNumber(h.prev.avgWeight)} ‡∏Å‡∏£‡∏±‡∏°</span></div>
                </div>
              </div>
            `).reverse().join('')}
          </div>
          <button onclick="setState({modal:null,viewingFishTypeHistory:null})" class="w-full mt-4 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-medium transition-colors">‡∏õ‡∏¥‡∏î</button>
        </div>
      `;
    };

    const renderEditFeedModal = () => {
      const f = state.editingFeed;
      if (!f) return '';
      const isPellet = f.type === 'pellet';
      const useBag = f.useBag || false;
      return `
        ${renderModalHeader('‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏≤‡∏´‡∏≤‡∏£')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="updateFeed(event)">
            <div class="flex gap-3 mb-4">
              <button type="button" id="btnFresh" onclick="selectFeedType('fresh')" class="flex-1 p-3 rounded-xl border ${f.type === 'fresh' ? 'bg-orange-500/20 border-orange-500/50 text-orange-400' : 'bg-slate-700/50 border-slate-600 text-slate-400'} transition-colors">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏î</button>
              <button type="button" id="btnPellet" onclick="selectFeedType('pellet')" class="flex-1 p-3 rounded-xl border ${f.type === 'pellet' ? 'bg-blue-500/20 border-blue-500/50 text-blue-400' : 'bg-slate-700/50 border-slate-600 text-slate-400'} transition-colors">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏°‡πá‡∏î</button>
              <input type="hidden" name="type" value="${f.type}">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£ <span class="text-red-400">*</span></label>
              <input type="text" name="name" value="${f.name}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏°‡πá‡∏î)</label>
              <input type="text" name="brand" value="${f.brand || ''}" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏°‡πá‡∏î)</label>
              <input type="text" name="sizeNumber" value="${f.sizeNumber || ''}" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div id="bagSizeSection" class="mb-4 ${isPellet ? '' : 'hidden'}">
              <div class="mb-3">
                <label class="flex items-center gap-3 cursor-pointer bg-slate-700/30 rounded-xl p-3">
                  <input type="checkbox" name="useBag" id="useBagCheckbox" ${useBag ? 'checked' : ''} class="w-5 h-5 rounded bg-slate-600 accent-blue-500" onchange="toggleBagSizeInput(this.checked)">
                  <span class="text-slate-200">‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</span>
                </label>
              </div>
              <div id="bagSizeInput" style="display: ${useBag ? 'block' : 'none'}">
                <label class="block text-sm text-slate-400 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö (‡∏Å‡∏Å.)</label>
                <input type="number" step="0.1" name="bagSize" value="${f.bagSize || 20}" min="1" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
              </div>
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.) <span class="text-red-400">*</span></label>
              <input type="number" step="0.1" name="price" value="${f.pricePerKg}" min="0.1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          </form>
        </div>
      `;
    };

    const renderFeedHistoryModal = () => {
      const f = state.viewingFeedHistory;
      if (!f || !f.editHistory || f.editHistory.length === 0) return '';
      return `
        ${renderModalHeader('üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ' + f.name)}
        <div class="p-4 overflow-y-auto">
          <div class="space-y-3">
            ${f.editHistory.map((h, i) => `
              <div class="bg-slate-700/30 rounded-xl p-3">
                <div class="text-xs text-slate-400 mb-2">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatDate(h.editedAt)} ${new Date(h.editedAt).toLocaleTimeString('th-TH')}</div>
                <div class="text-sm space-y-1">
                  <div><span class="text-slate-400">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°:</span> <span class="text-slate-200">${h.prev.name}</span></div>
                  <div><span class="text-slate-400">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</span> <span class="text-slate-200">${h.prev.type === 'fresh' ? '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏î' : '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏°‡πá‡∏î'}</span></div>
                  ${h.prev.brand ? `<div><span class="text-slate-400">‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠:</span> <span class="text-slate-200">${h.prev.brand}</span></div>` : ''}
                  ${h.prev.sizeNumber ? `<div><span class="text-slate-400">‡πÄ‡∏ö‡∏≠‡∏£‡πå:</span> <span class="text-slate-200">${h.prev.sizeNumber}</span></div>` : ''}
                  <div><span class="text-slate-400">‡∏£‡∏≤‡∏Ñ‡∏≤:</span> <span class="text-slate-200">${formatCurrency(h.prev.pricePerKg)}/‡∏Å‡∏Å.</span></div>
                </div>
              </div>
            `).reverse().join('')}
          </div>
          <button onclick="setState({modal:null,viewingFeedHistory:null})" class="w-full mt-4 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-medium transition-colors">‡∏õ‡∏¥‡∏î</button>
        </div>
      `;
    };

    const renderEditSupplementModal = () => {
      const s = state.editingSupplement;
      if (!s) return '';
      const isLiquid = s.suppType === 'liquid';
      return `
        ${renderModalHeader('‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô/‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°')}
        <div class="p-4 overflow-y-auto">
          <form onsubmit="updateSupplement(event)">
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏ä‡∏∑‡πà‡∏≠ <span class="text-red-400">*</span></label>
              <input type="text" name="name" value="${s.name}" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
              <input type="text" name="description" value="${s.description || ''}" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
              <div class="flex gap-3">
                <button type="button" id="btnSuppLiquid" onclick="selectSuppType('liquid')" class="flex-1 p-3 rounded-xl border ${isLiquid ? 'bg-blue-500/20 border-blue-500/50 text-blue-400' : 'bg-slate-700/50 border-slate-600 text-slate-400'} transition-colors">üíß ‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß</button>
                <button type="button" id="btnSuppSolid" onclick="selectSuppType('solid')" class="flex-1 p-3 rounded-xl border ${!isLiquid ? 'bg-cyan-500/20 border-cyan-500/50 text-cyan-400' : 'bg-slate-700/50 border-slate-600 text-slate-400'} transition-colors">üíä ‡∏Ç‡∏≠‡∏á‡πÅ‡∏Ç‡πá‡∏á/‡πÄ‡∏°‡πá‡∏î</button>
                <input type="hidden" name="suppType" value="${s.suppType || 'solid'}">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
              <div>
                <label class="block text-sm text-slate-400 mb-1">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ï‡πà‡∏≠‡∏Ç‡∏ß‡∏î/‡∏´‡πà‡∏≠ <span class="text-red-400">*</span></label>
                <input type="number" step="0.1" name="packageSize" value="${s.packageSize || 100}" min="1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
              </div>
              <div>
                <label class="block text-sm text-slate-400 mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                <select id="suppUnitSelect" name="unit" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
                  ${isLiquid ? `
                    <option value="‡∏°‡∏•." selected>‡∏°‡∏•.</option>
                  ` : `
                    <option value="‡∏Å‡∏£‡∏±‡∏°" ${s.unit === '‡∏Å‡∏£‡∏±‡∏°' ? 'selected' : ''}>‡∏Å‡∏£‡∏±‡∏°</option>
                    <option value="‡∏Å‡∏Å." ${s.unit === '‡∏Å‡∏Å.' ? 'selected' : ''}>‡∏Å‡∏Å.</option>
                  `}
                </select>
              </div>
            </div>
            <div class="mb-4">
              <label class="block text-sm text-slate-400 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Ç‡∏ß‡∏î/‡∏´‡πà‡∏≠ (‡∏ö‡∏≤‡∏ó) <span class="text-red-400">*</span></label>
              <input type="number" step="0.1" name="price" value="${s.price}" min="0.1" required class="w-full bg-slate-700 border border-slate-600 rounded-xl px-4 py-3 text-slate-100">
            </div>
            <button type="submit" class="w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          </form>
        </div>
      `;
    };

    const renderSupplementHistoryModal = () => {
      const s = state.viewingSupplementHistory;
      if (!s || !s.editHistory || s.editHistory.length === 0) return '';
      return `
        ${renderModalHeader('üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ' + s.name)}
        <div class="p-4 overflow-y-auto">
          <div class="space-y-3">
            ${s.editHistory.map((h, i) => `
              <div class="bg-slate-700/30 rounded-xl p-3">
                <div class="text-xs text-slate-400 mb-2">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatDate(h.editedAt)} ${new Date(h.editedAt).toLocaleTimeString('th-TH')}</div>
                <div class="text-sm space-y-1">
                  <div><span class="text-slate-400">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°:</span> <span class="text-slate-200">${h.prev.name}</span></div>
                  ${h.prev.description ? `<div><span class="text-slate-400">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</span> <span class="text-slate-200">${h.prev.description}</span></div>` : ''}
                  <div><span class="text-slate-400">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</span> <span class="text-slate-200">${h.prev.suppType === 'liquid' ? 'üíß ‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß' : 'üíä ‡∏Ç‡∏≠‡∏á‡πÅ‡∏Ç‡πá‡∏á/‡πÄ‡∏°‡πá‡∏î'}</span></div>
                  <div><span class="text-slate-400">‡∏£‡∏≤‡∏Ñ‡∏≤:</span> <span class="text-slate-200">${formatCurrency(h.prev.price)}/100${h.prev.unit}</span></div>
                </div>
              </div>
            `).reverse().join('')}
          </div>
          <button onclick="setState({modal:null,viewingSupplementHistory:null})" class="w-full mt-4 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-medium transition-colors">‡∏õ‡∏¥‡∏î</button>
        </div>
      `;
    };

    // ===== Event Handlers =====
    window.selectFeedType = (type) => {
      const form = document.querySelector('form');
      form.querySelector('[name=type]').value = type;
      const btnFresh = document.getElementById('btnFresh');
      const btnPellet = document.getElementById('btnPellet');
      const bagSizeSection = document.getElementById('bagSizeSection');

      if (type === 'fresh') {
        btnFresh.className = 'flex-1 p-3 rounded-xl border bg-orange-500/20 border-orange-500/50 text-orange-400 transition-colors';
        btnPellet.className = 'flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors';
        if (bagSizeSection) bagSizeSection.classList.add('hidden');
      } else {
        btnPellet.className = 'flex-1 p-3 rounded-xl border bg-blue-500/20 border-blue-500/50 text-blue-400 transition-colors';
        btnFresh.className = 'flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors';
        if (bagSizeSection) bagSizeSection.classList.remove('hidden');
      }
    };

    window.toggleBagSizeInput = (checked) => {
      const bagSizeInput = document.getElementById('bagSizeInput');
      if (bagSizeInput) {
        bagSizeInput.style.display = checked ? 'block' : 'none';
      }
    };

    window.switchFeedTab = (type) => {
      const tabPellet = document.getElementById('tabPellet');
      const tabFresh = document.getElementById('tabFresh');
      const pelletFeeds = document.getElementById('pelletFeeds');
      const freshFeeds = document.getElementById('freshFeeds');
      const feedTypeInput = document.querySelector('[name=feedType]');

      if (type === 'pellet') {
        tabPellet.className = 'flex-1 p-2 rounded-xl border bg-blue-500/20 border-blue-500/50 text-blue-400 transition-colors text-sm';
        tabFresh.className = 'flex-1 p-2 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors text-sm';
        pelletFeeds.classList.remove('hidden');
        freshFeeds.classList.add('hidden');
      } else {
        tabFresh.className = 'flex-1 p-2 rounded-xl border bg-orange-500/20 border-orange-500/50 text-orange-400 transition-colors text-sm';
        tabPellet.className = 'flex-1 p-2 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors text-sm';
        freshFeeds.classList.remove('hidden');
        pelletFeeds.classList.add('hidden');
      }
      feedTypeInput.value = type;
    };

    window.toggleSuppInput = (id) => {
      const checkbox = document.getElementById('supp_' + id);
      const input = document.getElementById('suppAmt_' + id);
      input.disabled = !checkbox.checked;
      if (checkbox.checked) {
        input.focus();
      }
    };

    window.toggleMedInput = (id) => {
      const checkbox = document.getElementById('med_' + id);
      const input = document.getElementById('medAmt_' + id);
      input.disabled = !checkbox.checked;
      if (checkbox.checked) {
        input.focus();
      }
    };

    window.toggleMedicineOnlyMode = (isChecked) => {
      const feedSection = document.getElementById('feedSection');
      const feedWeight = document.getElementById('feedWeight');
      const submitBtn = document.getElementById('feedingSubmitBtn');

      if (feedSection) {
        feedSection.style.display = isChecked ? 'none' : 'block';
      }
      if (feedWeight) {
        feedWeight.required = !isChecked;
        feedWeight.disabled = isChecked;
        if (isChecked) feedWeight.value = '';
      }
      if (submitBtn) {
        submitBtn.textContent = isChecked ? 'üíâ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏¢‡∏≤' : '+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£';
        submitBtn.className = isChecked
          ? 'w-full py-3 bg-rose-500 hover:bg-rose-600 text-white rounded-xl font-medium transition-colors'
          : 'w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors';
      }
    };

    window.selectFishFeedType = (type) => {
      const form = document.querySelector('form');
      form.querySelector('[name=feedType]').value = type;
      const btnFresh = document.getElementById('btnFreshFish');
      const btnPellet = document.getElementById('btnPelletFish');

      if (type === 'fresh') {
        btnFresh.className = 'flex-1 p-3 rounded-xl border bg-orange-500/20 border-orange-500/50 text-orange-400 transition-colors';
        btnPellet.className = 'flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors';
      } else {
        btnPellet.className = 'flex-1 p-3 rounded-xl border bg-blue-500/20 border-blue-500/50 text-blue-400 transition-colors';
        btnFresh.className = 'flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors';
      }
    };

    window.selectSuppType = (type) => {
      const form = document.querySelector('form');
      form.querySelector('[name=suppType]').value = type;
      const btnLiquid = document.getElementById('btnSuppLiquid');
      const btnSolid = document.getElementById('btnSuppSolid');
      const unitSelect = document.getElementById('suppUnitSelect');

      // Update button styles
      if (type === 'liquid') {
        btnLiquid.className = 'flex-1 p-3 rounded-xl border bg-blue-500/20 border-blue-500/50 text-blue-400 transition-colors';
        btnSolid.className = 'flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors';
        // Update unit options for liquid
        unitSelect.innerHTML = '<option value="‡∏°‡∏•.">‡∏°‡∏•.</option>';
      } else {
        btnSolid.className = 'flex-1 p-3 rounded-xl border bg-cyan-500/20 border-cyan-500/50 text-cyan-400 transition-colors';
        btnLiquid.className = 'flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors';
        // Update unit options for solid
        unitSelect.innerHTML = '<option value="‡∏Å‡∏£‡∏±‡∏°">‡∏Å‡∏£‡∏±‡∏°</option><option value="‡∏Å‡∏Å.">‡∏Å‡∏Å.</option>';
      }
    };

    // ===== Guide Functions =====
    window.addGuide = (e) => {
      e.preventDefault();
      const form = e.target;
      const guide = {
        category: form.category.value,
        title: form.title.value.trim(),
        fishType: form.fishType.value || null,
        summary: form.summary.value.trim() || null,
        content: form.content.value.trim()
      };
      if (db.guides.add(guide)) {
        setState({ modal: null });
      }
    };

    window.updateGuide = (e, id) => {
      e.preventDefault();
      const form = e.target;
      const updates = {
        category: form.category.value,
        title: form.title.value.trim(),
        fishType: form.fishType.value || null,
        summary: form.summary.value.trim() || null,
        content: form.content.value.trim()
      };
      if (db.guides.update(id, updates)) {
        setState({ modal: null, selectedGuide: id });
      }
    };

    window.confirmDeleteGuide = (id) => {
      const guide = db.guides.getById(id);
      if (!guide) return;

      showConfirm(
        `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ "${guide.title}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
        () => {
          db.guides.delete(id);
          setState({ selectedGuide: null });
        }
      );
    };

    window.reloadDefaultGuides = async () => {
      showConfirm(
        '‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å guides.json? (‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö)',
        async () => {
          try {
            const response = await fetch('guides.json?t=' + Date.now()); // Bypass cache
            if (!response.ok) throw new Error('Failed to load guides.json');
            const data = await response.json();

            if (data.guides && Array.isArray(data.guides)) {
              const existingGuides = db.guides.getAll();
              const existingIds = new Set(existingGuides.map(g => g.id));
              let addedCount = 0;

              data.guides.forEach(guide => {
                if (existingIds.has(guide.id)) return;

                const guides = storage.get(KEYS.GUIDES);
                guides.push({
                  ...guide,
                  createdAt: Date.now(),
                  updatedAt: Date.now()
                });
                storage.set(KEYS.GUIDES, guides);
                addedCount++;
              });

              if (addedCount > 0) {
                showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà ${addedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
                render();
              } else {
                showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°', 'info');
              }
            }
          } catch (err) {
            showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÑ‡∏î‡πâ: ' + err.message, 'error');
          }
        }
      );
    };

    window.addFishType = (e) => {
      e.preventDefault();
      const form = e.target;
      const result = db.fishTypes.create({
        name: form.name.value,
        feedType: form.feedType.value,
        avgWeight: parseFloat(form.avgWeight.value)
      });
      if (result) setState({ modal: null });
    };

    // Inventory Section Controls
    window.toggleInventorySection = (sectionId) => {
      const collapsed = state.inventoryCollapsed || {};
      collapsed[sectionId] = !collapsed[sectionId];
      setState({ inventoryCollapsed: { ...collapsed } });
    };

    window.collapseAllInventory = () => {
      setState({
        inventoryCollapsed: {
          fishTypes: true,
          feeds: true,
          supplements: true,
          medicines: true
        }
      });
    };

    window.expandAllInventory = () => {
      setState({ inventoryCollapsed: {} });
    };

    // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏±‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Delete All Inventory Data)
    window.confirmDeleteAllInventory = () => {
      const fishTypes = storage.get(KEYS.FISH_TYPES) || [];
      const feeds = storage.get(KEYS.FEEDS) || [];
      const supplements = storage.get(KEYS.SUPPLEMENTS) || [];
      const medicines = storage.get(KEYS.MEDICINES) || [];

      const totalItems = fishTypes.length + feeds.length + supplements.length + medicines.length;

      if (totalItems === 0) {
        showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á', 'info');
        return;
      }

      if (confirm(`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏±‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?\n\n` +
                  `‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏õ‡∏•‡∏≤: ${fishTypes.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n` +
                  `‡∏≠‡∏≤‡∏´‡∏≤‡∏£: ${feeds.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n` +
                  `‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°: ${supplements.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n` +
                  `‡∏¢‡∏≤: ${medicines.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n\n` +
                  `‡∏£‡∏ß‡∏° ${totalItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n\n` +
                  `‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!`)) {

        // Mark all items as deleted for sync
        fishTypes.forEach(item => {
          if (item.id && window.markAsDeleted) {
            window.markAsDeleted(KEYS.FISH_TYPES, item.id);
          }
        });

        feeds.forEach(item => {
          if (item.id && window.markAsDeleted) {
            window.markAsDeleted(KEYS.FEEDS, item.id);
          }
        });

        supplements.forEach(item => {
          if (item.id && window.markAsDeleted) {
            window.markAsDeleted(KEYS.SUPPLEMENTS, item.id);
          }
        });

        medicines.forEach(item => {
          if (item.id && window.markAsDeleted) {
            window.markAsDeleted(KEYS.MEDICINES, item.id);
          }
        });

        // Clear all inventory storage
        storage.set(KEYS.FISH_TYPES, []);
        storage.set(KEYS.FEEDS, []);
        storage.set(KEYS.SUPPLEMENTS, []);
        storage.set(KEYS.MEDICINES, []);

        showToast(`‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏±‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');

        // Refresh the view
        renderApp();
      }
    };

    window.filterInventory = (query) => {
      const sections = document.getElementById('inventorySections');
      if (!sections) return;

      const items = sections.querySelectorAll('.bg-slate-800\\/40');
      const q = query.toLowerCase().trim();

      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (q === '' || text.includes(q)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    };

    window.editFishType = (id) => {
      const ft = db.fishTypes.getById(id);
      if (ft) {
        setState({ modal: 'editFishType', editingFishType: ft });
      }
    };

    window.updateFishType = (e, id) => {
      e.preventDefault();
      const form = e.target;
      db.fishTypes.update(id, {
        name: form.name.value,
        feedType: form.feedType.value,
        avgWeight: parseFloat(form.avgWeight.value)
      });
      setState({ modal: null, editingFishType: null });
    };

    window.deleteFishType = (id) => {
      showConfirm('‡∏•‡∏ö‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏•‡∏≤?', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö', () => {
        db.fishTypes.delete(id);
        render();
      }, 'warning');
    };

    window.showFishTypeHistory = (id) => {
      const ft = db.fishTypes.getById(id);
      if (ft && ft.editHistory?.length > 0) {
        setState({ modal: 'fishTypeHistory', viewingFishTypeHistory: ft });
      }
    };

    window.createPond = (e) => {
      e.preventDefault();
      const form = e.target;
      const result = db.ponds.create(form.name.value);
      if (result) setState({ modal: null });
    };

    window.deletePond = (id) => {
      showConfirm('‡∏•‡∏ö‡∏ö‡πà‡∏≠?', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ö‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö', () => {
        db.ponds.delete(id);
        setState({ selectedPond: null });
      }, 'danger');
    };

    window.startCycle = (e) => {
      e.preventDefault();
      const form = e.target;
      const fishType = db.fishTypes.getById(form.fishType.value);
      const result = db.cycles.create({
        pondId: state.selectedPond,
        fishType: form.fishType.value,
        fishTypeName: fishType?.name || form.fishType.value,
        startDate: form.startDate.value,
        initialCount: parseInt(form.count.value),
        initialWeight: parseFloat(form.initialWeight.value),
        pricePerFish: parseFloat(form.price.value),
        status: 'active'
      });
      if (result) setState({ modal: null });
    };

    window.addFeeding = (e) => {
      e.preventDefault();
      const form = e.target;
      const pond = db.ponds.getById(state.selectedPond);
      const cycle = db.cycles.getActive(pond?.id);
      if (!cycle) return;

      const isMedicineOnly = form.medicineOnly?.checked || false;
      const feedId = isMedicineOnly ? null : form.feedId?.value;
      const weightKg = isMedicineOnly ? 0 : parseFloat(form.weight.value);

      // Check stock before adding feeding (only if not medicine-only mode)
      if (!isMedicineOnly && feedId) {
        const currentStock = db.feedStock.getStock(feedId);
        if (currentStock < weightKg) {
          showToast(`‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${formatNumber(currentStock, 1)} ‡∏Å‡∏Å.)`, 'error');
          return;
        }
      }

      const supplements = db.supplements.getAll();
      const selectedSupps = isMedicineOnly ? [] : supplements.filter(s => form[`supp_${s.id}`]?.checked).map(s => ({
        supplementId: s.id,
        amount: parseFloat(form[`suppAmt_${s.id}`]?.value || 100),
        unit: s.unit
      }));

      const medicines = db.medicines.getAll();
      const selectedMeds = medicines.filter(m => form[`med_${m.id}`]?.checked).map(m => ({
        medicineId: m.id,
        amount: parseFloat(form[`medAmt_${m.id}`]?.value || 10),
        unit: m.unit
      }));

      const result = db.feedingLogs.create({
        cycleId: cycle.id,
        date: new Date().toISOString(),
        time: form.time.value,
        feedId: feedId,
        weightKg: weightKg,
        supplements: selectedSupps,
        medicines: selectedMeds,
        medicineOnly: isMedicineOnly,
        notes: form.notes.value
      });

      // Deduct stock after successful feeding record
      if (result && !isMedicineOnly && feedId && weightKg > 0) {
        db.feedStock.deduct(feedId, weightKg);
      }

      if (result) setState({ modal: null });
    };

    window.addWaterQuality = (e) => {
      e.preventDefault();
      const form = e.target;
      const pond = db.ponds.getById(state.selectedPond);
      const cycle = db.cycles.getActive(pond?.id);
      if (!cycle) return;

      db.waterQuality.create({
        cycleId: cycle.id,
        date: new Date().toISOString(),
        time: form.time.value,
        temperature: form.temp.value ? parseFloat(form.temp.value) : null,
        doLevel: form.do.value ? parseFloat(form.do.value) : null,
        ph: form.ph.value ? parseFloat(form.ph.value) : null,
        notes: form.notes.value
      });
      setState({ modal: null });
    };

    window.addExpense = (e) => {
      e.preventDefault();
      const form = e.target;
      const pond = db.ponds.getById(state.selectedPond);
      const cycle = db.cycles.getActive(pond?.id);
      if (!cycle) return;

      const result = db.expenses.create({
        cycleId: cycle.id,
        date: form.date.value,
        category: form.category.value,
        description: form.description.value,
        amount: parseFloat(form.amount.value)
      });
      if (result) setState({ modal: null });
    };

    // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    window.showCostDetail = (type, pondId) => {
      const pond = db.ponds.getById(pondId);
      const cycle = db.cycles.getActive(pondId);
      if (!cycle) return;

      const logs = db.feedingLogs.getByCycle(cycle.id);
      const feeds = storage.get(KEYS.FEEDS) || [];
      const supplements = storage.get(KEYS.SUPPLEMENTS) || [];
      const expenses = db.expenses.getByCycle(cycle.id);
      const fishType = db.fishTypes.getById(cycle.fishTypeId);

      let title = '';
      let content = '';
      let total = 0;

      switch(type) {
        case 'fish':
          title = 'üêü ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡∏•‡∏π‡∏Å‡∏õ‡∏•‡∏≤';
          const fishCost = (cycle.fingerlingPrice || 0) * (cycle.fingerlingCount || 0);
          total = fishCost;
          content = `
            <div class="space-y-3">
              <div class="bg-slate-700/30 rounded-xl p-3">
                <div class="text-slate-400 text-xs mb-1">‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏õ‡∏•‡∏≤</div>
                <div class="text-slate-200">${fishType?.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div class="bg-slate-700/30 rounded-xl p-3">
                  <div class="text-slate-400 text-xs mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏õ‡∏•‡∏≤</div>
                  <div class="text-cyan-400 font-medium">${formatNumber(cycle.fingerlingCount || 0)} ‡∏ï‡∏±‡∏ß</div>
                </div>
                <div class="bg-slate-700/30 rounded-xl p-3">
                  <div class="text-slate-400 text-xs mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ï‡∏±‡∏ß</div>
                  <div class="text-cyan-400 font-medium">${formatCurrency(cycle.fingerlingPrice || 0)}</div>
                </div>
              </div>
              <div class="bg-cyan-500/10 rounded-xl p-3 border border-cyan-500/30">
                <div class="text-slate-400 text-xs mb-1">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏•‡∏π‡∏Å‡∏õ‡∏•‡∏≤</div>
                <div class="text-cyan-400 font-bold text-lg">${formatCurrency(fishCost)}</div>
              </div>
            </div>
          `;
          break;

        case 'feed':
          title = 'üçΩÔ∏è ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£';
          const feedItems = logs.filter(l => !l.medicineOnly).map(log => {
            const feed = feeds.find(f => f.id === log.feedId);
            const cost = log.weightKg * (feed?.pricePerKg || 0);
            total += cost;
            return { date: log.date, time: log.time, feed: feed?.name || '‡∏≠‡∏≤‡∏´‡∏≤‡∏£', weight: log.weightKg, price: feed?.pricePerKg || 0, cost };
          }).sort((a,b) => new Date(b.date) - new Date(a.date));

          content = feedItems.length > 0 ? `
            <div class="space-y-2 max-h-60 overflow-y-auto">
              ${feedItems.slice(0, 20).map(item => `
                <div class="bg-slate-700/30 rounded-xl p-3 flex justify-between items-center">
                  <div>
                    <div class="text-slate-300 text-sm">${item.feed}</div>
                    <div class="text-slate-500 text-xs">${item.date} ${item.time} ‚Ä¢ ${item.weight} ‡∏Å‡∏Å. √ó ${formatCurrency(item.price)}/‡∏Å‡∏Å.</div>
                  </div>
                  <div class="text-amber-400 font-medium">${formatCurrency(item.cost)}</div>
                </div>
              `).join('')}
              ${feedItems.length > 20 ? `<div class="text-center text-slate-500 text-sm">‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${feedItems.length - 20} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</div>` : ''}
            </div>
          ` : '<div class="text-slate-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div>';
          break;

        case 'supplement':
          title = 'üíä ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô/‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°';
          const suppItems = [];
          logs.forEach(log => {
            if (log.supplements?.length > 0) {
              log.supplements.forEach(s => {
                const supp = supplements.find(sp => sp.id === s.supplementId);
                const cost = (s.amount || 0) * (supp?.pricePerUnit || 0);
                total += cost;
                suppItems.push({ date: log.date, time: log.time, name: supp?.name || '‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô', amount: s.amount, unit: supp?.unit || '', price: supp?.pricePerUnit || 0, cost });
              });
            }
          });
          suppItems.sort((a,b) => new Date(b.date) - new Date(a.date));

          content = suppItems.length > 0 ? `
            <div class="space-y-2 max-h-60 overflow-y-auto">
              ${suppItems.slice(0, 20).map(item => `
                <div class="bg-slate-700/30 rounded-xl p-3 flex justify-between items-center">
                  <div>
                    <div class="text-slate-300 text-sm">${item.name}</div>
                    <div class="text-slate-500 text-xs">${item.date} ${item.time} ‚Ä¢ ${item.amount} ${item.unit}</div>
                  </div>
                  <div class="text-amber-400 font-medium">${formatCurrency(item.cost)}</div>
                </div>
              `).join('')}
              ${suppItems.length > 20 ? `<div class="text-center text-slate-500 text-sm">‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${suppItems.length - 20} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</div>` : ''}
            </div>
          ` : '<div class="text-slate-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô</div>';
          break;

        case 'other':
          title = 'üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
          const otherItems = expenses.map(e => {
            total += e.amount;
            return { date: e.date, category: e.category, description: e.description, amount: e.amount };
          }).sort((a,b) => new Date(b.date) - new Date(a.date));

          content = otherItems.length > 0 ? `
            <div class="space-y-2 max-h-60 overflow-y-auto">
              ${otherItems.map(item => `
                <div class="bg-slate-700/30 rounded-xl p-3 flex justify-between items-center">
                  <div>
                    <div class="text-slate-300 text-sm">${item.description || item.category}</div>
                    <div class="text-slate-500 text-xs">${item.date} ‚Ä¢ ${item.category}</div>
                  </div>
                  <div class="text-amber-400 font-medium">${formatCurrency(item.amount)}</div>
                </div>
              `).join('')}
            </div>
          ` : '<div class="text-slate-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div>';
          break;
      }

      // ‡πÅ‡∏™‡∏î‡∏á modal
      const modalHtml = `
        <div id="costDetailModal" class="fixed inset-0 z-50 flex items-end justify-center" onclick="if(event.target === this) closeCostDetailModal()">
          <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
          <div class="relative w-full max-w-lg bg-slate-800 rounded-t-3xl p-6 max-h-[80vh] overflow-y-auto animate-slide-up">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-slate-200">${title}</h3>
              <button onclick="closeCostDetailModal()" class="p-2 text-slate-400 hover:text-slate-200">‚úï</button>
            </div>
            ${content}
            <div class="mt-4 pt-4 border-t border-slate-700/50 flex justify-between items-center">
              <span class="text-slate-300 font-medium">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
              <span class="text-amber-400 font-bold text-xl">${formatCurrency(total)}</span>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    };

    window.closeCostDetailModal = () => {
      document.getElementById('costDetailModal')?.remove();
    };

    window.calculateHarvestCount = () => {
      const avgWeight = parseFloat(document.getElementById('harvestAvgWeight')?.value) || 150;
      const soldWeight = parseFloat(document.getElementById('harvestSoldWeight')?.value) || 0;
      const undersizedWeight = parseFloat(document.getElementById('harvestUndersizedWeight')?.value) || 0;

      // Calculate counts (weight in kg * 1000 / avgWeight in grams)
      const soldCount = avgWeight > 0 ? Math.round((soldWeight * 1000) / avgWeight) : 0;
      const undersizedCount = avgWeight > 0 ? Math.round((undersizedWeight * 1000) / avgWeight) : 0;
      const totalWeight = soldWeight + undersizedWeight;
      const totalCount = soldCount + undersizedCount;

      // Update display
      const soldCountEl = document.getElementById('soldCount');
      const undersizedCountEl = document.getElementById('undersizedCount');
      const totalWeightEl = document.getElementById('totalHarvestWeight');
      const totalCountEl = document.getElementById('totalHarvestCount');

      if (soldCountEl) soldCountEl.textContent = formatNumber(soldCount);
      if (undersizedCountEl) undersizedCountEl.textContent = formatNumber(undersizedCount);
      if (totalWeightEl) totalWeightEl.textContent = formatNumber(totalWeight, 1) + ' ‡∏Å‡∏Å.';
      if (totalCountEl) totalCountEl.textContent = formatNumber(totalCount) + ' ‡∏ï‡∏±‡∏ß';
    };

    window.selectUndersizedAction = (action) => {
      const priceSection = document.getElementById('undersizedPriceSection');
      const actionText = document.getElementById('undersizedActionText');
      const sellRadio = document.getElementById('actionSell');
      const keepRadio = document.getElementById('actionKeep');

      if (action === 'sell') {
        priceSection?.classList.remove('hidden');
        if (actionText) actionText.textContent = '(‡∏Ç‡∏≤‡∏¢)';
        if (sellRadio) sellRadio.checked = true;
        if (keepRadio) keepRadio.checked = false;
      } else {
        priceSection?.classList.add('hidden');
        if (actionText) actionText.textContent = '(‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ï‡πà‡∏≠)';
        if (sellRadio) sellRadio.checked = false;
        if (keepRadio) keepRadio.checked = true;
      }
    };

    window.addHarvest = (e) => {
      e.preventDefault();
      const form = e.target;
      const pond = db.ponds.getById(state.selectedPond);
      const cycle = db.cycles.getActive(pond?.id);
      if (!cycle) return;

      const avgWeight = parseFloat(form.avgWeight.value) || 150;
      const soldWeight = parseFloat(form.soldWeight.value) || 0;
      const undersizedWeight = parseFloat(form.undersizedWeight.value) || 0;
      const soldPrice = parseFloat(form.soldPrice.value) || 0;
      const undersizedAction = form.undersizedAction?.value || 'keep';
      const undersizedPrice = undersizedAction === 'sell' ? (parseFloat(form.undersizedPrice?.value) || 0) : 0;

      // Calculate counts
      const soldCount = avgWeight > 0 ? Math.round((soldWeight * 1000) / avgWeight) : 0;
      const undersizedCount = avgWeight > 0 ? Math.round((undersizedWeight * 1000) / avgWeight) : 0;

      const totalWeight = soldWeight + undersizedWeight;
      const totalCount = soldCount + undersizedCount;

      // Calculate total revenue (undersized fish only if sold)
      const totalRevenue = (soldWeight * soldPrice) + (undersizedAction === 'sell' ? undersizedWeight * undersizedPrice : 0);

      const result = db.harvests.create({
        cycleId: cycle.id,
        date: form.date.value,
        avgWeightPerFish: avgWeight,
        weightKg: totalWeight,
        count: totalCount,
        soldWeight: soldWeight,
        soldCount: soldCount,
        soldPrice: soldPrice,
        undersizedWeight: undersizedWeight,
        undersizedCount: undersizedCount,
        undersizedPrice: undersizedPrice,
        undersizedAction: undersizedAction,
        pricePerKg: soldWeight > 0 ? soldPrice : undersizedPrice,
        totalRevenue: totalRevenue,
        isFinalHarvest: form.isFinal.checked
      });

      if (result) {
        if (form.isFinal.checked) {
          setState({ modal: null, selectedPond: null });
        } else {
          setState({ modal: null });
        }
      }
    };

    window.addFeed = (e) => {
      e.preventDefault();
      const form = e.target;
      const isPellet = form.type.value === 'pellet';
      const useBag = isPellet && form.useBag?.checked;
      const bagSize = useBag && form.bagSize && form.bagSize.value ? parseFloat(form.bagSize.value) : null;
      const result = db.feeds.create({
        type: form.type.value,
        name: form.name.value,
        brand: form.brand.value || null,
        sizeNumber: form.sizeNumber.value || null,
        useBag: useBag,
        bagSize: bagSize,
        pricePerKg: parseFloat(form.price.value)
      });
      if (result) setState({ modal: null });
    };

    window.addSupplement = (e) => {
      e.preventDefault();
      const form = e.target;
      const packageSize = parseFloat(form.packageSize.value);
      const price = parseFloat(form.price.value);
      const result = db.supplements.create({
        name: form.name.value,
        description: form.description.value,
        suppType: form.suppType.value,
        packageSize: packageSize,
        price: price,
        pricePerUnit: price / packageSize,
        unit: form.unit.value
      });
      if (result) setState({ modal: null });
    };

    window.deleteFeedingLog = (id) => {
      showConfirm('‡∏•‡∏ö‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£?', '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ', () => {
        db.feedingLogs.delete(id);
        render();
      }, 'warning');
    };

    window.editFeedingLog = (id) => {
      const logs = storage.get(KEYS.FEEDING_LOGS);
      const log = logs.find(l => l.id === id);
      if (log) {
        setState({ modal: 'editFeeding', editingLog: log });
      }
    };

    window.updateFeeding = (e, id) => {
      e.preventDefault();
      const form = e.target;
      db.feedingLogs.update(id, {
        time: form.time.value,
        feedId: form.feedId.value,
        weightKg: parseFloat(form.weight.value)
      });
      setState({ modal: null, editingLog: null });
    };

    window.deleteFeed = (id) => {
      showConfirm('‡∏•‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£?', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö', () => {
        db.feeds.delete(id);
        render();
      }, 'warning');
    };

    window.deleteSupplement = (id) => {
      showConfirm('‡∏•‡∏ö‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô?', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö', () => {
        db.supplements.delete(id);
        render();
      }, 'warning');
    };

    window.editFeed = (id) => {
      const feed = db.feeds.getAll().find(f => f.id === id);
      if (feed) {
        setState({ modal: 'editFeed', editingFeed: feed });
      }
    };

    window.viewFeedHistory = (id) => {
      const feed = db.feeds.getAll().find(f => f.id === id);
      if (feed && feed.editHistory && feed.editHistory.length > 0) {
        setState({ modal: 'feedHistory', viewingFeedHistory: feed });
      }
    };

    window.updateFeed = (e) => {
      e.preventDefault();
      const form = e.target;
      const isPellet = form.type.value === 'pellet';
      const useBag = isPellet && form.useBag?.checked;
      const bagSize = useBag && form.bagSize && form.bagSize.value ? parseFloat(form.bagSize.value) : null;
      db.feeds.update(state.editingFeed.id, {
        type: form.type.value,
        name: form.name.value,
        brand: form.brand.value || null,
        sizeNumber: form.sizeNumber.value || null,
        useBag: useBag,
        bagSize: bagSize,
        pricePerKg: parseFloat(form.price.value)
      });
      setState({ modal: null, editingFeed: null });
    };

    window.editSupplement = (id) => {
      const supp = db.supplements.getAll().find(s => s.id === id);
      if (supp) {
        setState({ modal: 'editSupplement', editingSupplement: supp });
      }
    };

    window.viewSupplementHistory = (id) => {
      const supp = db.supplements.getAll().find(s => s.id === id);
      if (supp && supp.editHistory && supp.editHistory.length > 0) {
        setState({ modal: 'supplementHistory', viewingSupplementHistory: supp });
      }
    };

    window.updateSupplement = (e) => {
      e.preventDefault();
      const form = e.target;
      const packageSize = parseFloat(form.packageSize.value);
      const price = parseFloat(form.price.value);
      db.supplements.update(state.editingSupplement.id, {
        name: form.name.value,
        description: form.description.value || null,
        suppType: form.suppType.value,
        packageSize: packageSize,
        price: price,
        pricePerUnit: price / packageSize,
        unit: form.unit.value
      });
      setState({ modal: null, editingSupplement: null });
    };

    // Medicine Functions
    window.addMedicine = (e) => {
      e.preventDefault();
      const form = e.target;
      const packageSize = parseFloat(form.packageSize.value);
      const price = parseFloat(form.price.value);
      const result = db.medicines.create({
        name: form.name.value,
        description: form.description.value,
        medType: form.medType.value,
        packageSize: packageSize,
        price: price,
        pricePerUnit: price / packageSize,
        unit: form.unit.value,
        usageDetails: form.usageDetails.value
      });
      if (result) setState({ modal: null });
    };

    window.deleteMedicine = (id) => {
      showConfirm('‡∏•‡∏ö‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ?', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö', () => {
        db.medicines.delete(id);
        render();
      }, 'warning');
    };

    window.editMedicine = (id) => {
      const med = db.medicines.getAll().find(m => m.id === id);
      if (med) {
        setState({ modal: 'editMedicine', editingMedicine: med });
      }
    };

    window.viewMedicineHistory = (id) => {
      const med = db.medicines.getAll().find(m => m.id === id);
      if (med && med.editHistory && med.editHistory.length > 0) {
        setState({ modal: 'medicineHistory', viewingMedicineHistory: med });
      }
    };

    window.updateMedicine = (e, id) => {
      e.preventDefault();
      const form = e.target;
      const packageSize = parseFloat(form.packageSize.value) || 0;
      const price = parseFloat(form.price.value) || 0;
      db.medicines.update(id, {
        name: form.name.value,
        description: form.description.value || null,
        medType: form.medType.value,
        packageSize: packageSize,
        price: price,
        pricePerUnit: packageSize > 0 ? price / packageSize : 0,
        unit: form.unit.value,
        usageDetails: form.usageDetails.value
      });
      setState({ modal: null, editingMedicine: null });
    };

    window.selectMedType = (type) => {
      const btnLiquid = document.getElementById('btnMedLiquid');
      const btnSolid = document.getElementById('btnMedSolid');
      const hiddenInput = document.querySelector('input[name="medType"]');
      const unitSelect = document.getElementById('medUnitSelect');

      if (type === 'liquid') {
        btnLiquid.className = 'flex-1 p-3 rounded-xl border bg-blue-500/20 border-blue-500/50 text-blue-400 transition-colors';
        btnSolid.className = 'flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors';
        if (unitSelect) unitSelect.value = '‡∏°‡∏•.';
      } else {
        btnSolid.className = 'flex-1 p-3 rounded-xl border bg-rose-500/20 border-rose-500/50 text-rose-400 transition-colors';
        btnLiquid.className = 'flex-1 p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors';
        if (unitSelect) unitSelect.value = '‡∏Å‡∏£‡∏±‡∏°';
      }
      if (hiddenInput) hiddenInput.value = type;
    };

    // Mortality Functions
    window.addMortality = (e) => {
      e.preventDefault();
      const form = e.target;
      const pond = db.ponds.getById(state.selectedPond);
      const cycle = db.cycles.getActive(pond?.id);
      if (!cycle) return;

      const result = db.mortalities.create({
        cycleId: cycle.id,
        date: form.date.value,
        count: parseInt(form.count.value),
        reason: form.reason.value || null
      });
      if (result) {
        form.count.value = '';
        form.reason.value = '';
        render();
      }
    };

    window.deleteMortality = (id) => {
      showConfirm('‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏•‡∏≤‡∏ï‡∏≤‡∏¢?', '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ', () => {
        db.mortalities.delete(id);
        render();
      }, 'warning');
    };

    // Feed Stock Functions
    window.addFeedStock = (e) => {
      e.preventDefault();
      const form = e.target;
      const feedId = form.feedId.value;
      const quantity = parseFloat(form.quantity.value);
      const note = form.note?.value || '';

      if (db.feedStock.add(feedId, quantity, note)) {
        setState({ modal: null });
      }
    };

    window.showAddStockForm = (feedId) => {
      const btnAdd = document.getElementById('btnAddStock');
      const btnSet = document.getElementById('btnSetStock');
      const label = document.getElementById('stockLabel');
      const submitBtn = document.getElementById('stockSubmitBtn');
      const form = document.getElementById('stockForm');

      btnAdd.className = 'p-3 rounded-xl border bg-green-500/20 border-green-500/50 text-green-400 transition-colors text-sm font-medium';
      btnSet.className = 'p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors text-sm font-medium';
      label.innerHTML = '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏Å‡∏Å.) <span class="text-red-400">*</span>';
      submitBtn.textContent = '+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å';
      submitBtn.className = 'w-full py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl font-medium transition-colors';
      form.querySelector('[name=action]').value = 'add';
      form.querySelector('[name=quantity]').value = '';
      form.querySelector('[name=quantity]').min = '0.1';
    };

    window.showSetStockForm = (feedId) => {
      const btnAdd = document.getElementById('btnAddStock');
      const btnSet = document.getElementById('btnSetStock');
      const label = document.getElementById('stockLabel');
      const submitBtn = document.getElementById('stockSubmitBtn');
      const form = document.getElementById('stockForm');
      const currentStock = db.feedStock.getStock(feedId);

      btnSet.className = 'p-3 rounded-xl border bg-cyan-500/20 border-cyan-500/50 text-cyan-400 transition-colors text-sm font-medium';
      btnAdd.className = 'p-3 rounded-xl border bg-slate-700/50 border-slate-600 text-slate-400 transition-colors text-sm font-medium';
      label.innerHTML = '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏Å‡∏Å.) <span class="text-red-400">*</span>';
      submitBtn.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
      submitBtn.className = 'w-full py-3 bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl font-medium transition-colors';
      form.querySelector('[name=action]').value = 'set';
      form.querySelector('[name=quantity]').value = currentStock;
      form.querySelector('[name=quantity]').min = '0';
    };

    window.submitStockEdit = (e, feedId) => {
      e.preventDefault();
      const form = e.target;
      const action = form.action.value;
      const quantity = parseFloat(form.quantity.value);

      if (action === 'add') {
        if (db.feedStock.add(feedId, quantity)) {
          setState({ modal: null, editingStockFeedId: null });
        }
      } else {
        if (db.feedStock.setQuantity(feedId, quantity)) {
          setState({ modal: null, editingStockFeedId: null });
        }
      }
    };

    // Stock History Functions
    window.loadMoreStockHistory = () => {
      const currentLimit = state.stockHistoryLimit || 20;
      setState({ stockHistoryLimit: currentLimit + 20 });
    };

    window.downloadStockHistory = () => {
      const stocks = db.feedStock.getAll();
      const feeds = db.feeds.getAll();

      // Collect all history
      const allHistory = [];
      stocks.forEach(stock => {
        const feed = feeds.find(f => f.id === stock.feedId);
        if (stock.history && feed) {
          stock.history.forEach(h => {
            allHistory.push({
              ...h,
              feedName: feed.name,
              feedType: feed.type
            });
          });
        }
      });

      // Sort by date descending
      allHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

      // Calculate summary
      let totalAdd = 0, totalDeduct = 0;
      const byFeed = {};
      allHistory.forEach(h => {
        if (h.type === 'add') totalAdd += h.quantity;
        if (h.type === 'deduct') totalDeduct += h.quantity;
        if (!byFeed[h.feedName]) byFeed[h.feedName] = { add: 0, deduct: 0, type: h.feedType };
        if (h.type === 'add') byFeed[h.feedName].add += h.quantity;
        if (h.type === 'deduct') byFeed[h.feedName].deduct += h.quantity;
      });

      // Generate report
      const now = new Date();
      const dateStr = now.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });

      let report = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£\n`;
      report += `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${dateStr}\n`;
      report += `${'='.repeat(50)}\n\n`;

      report += `üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°\n`;
      report += `-`.repeat(30) + `\n`;
      report += `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${formatNumber(totalAdd, 1)} ‡∏Å‡∏Å.\n`;
      report += `‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${formatNumber(totalDeduct, 1)} ‡∏Å‡∏Å.\n`;
      report += `‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${formatNumber(totalAdd - totalDeduct, 1)} ‡∏Å‡∏Å.\n\n`;

      report += `üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£\n`;
      report += `-`.repeat(30) + `\n`;
      Object.entries(byFeed).forEach(([name, data]) => {
        const typeIcon = data.type === 'fresh' ? 'üü†' : 'üîµ';
        report += `${typeIcon} ${name}\n`;
        report += `   ‡πÄ‡∏û‡∏¥‡πà‡∏°: +${formatNumber(data.add, 1)} ‡∏Å‡∏Å. | ‡πÉ‡∏ä‡πâ: -${formatNumber(data.deduct, 1)} ‡∏Å‡∏Å.\n`;
      });

      report += `\nüìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${allHistory.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)\n`;
      report += `-`.repeat(30) + `\n`;
      allHistory.forEach(h => {
        const date = new Date(h.date);
        const dateStr = date.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: '2-digit' });
        const timeStr = date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
        const typeIcon = h.feedType === 'fresh' ? 'üü†' : 'üîµ';
        const actionIcon = h.type === 'add' ? '‚ûï' : h.type === 'deduct' ? '‚ûñ' : 'üîÑ';
        const qty = h.type === 'adjust' ? `${formatNumber(h.oldQuantity, 1)} ‚Üí ${formatNumber(h.newQuantity, 1)}` : formatNumber(h.quantity, 1);
        report += `${dateStr} ${timeStr} | ${typeIcon} ${h.feedName} | ${actionIcon} ${qty} ‡∏Å‡∏Å.${h.note ? ` (${h.note})` : ''}\n`;
      });

      // Download as text file
      const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `stock-history-${now.toISOString().split('T')[0]}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    };

    // Export Functions
    window.exportFeedingData = () => {
      const feedingLogs = storage.get(KEYS.FEEDING_LOGS);
      const feeds = db.feeds.getAll();
      const supplements = db.supplements.getAll();
      const medicines = db.medicines.getAll();
      const ponds = db.ponds.getAll();
      const cycles = storage.get(KEYS.CYCLES);

      if (feedingLogs.length === 0) {
        showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£', 'error');
        return;
      }

      const now = new Date();
      const dateStr = now.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });

      // Generate detailed report
      let report = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ - Fish Farm Pro\n`;
      report += `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${dateStr}\n`;
      report += `${'='.repeat(60)}\n\n`;

      // Summary
      const totalFeedings = feedingLogs.filter(l => !l.medicineOnly).length;
      const totalWeight = feedingLogs.reduce((s, l) => s + (l.weightKg || 0), 0);
      const medicineOnlyCount = feedingLogs.filter(l => l.medicineOnly).length;

      report += `üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°\n`;
      report += `-`.repeat(40) + `\n`;
      report += `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalFeedings} ‡∏°‡∏∑‡πâ‡∏≠\n`;
      report += `‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏£‡∏ß‡∏°: ${formatNumber(totalWeight, 2)} ‡∏Å‡∏Å.\n`;
      report += `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏¢‡∏≤ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏´‡∏≤‡∏£): ${medicineOnlyCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n\n`;

      // Group by pond/cycle
      const byCycle = {};
      feedingLogs.forEach(log => {
        if (!byCycle[log.cycleId]) byCycle[log.cycleId] = [];
        byCycle[log.cycleId].push(log);
      });

      Object.entries(byCycle).forEach(([cycleId, logs]) => {
        const cycle = cycles.find(c => c.id === cycleId);
        const pond = cycle ? ponds.find(p => p.id === cycle.pondId) : null;
        const pondName = pond?.name || '‡∏ö‡πà‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        const cycleStart = cycle ? new Date(cycle.startDate).toLocaleDateString('th-TH') : '-';

        report += `\nüî≤ ${pondName} (‡πÄ‡∏£‡∏¥‡πà‡∏°: ${cycleStart})\n`;
        report += `-`.repeat(40) + `\n`;

        const cycleWeight = logs.reduce((s, l) => s + (l.weightKg || 0), 0);
        report += `‡∏£‡∏ß‡∏°: ${logs.length} ‡∏°‡∏∑‡πâ‡∏≠, ${formatNumber(cycleWeight, 2)} ‡∏Å‡∏Å.\n\n`;

        logs.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(log => {
          const date = new Date(log.date);
          const dateStr = date.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: '2-digit' });
          const feed = feeds.find(f => f.id === log.feedId);
          const feedName = feed?.name || (log.medicineOnly ? '‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß' : '-');

          report += `${dateStr} ${log.time} | ${feedName}`;
          if (!log.medicineOnly) report += ` | ${formatNumber(log.weightKg, 2)} ‡∏Å‡∏Å.`;

          // Supplements
          if (log.supplements?.length > 0) {
            const suppList = log.supplements.map(s => {
              const supp = supplements.find(sp => sp.id === s.supplementId);
              return `${supp?.name || '-'} ${s.amount}${s.unit}`;
            }).join(', ');
            report += ` | ‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô: ${suppList}`;
          }

          // Medicines
          if (log.medicines?.length > 0) {
            const medList = log.medicines.map(m => {
              const med = medicines.find(md => md.id === m.medicineId);
              return `${med?.name || '-'} ${m.amount}${m.unit}`;
            }).join(', ');
            report += ` | ‡∏¢‡∏≤: ${medList}`;
          }

          if (log.notes) report += ` | ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${log.notes}`;
          report += `\n`;

          // Edit history
          if (log.editHistory?.length > 0) {
            log.editHistory.forEach(h => {
              const editDate = new Date(h.editedAt).toLocaleDateString('th-TH');
              report += `   ‚îî ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${editDate}: ${formatNumber(h.prev.weightKg, 2)} ‡∏Å‡∏Å. ‚Üí ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô\n`;
            });
          }
        });
      });

      // Download
      downloadFile(report, `feeding-data-${now.toISOString().split('T')[0]}.txt`, 'text/plain');
      showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    };

    window.exportStockData = () => {
      const stocks = db.feedStock.getAll();
      const feeds = db.feeds.getAll();

      if (stocks.length === 0) {
        showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£', 'error');
        return;
      }

      const now = new Date();
      const dateStr = now.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });

      let report = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ - Fish Farm Pro\n`;
      report += `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${dateStr}\n`;
      report += `${'='.repeat(60)}\n\n`;

      // Current stock summary
      report += `üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô\n`;
      report += `-`.repeat(40) + `\n`;

      let totalStock = 0;
      stocks.forEach(stock => {
        const feed = feeds.find(f => f.id === stock.feedId);
        if (feed) {
          const typeIcon = feed.type === 'fresh' ? 'üü†' : 'üîµ';
          report += `${typeIcon} ${feed.name}: ${formatNumber(stock.stock, 2)} ‡∏Å‡∏Å.\n`;
          totalStock += stock.stock;
        }
      });
      report += `\n‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${formatNumber(totalStock, 2)} ‡∏Å‡∏Å.\n\n`;

      // History by feed
      stocks.forEach(stock => {
        const feed = feeds.find(f => f.id === stock.feedId);
        if (!feed || !stock.history?.length) return;

        const typeIcon = feed.type === 'fresh' ? 'üü†' : 'üîµ';
        report += `\n${typeIcon} ${feed.name} - ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á\n`;
        report += `-`.repeat(40) + `\n`;

        const totalAdd = stock.history.filter(h => h.type === 'add').reduce((s, h) => s + h.quantity, 0);
        const totalDeduct = stock.history.filter(h => h.type === 'deduct').reduce((s, h) => s + h.quantity, 0);
        report += `‡∏™‡∏£‡∏∏‡∏õ: ‡πÄ‡∏û‡∏¥‡πà‡∏° ${formatNumber(totalAdd, 2)} ‡∏Å‡∏Å. | ‡πÉ‡∏ä‡πâ ${formatNumber(totalDeduct, 2)} ‡∏Å‡∏Å.\n\n`;

        stock.history.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(h => {
          const date = new Date(h.date);
          const dateStr = date.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: '2-digit' });
          const timeStr = date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
          const actionIcon = h.type === 'add' ? '‚ûï' : h.type === 'deduct' ? '‚ûñ' : 'üîÑ';
          const qty = h.type === 'adjust' ? `${formatNumber(h.oldQuantity, 2)} ‚Üí ${formatNumber(h.newQuantity, 2)}` : formatNumber(h.quantity, 2);

          report += `${dateStr} ${timeStr} | ${actionIcon} ${qty} ‡∏Å‡∏Å.`;
          if (h.note) report += ` | ${h.note}`;
          if (h.pondName) report += ` | ‡∏ö‡πà‡∏≠: ${h.pondName}`;
          report += `\n`;
        });
      });

      downloadFile(report, `stock-data-${now.toISOString().split('T')[0]}.txt`, 'text/plain');
      showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    };

    window.exportAllDataCSV = () => {
      const feedingLogs = storage.get(KEYS.FEEDING_LOGS);
      const stocks = db.feedStock.getAll();
      const feeds = db.feeds.getAll();
      const ponds = db.ponds.getAll();
      const cycles = storage.get(KEYS.CYCLES);
      const supplements = db.supplements.getAll();
      const medicines = db.medicines.getAll();

      const now = new Date();

      // Feeding Logs CSV
      let feedingCSV = '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡πÄ‡∏ß‡∏•‡∏≤,‡∏ö‡πà‡∏≠,‡∏ä‡∏ô‡∏¥‡∏î‡∏õ‡∏•‡∏≤,‡∏≠‡∏≤‡∏´‡∏≤‡∏£,‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å(‡∏Å‡∏Å.),‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô,‡∏¢‡∏≤,‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏\n';
      feedingLogs.forEach(log => {
        const cycle = cycles.find(c => c.id === log.cycleId);
        const pond = cycle ? ponds.find(p => p.id === cycle.pondId) : null;
        const feed = feeds.find(f => f.id === log.feedId);
        const date = new Date(log.date).toLocaleDateString('th-TH');
        const suppList = (log.supplements || []).map(s => {
          const supp = supplements.find(sp => sp.id === s.supplementId);
          return `${supp?.name || '-'}(${s.amount}${s.unit})`;
        }).join('; ');
        const medList = (log.medicines || []).map(m => {
          const med = medicines.find(md => md.id === m.medicineId);
          return `${med?.name || '-'}(${m.amount}${m.unit})`;
        }).join('; ');

        feedingCSV += `"${date}","${log.time}","${pond?.name || '-'}","${cycle?.fishType || '-'}","${feed?.name || (log.medicineOnly ? '‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß' : '-')}",${log.weightKg || 0},"${suppList}","${medList}","${log.notes || ''}"\n`;
      });

      // Stock History CSV
      let stockCSV = '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡πÄ‡∏ß‡∏•‡∏≤,‡∏≠‡∏≤‡∏´‡∏≤‡∏£,‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó,‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô(‡∏Å‡∏Å.),‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏,‡∏ö‡πà‡∏≠\n';
      stocks.forEach(stock => {
        const feed = feeds.find(f => f.id === stock.feedId);
        if (!feed || !stock.history) return;

        stock.history.forEach(h => {
          const date = new Date(h.date);
          const dateStr = date.toLocaleDateString('th-TH');
          const timeStr = date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
          const action = h.type === 'add' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°' : h.type === 'deduct' ? '‡πÉ‡∏ä‡πâ' : '‡∏õ‡∏£‡∏±‡∏ö';
          const qty = h.type === 'adjust' ? `${h.oldQuantity} ‚Üí ${h.newQuantity}` : h.quantity;

          stockCSV += `"${dateStr}","${timeStr}","${feed.name}","${feed.type === 'fresh' ? '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏î' : '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏°‡πá‡∏î'}","${action}",${qty},"${h.note || ''}","${h.pondName || ''}"\n`;
        });
      });

      // Create zip-like combined file
      const combined = `=== ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ===\n${feedingCSV}\n\n=== ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ===\n${stockCSV}`;

      downloadFile(combined, `fish-farm-data-${now.toISOString().split('T')[0]}.csv`, 'text/csv');
      showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    };

    window.exportAllDataJSON = () => {
      const allData = {
        exportDate: new Date().toISOString(),
        appVersion: 'Fish Farm Pro v1.2',
        data: {
          ponds: db.ponds.getAll(),
          fishTypes: db.fishTypes.getAll(),
          feeds: db.feeds.getAll(),
          supplements: db.supplements.getAll(),
          medicines: db.medicines.getAll(),
          cycles: storage.get(KEYS.CYCLES),
          feedingLogs: storage.get(KEYS.FEEDING_LOGS),
          feedStock: db.feedStock.getAll(),
          waterQuality: storage.get(KEYS.WATER_QUALITY),
          expenses: storage.get(KEYS.EXPENSES),
          harvests: storage.get(KEYS.HARVESTS)
        }
      };

      const json = JSON.stringify(allData, null, 2);
      downloadFile(json, `fish-farm-backup-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
      showToast('‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    };

    // Helper function to download files
    const downloadFile = (content, filename, mimeType) => {
      const blob = new Blob([content], { type: `${mimeType};charset=utf-8` });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    // Stock Password Functions
    window.requestDeleteStock = (feedId) => {
      setState({ modal: 'stockPasswordConfirm', pendingStockDelete: feedId });
    };

    window.confirmDeleteStock = (e, feedId) => {
      e.preventDefault();
      const form = e.target;
      const password = form.password.value;

      if (db.stockPassword.check(password)) {
        executeDeleteStock(feedId);
      } else {
        showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
      }
    };

    window.executeDeleteStock = (feedId) => {
      db.feedStock.delete(feedId);
      showToast('‡∏•‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      setState({ modal: null, pendingStockDelete: null });
    };

    window.setStockPassword = (e) => {
      e.preventDefault();
      const form = e.target;
      const password = form.password.value;
      const confirmPassword = form.confirmPassword.value;

      if (password !== confirmPassword) {
        showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô', 'error');
        return;
      }

      if (password.length < 4) {
        showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß', 'error');
        return;
      }

      db.stockPassword.set(password);
      render();
    };

    window.changeStockPassword = (e) => {
      e.preventDefault();
      const form = e.target;
      const oldPassword = form.oldPassword.value;
      const newPassword = form.newPassword.value;
      const confirmPassword = form.confirmPassword.value;

      if (newPassword !== confirmPassword) {
        showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô', 'error');
        return;
      }

      if (newPassword.length < 4) {
        showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß', 'error');
        return;
      }

      if (db.stockPassword.change(oldPassword, newPassword)) {
        render();
      }
    };

    window.disableStockPassword = (e) => {
      e.preventDefault();
      const form = e.target;
      const password = form.password.value;

      if (db.stockPassword.check(password)) {
        db.stockPassword.disable();
        render();
      } else {
        showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
      }
    };

    window.resetPond = () => {
      showConfirm('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ö‡πà‡∏≠?', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö!', () => {
        db.cycles.reset(state.selectedPond);
        render();
      }, 'danger');
    };

    // Theme Functions
    window.getCurrentTheme = () => {
      return localStorage.getItem('ff_theme') || 'dark';
    };

    window.setTheme = (theme) => {
      localStorage.setItem('ff_theme', theme);
      if (theme === 'pastel') {
        document.body.classList.add('pastel-theme');
      } else {
        document.body.classList.remove('pastel-theme');
      }
      render();
      showToast(theme === 'pastel' ? '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏µ‡∏°‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•' : '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏µ‡∏°‡∏°‡∏∑‡∏î', 'success');
    };

    window.initTheme = () => {
      const theme = getCurrentTheme();
      if (theme === 'pastel') {
        document.body.classList.add('pastel-theme');
      }
    };

    window.clearAllData = () => {
      showConfirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?', '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!', () => {
        Object.values(KEYS).forEach(key => localStorage.removeItem(key));
        showToast('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        setTimeout(() => location.reload(), 500);
      }, 'danger');
    };

    window.exportReport = (type) => {
      const ponds = db.ponds.getAll();
      const feeds = db.feeds.getAll();

      if (type === 'json') {
        const backup = {};
        Object.entries(KEYS).forEach(([name, key]) => {
          backup[name] = storage.get(key);
        });
        backup.exportDate = new Date().toISOString();
        backup.version = '1.1';

        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `fish-farm-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        return;
      }

      let report = '=== ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ü‡∏≤‡∏£‡πå‡∏° ===\n';
      report += `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatDate(new Date())}\n\n`;

      ponds.forEach(pond => {
        const cycle = db.cycles.getActive(pond.id);
        if (cycle) {
          const stats = calculations.getCycleStats(cycle.id);
          report += `üìç ${pond.name}\n`;
          report += `   ‡∏ä‡∏ô‡∏¥‡∏î: ${cycle.fishTypeName}\n`;
          report += `   ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á: ${stats.days} ‡∏ß‡∏±‡∏ô\n`;
          report += `   ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏•‡πà‡∏≠‡∏¢: ${formatNumber(cycle.initialCount)} ‡∏ï‡∏±‡∏ß\n`;
          report += `   ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏£‡∏ß‡∏°: ${formatNumber(stats.totalFeed, 1)} ‡∏Å‡∏Å.\n`;
          report += `   FCR: ${stats.fcr}\n`;
          report += `   ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô: ${formatCurrency(stats.totalCost)}\n\n`;
        }
      });

      const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `fish-farm-report-${new Date().toISOString().split('T')[0]}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    };

    window.importData = (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (!data.version) {
            showToast('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            return;
          }

          showConfirm('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå', () => {
            Object.entries(KEYS).forEach(([name, key]) => {
              if (data[name]) {
                storage.set(key, data[name]);
              }
            });
            showToast('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            setTimeout(() => location.reload(), 500);
          }, 'warning');
        } catch (err) {
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ', 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    };

    // ===== Initialize =====
    initData();
    initTheme();
    render();

    // ===== PWA Service Worker Registration =====
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then((registration) => {
            console.log('ServiceWorker registered:', registration.scope);
          })
          .catch((error) => {
            console.log('ServiceWorker registration failed:', error);
          });
      });
    }

    // ===== PWA Install Prompt =====
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      // Show install button in settings if available
      console.log('PWA install available');
    });

    window.installPWA = () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            showToast('‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
          }
          deferredPrompt = null;
        });
      }
    };

    // ===== Cloud Sync is handled by firebase-sync.js =====
    // Manual sync functions use cloudSync from firebase-sync.js
    window.manualSyncUpload = async () => {
      if (!window.cloudSync?.isOnline()) {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Cloud ‡πÑ‡∏î‡πâ', 'error');
        return;
      }
      showConfirm('üì§ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ô Cloud', async () => {
        showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î...', 'info');
        await window.cloudSync.syncToCloud();
        showToast('‚úÖ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      }, 'warning');
    };

    window.manualSyncDownload = async () => {
      showConfirm('üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cloud', async () => {
        showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...', 'info');
        await window.cloudSync.syncFromCloud();
        showToast('‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        render();
      }, 'warning');
    };

    window.confirmResetFirebase = () => {
      window.cloudSync?.reset();
    };

    // Show cloud sync setup
    window.showFirebaseSetupWizard = () => {
      window.cloudSync?.showSetup();
    };

    window.showFirebaseSetup = () => {
      window.cloudSync?.showSetup();
    };
  </script>

  <!-- Cloud Sync Module -->
  <script src="firebase-sync.js"></script>
</body>
</html>
